<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠ±è“®ç‰¹æœæˆ°æƒ…ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { background-color: #1a1a1a; color: #e0e0e0; font-family: sans-serif; padding-bottom: 120px; }
        .card { background-color: #2d2d2d; border-radius: 12px; padding: 16px; margin-bottom: 12px; border-left: 5px solid #4CAF50; }
        .btn { width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; margin-top: 8px; cursor: pointer; transition: all 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-green { background-color: #4CAF50; color: white; border: none; }
        .btn-red { background-color: #f44336; color: white; border: none; }
        .btn-blue { background-color: #2196F3; color: white; border: none; }
        .loader { border: 4px solid #333; border-top: 4px solid #4CAF50; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .input-dark { width: 100%; background-color: #374151; color: white; padding: 10px; border-radius: 6px; border: 1px solid #4b5563; outline: none; }
        .input-dark:focus { border-color: #f59e0b; }
        .btn-filter.active { background-color: #ca8a04; color: white; }
        
        /* ä»»å‹™çœ‹æ¿ CSS (é…åˆ task.js) */
        .mission-detail { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background-color: #333; border-radius: 0 0 12px 12px; }
        .mission-detail.open { max-height: 800px; border-top: 1px solid #444; }
        .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        
        /* æ²è»¸èˆ‡å½ˆçª— */
        .custom-scrollbar::-webkit-scrollbar { height: 4px; width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #555; border-radius: 2px; }
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        .modal-overlay.flex { display: flex !important; }
        .batch-table th { position: sticky; top: 0; background: #374151; color: #ddd; padding: 8px; text-align: left; }
        .batch-table td { border-bottom: 1px solid #4b5563; padding: 8px; color: #eee; }
    </style>
</head>
<body class="p-4">

    <div id="boar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-95 z-[9999] flex flex-col items-center justify-center">
        <div id="boar-anim" class="text-6xl mb-4 animate-bounce">ğŸ—</div> 
        <p id="boar-text" class="text-green-500 font-bold text-xl animate-pulse">è³‡æ–™è™•ç†ä¸­...</p>
    </div>

    <div id="header" class="mb-4 text-center">
        <h1 class="text-xl font-bold text-green-400">ğŸš’ èŠ±è“®ç‰¹æœè¡Œå‹•ç³»çµ±</h1>
        <p id="user-info" class="text-sm text-gray-400">è­˜åˆ¥ä¸­...</p>
    </div>

    <div id="view-report" class="hidden"><h2 class="text-lg font-bold mb-2">ğŸ“ æ‚¨çš„ä»»å‹™å›å ±</h2><div id="report-list"></div></div>
    <div id="view-query" class="hidden"><h2 class="text-lg font-bold mb-2">ğŸ” é€²è¡Œä¸­ä»»å‹™çœ‹æ¿</h2><div id="query-list"></div></div>
    
    <div id="view-ai" class="hidden">
        <h2 class="text-lg font-bold mb-2">ğŸ¤– AI æˆ°æƒ…/ç°¡å ±ä¸­å¿ƒ</h2>
        <div class="bg-gray-800 p-3 rounded mb-3 border border-gray-700">
            <p class="text-sm text-gray-400 mb-1">è«‹è¼¸å…¥ç›®æ¨™ (æ”¯æ´ GPS)</p>
            <input type="text" id="ai-input" class="input-dark" placeholder="ä¾‹å¦‚: åœŸè€³å…¶ã€èŠ±è“®ç§€æ—é„‰...">
        </div>
        <div class="flex gap-2 mb-3">
            <button onclick="safeExecute(this, () => askAI('text'))" class="btn btn-blue flex-1">ğŸ’¬ æ–‡å­—åˆ†æ</button>
            <button onclick="safeExecute(this, () => askAI('ppt'))" class="btn btn-red flex-1">ğŸ“Š ç”Ÿæˆç°¡å ±</button>
        </div>
        <a href="https://drive.google.com/drive/folders/1XAtHLGeo2fQH3wO5Lfq5_IjunbkIqzn_" target="_blank" class="btn block text-center mb-4" style="background-color: #FF9800; color: white;">ğŸ“‚ é–‹å•Ÿã€Œæ­·å²æƒ…è³‡æ­¸æª”ã€</a>
        <div id="ai-response" class="mt-4 p-4 bg-gray-800 rounded border-l-4 border-green-500 hidden"></div>
    </div>
    
    <div id="view-equipment" class="hidden pb-20">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mb-3">
            <div class="flex items-center gap-2 w-full sm:w-auto">
                <h2 class="text-lg font-bold text-yellow-400 whitespace-nowrap">ğŸ’ è£å‚™</h2>
                <select id="status-filter" onchange="renderEquipmentList()" class="flex-1 sm:flex-none bg-gray-700 text-white text-sm py-2 px-2 rounded border border-gray-600 outline-none focus:border-yellow-500">
                    <option value="All">å…¨éƒ¨é¡¯ç¤º</option> <option value="Borrowed">åªçœ‹å€Ÿå‡º</option> <option value="InStock">åªçœ‹åœ¨éšŠ</option>
                </select>
            </div>
            <div class="flex gap-2 w-full sm:w-auto">
                <button onclick="fetchHistory()" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded text-sm font-bold shadow">ğŸ“œ æ­·å²</button>
                <button onclick="fetchEquipmentData(true)" class="flex-1 bg-green-600 text-white px-3 py-2 rounded text-sm font-bold shadow">ğŸ”„ åˆ·æ–°</button>
                <button onclick="toggleExportMode()" id="btn-export-mode" class="flex-1 bg-purple-600 text-white px-3 py-2 rounded text-sm font-bold shadow">ğŸ“Š åŒ¯å‡º</button>
            </div>
        </div>
        <div class="bg-gray-800 p-2 rounded-lg mb-3 border border-gray-700">
            <input type="text" id="eq-search" oninput="renderEquipmentList()" class="w-full bg-gray-700 text-white p-2 rounded mb-2 border border-gray-600 outline-none" placeholder="ğŸ” æœå°‹...">
            <div id="category-filter-container" class="flex gap-2 overflow-x-auto pb-1 custom-scrollbar"></div>
            <div id="note-filter-container" class="flex gap-2 overflow-x-auto pb-1 mt-2 custom-scrollbar border-t border-gray-700 pt-2 hidden"></div>
        </div>
        <button onclick="openEditModal('create')" class="w-full bg-yellow-600 text-white py-2 rounded mb-3 font-bold shadow-lg">â• æ–°å¢è£å‚™ (ç®¡ç†å“¡)</button>
        <div id="equipment-list" class="space-y-3 min-h-[200px]"></div>
        
        <div id="export-toolbar" class="hidden fixed bottom-4 left-4 right-4 bg-gray-900 border border-purple-500 p-3 rounded-lg shadow-2xl z-40 flex flex-col gap-3">
            <div class="flex justify-between items-center border-b border-gray-700 pb-2">
                <div class="text-white text-sm">å·²é¸ <span id="export-count" class="text-yellow-400 font-bold text-lg">0</span> é …</div>
                <button id="btn-select-all" onclick="toggleSelectAll()" class="bg-gray-700 text-white px-3 py-1 rounded text-xs">å…¨é¸æ­¤é </button>
            </div>
            <div class="flex gap-2">
                <button onclick="openBatchBorrowModal()" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold text-sm shadow">æ‰¹é‡å€Ÿå‡º</button>
                <button onclick="openBatchReturnModal()" class="flex-1 bg-green-600 text-white py-2 rounded font-bold text-sm shadow">æ‰¹é‡æ­¸é‚„</button>
                <button onclick="confirmExport()" class="flex-1 bg-purple-600 text-white py-2 rounded font-bold text-sm shadow">åŒ¯å‡º</button>
            </div>
        </div>
    </div>

    <div id="batch-borrow-modal" class="modal-overlay"><div class="bg-gray-800 p-5 rounded-lg w-full max-w-md border border-blue-500 flex flex-col max-h-[90vh]">
        <h3 class="text-xl font-bold mb-4 text-blue-400">ğŸ“¦ å€Ÿå‡ºè£å‚™</h3>
        <div class="mb-3"><label class="block text-gray-400 text-sm mb-1">å€Ÿç”¨äºº (å¿…å¡«)</label><input type="text" id="batch-borrower" class="input-dark"></div>
        <div class="mb-3"><label class="block text-gray-400 text-sm mb-1">å‚™è¨»</label><input type="text" id="batch-note" list="note-suggestions" class="input-dark"></div>
        <div class="flex-1 overflow-y-auto custom-scrollbar mb-4 border-t border-b border-gray-700 py-2 bg-gray-900 px-2">
            <table class="w-full text-sm text-left text-gray-400 batch-table"><thead><tr><th class="w-1/2">è£å‚™</th><th class="text-center">åº«å­˜</th><th class="w-20 text-center">æ•¸é‡</th></tr></thead><tbody id="batch-borrow-list"></tbody></table>
        </div>
        <div class="flex gap-2"><button onclick="closeModal('batch-borrow-modal')" class="flex-1 bg-gray-600 text-white py-2 rounded">å–æ¶ˆ</button><button onclick="submitBatchBorrow()" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold">ç¢ºèª</button></div>
    </div></div>

    <div id="batch-return-modal" class="modal-overlay"><div class="bg-gray-800 p-5 rounded-lg w-full max-w-md border border-green-500 flex flex-col max-h-[90vh]">
        <h3 class="text-xl font-bold mb-2 text-green-400">â™»ï¸ æ­¸é‚„è£å‚™</h3>
        <p class="text-xs text-gray-400 mb-4">è«‹å‹¾é¸ä¸¦ç¢ºèªæ­¸é‚„æ•¸é‡ã€‚</p>
        <div class="flex-1 overflow-y-auto custom-scrollbar mb-4 bg-gray-900 rounded p-2"><div id="batch-return-list" class="space-y-3"></div></div>
        <div class="flex gap-2"><button onclick="closeModal('batch-return-modal')" class="flex-1 bg-gray-600 text-white py-2 rounded">å–æ¶ˆ</button><button onclick="submitBatchReturn()" class="flex-1 bg-green-600 text-white py-2 rounded font-bold">ç¢ºèª</button></div>
    </div></div>

    <div id="edit-eq-modal" class="modal-overlay"><div class="bg-gray-800 p-5 rounded-lg w-full max-w-sm border border-yellow-600 h-3/4 overflow-y-auto">
        <h3 id="edit-modal-title" class="text-xl font-bold mb-4 text-yellow-400">æ–°å¢è£å‚™</h3><input type="hidden" id="edit-eq-id"><input type="hidden" id="edit-mode">
        <div class="space-y-3">
            <input type="text" id="eq-name" class="input-dark" placeholder="åç¨± (å¿…å¡«)">
            <input type="text" id="eq-category" list="category-options" class="input-dark" placeholder="åˆ†é¡"><datalist id="category-options"></datalist>
            <input type="text" id="eq-model" class="input-dark" placeholder="å‹è™Ÿ">
            <input type="text" id="eq-location" class="input-dark" placeholder="ä½ç½®">
            <div class="flex items-center gap-2"><label class="text-gray-400 w-20">ç¸½é‡:</label><input type="number" id="eq-total" class="input-dark flex-1" value="1" min="1"></div>
        </div>
        <div class="flex gap-2 mt-6"><button id="btn-delete-eq" onclick="deleteEquipment()" class="hidden bg-red-600 text-white px-3 py-2 rounded font-bold">ğŸ—‘ï¸</button><button onclick="closeModal('edit-eq-modal')" class="flex-1 bg-gray-600 text-white py-2 rounded">å–æ¶ˆ</button><button onclick="submitEquipmentEdit()" class="flex-1 bg-yellow-600 text-white py-2 rounded font-bold">å„²å­˜</button></div>
    </div></div>

    <div id="history-modal" class="modal-overlay"><div class="bg-gray-800 p-4 rounded-lg w-full max-w-md border border-blue-500 h-4/5 flex flex-col">
        <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2"><h3 class="text-xl font-bold text-blue-400">ğŸ“œ æ­·å²ç´€éŒ„</h3><button onclick="closeModal('history-modal')" class="text-2xl text-gray-400">&times;</button></div>
        <div id="history-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-2"></div>
    </div></div>

    <datalist id="note-suggestions"><option value="é›ªè¨“"><option value="ç¹©ç´¢è¨“ç·´"><option value="å‹•å“¡è¨“ç·´"><option value="å±±åŸŸæœæ•‘"></datalist>

    <script src="mission_folder/task.js"></script>

    <script>
        // è¨­å®š API ç¶²å€
        const GAS_API_URL = "https://line-bot-liff-lovat.vercel.app/api/webhook";
        let userId = "", displayName = "";
        let equipmentCache = [], currentCategory = 'All', currentNote = 'All', isExportMode = false, selectedItems = new Set(), loaderInterval;

        async function main() {
            try {
                await liff.init({ liffId: "2008804963-FBGT1ktJ" }); 
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                userId = profile.userId; displayName = profile.displayName;
                document.getElementById('user-info').innerText = `éšŠå“¡ï¼š${displayName}`;
                const path = new URLSearchParams(window.location.search).get('path');
                document.getElementById('loader').classList.add('hidden'); 
                
                // é€™è£¡çš„ function (showReportPage, showQueryPage) ä¾†è‡ª task.js
                if (path === 'report') showReportPage();
                else if (path === 'query') showQueryPage();
                else if (path === 'ai') showAiPage();
                else loadEquipment(); 
            } catch (err) { alert("LIFF éŒ¯èª¤: " + err); }
        }

        // --- å…±ç”¨å‡½æ•¸ ---
        function toggleLoader(show, text = "è³‡æ–™è™•ç†ä¸­...") {
            const overlay = document.getElementById('boar-overlay');
            const txt = document.getElementById('boar-text');
            const anim = document.getElementById('boar-anim');
            if (show) {
                overlay.classList.remove('hidden'); txt.innerText = text;
                const icons = ['ğŸ—ğŸ’¨', 'ğŸ—ğŸ“¦', 'ğŸ—ğŸ“', 'ğŸ—âœ…']; let i = 0;
                if (loaderInterval) clearInterval(loaderInterval);
                loaderInterval = setInterval(() => { anim.innerText = icons[i++ % icons.length]; }, 500);
            } else {
                overlay.classList.add('hidden'); if (loaderInterval) clearInterval(loaderInterval);
            }
        }
        async function callGasApi(payload) {
            const body = JSON.stringify({ ...payload, source: 'liff' });
            const res = await fetch(GAS_API_URL, { method: "POST", body: body });
            return await res.json();
        }
        function closeModal(id) {
            document.getElementById(id).classList.remove('flex');
            document.getElementById(id).classList.add('hidden');
        }

        // ============================================
        // ğŸ”¥ è£å‚™ç®¡ç†ç³»çµ± (æ‰¹æ¬¡æ•¸é‡ç®¡ç†)
        // ============================================
        function loadEquipment() {
            document.getElementById('view-equipment').classList.remove('hidden');
            if (equipmentCache.length === 0) fetchEquipmentData(true); else renderEquipmentList();
        }
        async function fetchEquipmentData(showLoading = false) {
            if (showLoading) toggleLoader(true, "ç›¤é»ä¸­...");
            try {
                const data = await callGasApi({ action: 'get_equipment_list', userId: userId, category: 'All' });
                equipmentCache = (data && data.length > 0) ? data : [];
                if(equipmentCache.length === 0) document.getElementById('equipment-list').innerHTML = "<p class='text-center text-gray-500'>æŸ¥ç„¡è£å‚™</p>";
                else { renderCategoryUI(); renderNoteUI(); renderEquipmentList(); }
            } catch (e) { alert(e.message); } finally { if (showLoading) toggleLoader(false); }
        }

        function renderEquipmentList() {
            const listDiv = document.getElementById('equipment-list');
            const searchText = document.getElementById('eq-search').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            
            let filtered = equipmentCache.filter(eq => {
                const matchCat = currentCategory === 'All' || eq.category === currentCategory;
                const matchSearch = (eq.name+eq.model).toLowerCase().includes(searchText) || (eq.active_loans && eq.active_loans.some(l => l.borrower.toLowerCase().includes(searchText)));
                const isBorrowed = eq.available_qty < eq.total_qty;
                let matchStatus = (statusFilter === 'Borrowed' ? isBorrowed : (statusFilter === 'InStock' ? !isBorrowed : true));
                let matchNote = true;
                if (currentNote !== 'All') {
                    if (!eq.active_loans || eq.active_loans.length === 0) matchNote = false;
                    else matchNote = eq.active_loans.some(l => (currentNote==='æœªåˆ†é¡' ? (!l.note||l.note.trim()==='') : l.note===currentNote));
                }
                return matchCat && matchSearch && matchStatus && matchNote;
            });
            filtered.sort((a, b) => (a.available_qty < a.total_qty ? -1 : 1));

            let html = '';
            filtered.forEach(eq => {
                const isFull = eq.available_qty === eq.total_qty;
                const isEmpty = eq.available_qty === 0;
                const statusBadge = isFull ? `<span class="text-green-400 font-bold text-sm">ğŸŸ¢ åœ¨éšŠ (${eq.available_qty})</span>` 
                    : (isEmpty ? `<span class="text-red-400 font-bold text-sm">ğŸ”´ å…¨éƒ¨å€Ÿå‡º</span>` 
                    : `<span class="text-blue-400 font-bold text-sm">ğŸ”µ éƒ¨åˆ†å€Ÿå‡º (${eq.available_qty}/${eq.total_qty})</span>`);

                let loansHtml = '';
                if (eq.active_loans && eq.active_loans.length > 0) {
                    loansHtml = `<div class="mt-2 pt-2 border-t border-gray-600 space-y-1">`;
                    eq.active_loans.forEach(l => {
                        loansHtml += `<div class="flex justify-between items-center text-xs text-gray-300">
                                <span>ğŸ‘¤ ${l.borrower} <span class="text-yellow-400">x${l.qty}</span> <span class="text-blue-300">${l.note ? `#${l.note}` : ''}</span></span>
                                <button onclick="openSingleReturnModal('${eq.id}', '${l.loan_id}', ${l.qty}, '${l.borrower}')" class="bg-green-700 text-white px-2 py-1 rounded text-[10px]">æ­¸é‚„</button>
                            </div>`;
                    });
                    loansHtml += `</div>`;
                }
                const checked = selectedItems.has(eq.id) ? 'checked' : '';
                const checkHtml = isExportMode ? `<div class="mr-3 flex items-center"><input type="checkbox" onchange="toggleSelect('${eq.id}')" ${checked} class="w-6 h-6"></div>` : '';

                html += `<div class="flex items-start bg-gray-800 p-4 rounded-lg mb-3 border-l-4 ${isEmpty ? "border-red-500" : (isFull ? "border-green-500" : "border-blue-500")}">
                        ${checkHtml}<div class="flex-1"><div class="flex justify-between"><div><h3 class="font-bold text-white text-lg">${eq.name}</h3><div class="flex gap-2 text-xs text-gray-400 mt-1"><span>${eq.model||'-'}</span><span>ğŸ“${eq.location||'-'}</span></div></div><div class="flex gap-2"><button onclick="fetchItemHistory('${eq.id}')" class="text-blue-400 p-1">ğŸ“œ</button><button onclick="openEditModal('update', '${eq.id}')" class="text-gray-500 p-1">âš™ï¸</button></div></div>
                        <div class="flex justify-between items-center mt-3">${statusBadge}${!isEmpty ? `<button onclick="openSingleBorrowModal('${eq.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold">å€Ÿå‡º</button>` : ''}</div>${loansHtml}</div></div>`;
            });
            listDiv.innerHTML = html || "<p class='text-center text-gray-500'>ç„¡ç¬¦åˆè£å‚™</p>";
            updateExportCount();
        }

        // --- å€Ÿå‡º (æ‰¹æ¬¡æ•¸é‡) ---
        function openSingleBorrowModal(id) { selectedItems.clear(); selectedItems.add(id); openBatchBorrowModal(); }
        function openBatchBorrowModal() {
            if (selectedItems.size === 0) { alert("è«‹å…ˆå‹¾é¸è£å‚™"); return; }
            document.getElementById('batch-borrow-modal').classList.add('flex');
            document.getElementById('batch-borrower').value = ""; document.getElementById('batch-note').value = "";
            const tbody = document.getElementById('batch-borrow-list'); tbody.innerHTML = "";
            selectedItems.forEach(id => {
                const eq = equipmentCache.find(e => e.id === id);
                if (eq && eq.available_qty > 0) {
                    tbody.innerHTML += `<tr class="border-b border-gray-700"><td class="px-2 py-2 text-white">${eq.name}</td><td class="text-center text-gray-400">${eq.available_qty}</td><td class="text-center"><input type="number" data-id="${eq.id}" class="borrow-qty-input w-16 bg-gray-700 text-white p-1 rounded border border-gray-600 text-center" value="1" min="1" max="${eq.available_qty}"></td></tr>`;
                }
            });
        }
        async function submitBatchBorrow() {
            const borrower = document.getElementById('batch-borrower').value;
            const note = document.getElementById('batch-note').value;
            if (!borrower) { alert("è«‹è¼¸å…¥å€Ÿç”¨äºº"); return; }
            const inputs = document.querySelectorAll('.borrow-qty-input');
            const requests = [];
            inputs.forEach(input => {
                const qty = parseInt(input.value);
                if (qty > 0) requests.push({ action: 'borrow_equipment', userId, displayName, eqId: input.dataset.id, borrower, qty, note });
            });
            if (requests.length === 0) return;
            toggleLoader(true); closeModal('batch-borrow-modal');
            try { await Promise.all(requests.map(req => callGasApi(req))); alert("å€Ÿå‡ºæˆåŠŸ"); selectedItems.clear(); if(isExportMode) toggleExportMode(); fetchEquipmentData(false); } catch (e) { alert(e.message); } finally { toggleLoader(false); }
        }

        // --- æ­¸é‚„ (æ‰¹æ¬¡æ•¸é‡) ---
        function openSingleReturnModal(eqId, loanId, qty, borrower) {
            document.getElementById('batch-return-modal').classList.add('flex');
            const listDiv = document.getElementById('batch-return-list'); listDiv.innerHTML = "";
            const eq = equipmentCache.find(e => e.id === eqId);
            renderReturnItem(listDiv, eq ? eq.name : 'è£å‚™', loanId, qty, borrower);
        }
        function openBatchReturnModal() {
            if (selectedItems.size === 0) { alert("è«‹å…ˆå‹¾é¸æ­¸é‚„è£å‚™"); return; }
            document.getElementById('batch-return-modal').classList.add('flex');
            const listDiv = document.getElementById('batch-return-list'); listDiv.innerHTML = "";
            let hasLoan = false;
            selectedItems.forEach(id => {
                const eq = equipmentCache.find(e => e.id === id);
                if (eq && eq.active_loans) eq.active_loans.forEach(l => { hasLoan=true; renderReturnItem(listDiv, eq.name, l.loan_id, l.qty, l.borrower); });
            });
            if (!hasLoan) { alert("ç„¡å€Ÿå‡ºç´€éŒ„"); closeModal('batch-return-modal'); }
        }
        function renderReturnItem(container, eqName, loanId, maxQty, borrower) {
            container.innerHTML += `<div class="flex items-center justify-between bg-gray-700 p-3 rounded border border-gray-600">
                <div class="flex items-center gap-3"><input type="checkbox" class="return-checkbox w-5 h-5" checked data-loan-id="${loanId}"><div class="text-sm"><div class="text-white font-bold">${eqName}</div><div class="text-gray-300 text-xs">ğŸ‘¤ ${borrower} (å€Ÿ: ${maxQty})</div></div></div>
                <div class="flex items-center gap-2"><label class="text-xs text-gray-400">æ­¸é‚„:</label><input type="number" class="return-qty-input w-16 bg-gray-800 text-white p-1 rounded border border-gray-500 text-center" value="${maxQty}" min="1" max="${maxQty}" data-loan-id="${loanId}"></div></div>`;
        }
        async function submitBatchReturn() {
            const checkboxes = document.querySelectorAll('.return-checkbox:checked');
            if (checkboxes.length === 0) return alert("è«‹å‹¾é¸");
            const requests = [];
            checkboxes.forEach(cb => {
                const loanId = cb.dataset.loanId;
                const qty = parseInt(document.querySelector(`.return-qty-input[data-loan-id="${loanId}"]`).value);
                if (qty > 0) requests.push({ action: 'return_equipment', userId, displayName, loanId, returnQty: qty });
            });
            toggleLoader(true); closeModal('batch-return-modal');
            try { await Promise.all(requests.map(req => callGasApi(req))); alert("æ­¸é‚„æˆåŠŸ"); selectedItems.clear(); if(isExportMode) toggleExportMode(); fetchEquipmentData(false); } catch (e) { alert(e.message); } finally { toggleLoader(false); }
        }

        // --- å…¶ä»–å·¥å…· ---
        function toggleExportMode() { isExportMode = !isExportMode; document.getElementById('export-toolbar').classList.toggle('hidden'); document.getElementById('btn-export-mode').innerText = isExportMode ? "âŒ å–æ¶ˆ" : "ğŸ“Š åŒ¯å‡º"; renderEquipmentList(); }
        function toggleSelect(id) { if (selectedItems.has(id)) selectedItems.delete(id); else selectedItems.add(id); updateExportCount(); }
        function toggleSelectAll() { const ids = Array.from(document.querySelectorAll('#equipment-list input[type="checkbox"]')).map(c => c.getAttribute('onchange').match(/'([^']+)'/)[1]); if (ids.every(id => selectedItems.has(id))) ids.forEach(id => selectedItems.delete(id)); else ids.forEach(id => selectedItems.add(id)); renderEquipmentList(); }
        function updateExportCount() { document.getElementById('export-count').innerText = selectedItems.size; }
        async function confirmExport() { if (selectedItems.size === 0) return alert("è«‹é¸æ“‡"); toggleLoader(true); try { const res = await callGasApi({ action: 'export_equipment_report', userId, eqIds: Array.from(selectedItems) }); if (res.url) window.open(res.url); else alert("å¤±æ•—"); } catch (e) { alert(e.message); } finally { toggleLoader(false); } }
        function renderCategoryUI() {
            const cats = [...new Set(['ç®¡ç†','æœç´¢','æ•‘æ´','é†«ç™‚','å¾Œå‹¤', ...equipmentCache.map(e=>e.category)])];
            document.getElementById('category-filter-container').innerHTML = `<button onclick="switchCategory('All')" class="btn-filter ${currentCategory==='All'?'active':''} px-3 py-1 rounded-full text-sm bg-gray-700 mr-2">å…¨éƒ¨</button>` + cats.map(c=>`<button onclick="switchCategory('${c}')" class="btn-filter ${currentCategory===c?'active':''} px-3 py-1 rounded-full text-sm bg-gray-700 mr-2">${c}</button>`).join('');
            document.getElementById('category-options').innerHTML = cats.map(c=>`<option value="${c}">`).join('');
        }
        function switchCategory(c) { currentCategory = c; renderCategoryUI(); renderEquipmentList(); }
        function renderNoteUI() {
            const notes = new Set(); equipmentCache.forEach(e => e.active_loans?.forEach(l => notes.add(l.note?.trim() || 'æœªåˆ†é¡')));
            const div = document.getElementById('note-filter-container');
            if(notes.size===0) { div.classList.add('hidden'); return; } div.classList.remove('hidden');
            div.innerHTML = `<button onclick="switchNote('All')" class="btn-filter ${currentNote==='All'?'active':''} px-3 py-1 rounded-full text-xs bg-gray-700 mr-2">å…¨éƒ¨</button>` + Array.from(notes).map(n=>`<button onclick="switchNote('${n}')" class="btn-filter ${currentNote===n?'active':''} px-3 py-1 rounded-full text-xs bg-gray-700 mr-2">${n}</button>`).join('');
        }
        function switchNote(n) { currentNote = n; renderNoteUI(); renderEquipmentList(); }
        
        // ç·¨è¼¯/æ–°å¢/åˆªé™¤ (ç°¡åŒ–)
        function openEditModal(mode,id) {
            document.getElementById('edit-eq-modal').classList.add('flex'); document.getElementById('edit-mode').value = mode;
            let eq = (mode === 'update' && id) ? (equipmentCache.find(e => e.id === id) || {}) : {};
            document.getElementById('edit-modal-title').innerText = mode==='create'?"â• æ–°å¢":"âš™ï¸ ç·¨è¼¯";
            document.getElementById('edit-eq-id').value=id||""; document.getElementById('eq-name').value=eq.name||""; 
            document.getElementById('eq-category').value=eq.category||""; document.getElementById('eq-model').value=eq.model||"";
            document.getElementById('eq-location').value=eq.location||""; document.getElementById('eq-total').value=eq.total_qty||1;
            document.getElementById('btn-delete-eq').className = mode==='create' ? 'hidden' : 'bg-red-600 text-white px-3 py-2 rounded font-bold';
        }
        async function submitEquipmentEdit() {
            const p = { action:'manage_equipment', userId, displayName, mode:document.getElementById('edit-mode').value, eqId:document.getElementById('edit-eq-id').value, name:document.getElementById('eq-name').value, category:document.getElementById('eq-category').value, model:document.getElementById('eq-model').value, location:document.getElementById('eq-location').value, totalQty:document.getElementById('eq-total').value };
            if(!p.name) return alert("åç¨±å¿…å¡«"); toggleLoader(true); closeModal('edit-eq-modal'); await callGasApi(p); fetchEquipmentData(false); toggleLoader(false);
        }
        async function deleteEquipment() { if(confirm("ç¢ºå®šåˆªé™¤?")) { toggleLoader(true); closeModal('edit-eq-modal'); await callGasApi({action:'manage_equipment', userId, displayName, mode:'delete', eqId:document.getElementById('edit-eq-id').value}); fetchEquipmentData(false); toggleLoader(false); } }
        async function fetchHistory() { 
            document.getElementById('history-modal').classList.add('flex'); document.getElementById('history-list').innerHTML = '<div class="loader"></div>';
            const data = await callGasApi({action:'get_loan_history', userId});
            document.getElementById('history-list').innerHTML = data.map(l=>`<div class="bg-gray-700 p-3 mb-2 rounded border-l-4 ${l.status==='å·²æ­¸é‚„'?'border-green-500':'border-blue-500'} text-sm"><div class="flex justify-between font-bold"><span>${l.item_name}</span><span>${l.borrower}</span></div><div class="flex justify-between text-xs mt-1"><span>${l.status} x${l.qty}</span><span>${l.time}</span></div></div>`).join('') || "ç„¡ç´€éŒ„";
        }
        async function fetchItemHistory(id) {
            document.getElementById('history-modal').classList.add('flex'); document.getElementById('history-list').innerHTML = '<div class="loader"></div>';
            const data = await callGasApi({action:'get_loan_history', userId, eqId:id});
            document.getElementById('history-list').innerHTML = data.map(l=>`<div class="bg-gray-700 p-3 mb-2 rounded border-l-4 ${l.status==='å·²æ­¸é‚„'?'border-green-500':'border-blue-500'} text-sm"><div class="flex justify-between font-bold"><span>${l.status}</span><span>${l.borrower}</span></div><div class="flex justify-between text-xs mt-1"><span>æ•¸é‡: ${l.qty}</span><span>${l.time}</span></div></div>`).join('') || "ç„¡ç´€éŒ„";
        }

        // AI
        function showAiPage() { document.getElementById('view-ai').classList.remove('hidden'); }
        async function askAI(mode) { 
            const q = document.getElementById('ai-input').value; if(!q) return alert("è«‹è¼¸å…¥"); toggleLoader(true);
            try { const r = await callGasApi({action:mode==='ppt'?'make_briefing_ppt':'ask_ai', userId, question:q, query:q});
            document.getElementById('ai-response').classList.remove('hidden');
            document.getElementById('ai-response').innerHTML = mode==='ppt'?`<a href="${r.url}" target="_blank" class="btn block text-center bg-green-600 p-2 rounded">ä¸‹è¼‰ç°¡å ±</a>`:r.answer; } catch(e){alert(e.message)} finally{toggleLoader(false)}
        }
        async function safeExecute(btn, fn) { btn.disabled=true; await fn(); btn.disabled=false; }

        main();
    </script>
</body>
</html>
