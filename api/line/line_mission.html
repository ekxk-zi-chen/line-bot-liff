<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èŠ±è“®ç‰¹æœæˆ°æƒ…ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* =========================================
           1. å…¨å±€ä½ˆå±€
           ========================================= */
        body {
            background-color: #1a1a1a;
            color: #e0e0e0;
            font-family: sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin: 0;
            padding: 0;
        }

        #top-fixed-area {
            flex-shrink: 0;
            background-color: #1a1a1a;
            z-index: 20;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            padding-bottom: 8px;
        }

        #content-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 120px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        /* =========================================
           2. ç¯©é¸å™¨èˆ‡å…ƒä»¶
           ========================================= */
        .filter-row {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 4px 16px;
            white-space: nowrap;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .filter-row::-webkit-scrollbar {
            display: none;
        }

        .btn-chip {
            background-color: #333;
            color: #aaa;
            padding: 6px 14px;
            border-radius: 9999px;
            font-size: 13px;
            font-weight: 500;
            border: 1px solid #444;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .btn-chip.active {
            background-color: #ca8a04;
            color: white;
            border-color: #ca8a04;
        }

        .input-dark {
            width: 100%;
            background-color: #374151;
            color: white;
            padding: 10px 14px;
            border-radius: 20px;
            border: 1px solid #4b5563;
            outline: none;
            font-size: 14px;
        }

        .hidden {
            display: none !important;
        }

        .loader {
            border: 4px solid #333;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* =========================================
           3. ä»»å‹™çœ‹æ¿èˆ‡å½ˆçª—
           ========================================= */
        .card {
            background-color: #2d2d2d;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 5px solid #4CAF50;
        }

        .mission-detail {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background-color: #333;
            border-radius: 0 0 12px 12px;
        }

        .mission-detail.open {
            max-height: 800px;
            border-top: 1px solid #444;
        }

        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }

        .modal-overlay.flex {
            display: flex !important;
        }

        .custom-scrollbar::-webkit-scrollbar {
            height: 4px;
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 2px;
        }

        .batch-table th {
            position: sticky;
            top: 0;
            background: #374151;
            color: #ddd;
            padding: 8px;
            text-align: left;
        }

        .batch-table td {
            border-bottom: 1px solid #4b5563;
            padding: 8px;
            color: #eee;
        }

        /* =========================================
           4. å‹•ç•«
           ========================================= */
        #boar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .boar-scene {
            font-size: 60px;
            margin-bottom: 20px;
            animation: bounce 1s infinite alternate;
        }

        .boar-text {
            color: #4CAF50;
            font-weight: bold;
            font-size: 1.2rem;
            animation: pulse 1.5s infinite;
        }

        @keyframes bounce {
            0% {
                transform: translateY(0);
            }

            100% {
                transform: translateY(-10px);
            }
        }
    </style>
</head>

<body class="p-4">

    <div id="boar-overlay" class="hidden">
        <div id="boar-anim" class="boar-scene">ğŸ—</div>
        <p id="boar-text" class="boar-text">è³‡æ–™è™•ç†ä¸­...</p>
    </div>
    <div id="header" class="mb-4 text-center">
        <h1 class="text-xl font-bold text-green-400">ğŸš’ èŠ±è“®ç‰¹æœè¡Œå‹•ç³»çµ±</h1>
        <p id="user-info" class="text-sm text-gray-400">è­˜åˆ¥ä¸­...</p>
    </div>
    <div id="loader" class="loader"></div>

    <div id="view-report" class="hidden">
        <h2 class="text-lg font-bold mb-2">ğŸ“ æ‚¨çš„ä»»å‹™å›å ±</h2>
        <div id="report-list"></div>
    </div>
    <div id="view-query" class="hidden">
        <h2 class="text-lg font-bold mb-2">ğŸ” é€²è¡Œä¸­ä»»å‹™çœ‹æ¿</h2>
        <div id="query-list"></div>
    </div>

    <div id="view-ai" class="hidden">
        <h2 class="text-lg font-bold mb-2">ğŸ¤– AI æˆ°æƒ…/ç°¡å ±ä¸­å¿ƒ</h2>
        <div class="bg-gray-800 p-3 rounded mb-3 border border-gray-700">
            <p class="text-sm text-gray-400 mb-1">è«‹è¼¸å…¥ç›®æ¨™</p><input type="text" id="ai-input" class="input-dark"
                placeholder="ä¾‹å¦‚: åœŸè€³å…¶...">
        </div>
        <div class="flex gap-2 mb-3"><button onclick="safeExecute(this, () => askAI('text'))"
                class="w-full bg-blue-600 text-white py-2 rounded font-bold">ğŸ’¬ åˆ†æ</button><button
                onclick="safeExecute(this, () => askAI('ppt'))"
                class="w-full bg-red-600 text-white py-2 rounded font-bold">ğŸ“Š ç°¡å ±</button></div>
        <a href="https://drive.google.com/drive/folders/1XAtHLGeo2fQH3wO5Lfq5_IjunbkIqzn_" target="_blank"
            class="block text-center bg-orange-500 text-white py-2 rounded font-bold no-underline mb-4">ğŸ“‚ é–‹å•Ÿæ­¸æª”</a>
        <div id="ai-response" class="mt-4 p-4 bg-gray-800 rounded border-l-4 border-green-500 hidden"></div>
    </div>

    <div id="view-equipment" class="hidden h-full flex flex-col">

        <div id="top-fixed-area" class="pb-1 bg-gray-900 border-b border-gray-800">
            <div class="flex justify-between items-center px-4 py-2">
                <div class="flex items-center gap-2">
                    <h2 class="text-base font-bold text-yellow-400">ğŸ’ è£å‚™</h2>
                    <button onclick="toggleFilterPanel()" id="btn-toggle-filter"
                        class="text-xs bg-gray-800 text-gray-400 border border-gray-600 px-2 py-1 rounded flex items-center gap-1 transition-colors"><span>ğŸ”</span>
                        ç¯©é¸</button>
                </div>
                <div class="flex gap-2 items-center">
                    <select id="status-filter" onchange="renderEquipmentList()"
                        class="bg-gray-800 text-gray-300 text-xs py-1 px-1 rounded border border-gray-700 outline-none max-w-[70px]">
                        <option value="All">å…¨éƒ¨</option>
                        <option value="Borrowed">å€Ÿå‡º</option>
                        <option value="InStock">åœ¨éšŠ</option>
                    </select>
                    <button onclick="fetchHistory()"
                        class="text-xs text-blue-400 border border-blue-400 px-2 py-1 rounded">ğŸ“œ</button>
                    <button onclick="fetchEquipmentData(true)"
                        class="text-xs text-green-400 border border-green-400 px-2 py-1 rounded">ğŸ”„</button>
                    <button onclick="toggleExportMode()" id="btn-export-mode"
                        class="text-xs text-purple-400 border border-purple-400 px-2 py-1 rounded">ğŸ“Š</button>
                    <button id="btn-add-eq" onclick="openEditModal('create')"
                        class="hidden text-xs text-yellow-400 border border-yellow-400 px-2 py-1 rounded hover:bg-yellow-400 hover:text-black transition">+æ–°å¢</button>
                </div>
            </div>

            <div id="collapsible-filters" class="transition-all duration-300 overflow-hidden"
                style="max-height: 0px; opacity: 0;">
                <div class="px-4 pb-2"><input type="text" id="eq-search" oninput="renderEquipmentList()"
                        class="input-dark w-full text-xs" placeholder="ğŸ” æœå°‹è£å‚™åç¨±ã€å‹è™Ÿ..."></div>
                <div id="category-filter-container" class="filter-row"></div>
                <div id="location-filter-container" class="filter-row hidden"></div>
                <div id="note-filter-container" class="filter-row hidden"></div>
                <div class="h-2"></div>
            </div>
        </div>

        <div id="content-area">
            <div id="equipment-list" class="space-y-2 pb-20"></div>
        </div>

        <div id="export-toolbar"
            class="hidden fixed bottom-4 left-4 right-4 bg-gray-900 border border-purple-500 p-3 rounded-lg shadow-2xl z-40 flex flex-col gap-3">
            <div class="flex justify-between items-center border-b border-gray-700 pb-2">
                <div class="text-white text-sm">å·²é¸ <span id="export-count"
                        class="text-yellow-400 font-bold text-lg">0</span> é …</div>
                <button id="btn-select-all" onclick="toggleSelectAll()"
                    class="bg-gray-700 text-white px-3 py-1 rounded text-xs">å…¨é¸</button>
            </div>
            <div class="flex gap-2">
                <button id="btn-batch-borrow" onclick="openBatchBorrowModal()"
                    class="hidden flex-1 bg-blue-600 text-white py-2 rounded font-bold text-sm shadow">æ‰¹é‡å€Ÿå‡º</button>
                <button id="btn-batch-return" onclick="openBatchReturnModal()"
                    class="hidden flex-1 bg-green-600 text-white py-2 rounded font-bold text-sm shadow">æ‰¹é‡æ­¸é‚„</button>
                <button onclick="confirmExport()"
                    class="flex-1 bg-purple-600 text-white py-2 rounded font-bold text-sm shadow">åŒ¯å‡º</button>
            </div>
        </div>
    </div>

    <div id="batch-borrow-modal" class="modal-overlay">
        <div class="bg-gray-800 p-5 rounded-lg w-full max-w-md border border-blue-500 flex flex-col max-h-[90vh]">
            <h3 class="text-xl font-bold mb-4 text-blue-400">ğŸ“¦ å€Ÿå‡ºè£å‚™</h3>
            <div class="mb-3"><label class="block text-gray-400 text-sm mb-1">å€Ÿç”¨äºº (å¿…å¡«)</label><input type="text"
                    id="batch-borrower" class="input-dark"></div>
            <div class="mb-3"><label class="block text-gray-400 text-sm mb-1">å‚™è¨»</label><input type="text"
                    id="batch-note" list="note-suggestions" class="input-dark"></div>
            <div
                class="flex-1 overflow-y-auto custom-scrollbar mb-4 border-t border-b border-gray-700 py-2 bg-gray-900 px-2">
                <table class="w-full text-sm text-left text-gray-400 batch-table">
                    <thead>
                        <tr>
                            <th class="w-1/2">è£å‚™</th>
                            <th class="text-center">åº«å­˜</th>
                            <th class="w-20 text-center">æ•¸é‡</th>
                        </tr>
                    </thead>
                    <tbody id="batch-borrow-list"></tbody>
                </table>
            </div>
            <div class="flex gap-2"><button onclick="closeModal('batch-borrow-modal')"
                    class="flex-1 bg-gray-600 text-white py-2 rounded">å–æ¶ˆ</button><button onclick="submitBatchBorrow()"
                    class="flex-1 bg-blue-600 text-white py-2 rounded font-bold">ç¢ºèª</button></div>
        </div>
    </div>
    <div id="batch-return-modal" class="modal-overlay">
        <div class="bg-gray-800 p-5 rounded-lg w-full max-w-md border border-green-500 flex flex-col max-h-[90vh]">
            <h3 class="text-xl font-bold mb-2 text-green-400">â™»ï¸ æ­¸é‚„è£å‚™</h3>
            <p class="text-xs text-gray-400 mb-4">è«‹å‹¾é¸ä¸¦ç¢ºèªæ­¸é‚„æ•¸é‡ã€‚</p>
            <div class="flex-1 overflow-y-auto custom-scrollbar mb-4 bg-gray-900 rounded p-2">
                <div id="batch-return-list" class="space-y-3"></div>
            </div>
            <div class="flex gap-2"><button onclick="closeModal('batch-return-modal')"
                    class="flex-1 bg-gray-600 text-white py-2 rounded">å–æ¶ˆ</button><button onclick="submitBatchReturn()"
                    class="flex-1 bg-green-600 text-white py-2 rounded font-bold">ç¢ºèª</button></div>
        </div>
    </div>
    <div id="edit-eq-modal" class="modal-overlay">
        <div class="bg-gray-800 p-5 rounded-lg w-full max-w-sm border border-yellow-600 h-3/4 overflow-y-auto">
            <h3 id="edit-modal-title" class="text-xl font-bold mb-4 text-yellow-400">æ–°å¢</h3><input type="hidden"
                id="edit-eq-id"><input type="hidden" id="edit-mode">
            <div class="space-y-3"><input type="text" id="eq-name" class="input-dark" placeholder="åç¨±"><input
                    type="text" id="eq-category" list="category-options" class="input-dark" placeholder="åˆ†é¡"><datalist
                    id="category-options"></datalist><input type="text" id="eq-model" class="input-dark"
                    placeholder="å‹è™Ÿ"><input type="text" id="eq-location" class="input-dark" placeholder="ä½ç½®">
                <div class="flex items-center gap-2"><label class="text-gray-400 w-20">ç¸½é‡:</label><input type="number"
                        id="eq-total" class="input-dark flex-1" value="1" min="1"></div>
            </div>
            <div class="flex gap-2 mt-6"><button id="btn-delete-eq" onclick="deleteEquipment()"
                    class="hidden bg-red-600 text-white px-3 py-2 rounded font-bold">ğŸ—‘ï¸</button><button
                    onclick="closeModal('edit-eq-modal')"
                    class="flex-1 bg-gray-600 text-white py-2 rounded">å–æ¶ˆ</button><button
                    onclick="submitEquipmentEdit()"
                    class="flex-1 bg-yellow-600 text-white py-2 rounded font-bold">å„²å­˜</button></div>
        </div>
    </div>
    <div id="history-modal" class="modal-overlay">
        <div class="bg-gray-800 p-4 rounded-lg w-full max-w-md border border-blue-500 h-4/5 flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <h3 class="text-xl font-bold text-blue-400">ğŸ“œ æ­·å²ç´€éŒ„</h3><button onclick="closeModal('history-modal')"
                    class="text-2xl text-gray-400">&times;</button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-2"></div>
        </div>
    </div>
    <datalist id="note-suggestions">
        <option value="é›ªè¨“">
        <option value="ç¹©ç´¢è¨“ç·´">
        <option value="å‹•å“¡è¨“ç·´">
        <option value="å±±åŸŸæœæ•‘">
    </datalist>

    <script src="mission_folder/task.js"></script>

    <script>
        const GAS_API_URL = "https://line-bot-liff-lovat.vercel.app/api/webhook";
        let userId = "", displayName = "", equipmentCache = [], currentCategory = 'All', currentLocation = 'All', currentNote = 'All', isExportMode = false, selectedItems = new Set(), loaderInterval;
        let isUserAdmin = false; // ğŸ”¥ æ¬Šé™æ——æ¨™ (é è¨­ false)

        async function main() {
            try {
                await liff.init({ liffId: "2008804963-FBGT1ktJ" });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                userId = profile.userId; displayName = profile.displayName;
                document.getElementById('user-info').innerText = `éšŠå“¡ï¼š${displayName}`;

                checkAdminRole(); // ğŸ”¥ æª¢æŸ¥æ¬Šé™

                const path = new URLSearchParams(window.location.search).get('path');
                document.getElementById('loader').classList.add('hidden');

                if (path === 'report') showReportPage();
                else if (path === 'query') showQueryPage();
                else if (path === 'ai') showAiPage();
                else loadEquipment();
            } catch (err) { alert("LIFF éŒ¯èª¤: " + err); }
        }

        async function checkAdminRole() {
            try {
                const res = await callGasApi({ action: 'check_user_role', userId: userId });
                if (res && res.isAdmin) {
                    isUserAdmin = true;
                    // ğŸ”¥ ç®¡ç†å“¡æ‰çœ‹å¾—åˆ°é€™äº›æŒ‰éˆ•
                    document.getElementById('btn-add-eq').classList.remove('hidden');
                    document.getElementById('btn-batch-borrow').classList.remove('hidden');
                    document.getElementById('btn-batch-return').classList.remove('hidden');
                    // é‡æ–°æ¸²æŸ“ï¼ŒæŠŠå¡ç‰‡ä¸Šçš„æŒ‰éˆ•ç§€å‡ºä¾†
                    if (!document.getElementById('view-equipment').classList.contains('hidden')) {
                        renderEquipmentList();
                    }
                }
            } catch (e) { console.error("æ¬Šé™å¤±æ•—", e); }
        }

        function loadEquipment() {
            document.getElementById('view-equipment').classList.remove('hidden');
            if (equipmentCache.length === 0) fetchEquipmentData(true); else renderEquipmentList();
        }

        async function fetchEquipmentData(showLoading = false) {
            if (showLoading) toggleLoader(true, "ç›¤é»ä¸­...");
            try {
                const data = await callGasApi({ action: 'get_equipment_list', userId: userId, category: 'All' });
                equipmentCache = (data && data.length > 0) ? data : [];
                if (equipmentCache.length === 0) document.getElementById('equipment-list').innerHTML = "<p class='text-center text-gray-500'>æŸ¥ç„¡è£å‚™</p>";
                else { renderCategoryUI(); renderLocationUI(); renderNoteUI(); renderEquipmentList(); }
            } catch (e) { alert(e.message); } finally { if (showLoading) toggleLoader(false); }
        }

        function renderEquipmentList() {
            const listDiv = document.getElementById('equipment-list');
            const searchText = document.getElementById('eq-search').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;

            let filtered = equipmentCache.filter(eq => {
                const matchCat = currentCategory === 'All' || eq.category === currentCategory;
                const matchLoc = currentLocation === 'All' || eq.location === currentLocation;
                const matchSearch = (eq.name + eq.model).toLowerCase().includes(searchText) || (eq.active_loans && eq.active_loans.some(l => l.borrower.toLowerCase().includes(searchText)));
                const isBorrowed = eq.available_qty < eq.total_qty;
                let matchStatus = (statusFilter === 'Borrowed' ? isBorrowed : (statusFilter === 'InStock' ? !isBorrowed : true));
                let matchNote = true;
                if (currentNote !== 'All') {
                    if (!eq.active_loans || eq.active_loans.length === 0) matchNote = false;
                    else matchNote = eq.active_loans.some(l => (currentNote === 'æœªåˆ†é¡' ? (!l.note || l.note.trim() === '') : l.note === currentNote));
                }
                return matchCat && matchLoc && matchSearch && matchStatus && matchNote;
            });
            filtered.sort((a, b) => (a.available_qty < a.total_qty ? -1 : 1));

            let html = '';
            filtered.forEach(eq => {
                const isFull = eq.available_qty === eq.total_qty;
                const isEmpty = eq.available_qty === 0;
                const statusBadge = isFull ? `<span class="text-green-400 font-bold text-sm">ğŸŸ¢ åœ¨éšŠ (${eq.available_qty})</span>`
                    : (isEmpty ? `<span class="text-red-400 font-bold text-sm">ğŸ”´ å…¨éƒ¨å€Ÿå‡º</span>`
                        : `<span class="text-blue-400 font-bold text-sm">ğŸ”µ éƒ¨åˆ†å€Ÿå‡º (${eq.available_qty}/${eq.total_qty})</span>`);

                // ğŸ”¥ å€Ÿå‡ºæ¸…å–® (è³‡è¨Šä¿ç•™ï¼Œä½†æ­¸é‚„æŒ‰éˆ•çœ‹äººçµ¦)
                let loansHtml = '';
                if (eq.active_loans && eq.active_loans.length > 0) {
                    loansHtml = `<div class="mt-2 pt-2 border-t border-gray-600 space-y-1">`;
                    eq.active_loans.forEach(l => {
                        // âŒ ä¸€èˆ¬äººï¼šçœ‹ä¸åˆ°æŒ‰éˆ•
                        // âœ… ç®¡ç†å“¡ï¼šçœ‹å¾—åˆ° <button>
                        const returnBtn = isUserAdmin ? `<button onclick="openSingleReturnModal('${eq.id}', '${l.loan_id}', ${l.qty}, '${l.borrower}')" class="bg-green-700 text-white px-2 py-1 rounded text-[10px]">æ­¸é‚„</button>` : '';

                        // è³‡è¨Š (User, Qty, Note) æ°¸é é¡¯ç¤º
                        loansHtml += `<div class="flex justify-between items-center text-xs text-gray-300">
                                <span>ğŸ‘¤ ${l.borrower} <span class="text-yellow-400">x${l.qty}</span> <span class="text-blue-300">${l.note ? `#${l.note}` : ''}</span></span>
                                ${returnBtn}
                            </div>`;
                    });
                    loansHtml += `</div>`;
                }

                const checked = selectedItems.has(eq.id) ? 'checked' : '';
                const checkHtml = isExportMode ? `<div class="mr-3 flex items-center"><input type="checkbox" onchange="toggleSelect('${eq.id}')" ${checked} class="w-6 h-6"></div>` : '';

                // ğŸ”¥ å€Ÿå‡ºæŒ‰éˆ• (åªæœ‰ç®¡ç†å“¡çœ‹å¾—åˆ°)
                const borrowBtn = (!isEmpty && isUserAdmin) ? `<button onclick="openSingleBorrowModal('${eq.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold">å€Ÿå‡º</button>` : '';
                const editBtn = isUserAdmin ? `<button onclick="openEditModal('update', '${eq.id}')" class="text-gray-500 p-1">âš™ï¸</button>` : '';

                html += `<div class="flex items-start bg-gray-800 p-4 rounded-lg mb-3 border-l-4 ${isEmpty ? "border-red-500" : (isFull ? "border-green-500" : "border-blue-500")}">
                        ${checkHtml}<div class="flex-1"><div class="flex justify-between"><div><h3 class="font-bold text-white text-lg">${eq.name}</h3><div class="flex gap-2 text-xs text-gray-400 mt-1"><span>${eq.model || '-'}</span><span>ğŸ“${eq.location || '-'}</span></div></div><div class="flex gap-2"><button onclick="fetchItemHistory('${eq.id}')" class="text-blue-400 p-1">ğŸ“œ</button>${editBtn}</div></div>
                        <div class="flex justify-between items-center mt-3">${statusBadge}${borrowBtn}</div>${loansHtml}</div></div>`;
            });
            listDiv.innerHTML = html || "<p class='text-center text-gray-500'>ç„¡ç¬¦åˆè£å‚™</p>";
            updateExportCount();
        }

        // --- å…¶é¤˜ JS é‚è¼¯ (ç¯©é¸/å½ˆçª—/AI) ä¿æŒä¸è®Š ---
        function renderCategoryUI() { const c = [...new Set(['ç®¡ç†', 'æœç´¢', 'æ•‘æ´', 'é†«ç™‚', 'å¾Œå‹¤', ...equipmentCache.map(e => e.category)])]; document.getElementById('category-filter-container').innerHTML = `<button onclick="switchCategory('All')" class="btn-chip ${currentCategory === 'All' ? 'active' : ''}">å…¨éƒ¨åˆ†çµ„</button>` + c.map(i => `<button onclick="switchCategory('${i}')" class="btn-chip ${currentCategory === i ? 'active' : ''}">${i}</button>`).join(''); document.getElementById('category-options').innerHTML = c.map(i => `<option value="${i}">`).join('') }
        function renderLocationUI() { const c = document.getElementById('location-filter-container'), s = new Set(); equipmentCache.forEach(e => { if (e.location) s.add(e.location) }); if (s.size === 0) { c.classList.add('hidden'); return } c.classList.remove('hidden'); c.innerHTML = `<button onclick="switchLocation('All')" class="btn-chip ${currentLocation === 'All' ? 'active' : ''}">å…¨éƒ¨ä½ç½®</button>` + Array.from(s).sort().map(i => `<button onclick="switchLocation('${i}')" class="btn-chip ${currentLocation === i ? 'active' : ''}">${i}</button>`).join('') }
        function renderNoteUI() { const c = document.getElementById('note-filter-container'), s = new Set(); equipmentCache.forEach(e => e.active_loans?.forEach(l => s.add(l.note?.trim() || 'æœªåˆ†é¡'))); if (currentNote !== 'All' && !s.has(currentNote)) { currentNote = 'All'; renderEquipmentList() } if (s.size === 0) { c.classList.add('hidden'); return } c.classList.remove('hidden'); c.innerHTML = `<button onclick="switchNote('All')" class="btn-chip ${currentNote === 'All' ? 'active' : ''}">å…¨éƒ¨ç”¨é€”</button>` + Array.from(s).sort().map(i => `<button onclick="switchNote('${i}')" class="btn-chip ${currentNote === i ? 'active' : ''}">${i}</button>`).join('') }
        function toggleFilterPanel() { const p = document.getElementById('collapsible-filters'), b = document.getElementById('btn-toggle-filter'); if (p.style.maxHeight === '0px') { p.style.maxHeight = '500px'; p.style.opacity = '1'; b.innerHTML = '<span>â–¼</span> æ”¶åˆ'; b.classList.add('text-yellow-400', 'border-yellow-600'); b.classList.remove('text-gray-400', 'border-gray-600') } else { p.style.maxHeight = '0px'; p.style.opacity = '0'; b.innerHTML = '<span>ğŸ”</span> ç¯©é¸'; b.classList.remove('text-yellow-400', 'border-yellow-600'); b.classList.add('text-gray-400', 'border-gray-600') } }
        function switchCategory(c) { currentCategory = c; renderCategoryUI(); renderEquipmentList() }
        function switchLocation(l) { currentLocation = l; renderLocationUI(); renderEquipmentList() }
        function switchNote(n) { currentNote = n; renderNoteUI(); renderEquipmentList(); toggleFilterPanel() }
        function openSingleBorrowModal(id) { selectedItems.clear(); selectedItems.add(id); openBatchBorrowModal() }
        function openBatchBorrowModal() { if (selectedItems.size === 0) return alert("è«‹å‹¾é¸"); document.getElementById('batch-borrow-modal').classList.add('flex'); document.getElementById('batch-borrower').value = ""; document.getElementById('batch-note').value = ""; const t = document.getElementById('batch-borrow-list'); t.innerHTML = ""; selectedItems.forEach(id => { const e = equipmentCache.find(x => x.id === id); if (e && e.available_qty > 0) t.innerHTML += `<tr class="border-b border-gray-700"><td class="px-2 py-2 text-white">${e.name}</td><td class="text-center text-gray-400">${e.available_qty}</td><td class="text-center"><input type="number" data-id="${e.id}" class="borrow-qty-input w-16 bg-gray-700 text-white p-1 rounded border border-gray-600 text-center" value="1" min="1" max="${e.available_qty}"></td></tr>` }) }
        async function submitBatchBorrow() { const b = document.getElementById('batch-borrower').value, n = document.getElementById('batch-note').value; if (!b) return alert("è«‹è¼¸å…¥å€Ÿç”¨äºº"); const r = []; document.querySelectorAll('.borrow-qty-input').forEach(i => { if (i.value > 0) r.push({ action: 'borrow_equipment', userId, displayName, eqId: i.dataset.id, borrower: b, qty: i.value, note: n }) }); if (r.length === 0) return; toggleLoader(true); closeModal('batch-borrow-modal'); try { await Promise.all(r.map(x => callGasApi(x))); alert("æˆåŠŸ"); selectedItems.clear(); if (isExportMode) toggleExportMode(); fetchEquipmentData(false) } catch (e) { alert(e.message) } finally { toggleLoader(false) } }
        function openSingleReturnModal(eqId, lid, qty, b) { document.getElementById('batch-return-modal').classList.add('flex'); const l = document.getElementById('batch-return-list'); l.innerHTML = ""; const e = equipmentCache.find(x => x.id === eqId); renderReturnItem(l, e ? e.name : 'è£å‚™', lid, qty, b) }
        function openBatchReturnModal() { if (selectedItems.size === 0) return alert("è«‹å‹¾é¸"); document.getElementById('batch-return-modal').classList.add('flex'); const l = document.getElementById('batch-return-list'); l.innerHTML = ""; selectedItems.forEach(id => { const e = equipmentCache.find(x => x.id === id); if (e && e.active_loans) e.active_loans.forEach(k => renderReturnItem(l, e.name, k.loan_id, k.qty, k.borrower)) }); if (!l.innerHTML) return alert("ç„¡å€Ÿå‡ºç´€éŒ„"), closeModal('batch-return-modal') }
        function renderReturnItem(c, n, lid, max, b) { c.innerHTML += `<div class="flex items-center justify-between bg-gray-700 p-3 rounded border border-gray-600"><div class="flex items-center gap-3"><input type="checkbox" class="return-checkbox w-5 h-5" checked data-loan-id="${lid}"><div class="text-sm"><div class="text-white font-bold">${n}</div><div class="text-gray-300 text-xs">ğŸ‘¤ ${b} (å€Ÿ: ${max})</div></div></div><div class="flex items-center gap-2"><label class="text-xs text-gray-400">æ­¸é‚„:</label><input type="number" class="return-qty-input w-16 bg-gray-800 text-white p-1 rounded border border-gray-500 text-center" value="${max}" min="1" max="${max}" data-loan-id="${lid}"></div></div>` }
        async function submitBatchReturn() { const r = []; document.querySelectorAll('.return-checkbox:checked').forEach(c => { const lid = c.dataset.loanId, qty = document.querySelector(`.return-qty-input[data-loan-id="${lid}"]`).value; if (qty > 0) r.push({ action: 'return_equipment', userId, displayName, loanId: lid, returnQty: qty }) }); if (r.length === 0) return; toggleLoader(true); closeModal('batch-return-modal'); try { await Promise.all(r.map(x => callGasApi(x))); alert("æˆåŠŸ"); selectedItems.clear(); if (isExportMode) toggleExportMode(); fetchEquipmentData(false) } catch (e) { alert(e.message) } finally { toggleLoader(false) } }
        function toggleExportMode() { isExportMode = !isExportMode; document.getElementById('export-toolbar').classList.toggle('hidden'); document.getElementById('btn-export-mode').innerText = isExportMode ? "âŒ å–æ¶ˆ" : "ğŸ“Š åŒ¯å‡º"; renderEquipmentList() }
        function toggleSelect(id) { if (selectedItems.has(id)) selectedItems.delete(id); else selectedItems.add(id); document.getElementById('export-count').innerText = selectedItems.size }
        function toggleSelectAll() { const i = Array.from(document.querySelectorAll('#equipment-list input[type="checkbox"]')).map(c => c.getAttribute('onchange').match(/'([^']+)'/)[1]); if (i.every(x => selectedItems.has(x))) i.forEach(x => selectedItems.delete(x)); else i.forEach(x => selectedItems.add(x)); renderEquipmentList(); document.getElementById('export-count').innerText = selectedItems.size }
        async function confirmExport() { if (selectedItems.size === 0) return alert("è«‹é¸æ“‡"); toggleLoader(true); try { const r = await callGasApi({ action: 'export_equipment_report', userId, eqIds: Array.from(selectedItems) }); if (r.url) window.open(r.url); else alert("å¤±æ•—") } catch (e) { alert(e.message) } finally { toggleLoader(false) } }
        function openEditModal(m, id) { document.getElementById('edit-eq-modal').classList.add('flex'); document.getElementById('edit-mode').value = m; let e = (m === 'update' && id) ? (equipmentCache.find(x => x.id === id) || {}) : {}; document.getElementById('edit-modal-title').innerText = m === 'create' ? "â• æ–°å¢" : "âš™ï¸ ç·¨è¼¯"; document.getElementById('edit-eq-id').value = id || ""; document.getElementById('eq-name').value = e.name || ""; document.getElementById('eq-category').value = e.category || ""; document.getElementById('eq-model').value = e.model || ""; document.getElementById('eq-location').value = e.location || ""; document.getElementById('eq-total').value = e.total_qty || 1; document.getElementById('btn-delete-eq').className = m === 'create' ? 'hidden' : 'bg-red-600 text-white px-3 py-2 rounded font-bold' }
        async function submitEquipmentEdit() { const p = { action: 'manage_equipment', userId, displayName, mode: document.getElementById('edit-mode').value, eqId: document.getElementById('edit-eq-id').value, name: document.getElementById('eq-name').value, category: document.getElementById('eq-category').value, model: document.getElementById('eq-model').value, location: document.getElementById('eq-location').value, totalQty: document.getElementById('eq-total').value }; if (!p.name) return alert("åç¨±å¿…å¡«"); toggleLoader(true); closeModal('edit-eq-modal'); await callGasApi(p); fetchEquipmentData(false); toggleLoader(false) }
        async function deleteEquipment() { if (confirm("ç¢ºå®šåˆªé™¤?")) { toggleLoader(true); closeModal('edit-eq-modal'); await callGasApi({ action: 'manage_equipment', userId, displayName, mode: 'delete', eqId: document.getElementById('edit-eq-id').value }); fetchEquipmentData(false); toggleLoader(false) } }
        async function fetchHistory() { document.getElementById('history-modal').classList.add('flex'); document.getElementById('history-list').innerHTML = '<div class="loader"></div>'; const d = await callGasApi({ action: 'get_loan_history', userId }); document.getElementById('history-list').innerHTML = d.map(l => `<div class="bg-gray-700 p-3 mb-2 rounded border-l-4 ${l.status === 'å·²æ­¸é‚„' ? 'border-green-500' : 'border-blue-500'} text-sm"><div class="flex justify-between font-bold"><span>${l.item_name}</span><span>${l.borrower}</span></div><div class="flex justify-between text-xs mt-1"><span>${l.status} x${l.qty}</span><span>${l.time}</span></div></div>`).join('') || "ç„¡ç´€éŒ„" }
        async function fetchItemHistory(id) { document.getElementById('history-modal').classList.add('flex'); document.getElementById('history-list').innerHTML = '<div class="loader"></div>'; const d = await callGasApi({ action: 'get_loan_history', userId, eqId: id }); document.getElementById('history-list').innerHTML = d.map(l => `<div class="bg-gray-700 p-3 mb-2 rounded border-l-4 ${l.status === 'å·²æ­¸é‚„' ? 'border-green-500' : 'border-blue-500'} text-sm"><div class="flex justify-between font-bold"><span>${l.status}</span><span>${l.borrower}</span></div><div class="flex justify-between text-xs mt-1"><span>æ•¸é‡: ${l.qty}</span><span>${l.time}</span></div></div>`).join('') || "ç„¡ç´€éŒ„" }
        function showAiPage() { document.getElementById('view-ai').classList.remove('hidden') }
        async function askAI(m) { const q = document.getElementById('ai-input').value; if (!q) return alert("è«‹è¼¸å…¥"); toggleLoader(true); try { const r = await callGasApi({ action: m === 'ppt' ? 'make_briefing_ppt' : 'ask_ai', userId, question: q, query: q }); document.getElementById('ai-response').classList.remove('hidden'); document.getElementById('ai-response').innerHTML = m === 'ppt' ? `<a href="${r.url}" target="_blank" class="btn block text-center bg-green-600 p-2 rounded">ä¸‹è¼‰ç°¡å ±</a>` : r.answer } catch (e) { alert(e.message) } finally { toggleLoader(false) } }
        async function safeExecute(b, f) { b.disabled = true; await f(); b.disabled = false }
        function toggleLoader(s, t = "è™•ç†ä¸­...") { const e = document.getElementById('boar-overlay'), x = document.getElementById('boar-text'); if (s) { e.classList.remove('hidden'); x.innerText = t; let i = 0; if (loaderInterval) clearInterval(loaderInterval); loaderInterval = setInterval(() => { document.getElementById('boar-anim').innerText = ['ğŸ—ğŸ’¨', 'ğŸ—ğŸ“¦', 'ğŸ—ğŸ“', 'ğŸ—âœ…'][i++ % 4] }, 500) } else { e.classList.add('hidden'); if (loaderInterval) clearInterval(loaderInterval) } }
        async function callGasApi(p) { const r = await fetch(GAS_API_URL, { method: "POST", body: JSON.stringify({ ...p, source: 'liff' }) }); return await r.json() }
        function closeModal(id) { document.getElementById(id).classList.remove('flex'); document.getElementById(id).classList.add('hidden') }

        main();
    </script>
</body>

</html>
