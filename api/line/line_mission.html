<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èŠ±è“®ç‰¹æœæˆ°æƒ…ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* =========================================
           1. å…¨å±€ä½ˆå±€ (é‡å°æ‰‹æ©Ÿå„ªåŒ– - Sticky Layout)
           ========================================= */
        body { 
            background-color: #1a1a1a; 
            color: #e0e0e0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            /* é—œéµï¼šè®“ body è®Šæˆä¸€å€‹æ»¿å±çš„ç›’å­ï¼Œç¦æ­¢å¤–å±¤æ²å‹• */
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column;
            margin: 0;
            padding: 0; /* ç§»é™¤ body paddingï¼Œæ”¹åœ¨å…§å®¹å€è¨­å®š */
        }

        /* é ‚éƒ¨å›ºå®šå€ (Header + ç¯©é¸å™¨) */
        #top-fixed-area {
            flex-shrink: 0; /* é˜²æ­¢è¢«å£“ç¸® */
            background-color: #1a1a1a;
            z-index: 20;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); /* åº•éƒ¨é™°å½± */
            padding-bottom: 8px;
        }

        /* å…§å®¹æ²å‹•å€ (åªæœ‰é€™è£¡å¯ä»¥æ»‘å‹•) */
        #content-area {
            flex-grow: 1; /* ä½”æ»¿å‰©é¤˜ç©ºé–“ */
            overflow-y: auto; /* å‚ç›´æ²å‹• */
            padding: 16px; /* åŸæœ¬ body çš„ p-4 ç§»åˆ°é€™è£¡ */
            padding-bottom: 120px; /* é ç•™çµ¦åº•éƒ¨å·¥å…·åˆ—çš„ç©ºé–“ */
            scroll-behavior: smooth;
        }

        /* =========================================
           2. æ–°ç‰ˆè† å›Šç¯©é¸å™¨ (Chip/Pill Styles)
           ========================================= */
        /* æ©«å‘æ»‘å‹•å®¹å™¨ */
        .filter-row {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 4px 16px;
            white-space: nowrap;
            -ms-overflow-style: none;
            scrollbar-width: none;
            /* ğŸ”¥ æ–°å¢é€™è¡Œï¼šè®“æ¸¸æ¨™è®Šæˆå¯ä»¥æŠ“å–çš„å°æ‰‹ */
            cursor: grab;
        }
        /* ğŸ”¥ æ–°å¢é€™å€‹æ¨£å¼ï¼šæŒ‰ä¸‹å»çš„æ™‚å€™è®Šæˆã€Œç·Šæ¡ã€çš„å°æ‰‹ */
        .filter-row:active {
            cursor: grabbing;
        }
        .filter-row::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        /* è† å›ŠæŒ‰éˆ•æœ¬é«” */
        .btn-chip {
            background-color: #333;
            color: #aaa;
            padding: 6px 14px;
            border-radius: 9999px; /* åœ“å½¢è† å›Š */
            font-size: 13px;
            font-weight: 500;
            border: 1px solid #444;
            transition: all 0.2s;
            flex-shrink: 0; /* é˜²æ­¢è¢«æ“ å£“ */
        }
        
        /* é¸ä¸­ç‹€æ…‹ */
        .btn-chip.active {
            background-color: #ca8a04; /* é»ƒè‰² */
            color: white;
            border-color: #ca8a04;
            box-shadow: 0 0 8px rgba(202, 138, 4, 0.4);
        }

        /* =========================================
           3. å…±ç”¨å…ƒä»¶ (Legacy Components)
           ========================================= */
        .card { 
            background-color: #2d2d2d; 
            border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 12px; 
            border-left: 5px solid #4CAF50; 
        }

        /* æŒ‰éˆ•é€šç”¨æ¨£å¼ */
        .btn { 
            width: 100%; 
            padding: 12px; 
            border-radius: 8px; 
            font-weight: bold; 
            margin-top: 8px; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        .btn:active { transform: scale(0.98); }
        .btn-green { background-color: #4CAF50; color: white; border: none; }
        .btn-red { background-color: #f44336; color: white; border: none; }
        .btn-blue { background-color: #2196F3; color: white; border: none; }
        
        /* èˆŠç‰ˆç¯©é¸æŒ‰éˆ• (è‹¥é‚„æœ‰ç”¨åˆ°çš„è©±) */
        .btn-filter { transition: all 0.2s; }
        .btn-filter.active { background-color: #ca8a04; color: white; }

        /* è¼¸å…¥æ¡†å„ªåŒ– */
        .input-dark { 
            width: 100%; 
            background-color: #374151; 
            color: white; 
            padding: 10px 14px; 
            border-radius: 20px; /* è®Šåœ“ä¸€é»æ¯”è¼ƒå¥½çœ‹ */
            border: 1px solid #4b5563; 
            outline: none; 
            font-size: 14px;
        }
        .input-dark:focus { border-color: #f59e0b; background-color: #4b5563; }

        /* å·¥å…·é¡ */
        .hidden { display: none !important; }
        .loader { border: 4px solid #333; border-top: 4px solid #4CAF50; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* =========================================
           4. ä»»å‹™çœ‹æ¿å°ˆç”¨ (Mission Board)
           ========================================= */
        .mission-detail { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.3s ease-out; 
            background-color: #333; 
            border-radius: 0 0 12px 12px; 
        }
        .mission-detail.open { 
            max-height: 800px; 
            border-top: 1px solid #444; 
        }
        .line-clamp-3 { 
            display: -webkit-box; 
            -webkit-line-clamp: 3; 
            line-clamp: 3; 
            -webkit-box-orient: vertical; 
            overflow: hidden; 
        }

        /* =========================================
           5. æ²è»¸èˆ‡å½ˆçª— (Modals & Scrollbars)
           ========================================= */
        /* è‡ªå®šç¾©æ²è»¸ */
        .custom-scrollbar::-webkit-scrollbar { height: 4px; width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #555; border-radius: 2px; }
        
        /* å½ˆçª—èƒŒæ™¯ */
        .modal-overlay { 
            position: fixed; 
            inset: 0; 
            background-color: rgba(0,0,0,0.9); 
            display: none; 
            align-items: center; 
            justify-content: center; 
            z-index: 50; 
            padding: 1rem; 
        }
        .modal-overlay.flex { display: flex !important; }
        
        /* æ‰¹æ¬¡æ“ä½œè¡¨æ ¼ */
        .batch-table th { 
            position: sticky; 
            top: 0; 
            background: #374151; 
            color: #ddd; 
            padding: 8px; 
            text-align: left; 
        }
        .batch-table td { 
            border-bottom: 1px solid #4b5563; 
            padding: 8px; 
            color: #eee; 
        }

        /* =========================================
           6. å±±è±¬ç‰¹æœå‹•ç•« (Loading Animation)
           ========================================= */
        #boar-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.9); 
            z-index: 9999; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
        }
        .boar-scene { 
            font-size: 60px; 
            margin-bottom: 20px; 
            animation: bounce 1s infinite alternate; 
        }
        .boar-text { 
            color: #4CAF50; 
            font-weight: bold; 
            font-size: 1.2rem; 
            animation: pulse 1.5s infinite; 
        }
        @keyframes bounce { 0% { transform: translateY(0); } 100% { transform: translateY(-10px); } }
    </style>
</head>
<body class="p-4">

    <div id="boar-overlay" class="hidden"><div id="boar-anim" class="boar-scene">ğŸ—</div><p id="boar-text" class="boar-text">è³‡æ–™è™•ç†ä¸­...</p></div>
    <div id="header" class="mb-3 text-center">
        <h1 class="text-xl font-bold text-green-400 mb-1">ğŸš’ èŠ±è“®ç‰¹æœè¡Œå‹•ç³»çµ±</h1>
        
        <div class="relative flex justify-center items-center h-6">
            <p id="user-info" class="text-sm text-gray-400">è­˜åˆ¥ä¸­...</p>
            
            <select id="custodian-filter" onchange="switchCustodian(this.value)" class="absolute right-0 bg-gray-800 text-indigo-300 text-xs py-1 px-1 rounded border border-indigo-700 outline-none max-w-[100px]">
                <option value="All">æ‰€æœ‰ğŸ›¡ï¸</option>
            </select>
        </div>
    </div>
    
    <div id="loader" class="loader"></div>
    
    <div id="view-report" class="hidden"><h2 class="text-lg font-bold mb-2">ğŸ“ æ‚¨çš„ä»»å‹™å›å ±</h2><div id="report-list"></div></div>
    <div id="view-query" class="hidden"><h2 class="text-lg font-bold mb-2">ğŸ” é€²è¡Œä¸­ä»»å‹™çœ‹æ¿</h2><div id="query-list"></div></div>
    
    <div id="view-ai" class="hidden">
        <h2 class="text-lg font-bold mb-2">ğŸ¤– AI æˆ°æƒ…/ç°¡å ±ä¸­å¿ƒ</h2>
        <div class="bg-gray-800 p-3 rounded mb-3 border border-gray-700">
            <p class="text-sm text-gray-400 mb-1">è«‹è¼¸å…¥ç›®æ¨™</p><input type="text" id="ai-input" class="input-dark" placeholder="ä¾‹å¦‚: åœŸè€³å…¶...">
        </div>
        <div class="flex gap-2 mb-3"><button onclick="safeExecute(this, () => askAI('text'))" class="btn btn-blue flex-1">ğŸ’¬ åˆ†æ</button><button onclick="safeExecute(this, () => askAI('ppt'))" class="btn btn-red flex-1">ğŸ“Š ç°¡å ±</button></div>
        <a href="https://drive.google.com/drive/folders/1XAtHLGeo2fQH3wO5Lfq5_IjunbkIqzn_" target="_blank" class="btn block text-center mb-4" style="background-color: #FF9800; color: white;">ğŸ“‚ é–‹å•Ÿæ­¸æª”</a>
        <div id="ai-response" class="mt-4 p-4 bg-gray-800 rounded border-l-4 border-green-500 hidden"></div>
    </div>
    
    <div id="view-equipment" class="hidden h-full flex flex-col">
        
        <div id="top-fixed-area" class="pb-1 bg-gray-900 border-b border-gray-800">
            
            <div class="flex justify-between items-center px-4 py-2">
                <div class="flex items-center gap-2">
                    <h2 class="text-base font-bold text-yellow-400">ğŸ’ è£å‚™</h2>
                    <button onclick="toggleFilterPanel()" id="btn-toggle-filter" class="text-xs bg-gray-800 text-gray-400 border border-gray-600 px-2 py-1 rounded flex items-center gap-1 transition-colors">
                        <span>ğŸ”</span> ç¯©é¸
                    </button>
                </div>
                
                <div class="flex gap-2">
                    <select id="status-filter" onchange="renderEquipmentList()" class="bg-gray-800 text-gray-300 text-xs py-1 px-1 rounded border border-gray-700 outline-none max-w-[80px]">
                        <option value="All">å…¨éƒ¨</option>
                        <option value="Borrowed">å€Ÿå‡º</option>
                        <option value="InStock">åœ¨éšŠ</option>
                        <option value="Repair">ç¶­ä¿®ä¸­</option>
                    </select>

                    <button onclick="fetchHistory()" class="text-xs text-blue-400 border border-blue-400 px-2 py-1 rounded">ğŸ“œ</button>
                    
                    <button onclick="fetchEquipmentData(true)" class="text-xs text-green-400 border border-green-400 px-2 py-1 rounded">ğŸ”„</button>
                    
                </div>
            </div>

            <div id="collapsible-filters" class="transition-all duration-300 overflow-hidden" style="max-height: 0px; opacity: 0;">
                <div class="px-4 pb-2">
                    <input type="text" id="eq-search" oninput="renderEquipmentList()" class="input-dark w-full text-xs" placeholder="ğŸ” æœå°‹è£å‚™åç¨±ã€å‹è™Ÿ...">
                </div>
                
                <div id="category-filter-container" class="filter-row"></div>
                
                <div id="subcategory-filter-container" class="filter-row hidden"></div> 
                
                <div id="location-filter-container" class="filter-row hidden"></div>
                
                <div id="note-filter-container" class="filter-row hidden"></div>
                <div class="h-2"></div> 
            </div>
        </div>

        <div id="content-area">
            <div class="flex gap-2 mb-2">
                <button onclick="toggleExportMode()" id="btn-export-mode" class="flex-1 bg-purple-600/90 text-white py-2 rounded-lg font-bold text-sm shadow transition-all hover:bg-purple-600 flex items-center justify-center gap-1">
                    <span>ğŸ“Š</span> æ‰¹é‡/åŒ¯å‡º
                </button>
                
                <button id="btn-add-eq" onclick="openEditModal('create')" class="hidden w-1/4 bg-yellow-600 text-white border border-yellow-500 py-2 rounded-lg font-bold text-sm shadow hover:bg-yellow-500 transition-all whitespace-nowrap">
                    +æ–°å¢
                </button>
            </div>

            <div id="equipment-list" class="space-y-2 pb-20"></div>
        </div>
        
        <div id="export-toolbar" class="hidden fixed bottom-4 left-4 right-4 bg-gray-900 border border-purple-500 p-3 rounded-lg shadow-2xl z-40 flex flex-col gap-3">
            <div class="flex justify-between items-center border-b border-gray-700 pb-2"><div class="text-white text-sm">å·²é¸ <span id="export-count" class="text-yellow-400 font-bold text-lg">0</span> é …</div><button id="btn-select-all" onclick="toggleSelectAll()" class="bg-gray-700 text-white px-3 py-1 rounded text-xs">å…¨é¸</button></div>
            <div class="flex gap-2">
                <button id="btn-batch-borrow" onclick="openBatchBorrowModal()" class="hidden flex-1 bg-blue-600 text-white py-2 rounded font-bold text-sm shadow">æ‰¹é‡å€Ÿå‡º</button>
                <button id="btn-batch-return" onclick="openBatchReturnModal()" class="hidden flex-1 bg-green-600 text-white py-2 rounded font-bold text-sm shadow">æ‰¹é‡æ­¸é‚„</button>
                <button onclick="confirmExport()" class="flex-1 bg-purple-600 text-white py-2 rounded font-bold text-sm shadow">åŒ¯å‡º</button>
            </div>
        </div>
    </div>

    <div id="batch-borrow-modal" class="modal-overlay"><div class="bg-gray-800 p-5 rounded-lg w-full max-w-md border border-blue-500 flex flex-col max-h-[90vh]">
        <h3 class="text-xl font-bold mb-4 text-blue-400">ğŸ“¦ å€Ÿå‡ºè£å‚™</h3>
        <div class="mb-3"><label class="block text-gray-400 text-sm mb-1">å€Ÿç”¨äºº (å¿…å¡«)</label><input type="text" id="batch-borrower" class="input-dark"></div>
        <div class="mb-3"><label class="block text-gray-400 text-sm mb-1">å‚™è¨»</label><input type="text" id="batch-note" list="note-suggestions" class="input-dark"></div>
        <div class="flex-1 overflow-y-auto custom-scrollbar mb-4 border-t border-b border-gray-700 py-2 bg-gray-900 px-2"><table class="w-full text-sm text-left text-gray-400 batch-table"><thead><tr><th class="w-1/2">è£å‚™</th><th class="text-center">åº«å­˜</th><th class="w-20 text-center">æ•¸é‡</th></tr></thead><tbody id="batch-borrow-list"></tbody></table></div>
        <div class="flex gap-2"><button onclick="closeModal('batch-borrow-modal')" class="flex-1 bg-gray-600 text-white py-2 rounded">å–æ¶ˆ</button><button onclick="submitBatchBorrow()" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold">ç¢ºèª</button></div>
    </div></div>

    <div id="batch-return-modal" class="modal-overlay"><div class="bg-gray-800 p-5 rounded-lg w-full max-w-md border border-green-500 flex flex-col max-h-[90vh]">
        <h3 class="text-xl font-bold mb-2 text-green-400">â™»ï¸ æ­¸é‚„è£å‚™</h3>
        <p class="text-xs text-gray-400 mb-4">è«‹å‹¾é¸ä¸¦ç¢ºèªæ­¸é‚„æ•¸é‡ã€‚</p>
        <div class="flex-1 overflow-y-auto custom-scrollbar mb-4 bg-gray-900 rounded p-2"><div id="batch-return-list" class="space-y-3"></div></div>
        <div class="flex gap-2"><button onclick="closeModal('batch-return-modal')" class="flex-1 bg-gray-600 text-white py-2 rounded">å–æ¶ˆ</button><button onclick="submitBatchReturn()" class="flex-1 bg-green-600 text-white py-2 rounded font-bold">ç¢ºèª</button></div>
    </div></div>

    <div id="edit-eq-modal" class="modal-overlay">
        <div class="bg-gray-800 p-5 rounded-lg w-full max-w-md border border-yellow-600 flex flex-col max-h-[90vh]">
            <h3 id="edit-modal-title" class="text-xl font-bold mb-4 text-yellow-400">æ–°å¢</h3>
            <input type="hidden" id="edit-eq-id"><input type="hidden" id="edit-mode">
            
            <div class="space-y-3 mb-4">
                <input type="text" id="eq-name" class="input-dark" placeholder="åç¨± (ä¾‹å¦‚: ä¸»ç¹©)">
                
                <div class="flex gap-2">
                    <div class="flex-1">
                        <input type="text" id="eq-category" list="category-options" class="input-dark" placeholder="åˆ†é¡">
                        <datalist id="category-options"></datalist>
                    </div>
                    <div class="flex-1">
                        <input type="text" id="eq-sub-category" list="subcategory-options" class="input-dark" placeholder="ç´°é …">
                        <datalist id="subcategory-options"></datalist>
                    </div>
                </div>
                
                <input type="text" id="eq-model" class="input-dark" placeholder="å‹è™Ÿ/è¦æ ¼">
                
                <div class="flex gap-2">
                    <div class="flex-1">
                        <input type="text" id="eq-location" list="location-options" class="input-dark" placeholder="å­˜æ”¾ä½ç½®">
                        <datalist id="location-options"></datalist>
                    </div>
                    <div class="flex-1">
                        <input type="text" id="eq-custodian" list="custodian-options" class="input-dark" placeholder="ğŸ›¡ï¸ ä¿ç®¡äºº (é¸å¡«)">
                        <datalist id="custodian-options"></datalist> </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <label class="text-gray-400 w-20">ç¸½é‡:</label>
                    <input type="number" id="eq-total" class="input-dark flex-1" value="1" min="1">
                </div>
            </div>

            <div id="batch-add-area" class="hidden flex-1 flex flex-col min-h-0 border-t border-gray-700 pt-2">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs text-gray-400">å¾…æ–°å¢æ¸…å–®</span>
                    <button onclick="addToPreBatch()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold">â¬‡ï¸ åŠ å…¥æš«å­˜</button>
                </div>
                <div class="flex-1 overflow-y-auto overflow-x-auto custom-scrollbar bg-gray-900 rounded p-2">
                    <table class="w-full text-left batch-table whitespace-nowrap">
                        <thead>
                            <tr>
                                <th>åç¨±</th>
                                <th>ç´°é …</th> 
                                <th>è¦æ ¼</th> <th>ä½ç½®</th>
                                <th>ä¿ç®¡äºº</th> 
                                <th>é‡</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="pre-batch-list"></tbody>
                    </table>
                </div>
            </div>

            <div class="flex gap-2 mt-4 pt-2 border-t border-gray-700">
                <button id="btn-delete-eq" onclick="deleteEquipment()" class="hidden bg-red-600 text-white px-3 py-2 rounded font-bold">ğŸ—‘ï¸</button>
                <button onclick="closeModal('edit-eq-modal')" class="flex-1 bg-gray-600 text-white py-2 rounded">å–æ¶ˆ</button>
                
                <button id="btn-save-edit" onclick="submitEquipmentEdit()" class="flex-1 bg-yellow-600 text-white py-2 rounded font-bold">å„²å­˜ä¿®æ”¹</button>
                
                <button id="btn-submit-batch" onclick="submitBatchAdd()" class="hidden flex-1 bg-green-600 text-white py-2 rounded font-bold">âœ… ç¢ºèªæ‰¹é‡é€å‡º</button>
            </div>
        </div>
    </div>

    <div id="repair-modal" class="modal-overlay">
        <div class="bg-gray-800 p-5 rounded-lg w-full max-w-md border border-orange-500 flex flex-col">
            <h3 class="text-xl font-bold mb-4 text-orange-400">ğŸ”§ è£å‚™å ±ä¿®</h3>
            <input type="hidden" id="repair-eq-id">
            <div class="mb-3">
                <label class="block text-gray-400 text-sm mb-1">ç¶“æ‰‹äºº / è² è²¬äºº</label>
                <input type="text" id="repair-user" class="input-dark" readonly>
            </div>
            <div class="mb-3">
                <label class="block text-gray-400 text-sm mb-1">ç¶­ä¿®åŸå›  (å¿…å¡«)</label>
                <input type="text" id="repair-reason" class="input-dark" placeholder="ä¾‹å¦‚: è¢å¹•ç ´è£‚...">
            </div>
            <div class="mb-4">
                <label class="block text-gray-400 text-sm mb-1">æ•¸é‡</label>
                <input type="number" id="repair-qty" class="input-dark text-center" value="1" min="1">
            </div>
            <div class="flex gap-2">
                <button onclick="closeModal('repair-modal')" class="flex-1 bg-gray-600 text-white py-2 rounded">å–æ¶ˆ</button>
                <button onclick="submitRepair()" class="flex-1 bg-orange-600 text-white py-2 rounded font-bold">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <div id="history-modal" class="modal-overlay"><div class="bg-gray-800 p-4 rounded-lg w-full max-w-md border border-blue-500 h-4/5 flex flex-col"><div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2"><h3 class="text-xl font-bold text-blue-400">ğŸ“œ æ­·å²ç´€éŒ„</h3><button onclick="closeModal('history-modal')" class="text-2xl text-gray-400">&times;</button></div><div id="history-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-2"></div></div></div>
    <datalist id="note-suggestions"><option value="é›ªè¨“"><option value="ç¹©ç´¢è¨“ç·´"><option value="å‹•å“¡è¨“ç·´"><option value="å±±åŸŸæœæ•‘"></datalist>

    <script>
        const GAS_API_URL = "https://line-bot-liff-lovat.vercel.app/api/webhook";
        let userId="", displayName="", equipmentCache=[], currentCategory='All', currentSubCategory='All', currentLocation='All', currentNote='All', currentCustodian='All', isExportMode=false, selectedItems=new Set(), loaderInterval;
        let isUserAdmin = false; // ğŸ”¥ [ä¿®æ­£] æ¬Šé™æ——æ¨™ (é è¨­ false)
        let pendingBatchItems = []; // æš«å­˜æ–°å¢çš„è£å‚™åˆ—è¡¨
        

        // --- å…¨åŸŸå·¥å…·å‡½æ•¸ (è®“ task.js ä¹Ÿèƒ½ç”¨) ---
        function toggleLoader(show, text="è™•ç†ä¸­...") {
            const el = document.getElementById('boar-overlay'), txt = document.getElementById('boar-text'), anim = document.getElementById('boar-anim');
            if(show) { el.classList.remove('hidden'); txt.innerText=text; const icons=['ğŸ—ğŸ’¨','ğŸ—ğŸ“¦','ğŸ—ğŸ“','ğŸ—âœ…']; let i=0; if(loaderInterval) clearInterval(loaderInterval); loaderInterval=setInterval(()=>{ anim.innerText=icons[i++%icons.length]; },500); }
            else { el.classList.add('hidden'); if(loaderInterval) clearInterval(loaderInterval); }
        }
        async function callGasApi(payload) {
            const res = await fetch(GAS_API_URL, { method:"POST", body:JSON.stringify({...payload, source:'liff'}) }); return await res.json();
        }
        function closeModal(id) { document.getElementById(id).classList.remove('flex'); document.getElementById(id).classList.add('hidden'); }
        async function safeExecute(btn, fn) { btn.disabled=true; await fn(); btn.disabled=false; }
    </script>

    <script src="mission_folder/task.js"></script>

    <script>
        
        // --- ä¸»ç¨‹å¼åˆå§‹åŒ– ---
        async function main() {
            try {
                await liff.init({ liffId: "2008804963-FBGT1ktJ" }); 
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                userId = profile.userId; displayName = profile.displayName;
                document.getElementById('user-info').innerText = `éšŠå“¡ï¼š${displayName}`;
                
                checkAdminRole(); // ğŸ”¥ [ä¿®æ­£] æª¢æŸ¥æ¬Šé™

                const path = new URLSearchParams(window.location.search).get('path');
                document.getElementById('loader').classList.add('hidden'); 
                
                if (path === 'report') showReportPage();
                else if (path === 'query') showQueryPage();
                else if (path === 'ai') showAiPage();
                else loadEquipment(); 
            } catch (err) { alert("LIFF éŒ¯èª¤: " + err); }
        }

        // ğŸ”¥ [ä¿®æ­£] æ¬Šé™æª¢æŸ¥å‡½æ•¸
        async function checkAdminRole() {
            try {
                const res = await callGasApi({ action: 'check_user_role', userId: userId });
                if (res && res.isAdmin) {
                    isUserAdmin = true; // æ¨™è¨˜ç‚ºç®¡ç†å“¡
                    
                    // è§£é–‹æŒ‰éˆ•å°å° (ç§»é™¤ hidden class)
                    document.getElementById('btn-add-eq').classList.remove('hidden');
                    document.getElementById('btn-batch-borrow').classList.remove('hidden');
                    document.getElementById('btn-batch-return').classList.remove('hidden');
                    
                    // å¦‚æœåˆ—è¡¨å·²ç¶“æ¸²æŸ“äº†ï¼Œè¦é‡åˆ·ä¸€æ¬¡è®“è£¡é¢çš„å°æŒ‰éˆ•å‡ºä¾†
                    if (!document.getElementById('view-equipment').classList.contains('hidden')) {
                        renderEquipmentList();
                    }
                }
            } catch (e) { console.error("æ¬Šé™æª¢æŸ¥å¤±æ•—", e); }
        }

        // ============================================
        // è£å‚™ç®¡ç† (æ‰¹æ¬¡æ•¸é‡) - ç•™åœ¨ä¸»æª”
        // ============================================
        function loadEquipment() {
            document.getElementById('view-equipment').classList.remove('hidden');
            if (equipmentCache.length === 0) fetchEquipmentData(true); else renderEquipmentList();
        }
        async function fetchEquipmentData(showLoading = false) {
            if (showLoading) toggleLoader(true, "ç›¤é»ä¸­...");
            try {
                const data = await callGasApi({ action: 'get_equipment_list', userId: userId, category: 'All' });
                equipmentCache = (data && data.length > 0) ? data : [];
                if(equipmentCache.length === 0) document.getElementById('equipment-list').innerHTML = "<p class='text-center text-gray-500'>æŸ¥ç„¡è£å‚™</p>";
                else { 
                    renderDatalists(); // ğŸ”¥ é€™è£¡æ”¹ç”¨æ–°çš„å‡½æ•¸
                    renderEquipmentList(); 
                }
            } catch (e) { alert(e.message); } finally { if (showLoading) toggleLoader(false); }
        }

        // ğŸ”¥ [æ–°å¢] åˆ‡æ›ä¿ç®¡äººéæ¿¾
        function switchCustodian(c) { 
            currentCustodian = c; 
            renderEquipmentList(); 
        }

        // ğŸ”¥ [ä¿®æ­£] çµ±ä¸€ç®¡ç†ä¸‹æ‹‰é¸å–® (å·²ç§»é™¤èˆŠçš„åˆ†é¡æ¸²æŸ“é‚è¼¯ï¼Œæ”¹å‘¼å«æ–°å‡½æ•¸)
        function renderDatalists() {
            const cats = new Set(equipmentCache.map(e => e.category));
            const subcats = new Set(equipmentCache.map(e => e.sub_category || ''));
            const locs = new Set(equipmentCache.map(e => e.location));
            const custodians = new Set(equipmentCache.map(e => e.custodian).filter(Boolean)); // ğŸ”¥ æŠ“å–æœ‰å€¼çš„ä¿ç®¡äºº
            
            const notes = new Set(['é›ªè¨“', 'ç¹©ç´¢è¨“ç·´', 'å‹•å“¡è¨“ç·´', 'å±±åŸŸæœæ•‘']);
            equipmentCache.forEach(e => e.active_loans?.forEach(l => {if(l.note) notes.add(l.note)}));

            // è™•ç†æš«å­˜å€è³‡æ–™
            pendingBatchItems.forEach(i => {
                if(i.category) cats.add(i.category);
                if(i.subCategory) subcats.add(i.subCategory);
                if(i.location) locs.add(i.location);
            });

            // âŒ [ç§»é™¤] é€™è£¡åŸæœ¬æœ‰ä¸€æ®µã€Œæ¸²æŸ“ä¸Šæ–¹åˆ†é¡æŒ‰éˆ•ã€çš„èˆŠç¨‹å¼ç¢¼ï¼ŒæŠŠå®ƒåˆªæ‰äº†ï¼
            // âŒ ä¸è¦å†æ‰‹å¯« innerHTML = html äº†

            // âœ… [æ–°å¢] ç›´æ¥å‘¼å«æˆ‘å€‘å¯«å¥½çš„æ¼‚äº® UI å‡½æ•¸
            renderCategoryUI(); 

            // æ¸²æŸ“ Datalist (è¼¸å…¥æ¡†çš„ä¸‹æ‹‰é¸å–®) - é€™é‚Šç¶­æŒåŸæ¨£
            document.getElementById('category-options').innerHTML = [...cats].map(c=>`<option value="${c}">`).join('');
            document.getElementById('subcategory-options').innerHTML = [...subcats].map(s=>`<option value="${s}">`).join('');
            document.getElementById('location-options').innerHTML = [...locs].sort().map(l=>`<option value="${l}">`).join('');
            document.getElementById('note-suggestions').innerHTML = [...notes].sort().map(n=>`<option value="${n}">`).join('');
            // å¡é€² Datalist
            document.getElementById('custodian-options').innerHTML = [...custodians].sort().map(c=>`<option value="${c}">`).join('');
            
            renderSubCategoryUI(); 
            renderLocationUI();    
            renderNoteUI();

            // ğŸ”¥ [æ–°å¢] æ¸²æŸ“é ‚éƒ¨ä¿ç®¡äººä¸‹æ‹‰é¸å–®
            const custodianSelect = document.getElementById('custodian-filter');
            let custHtml = `<option value="All">æ‰€æœ‰ğŸ›¡ï¸</option>`;
            Array.from(custodians).sort().forEach(c => custHtml += `<option value="${c}">${c}</option>`);
            custodianSelect.innerHTML = custHtml;
            if (currentCustodian) custodianSelect.value = currentCustodian; // ä¿æŒé¸æ“‡ç‹€æ…‹ä¸è·‘æ‰
        }

        // ğŸ”¥ [æ–°å¢] æ¸²æŸ“ç´°é …æŒ‰éˆ• (é€£å‹•é‚è¼¯: åªé¡¯ç¤ºè©²åˆ†é¡ä¸‹çš„ç´°é …)
        function renderSubCategoryUI() {
            const container = document.getElementById('subcategory-filter-container');
            const subcats = new Set();
            
            // é€£å‹•ï¼šåªæŠ“ç•¶å‰åˆ†é¡ä¸‹çš„ç´°é …
            const sourceData = currentCategory === 'All' ? equipmentCache : equipmentCache.filter(e => e.category === currentCategory);
            sourceData.forEach(e => { if(e.sub_category) subcats.add(e.sub_category); });

            if(subcats.size === 0) { container.classList.add('hidden'); return; }
            container.classList.remove('hidden');

            let html = `<button onclick="switchSubCategory('All')" class="btn-chip ${currentSubCategory==='All'?'active':''}">å…¨éƒ¨ç´°é …</button>`;
            Array.from(subcats).sort().forEach(sc => {
                html += `<button onclick="switchSubCategory('${sc}')" class="btn-chip ${currentSubCategory===sc?'active':''}">${sc}</button>`;
            });
            container.innerHTML = html;
        }
        // ğŸ”¥ [ä¿®æ”¹] æš«å­˜æ™‚åŠ å…¥ subCategory
        function addToPreBatch() {
            const name = document.getElementById('eq-name').value;
            const cat = document.getElementById('eq-category').value;
            const subcat = document.getElementById('eq-sub-category').value; // ğŸ”¥ è®€å–ç´°é …
            const model = document.getElementById('eq-model').value;
            const loc = document.getElementById('eq-location').value;
            const total = parseInt(document.getElementById('eq-total').value);
            const custodian = document.getElementById('eq-custodian').value; // ğŸ”¥ è®€å–

            if (!name || !cat) return alert("åç¨±å’Œåˆ†é¡å¿…å¡«ï¼");

            pendingBatchItems.push({ name, category: cat, subCategory: subcat, model, location: loc, custodian: custodian, totalQty: total }); // ğŸ”¥ å¡é€²å»
            
            document.getElementById('eq-name').value = "";
            document.getElementById('eq-model').value = "";
            document.getElementById('eq-custodian').value = ""; // ğŸ”¥ æ¸…ç©ºä¿ç®¡äººæ¬„ä½
            document.getElementById('eq-name').focus(); 

            renderPreBatchList();
            renderDatalists(); 
        }


        // ğŸ”¥ [ä¿®æ”¹] æ¸²æŸ“æš«å­˜è¡¨æ ¼ (å¤šä¸€æ¬„)
        function renderPreBatchList() {
            const tbody = document.getElementById('pre-batch-list');
            tbody.innerHTML = pendingBatchItems.map((item, index) => `
                <tr class="border-b border-gray-700">
                    <td class="pr-3">${item.name}</td>
                    <td class="pr-3 text-gray-400">${item.subCategory || '-'}</td> 
                    <td class="pr-3 text-gray-400">${item.model || '-'}</td> <td class="pr-3 text-gray-400">${item.location || '-'}</td>
                    <td class="pr-3 text-indigo-300">${item.custodian || '-'}</td>
                    <td class="pr-3 text-yellow-400 font-bold">${item.totalQty}</td>
                    <td class="text-right"><button onclick="removePreBatch(${index})" class="text-red-400 px-2 py-1">âœ•</button></td>
                </tr>
            `).join('');
        }

        function removePreBatch(index) {
            pendingBatchItems.splice(index, 1);
            renderPreBatchList();
        }

        // ğŸ”¥ [ä¿®æ”¹] æ‰¹é‡é€å‡º (åŠ å…¥åƒæ•¸)
        async function submitBatchAdd() {
            const name = document.getElementById('eq-name').value;
            if (pendingBatchItems.length === 0 && name) addToPreBatch(); 
            if (pendingBatchItems.length === 0) return alert("è«‹å…ˆåŠ å…¥è£å‚™åˆ°æ¸…å–®");

            toggleLoader(true, "æ‰¹é‡å»ºç«‹ä¸­...");
            try {
                const promises = pendingBatchItems.map(item => 
                    callGasApi({
                        action: 'manage_equipment',
                        userId, displayName,
                        mode: 'create',
                        p_eq_id: "", 
                        name: item.name,
                        category: item.category,
                        subCategory: item.subCategory, // ğŸ”¥
                        model: item.model,
                        location: item.location,
                        custodian: item.custodian, // ğŸ”¥
                        totalQty: item.totalQty
                    })
                );
                await Promise.all(promises);
                alert(`æˆåŠŸæ–°å¢ ${pendingBatchItems.length} ç­†è£å‚™ï¼`);
                closeModal('edit-eq-modal');
                fetchEquipmentData(false);
            } catch (e) {
                alert("æ–°å¢å¤±æ•—: " + e.message);
            } finally {
                toggleLoader(false);
            }
        }

        // ğŸ”¥ [ä¿®æ”¹] åˆ—è¡¨æ¸²æŸ“ (æ”¯æ´ç¶­ä¿®ç¯©é¸èˆ‡é¡¯ç¤º)
        function renderEquipmentList() {
            const listDiv = document.getElementById('equipment-list');
            const searchText = document.getElementById('eq-search').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value; // æŠ“å³ä¸Šè§’é¸å–®
            
            let filtered = equipmentCache.filter(eq => {
                const matchCat = currentCategory === 'All' || eq.category === currentCategory;
                const matchSubCat = currentSubCategory === 'All' || eq.sub_category === currentSubCategory;
                const matchLoc = currentLocation === 'All' || eq.location === currentLocation;
                const matchCustodian = currentCustodian === 'All' || eq.custodian === currentCustodian;
                // æœå°‹é‚è¼¯
                const matchSearch = (eq.name+eq.model+(eq.sub_category||'')).toLowerCase().includes(searchText) || 
                                    (eq.active_loans && eq.active_loans.some(l => l.borrower.toLowerCase().includes(searchText)));
                
                // --- ğŸ”¥ ç‹€æ…‹ç¯©é¸é‚è¼¯ (å³ä¸Šè§’ä¸‹æ‹‰é¸å–®) ---
                const isBorrowed = eq.available_qty < eq.total_qty;
                const hasRepair = eq.active_loans && eq.active_loans.some(l => l.note && l.note.startsWith('[ç¶­ä¿®]'));
                
                let matchStatus = true;
                if (statusFilter === 'Borrowed') matchStatus = isBorrowed;
                else if (statusFilter === 'InStock') matchStatus = !isBorrowed;
                else if (statusFilter === 'Repair') matchStatus = hasRepair; // ğŸ”¥ åªé¡¯ç¤ºæœ‰ç¶­ä¿®å–®çš„

                // --- ğŸ”¥ ç”¨é€”/å‚™è¨»ç¯©é¸é‚è¼¯ (ä¸‹æ–¹æŒ‰éˆ•) ---
                let matchNote = true;
                if (currentNote !== 'All') {
                    if (!eq.active_loans || eq.active_loans.length === 0) {
                        matchNote = false;
                    } else {
                        if (currentNote === 'ç¶­ä¿®ä¸­') {
                            // å¦‚æœæŒ‰éˆ•é¸ "ç¶­ä¿®ä¸­"ï¼Œåªè¦ note é–‹é ­æ˜¯ [ç¶­ä¿®] å°±ç®—ç¬¦åˆ
                            matchNote = eq.active_loans.some(l => l.note && l.note.startsWith('[ç¶­ä¿®]'));
                        } else if (currentNote === 'æœªåˆ†é¡') {
                            matchNote = eq.active_loans.some(l => !l.note || l.note.trim() === '');
                        } else {
                            matchNote = eq.active_loans.some(l => l.note === currentNote);
                        }
                    }
                }
                
                return matchCat && matchSubCat && matchLoc && matchSearch && matchStatus && matchNote && matchCustodian;
            });

            // æ’åºï¼šæœ‰ç¶­ä¿®çš„æ’å‰é¢ï¼Œæ–¹ä¾¿æŸ¥çœ‹
            filtered.sort((a, b) => {
                const aRepair = a.active_loans?.some(l => l.note?.startsWith('[ç¶­ä¿®]')) ? 1 : 0;
                const bRepair = b.active_loans?.some(l => l.note?.startsWith('[ç¶­ä¿®]')) ? 1 : 0;
                if (bRepair !== aRepair) return bRepair - aRepair; // ç¶­ä¿®å„ªå…ˆ
                return (a.available_qty < a.total_qty ? -1 : 1);
            });

            let html = '';
            filtered.forEach(eq => {
                const isFull = eq.available_qty === eq.total_qty;
                const isEmpty = eq.available_qty === 0;
                const statusBadge = isFull ? `<span class="text-green-400 font-bold text-sm">ğŸŸ¢ åœ¨éšŠ (${eq.available_qty})</span>` 
                    : (isEmpty ? `<span class="text-red-400 font-bold text-sm">ğŸ”´ å…¨éƒ¨å€Ÿå‡º</span>` 
                    : `<span class="text-blue-400 font-bold text-sm">ğŸ”µ éƒ¨åˆ†å€Ÿå‡º (${eq.available_qty}/${eq.total_qty})</span>`);

                let loansHtml = '';
                let toggleBtnHtml = ''; // ğŸ”¥ æ–°å¢ï¼šæ”¶åˆæŒ‰éˆ•
                if (eq.active_loans && eq.active_loans.length > 0) {
                    // ğŸ”¥ æ–°å¢æŒ‰éˆ• UI
                    toggleBtnHtml = `<button onclick="toggleLoanList('${eq.id}', this, ${eq.active_loans.length})" class="bg-gray-700 hover:bg-gray-600 text-blue-300 px-3 py-1 rounded text-xs font-bold">åå–® (${eq.active_loans.length})</button>`;
                    
                    // ğŸ”¥ åŠ ä¸Š id èˆ‡ hidden è®“å®ƒé è¨­éš±è—
                    loansHtml = `<div id="loan-list-${eq.id}" class="hidden mt-2 pt-2 border-t border-gray-600 space-y-1">`;
                    eq.active_loans.forEach(l => {
                        const returnBtn = isUserAdmin ? `<button onclick="openSingleReturnModal('${eq.id}', '${l.loan_id}', ${l.qty}, '${l.borrower}')" class="bg-green-700 text-white px-2 py-1 rounded text-[10px]">æ­¸é‚„</button>` : '';
                        
                        const isRepair = l.note && l.note.startsWith('[ç¶­ä¿®]');
                        let displayHtml = '';
                        
                        if (isRepair) {
                            const reason = l.note.replace('[ç¶­ä¿®]', '').trim();
                            displayHtml = `<span class="text-orange-400 font-bold">ğŸ”§ ç¶­ä¿®ä¸­</span> <span class="text-gray-400">(${l.borrower})</span> <span class="text-orange-300 text-xs">åŸå› : ${reason}</span>`;
                        } else {
                            displayHtml = `<span>ğŸ‘¤ ${l.borrower} <span class="text-yellow-400">x${l.qty}</span> <span class="text-blue-300">${l.note ? `#${l.note}` : ''}</span></span>`;
                        }
                        
                        loansHtml += `<div class="flex justify-between items-center text-xs text-gray-300">${displayHtml}${returnBtn}</div>`;
                    });
                    loansHtml += `</div>`;
                }
                
                const checked = selectedItems.has(eq.id) ? 'checked' : '';
                const checkHtml = isExportMode ? `<div class="mr-3 flex items-center"><input type="checkbox" onchange="toggleSelect('${eq.id}')" ${checked} class="w-6 h-6"></div>` : '';
                
                const repairBtn = (!isEmpty && isUserAdmin) ? `<button onclick="openRepairModal('${eq.id}', '${displayName}')" class="bg-orange-600 text-white px-3 py-1 rounded text-xs font-bold ml-2">å ±ä¿®</button>` : '';
                const borrowBtn = (!isEmpty && isUserAdmin) ? `<button onclick="openSingleBorrowModal('${eq.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold">å€Ÿå‡º</button>` : '';
                const editBtn = isUserAdmin ? `<button onclick="openEditModal('update', '${eq.id}')" class="text-gray-500 p-1">âš™ï¸</button>` : '';
                const subCatBadge = eq.sub_category ? `<span class="text-xs bg-gray-700 text-gray-300 px-2 py-0.5 rounded ml-2">${eq.sub_category}</span>` : '';
                // å¦‚æœæœ‰ä¿ç®¡äººï¼Œç”¢ç”Ÿå¾®å‹æ¨™ç±¤ï¼›å¦‚æœæ²’æœ‰ï¼Œå°±æ˜¯ç©ºå­—ä¸²
                const custodianBadge = eq.custodian ? `<span class="bg-indigo-900/50 text-indigo-300 px-1.5 py-0.5 rounded border border-indigo-700">ğŸ›¡ï¸ä¿ç®¡: ${eq.custodian}</span>` : '';

                // ğŸ”¥ å°‡ ${toggleBtnHtml} æ’å…¥åˆ° ${loansHtml} å‰é¢
                html += `<div class="flex items-start bg-gray-800 p-4 rounded-lg mb-3 border-l-4 ${isEmpty ? "border-red-500" : (isFull ? "border-green-500" : "border-blue-500")}">
                        ${checkHtml}<div class="flex-1"><div class="flex justify-between"><div>
                            <h3 class="font-bold text-white text-lg flex items-center flex-wrap gap-1">${eq.name} ${subCatBadge}</h3>
                            <div class="flex gap-2 text-xs text-gray-400 mt-1 flex-wrap"><span>${eq.model||'-'}</span><span>ğŸ“${eq.location||'-'}</span>${custodianBadge}</div>
                        </div><div class="flex gap-2"><button onclick="fetchItemHistory('${eq.id}')" class="text-blue-400 p-1">ğŸ“œ</button>${editBtn}</div></div>
                        <div class="flex justify-between items-end mt-3">${statusBadge}<div class="flex flex-col items-end gap-2"><div>${borrowBtn}${repairBtn}</div>${toggleBtnHtml}</div></div>${loansHtml}</div></div>`;
            });
            listDiv.innerHTML = html || "<p class='text-center text-gray-500'>ç„¡ç¬¦åˆè£å‚™</p>";
            updateExportCount();
        }

        // ğŸ”¥ [æ–°å¢] åˆ‡æ›é¡¯ç¤ºå€Ÿå‡ºåå–®
        function toggleLoanList(id, btn, count) {
            const list = document.getElementById(`loan-list-${id}`);
            if (list.classList.contains('hidden')) {
                // å±•é–‹
                list.classList.remove('hidden');
                btn.innerHTML = 'éš±è—';
                btn.classList.replace('text-blue-300', 'text-gray-400');
            } else {
                // æ”¶åˆ
                list.classList.add('hidden');
                btn.innerHTML = `åå–® (${count})`;
                btn.classList.replace('text-gray-400', 'text-blue-300');
            }
        }
        
        // å€Ÿå‡º (æ‰¹æ¬¡æ•¸é‡)
        function openSingleBorrowModal(id) { selectedItems.clear(); selectedItems.add(id); openBatchBorrowModal(); }
        function openBatchBorrowModal() {
            if (selectedItems.size === 0) { alert("è«‹å…ˆå‹¾é¸è£å‚™"); return; }
            document.getElementById('batch-borrow-modal').classList.add('flex');
            document.getElementById('batch-borrower').value = ""; document.getElementById('batch-note').value = "";
            const tbody = document.getElementById('batch-borrow-list'); tbody.innerHTML = "";
            selectedItems.forEach(id => {
                const eq = equipmentCache.find(e => e.id === id);
                if (eq && eq.available_qty > 0) {
                    tbody.innerHTML += `<tr class="border-b border-gray-700"><td class="px-2 py-2 text-white">${eq.name}</td><td class="text-center text-gray-400">${eq.available_qty}</td><td class="text-center"><input type="number" data-id="${eq.id}" class="borrow-qty-input w-16 bg-gray-700 text-white p-1 rounded border border-gray-600 text-center" value="1" min="1" max="${eq.available_qty}"></td></tr>`;
                }
            });
        }
        async function submitBatchBorrow() {
            const borrower = document.getElementById('batch-borrower').value;
            const note = document.getElementById('batch-note').value;
            if (!borrower) { alert("è«‹è¼¸å…¥å€Ÿç”¨äºº"); return; }
            const inputs = document.querySelectorAll('.borrow-qty-input');
            const requests = [];
            inputs.forEach(input => {
                const qty = parseInt(input.value);
                if (qty > 0) requests.push({ action: 'borrow_equipment', userId, displayName, eqId: input.dataset.id, borrower, qty, note });
            });
            if (requests.length === 0) return;
            toggleLoader(true); closeModal('batch-borrow-modal');
            try { await Promise.all(requests.map(req => callGasApi(req))); alert("å€Ÿå‡ºæˆåŠŸ"); selectedItems.clear(); if(isExportMode) toggleExportMode(); fetchEquipmentData(false); } catch (e) { alert(e.message); } finally { toggleLoader(false); }
        }

        // æ­¸é‚„ (æ‰¹æ¬¡æ•¸é‡)
        function openSingleReturnModal(eqId, loanId, qty, borrower) {
            document.getElementById('batch-return-modal').classList.add('flex');
            const listDiv = document.getElementById('batch-return-list'); listDiv.innerHTML = "";
            const eq = equipmentCache.find(e => e.id === eqId);
            renderReturnItem(listDiv, eq ? eq.name : 'è£å‚™', loanId, qty, borrower);
        }
        function openBatchReturnModal() {
            if (selectedItems.size === 0) { alert("è«‹å…ˆå‹¾é¸æ­¸é‚„è£å‚™"); return; }
            document.getElementById('batch-return-modal').classList.add('flex');
            const listDiv = document.getElementById('batch-return-list'); listDiv.innerHTML = "";
            let hasLoan = false;
            selectedItems.forEach(id => {
                const eq = equipmentCache.find(e => e.id === id);
                if (eq && eq.active_loans) eq.active_loans.forEach(l => { hasLoan=true; renderReturnItem(listDiv, eq.name, l.loan_id, l.qty, l.borrower); });
            });
            if (!hasLoan) { alert("ç„¡å€Ÿå‡ºç´€éŒ„"); closeModal('batch-return-modal'); }
        }
        function renderReturnItem(container, eqName, loanId, maxQty, borrower) {
            container.innerHTML += `<div class="flex items-center justify-between bg-gray-700 p-3 rounded border border-gray-600">
                <div class="flex items-center gap-3"><input type="checkbox" class="return-checkbox w-5 h-5" checked data-loan-id="${loanId}"><div class="text-sm"><div class="text-white font-bold">${eqName}</div><div class="text-gray-300 text-xs">ğŸ‘¤ ${borrower} (å€Ÿ: ${maxQty})</div></div></div>
                <div class="flex items-center gap-2"><label class="text-xs text-gray-400">æ­¸é‚„:</label><input type="number" class="return-qty-input w-16 bg-gray-800 text-white p-1 rounded border border-gray-500 text-center" value="${maxQty}" min="1" max="${maxQty}" data-loan-id="${loanId}"></div></div>`;
        }
        async function submitBatchReturn() {
            const checkboxes = document.querySelectorAll('.return-checkbox:checked');
            if (checkboxes.length === 0) return alert("è«‹å‹¾é¸");
            const requests = [];
            checkboxes.forEach(cb => {
                const loanId = cb.dataset.loanId;
                const qty = parseInt(document.querySelector(`.return-qty-input[data-loan-id="${loanId}"]`).value);
                if (qty > 0) requests.push({ action: 'return_equipment', userId, displayName, loanId, returnQty: qty });
            });
            toggleLoader(true); closeModal('batch-return-modal');
            try { await Promise.all(requests.map(req => callGasApi(req))); alert("æ­¸é‚„æˆåŠŸ"); selectedItems.clear(); if(isExportMode) toggleExportMode(); fetchEquipmentData(false); } catch (e) { alert(e.message); } finally { toggleLoader(false); }
        }

        // å…¶ä»–å·¥å…·
        function toggleExportMode() { isExportMode = !isExportMode; document.getElementById('export-toolbar').classList.toggle('hidden'); document.getElementById('btn-export-mode').innerText = isExportMode ? "âŒ å–æ¶ˆ" : "ğŸ“Š åŒ¯å‡º"; renderEquipmentList(); }
        function toggleSelect(id) { if (selectedItems.has(id)) selectedItems.delete(id); else selectedItems.add(id); updateExportCount(); }
        function toggleSelectAll() { const ids = Array.from(document.querySelectorAll('#equipment-list input[type="checkbox"]')).map(c => c.getAttribute('onchange').match(/'([^']+)'/)[1]); if (ids.every(id => selectedItems.has(id))) ids.forEach(id => selectedItems.delete(id)); else ids.forEach(id => selectedItems.add(id)); renderEquipmentList(); updateExportCount(); }
        function updateExportCount() { document.getElementById('export-count').innerText = selectedItems.size; }
        async function confirmExport() { if (selectedItems.size === 0) return alert("è«‹é¸æ“‡"); toggleLoader(true); try { const res = await callGasApi({ action: 'export_equipment_report', userId, eqIds: Array.from(selectedItems) }); if (res.url) window.open(res.url); else alert("å¤±æ•—"); } catch (e) { alert(e.message); } finally { toggleLoader(false); } }
        // ğŸ”¥ [ä¿®æ”¹] æ¸²æŸ“ä¸»åˆ†é¡æŒ‰éˆ• (å¼·åŒ–è¦–è¦ºæ¬Šé‡ï¼šé¦–è¦ç´¢å¼•)
        // ğŸ”¥ [ä¿®æ”¹] æ¸²æŸ“ä¸»åˆ†é¡æŒ‰éˆ• (å¼·åˆ¶é¡¯çœ¼ç‰ˆ)
        function renderCategoryUI() {
            const container = document.getElementById('category-filter-container');
            
            // ğŸ› å¦‚æœé€™è£¡å ±éŒ¯ï¼Œä»£è¡¨ HTML è£¡æ‰¾ä¸åˆ° id="category-filter-container"
            if (!container) {
                console.error("æ‰¾ä¸åˆ° category-filter-containerï¼Œè«‹æª¢æŸ¥ HTML id");
                return;
            }

            const categories = ['All', ...new Set(equipmentCache.map(e => e.category))];
            
            // ğŸ¨ å¼·åˆ¶é‡å¯«å®¹å™¨æ¨£å¼ (æš´åŠ›æ¸…é™¤èˆŠæ¨£å¼)
            // è®“å®ƒè®Šæˆä¸€å€‹æœ‰ã€Œé»ƒè‰²é‚Šæ¡†ã€å’Œã€Œæ·±é»‘èƒŒæ™¯ã€çš„ç¨ç«‹å€å¡Š
            container.className = ""; // æ¸…ç©ºåŸæœ¬çš„ class
            container.style.border = "3px solid #F59E0B"; // äº®æ©˜é»ƒè‰²é‚Šæ¡†
            container.style.backgroundColor = "#1F2937";   // æ·±ç°èƒŒæ™¯
            container.style.borderRadius = "12px";         // åœ“è§’
            container.style.padding = "15px";              // å…§è·
            container.style.marginBottom = "20px";         // ä¸‹æ–¹ç•™ç™½
            container.style.boxShadow = "0 4px 6px rgba(0,0,0,0.3)"; // é™°å½±

            // ğŸ·ï¸ æ¨™é¡Œå€ + æŒ‰éˆ•å€
            let html = `
                <div style="margin-bottom: 10px; color: #FBBF24; font-weight: bold; font-size: 1.1rem; border-bottom: 1px solid #4B5563; padding-bottom: 5px;">
                    âš¡ é¸æ“‡åˆ†é¡ <span style="font-size: 0.8rem; color: #9CA3AF; font-weight: normal;">(å¤§åˆ†é¡)</span>
                </div>
                <div class="flex gap-3 overflow-x-auto pb-2 custom-scrollbar">
            `;

            categories.forEach(cat => {
                const isActive = currentCategory === cat;
                
                // é¸ä¸­æ™‚ï¼šäº®é»ƒè‰²åº•ã€é»‘å­—ã€æ”¾å¤§
                // æœªé¸æ™‚ï¼šç°è‰²å¤–æ¡†ã€ç™½å­—
                const btnStyle = isActive 
                    ? "background-color: #F59E0B; color: black; font-weight: 800; border: 2px solid #F59E0B; transform: scale(1.05);"
                    : "background-color: transparent; color: white; border: 1px solid #6B7280;";

                const label = cat === 'All' ? 'å…¨éƒ¨é¡¯ç¤º' : cat;

                html += `<button onclick="switchCategory('${cat}')" 
                    style="padding: 8px 16px; border-radius: 9999px; white-space: nowrap; transition: all 0.2s; ${btnStyle}">
                    ${label}
                </button>`;
            });

            html += `</div>`;
            container.innerHTML = html;
        }
        // ğŸ”¥ [ä¿®æ”¹] æ¸²æŸ“ä½ç½®æŒ‰éˆ• (åŠ å…¥é€£å‹•é‚è¼¯)
        function renderLocationUI() {
            const container = document.getElementById('location-filter-container');
            const locs = new Set();
            
            let sourceData = currentCategory === 'All' ? equipmentCache : equipmentCache.filter(e => e.category === currentCategory);
            
            // ğŸ”¥ å†éæ¿¾ä¸€å±¤ç´°é …
            if (currentSubCategory !== 'All') {
                sourceData = sourceData.filter(e => e.sub_category === currentSubCategory);
            }

            sourceData.forEach(e => { if(e.location) locs.add(e.location); });
            
            if(locs.size === 0) { container.classList.add('hidden'); return; } 
            container.classList.remove('hidden');

            let html = `<button onclick="switchLocation('All')" class="btn-chip ${currentLocation==='All'?'active':''}">å…¨éƒ¨ä½ç½®</button>`;
            Array.from(locs).sort().forEach(loc => {
                html += `<button onclick="switchLocation('${loc}')" class="btn-chip ${currentLocation===loc?'active':''}">${loc}</button>`;
            });
            container.innerHTML = html;
        }

        // ğŸ”¥ [ä¿®æ­£] åˆ‡æ›ä½ç½®å‡½æ•¸
        function switchLocation(loc) { currentLocation = loc; renderLocationUI(); renderEquipmentList(); }

        // æ¸²æŸ“å‚™è¨»æŒ‰éˆ• (åŒ…å«è‡ªå‹•é‡ç½®é‚è¼¯)
        // ğŸ”¥ [ä¿®æ”¹] æ¸²æŸ“ç”¨é€”/å‚™è¨»æŒ‰éˆ• (è‡ªå‹•æ­¸ç´ç¶­ä¿®)
        function renderNoteUI() {
            const container = document.getElementById('note-filter-container');
            const notes = new Set();
            
            // éæ­·æ‰€æœ‰å€Ÿå‡ºä¸­çš„è£å‚™
            equipmentCache.forEach(e => {
                if (e.active_loans) {
                    e.active_loans.forEach(l => {
                        const note = l.note ? l.note.trim() : 'æœªåˆ†é¡';
                        if (note.startsWith('[ç¶­ä¿®]')) {
                            // ğŸ”¥ é—œéµé‚è¼¯ï¼šä¸ç®¡å¾Œé¢å¯«ä»€éº¼åŸå› ï¼Œçµ±ä¸€æ­¸é¡ç‚º "ç¶­ä¿®ä¸­"
                            notes.add('ç¶­ä¿®ä¸­');
                        } else {
                            notes.add(note);
                        }
                    });
                }
            });

            // å¦‚æœç›®å‰é¸çš„ note å·²ç¶“ä¸å­˜åœ¨æ–¼æ¸…å–®ä¸­ (ä¾‹å¦‚ä¿®å¥½äº†)ï¼Œé‡ç½®ç‚º All
            if (currentNote !== 'All' && !notes.has(currentNote)) {
                currentNote = 'All';
                renderEquipmentList();
            }

            if (notes.size === 0) { container.classList.add('hidden'); return; }
            container.classList.remove('hidden');

            let html = `<button onclick="switchNote('All')" class="btn-chip ${currentNote==='All'?'active':''}">å…¨éƒ¨ç”¨é€”</button>`;
            
            // æ’åºï¼šè®“ "ç¶­ä¿®ä¸­" æ’åœ¨å‰é¢æ¯”è¼ƒæ˜é¡¯
            const sortedNotes = Array.from(notes).sort((a, b) => {
                if (a === 'ç¶­ä¿®ä¸­') return -1;
                if (b === 'ç¶­ä¿®ä¸­') return 1;
                return a.localeCompare(b);
            });

            sortedNotes.forEach(n => {
                html += `<button onclick="switchNote('${n}')" class="btn-chip ${currentNote===n?'active':''}">${n}</button>`;
            });
            container.innerHTML = html;
        }

        // ğŸ”¥ åˆ‡æ›ç¯©é¸é¢æ¿å±•é–‹/æ”¶åˆ
        function toggleFilterPanel() {
            const panel = document.getElementById('collapsible-filters');
            const btn = document.getElementById('btn-toggle-filter');
            const icon = btn.querySelector('span');
            
            // åˆ¤æ–·ç›®å‰æ˜¯ç”¨ max-height æ§åˆ¶é‚„æ˜¯ class hidden
            // é€™è£¡æˆ‘å€‘ç”¨ style.maxHeight ä¾†åšå‹•ç•«æ•ˆæœ
            if (panel.style.maxHeight === '0px') {
                // å±•é–‹
                panel.style.maxHeight = '500px'; // è¶³å¤ å¤§çš„é«˜åº¦
                panel.style.opacity = '1';
                btn.innerHTML = '<span>â–¼</span> æ”¶åˆ';
                btn.classList.add('text-yellow-400', 'border-yellow-600');
                btn.classList.remove('text-gray-400', 'border-gray-600');
            } else {
                // æ”¶åˆ
                panel.style.maxHeight = '0px';
                panel.style.opacity = '0';
                btn.innerHTML = '<span>ğŸ”</span> ç¯©é¸'; // æ”¶èµ·ä¾†æ™‚è®Šæˆæœå°‹åœ–ç¤º
                btn.classList.remove('text-yellow-400', 'border-yellow-600');
                btn.classList.add('text-gray-400', 'border-gray-600');
            }
        }

        
        // ğŸ”¥ [ä¿®æ”¹] åˆ‡æ›åˆ†é¡ -> é‡ç½®ç´°é … -> é‡ç½®ä½ç½®
        function switchCategory(c) { 
            currentCategory = c; 
            currentSubCategory = 'All'; // é‡ç½®ç´°é …
            currentLocation = 'All';    // é‡ç½®ä½ç½®
            renderDatalists();          
            renderEquipmentList(); 
        }
        // ğŸ”¥ [æ–°å¢] åˆ‡æ›ç´°é … -> é‡ç½®ä½ç½®
        function switchSubCategory(sc) {
            currentSubCategory = sc;
            currentLocation = 'All';    // é‡ç½®ä½ç½®
            renderSubCategoryUI();      // ğŸ”¥ è£œä¸Šé€™è¡Œï¼šé‡æ–°ç¹ªè£½ç´°é …æŒ‰éˆ•ï¼ˆæ‰æœƒåé»ƒï¼‰
            renderLocationUI();         // æ›´æ–°ä½ç½®é¸å–®
            renderEquipmentList();
        }
        // åˆ‡æ›å‚™è¨»éæ¿¾
        function switchNote(n) { 
            currentNote = n; 
            renderNoteUI(); 
            renderEquipmentList(); 
            
            // ğŸ”¥ [ä¿®æ­£] é¸å®Œå¾Œè‡ªå‹•æ”¶åˆç¯©é¸é¢æ¿
            toggleFilterPanel(); 
        }
        // ğŸ”¥ [ä¿®æ”¹] åŠ å…¥ subCategory è™•ç†
        function openEditModal(mode, id) {
            document.getElementById('edit-eq-modal').classList.add('flex');
            document.getElementById('edit-mode').value = mode;
            document.getElementById('edit-eq-id').value = id || "";
            document.getElementById('eq-name').value = "";
            document.getElementById('eq-category').value = "";
            document.getElementById('eq-sub-category').value = ""; // ğŸ”¥ æ¸…ç©ºç´°é …
            document.getElementById('eq-model').value = "";
            document.getElementById('eq-location').value = "";
            document.getElementById('eq-total').value = 1;
            document.getElementById('eq-custodian').value = ""; // æ¸…ç©ºä¿ç®¡äººæ¬„ä½

            if (mode === 'update' && id) {
                const eq = equipmentCache.find(e => e.id === id) || {};
                document.getElementById('edit-modal-title').innerText = "âš™ï¸ ç·¨è¼¯è£å‚™";
                document.getElementById('eq-name').value = eq.name || "";
                document.getElementById('eq-category').value = eq.category || "";
                document.getElementById('eq-sub-category').value = eq.sub_category || ""; // ğŸ”¥ å¡«å…¥èˆŠç´°é …
                document.getElementById('eq-model').value = eq.model || "";
                document.getElementById('eq-location').value = eq.location || "";
                document.getElementById('eq-total').value = eq.total_qty || 1;
                document.getElementById('eq-custodian').value = eq.custodian || ""; // å¡«å…¥èˆŠè³‡æ–™

                
                document.getElementById('btn-delete-eq').classList.remove('hidden');
                document.getElementById('btn-save-edit').classList.remove('hidden');
                document.getElementById('btn-submit-batch').classList.add('hidden');
                document.getElementById('batch-add-area').classList.add('hidden');
            } else {
                document.getElementById('edit-modal-title').innerText = "â• æ‰¹é‡æ–°å¢è£å‚™";
                pendingBatchItems = []; 
                renderPreBatchList();
                document.getElementById('btn-delete-eq').classList.add('hidden');
                document.getElementById('btn-save-edit').classList.add('hidden');
                document.getElementById('btn-submit-batch').classList.remove('hidden');
                document.getElementById('batch-add-area').classList.remove('hidden');
            }
        }
                
        // ğŸ”¥ [ä¿®æ”¹] ç·¨è¼¯é€å‡º (åŠ å…¥åƒæ•¸)
        async function submitEquipmentEdit() {
            const p = { 
                action: 'manage_equipment', userId, displayName, 
                mode: document.getElementById('edit-mode').value, 
                eqId: document.getElementById('edit-eq-id').value, 
                name: document.getElementById('eq-name').value, 
                category: document.getElementById('eq-category').value, 
                subCategory: document.getElementById('eq-sub-category').value, // ğŸ”¥
                model: document.getElementById('eq-model').value, 
                location: document.getElementById('eq-location').value, 
                custodian: document.getElementById('eq-custodian').value, // ğŸ”¥ åŠ å…¥é€™è¡Œ
                totalQty: document.getElementById('eq-total').value 
            };
            if(!p.name) return alert("åç¨±å¿…å¡«"); 
            toggleLoader(true); 
            closeModal('edit-eq-modal'); 
            await callGasApi(p); 
            fetchEquipmentData(false); 
            toggleLoader(false);
        }
        async function deleteEquipment() { if(confirm("ç¢ºå®šåˆªé™¤?")) { toggleLoader(true); closeModal('edit-eq-modal'); await callGasApi({action:'manage_equipment', userId, displayName, mode:'delete', eqId:document.getElementById('edit-eq-id').value}); fetchEquipmentData(false); toggleLoader(false); } }
        async function fetchHistory(){
            document.getElementById('history-modal').classList.add('flex');
            document.getElementById('history-list').innerHTML='<div class="loader"></div>';
            try {
                const d = await callGasApi({action:'get_loan_history', userId});
                document.getElementById('history-list').innerHTML = (d && d.length > 0) 
                    ? d.map(l => renderHistoryCard(l)).join('') 
                    : "<div class='text-center text-gray-500 mt-4'>ç„¡æ­·å²ç´€éŒ„</div>";
            } catch(e) {
                document.getElementById('history-list').innerHTML = `<p class="text-red-400 text-center">è¼‰å…¥å¤±æ•—: ${e.message}</p>`;
            }
        }
        async function fetchItemHistory(id){
            document.getElementById('history-modal').classList.add('flex');
            document.getElementById('history-list').innerHTML='<div class="loader"></div>';
            try {
                const d = await callGasApi({action:'get_loan_history', userId, eqId:id});
                document.getElementById('history-list').innerHTML = (d && d.length > 0) 
                    ? d.map(l => renderHistoryCard(l)).join('') 
                    : "<div class='text-center text-gray-500 mt-4'>æ­¤è£å‚™ç„¡å€Ÿå‡ºç´€éŒ„</div>";
            } catch(e) {
                document.getElementById('history-list').innerHTML = `<p class="text-red-400 text-center">è¼‰å…¥å¤±æ•—: ${e.message}</p>`;
            }
        }
        // ğŸ”¥ [æ–°å¢] æ­·å²å¡ç‰‡æ¸²æŸ“å™¨ (å…±ç”¨é‚è¼¯)
        function renderHistoryCard(l) {
            // åˆ¤æ–·æ˜¯å¦ç‚ºç¶­ä¿®å–®
            const isRepair = l.note && l.note.startsWith('[ç¶­ä¿®]');
            const repairReason = isRepair ? l.note.replace('[ç¶­ä¿®]', '').trim() : '';

            // æ±ºå®šé¡¯ç¤ºçš„ç‹€æ…‹æ–‡å­—èˆ‡é¡è‰²
            let statusText = l.status;
            let statusClass = 'border-blue-500'; // é è¨­å€Ÿå‡ºæ˜¯è—è‰²
            let icon = 'ğŸ‘¤';

            if (isRepair) {
                // ç¶­ä¿®é‚è¼¯
                if (l.status === 'å€Ÿå‡ºä¸­') {
                    statusText = 'ğŸ”§ ç¶­ä¿®ä¸­';
                    statusClass = 'border-orange-500'; // ç¶­ä¿®æ˜¯æ©˜è‰²
                    icon = '';
                } else {
                    statusText = 'âœ… ç¶­ä¿®å®Œæˆ'; // æ­¸é‚„è®Šæˆç¶­ä¿®å®Œæˆ
                    statusClass = 'border-green-500';
                    icon = '';
                }
            } else {
                // ä¸€èˆ¬å€Ÿé‚„é‚è¼¯
                if (l.status === 'å·²æ­¸é‚„') {
                    statusClass = 'border-green-500';
                    icon = 'â™»ï¸';
                }
            }

            // é¡¯ç¤ºè£å‚™åç¨± (å¦‚æœæ˜¯å–®é …æŸ¥è©¢ï¼Œå¯èƒ½æœƒæƒ³éš±è—åç¨±ï¼Œä½†çµ±ä¸€é¡¯ç¤ºä¹Ÿç„¡å¦¨)
            const nameHtml = l.item_name ? `<div class="font-bold text-base mb-1">${l.item_name}</div>` : '';
            // å¦‚æœæ˜¯ç¶­ä¿®ï¼Œé¡¯ç¤ºåŸå› ï¼›ä¸€èˆ¬å€Ÿå‡ºé¡¯ç¤ºå‚™è¨»
            const subInfo = isRepair 
                ? `<div class="text-xs text-orange-300 mt-1">åŸå› : ${repairReason}</div>`
                : (l.note ? `<div class="text-xs text-gray-400 mt-1">å‚™è¨»: ${l.note}</div>` : '');

            return `
                <div class="bg-gray-700 p-3 mb-2 rounded border-l-4 ${statusClass} text-sm">
                    ${nameHtml}
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-gray-200">${icon} ${l.borrower}</span>
                        <span class="text-xs text-gray-400">${l.time}</span>
                    </div>
                    <div class="flex justify-between items-center mt-1">
                        <span class="font-bold ${isRepair && l.status==='å€Ÿå‡ºä¸­' ? 'text-orange-400' : 'text-gray-300'}">${statusText}</span>
                        <span class="bg-gray-800 px-2 py-0.5 rounded text-xs">æ•¸é‡: ${l.qty}</span>
                    </div>
                    ${subInfo}
                </div>`;
        }
        // AI
        function showAiPage() { document.getElementById('view-ai').classList.remove('hidden'); }
        async function askAI(mode) { 
            const q = document.getElementById('ai-input').value; if(!q) return alert("è«‹è¼¸å…¥"); toggleLoader(true);
            try { const r = await callGasApi({action:mode==='ppt'?'make_briefing_ppt':'ask_ai', userId, question:q, query:q});
            document.getElementById('ai-response').classList.remove('hidden');
            document.getElementById('ai-response').innerHTML = mode==='ppt'?`<a href="${r.url}" target="_blank" class="btn block text-center bg-green-600 p-2 rounded">ä¸‹è¼‰ç°¡å ±</a>`:r.answer; } catch(e){alert(e.message)} finally{toggleLoader(false)}
        }
        async function safeExecute(btn, fn) { btn.disabled=true; await fn(); btn.disabled=false; }

        // æ–°å¢ç¶­ä¿®ç›¸é—œåŠŸèƒ½
        function openRepairModal(id, currentUser) {
            const eq = equipmentCache.find(e => e.id === id);
            if (!eq) return;
            document.getElementById('repair-modal').classList.add('flex');
            document.getElementById('repair-eq-id').value = id;
            document.getElementById('repair-user').value = currentUser;
            document.getElementById('repair-reason').value = "";
            document.getElementById('repair-qty').value = 1;
            document.getElementById('repair-qty').max = eq.available_qty;
        }

        async function submitRepair() {
            const id = document.getElementById('repair-eq-id').value;
            const user = document.getElementById('repair-user').value;
            const reason = document.getElementById('repair-reason').value;
            const qty = document.getElementById('repair-qty').value;
            if (!reason) return alert("è«‹è¼¸å…¥ç¶­ä¿®åŸå› ");
            toggleLoader(true);
            closeModal('repair-modal');
            try {
                // è‡ªå‹•åŠ ä¸Š [ç¶­ä¿®] æ¨™ç±¤
                await callGasApi({
                    action: 'borrow_equipment', userId, displayName,
                    eqId: id, borrower: user, qty: qty, note: `[ç¶­ä¿®] ${reason}`
                });
                alert("å ±ä¿®æˆåŠŸ");
                fetchEquipmentData(false);
            } catch (e) { alert(e.message); } finally { toggleLoader(false); }
        }


        // ğŸ”¥ [æ–°å¢] æ»‘é¼ æ‹–æ›³æ²å‹•åŠŸèƒ½ (Drag to Scroll)
        const sliders = document.querySelectorAll('.filter-row');
        sliders.forEach(slider => {
            let isDown = false;
            let startX;
            let scrollLeft;

            slider.addEventListener('mousedown', (e) => {
                isDown = true;
                slider.classList.add('active');
                startX = e.pageX - slider.offsetLeft;
                scrollLeft = slider.scrollLeft;
            });

            slider.addEventListener('mouseleave', () => {
                isDown = false;
                slider.classList.remove('active');
            });

            slider.addEventListener('mouseup', () => {
                isDown = false;
                slider.classList.remove('active');
            });

            slider.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault(); // é˜²æ­¢é¸å–æ–‡å­—
                const x = e.pageX - slider.offsetLeft;
                const walk = (x - startX) * 2; // *2 æ˜¯æ»‘å‹•é€Ÿåº¦å€ç‡ï¼Œæ•¸å­—è¶Šå¤§æ»‘è¶Šå¿«
                slider.scrollLeft = scrollLeft - walk;
            });
        });
        
        main();
    </script>
</body>
</html>
