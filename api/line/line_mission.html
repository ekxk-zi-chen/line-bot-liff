<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠ±è“®ç‰¹æœæˆ°æƒ…ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #1a1a1a; color: #e0e0e0; font-family: sans-serif; }
        .card { background-color: #2d2d2d; border-radius: 12px; padding: 16px; margin-bottom: 12px; border-left: 5px solid #4CAF50; }
        .btn { width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; margin-top: 8px; cursor: pointer; }
        .btn-green { background-color: #4CAF50; color: white; border: none; }
        .btn-red { background-color: #f44336; color: white; border: none; }
        .btn-blue { background-color: #2196F3; color: white; border: none; }
        .loader { border: 4px solid #333; border-top: 4px solid #4CAF50; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none; }
        /* éª¨æ¶å±å‘¼å¸å‹•ç•« */
        .skeleton-pulse {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        /* æ¨¡æ“¬æ–‡å­—æ¢ */
        .skeleton-text {
            height: 16px;
            background-color: #4a4a4a;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .skeleton-title {
            height: 24px;
            width: 60%;
            background-color: #5a5a5a;
            border-radius: 4px;
            margin-bottom: 12px;
        }
        /* --- 1. å±±è±¬ç‰¹æœè¼‰å…¥å‹•ç•« --- */
        #boar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(26, 26, 26, 0.95); /* æ·±è‰²åŠé€æ˜èƒŒæ™¯ */
            z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .boar-scene {
            font-size: 80px; /* èª¿æ•´å¤§å° */
            margin-bottom: 20px;
            animation: bounce 1s infinite alternate;
        }
        .boar-text {
            color: #4CAF50; font-weight: bold; font-size: 1.2rem;
            animation: pulse 1.5s infinite;
        }
        @keyframes bounce {
            0% { transform: translateY(0); }
            100% { transform: translateY(-10px); }
        }

        /* --- 2. æŒ‰éˆ•é–å®šç‹€æ…‹ --- */
        .btn:disabled {
            opacity: 0.6; cursor: not-allowed; filter: grayscale(80%);
        }

        /* --- 3. ä»»å‹™çœ‹æ¿å±•é–‹ç´°ç¯€ (Accordion) --- */
        .mission-detail {
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;
            background-color: #333; border-radius: 0 0 12px 12px;
        }
        .mission-detail.open {
            max-height: 500px; /* è¶³å¤ é¡¯ç¤ºå…§å®¹çš„é«˜åº¦ */
            border-top: 1px solid #444;
        }
        .detail-row {
            padding: 8px 16px; font-size: 0.9rem; color: #ccc; border-bottom: 1px solid #444;
            display: flex; align-items: center; gap: 8px;
        }
        .detail-row:last-child { border-bottom: none; }
        .badge {
            padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; color: white;
        }
        .bg-blue { background-color: #2196F3; }
        .bg-orange { background-color: #FF9800; }
    </style>
</head>
<body class="p-4">

    <div id="boar-overlay" class="hidden">
        <div id="boar-anim" class="boar-scene">ğŸ—</div> 
        <p id="boar-text" class="boar-text">æœæ•‘è³‡æ–™åˆ†æä¸­...</p>
    </div>

    <div id="header" class="mb-4 text-center">
        <h1 class="text-xl font-bold text-green-400">ğŸš’ èŠ±è“®ç‰¹æœè¡Œå‹•ç³»çµ±</h1>
        <p id="user-info" class="text-sm text-gray-400">è­˜åˆ¥ä¸­...</p>
    </div>

    <div id="loader" class="loader"></div>

    <div id="view-report" class="hidden">
        <h2 class="text-lg font-bold mb-2">ğŸ“ æ‚¨çš„ä»»å‹™å›å ±</h2>
        <div id="report-list"></div>
    </div>

    <div id="view-query" class="hidden">
        <h2 class="text-lg font-bold mb-2">ğŸ” é€²è¡Œä¸­ä»»å‹™çœ‹æ¿</h2>
        <div id="query-list"></div>
    </div>

    <div id="view-ai" class="hidden">
        <h2 class="text-lg font-bold mb-2">ğŸ¤– AI æˆ°æƒ…/ç°¡å ±ä¸­å¿ƒ</h2>
        
        <div class="bg-gray-800 p-3 rounded mb-3 border border-gray-700">
            <p class="text-sm text-gray-400 mb-1">è«‹è¼¸å…¥ç›®æ¨™ (æ”¯æ´ GPS: 24.12, 121.55)</p>
            <input type="text" id="ai-input" class="w-full p-2 bg-gray-700 rounded text-white border border-gray-600 focus:border-green-500 outline-none" placeholder="ä¾‹å¦‚: åœŸè€³å…¶ã€èŠ±è“®ç§€æ—é„‰...">
        </div>

        <div class="flex gap-2 mb-3">
            <button onclick="safeExecute(this, () => askAI('text'))" class="btn btn-blue flex-1">ğŸ’¬ æ–‡å­—åˆ†æ</button>
            <button onclick="safeExecute(this, () => askAI('ppt'))" class="btn btn-red flex-1">ğŸ“Š ç”Ÿæˆç°¡å ±</button>
        </div>

        <a href="https://drive.google.com/drive/folders/1XAtHLGeo2fQH3wO5Lfq5_IjunbkIqzn_" target="_blank" class="btn block text-center mb-4" style="background-color: #FF9800; text-decoration: none; color: white;">
            ğŸ“‚ é–‹å•Ÿã€Œæ­·å²æƒ…è³‡æ­¸æª”ã€è³‡æ–™å¤¾
        </a>

        <div id="ai-response" class="mt-4 p-4 bg-gray-800 rounded border-l-4 border-green-500 hidden"></div>
    </div>

    <script>
        const GAS_API_URL = "https://line-bot-liff-lovat.vercel.app/api/webhook";

        let userId = "";
        let displayName = "";

        // --- åŠŸèƒ½ 1: å±±è±¬ç‰¹æœå‹•ç•«æ§åˆ¶ ---
        let loaderInterval;
        function toggleLoader(show, text = "è³‡æ–™è™•ç†ä¸­...") {
            const overlay = document.getElementById('boar-overlay');
            const anim = document.getElementById('boar-anim');
            const textDiv = document.getElementById('boar-text');
            
            if (show) {
                overlay.classList.remove('hidden');
                textDiv.innerText = text;
                
                // å®šç¾©å±±è±¬çš„å‹•ä½œ (ä½ å¯ä»¥æŠŠ emoji æ›æˆåœ–ç‰‡ URL)
                // ç¯„ä¾‹ï¼š['<img src="run.gif">', '<img src="map.gif">', ...]
                const actions = ['ğŸ— ğŸ”', 'ğŸ— ğŸ—ºï¸', 'ğŸ— ğŸš‘', 'ğŸ— ğŸ“¡']; 
                let idx = 0;
                
                // æ¸…é™¤èˆŠçš„å‹•ç•«ä»¥é˜²é‡ç–Š
                if (loaderInterval) clearInterval(loaderInterval);
                
                // å•Ÿå‹•å¾ªç’°å‹•ç•«
                loaderInterval = setInterval(() => {
                    anim.innerHTML = actions[idx];
                    idx = (idx + 1) % actions.length;
                }, 800); // æ¯ 0.8 ç§’æ›ä¸€å€‹å‹•ä½œ
            } else {
                overlay.classList.add('hidden');
                if (loaderInterval) clearInterval(loaderInterval);
            }
        }
        // --- å·¥å…·ï¼šé¡¯ç¤ºéª¨æ¶å± (å‡è£è¼‰å…¥ä¸­) ---
        function showSkeleton(containerId, count = 3) {
            const container = document.getElementById(containerId);
            let html = '';
            
            // éš¨æ©Ÿç”¢ç”Ÿå¹¾å¥ã€Œç‰¹æœæ„Ÿã€çš„è¼‰å…¥æ–‡å­—
            const loadingTexts = [
                "æ­£åœ¨å»ºç«‹åŠ å¯†é€£ç·š...",
                "åŒæ­¥ Supabase è³‡æ–™åº«...",
                "æ­£åœ¨è§£å¯†ä»»å‹™æª”æ¡ˆ...",
                "è¡›æ˜Ÿè¨Šè™Ÿæ ¡æ­£ä¸­..."
            ];
            const randomText = loadingTexts[Math.floor(Math.random() * loadingTexts.length)];

            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹æ–‡å­—
            html += `<p class="text-center text-xs text-green-400 mb-4 animate-pulse">${randomText}</p>`;

            // ç”Ÿæˆå‡å¡ç‰‡
            for (let i = 0; i < count; i++) {
                html += `
                    <div class="card skeleton-pulse" style="border-left-color: #555;">
                        <div class="skeleton-title"></div>
                        <div class="skeleton-text" style="width: 80%;"></div>
                        <div class="skeleton-text" style="width: 40%;"></div>
                        <div class="flex gap-2 mt-4">
                            <div class="skeleton-text" style="height: 40px; width: 100%; border-radius: 8px;"></div>
                            <div class="skeleton-text" style="height: 40px; width: 100%; border-radius: 8px;"></div>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }
        // åˆå§‹åŒ– LIFF
        async function main() {
            try {
                // è¨˜å¾—å¡«å…¥ LIFF ID
                await liff.init({ liffId: "2008804963-FBGT1ktJ" }); 
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                userId = profile.userId;
                displayName = profile.displayName;
                document.getElementById('user-info').innerText = `éšŠå“¡ï¼š${displayName}`;

                // æ ¹æ“š URL åƒæ•¸åˆ¤æ–·è¦é¡¯ç¤ºå“ªä¸€é 
                const urlParams = new URLSearchParams(window.location.search);
                const path = urlParams.get('path'); // æœƒæŠ“åˆ° 'report', 'query', æˆ– 'ai'

                document.getElementById('loader').classList.add('hidden');

                if (path === 'report') {
                    showReportPage();
                } else if (path === 'query') {
                    showQueryPage();
                } else if (path === 'ai') {
                    showAiPage();
                } else {
                    // é è¨­é¡¯ç¤ºæŸ¥è©¢
                    showQueryPage();
                }

            } catch (err) {
                alert("LIFF åˆå§‹åŒ–å¤±æ•—: " + err);
            }
        }

        // --- é é¢ 1: ä»»å‹™å›å ± ---
        async function showReportPage() {
            document.getElementById('view-report').classList.remove('hidden');
            
            // ğŸ”¥ ä¿®æ”¹é€™è£¡ï¼šç”¨éª¨æ¶å±å–ä»£è½‰åœˆåœˆ
            showSkeleton('report-list', 3);

            const data = await callGasApi({ action: 'get_my_assignments', userId: userId });
            const listDiv = document.getElementById('report-list');
            listDiv.innerHTML = "";

            if (!data || data.length === 0) {
                listDiv.innerHTML = "<p class='text-center text-gray-500'>ğŸ’¤ ç›®å‰æ²’æœ‰æŒ‡æ´¾çµ¦æ‚¨çš„ä»»å‹™</p>";
                return;
            }

            data.forEach(task => {
                const div = document.createElement('div');
                div.className = "card";
                div.innerHTML = `
                    <h3 class="font-bold text-lg">${task.mission_title}</h3>
                    <p class="text-sm text-gray-300 mb-2">æ¢¯æ¬¡: ${task.batch_no} | ${task.assignment_note || ''}</p>
                    <input type="text" id="note-${task.assignment_id}" class="w-full p-2 bg-gray-700 rounded text-white mb-2" placeholder="è¼¸å…¥å›å ±å…§å®¹ (ä¾‹å¦‚: æŠµé”)">
                    <div class="flex gap-2">
                        <button onclick="submitReport(${task.assignment_id}, '${task.mission_id}', false)" class="btn btn-blue flex-1">åƒ…å›å ±</button>
                        <button onclick="submitReport(${task.assignment_id}, '${task.mission_id}', true)" class="btn btn-green flex-1">ä»»å‹™å®Œæˆ</button>
                    </div>
                `;
                listDiv.appendChild(div);
            });
        }

        async function submitReport(assignmentId, missionId, isFinished) {
            const note = document.getElementById(`note-${assignmentId}`).value;
            if (!note && !isFinished) { alert("è«‹è¼¸å…¥å›å ±å…§å®¹"); return; }

            const confirmMsg = isFinished ? "ç¢ºå®šè¦å›å ±ã€Œä»»å‹™å®Œæˆã€å—ï¼Ÿ" : "ç¢ºå®šè¦é€å‡ºå›å ±å—ï¼Ÿ";
            if (!confirm(confirmMsg)) return;

            // é¡¯ç¤º Loading
            liff.sendMessages([{ type: 'text', text: isFinished ? 'ä»»å‹™å®Œæˆå›å ±ä¸­...' : 'é€²åº¦å›å ±ä¸­...' }]);
            
            await callGasApi({
                action: 'submit_report',
                userId: userId,
                assignmentId: assignmentId,
                missionId: missionId,
                isFinished: isFinished,
                note: note || (isFinished ? "ä»»å‹™å®Œæˆ" : "")
            });

            alert("âœ… å›å ±æˆåŠŸï¼");
            liff.closeWindow(); // é—œé–‰è¦–çª—
        }

        // --- é é¢ 2: ä»»å‹™æŸ¥è©¢ ---
        // --- åŠŸèƒ½ 3: äº’å‹•å¼ä»»å‹™çœ‹æ¿ ---
        async function showQueryPage() {
            document.getElementById('view-query').classList.remove('hidden');
            // ä½¿ç”¨éª¨æ¶å± (æ²¿ç”¨ä¹‹å‰çš„)
            showSkeleton('query-list', 4);

            const data = await callGasApi({ action: 'get_public_missions', userId: userId });
            const listDiv = document.getElementById('query-list');
            listDiv.innerHTML = "";

            if (!data || data.length === 0) {
                listDiv.innerHTML = "<p class='text-center text-gray-500'>ğŸ“­ ç›®å‰ç„¡é€²è¡Œä¸­ä»»å‹™</p>";
                return;
            }

            data.forEach(task => {
                // å‡è¨­ task çµæ§‹åŒ…å«: title, start_time, batch (æ¢¯æ¬¡), reporter (å›å ±äºº), details
                // å¦‚æœå¾Œç«¯é‚„æ²’çµ¦é€™éº¼å¤šï¼Œæœƒé¡¯ç¤º 'ç„¡è³‡æ–™'
                
                const cardId = `mission-${Math.random().toString(36).substr(2, 9)}`;
                const div = document.createElement('div');
                div.className = "card";
                div.style.borderLeftColor = "#2196F3"; // è—è‰²ä»£è¡¨æŸ¥è©¢
                div.style.cursor = "pointer";
                
                // å¡ç‰‡ HTML çµæ§‹
                div.innerHTML = `
                    <div onclick="toggleDetail('${cardId}')" class="flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-lg">${task.title}</h3>
                            <p class="text-sm text-gray-400">ğŸ•’ ${task.start_time.split('T')[0]}</p>
                        </div>
                        <div class="text-2xl text-gray-500 transition-transform duration-300" id="icon-${cardId}">â–¼</div>
                    </div>
                    
                    <div id="${cardId}" class="mission-detail mt-2">
                        <div class="detail-row">
                            <span>ğŸ“… å•Ÿå‹•æ™‚é–“:</span>
                            <span>${task.start_time.replace('T', ' ').substring(0, 16)}</span>
                        </div>
                        <div class="detail-row">
                            <span>ğŸ”¢ æ¢¯æ¬¡:</span>
                            <span class="badge bg-orange">${task.batch_no || 'ç¬¬1æ¢¯æ¬¡'}</span>
                        </div>
                        <div class="detail-row">
                            <span>ğŸ‘¤ æŒ‡æ®å®˜/å›å ±äºº:</span>
                            <span>${task.reporter || task.commander || 'æœªæ¨™è¨»'}</span>
                        </div>
                        <div class="detail-row">
                            <span>ğŸ“ ä»»å‹™æ‘˜è¦:</span>
                            <span>${task.description || task.note || 'å°šç„¡è©³ç´°æè¿°'}</span>
                        </div>
                        <div class="p-2">
                            <button class="btn btn-blue btn-sm" onclick="alert('é–‹å•Ÿåœ°åœ–åŠŸèƒ½é–‹ç™¼ä¸­...')">ğŸ—ºï¸ æŸ¥çœ‹ä»»å‹™åœ°åœ–</button>
                        </div>
                    </div>
                `;
                listDiv.appendChild(div);
            });
        }
                
        // åˆ‡æ›å±•é–‹/æ”¶åˆçš„å°å·¥å…·
        function toggleDetail(id) {
            const el = document.getElementById(id);
            const icon = document.getElementById(`icon-${id}`);
            
            if (el.classList.contains('open')) {
                el.classList.remove('open');
                icon.style.transform = "rotate(0deg)";
            } else {
                // é—œé–‰å…¶ä»–å·²å±•é–‹çš„ (å¦‚æœæƒ³è¦ä¸€æ¬¡åªé–‹ä¸€å€‹)
                document.querySelectorAll('.mission-detail.open').forEach(d => {
                    d.classList.remove('open');
                    // é€™è£¡æ‡¶å¾—æŠ“ icon å¾©åŸï¼Œç°¡å–®åš
                });
                
                el.classList.add('open');
                icon.style.transform = "rotate(180deg)";
            }
        }
        // --- é é¢ 3: AI æˆ°æƒ…å®¤ ---
        function showAiPage() {
            document.getElementById('view-ai').classList.remove('hidden');
        }

        // --- æ ¸å¿ƒæ”¹å‹•ï¼šAI è«‹æ±‚å‡½å¼ ---
        async function askAI(mode) {
            const input = document.getElementById('ai-input');
            const responseDiv = document.getElementById('ai-response');
            const query = input.value.trim();

            if (!query) { alert("è«‹è¼¸å…¥å…§å®¹ï¼"); return; }

            // å•Ÿå‹•å±±è±¬å‹•ç•«
            toggleLoader(true, mode === 'ppt' ? "æ­£åœ¨èª¿é–±åœ–è³‡èˆ‡ç”Ÿæˆç°¡å ±..." : "æˆ°æƒ…å®˜åˆ†æä¸­...");
            
            try {
                const action = mode === 'ppt' ? 'make_briefing_ppt' : 'ask_ai';
                const data = await callGasApi({ 
                    action: action, 
                    userId: userId, 
                    question: query, 
                    query: query 
                });
                
                // é—œé–‰å‹•ç•«
                toggleLoader(false);
                responseDiv.classList.remove('hidden');

                if (mode === 'text') {
                    responseDiv.innerHTML = `<strong class="text-blue-400">ğŸ¤– åˆ†æï¼š</strong><div class="text-gray-200 mt-2">${data.answer}</div>`;
                } else {
                    if (data.url) {
                        responseDiv.innerHTML = `
                            <p class="text-green-400 font-bold mb-2">âœ… ç°¡å ±å®Œæˆï¼</p>
                            <a href="${data.url}" target="_blank" class="btn btn-green text-center block no-underline">ğŸ“‚ ä¸‹è¼‰ç°¡å ±</a>
                        `;
                    } else {
                        throw new Error("ç”Ÿæˆå¤±æ•—");
                    }
                }
            } catch (e) {
                toggleLoader(false); // ç™¼ç”ŸéŒ¯èª¤ä¹Ÿè¦é—œé–‰
                // éŒ¯èª¤è™•ç†é‚è¼¯ (åŸæœ¬çš„ timeout æç¤ºæ”¾é€™è£¡)
                if (mode === 'ppt') {
                    responseDiv.classList.remove('hidden');
                    responseDiv.innerHTML = `<p class="text-yellow-400">âš ï¸ é€£ç·šé€¾æ™‚ï¼Œè«‹ç¨å¾Œè‡³é›²ç«¯è³‡æ–™å¤¾æŸ¥çœ‹ã€‚</p>`;
                } else {
                    alert("éŒ¯èª¤: " + e.message);
                }
            }
        }
                
        // --- å·¥å…·: å‘¼å« GAS API (é€é POST) ---
        async function callGasApi(payload) {
            // source: 'liff' æ˜¯ç‚ºäº†è®“ GAS å€åˆ†é€™ä¸æ˜¯ LINE Webhook
            const body = JSON.stringify({ ...payload, source: 'liff' });
            
            const res = await fetch(GAS_API_URL, {
                method: "POST",
                body: body
            });
            return await res.json();
        }

        // --- åŠŸèƒ½ 2: æŒ‰éˆ•é˜²å‘†é– (é˜²æ­¢é€£é») ---
        // btn: æŒ‰éˆ•å…ƒç´  (this), asyncFn: è¦åŸ·è¡Œçš„éåŒæ­¥å‡½å¼
        async function safeExecute(btn, asyncFn) {
            const originalText = btn.innerText;
            
            // 1. é–å®š
            btn.disabled = true;
            btn.innerHTML = `â³ è™•ç†ä¸­...`;
            
            try {
                // 2. åŸ·è¡Œä¸¦ç­‰å¾…
                await asyncFn();
            } catch (e) {
                console.error(e);
                alert("åŸ·è¡Œç™¼ç”ŸéŒ¯èª¤: " + e.message);
            } finally {
                // 3. è§£é– (ç„¡è«–æˆåŠŸå¤±æ•—)
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }
        // å•Ÿå‹•ä¸»ç¨‹å¼
        main();
    </script>
</body>
</html>
