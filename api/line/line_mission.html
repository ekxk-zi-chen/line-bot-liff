<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠ±è“®ç‰¹æœæˆ°æƒ…ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #1a1a1a; color: #e0e0e0; font-family: sans-serif; }
        .card { background-color: #2d2d2d; border-radius: 12px; padding: 16px; margin-bottom: 12px; border-left: 5px solid #4CAF50; }
        .btn { width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; margin-top: 8px; cursor: pointer; }
        .btn-green { background-color: #4CAF50; color: white; border: none; }
        .btn-red { background-color: #f44336; color: white; border: none; }
        .btn-blue { background-color: #2196F3; color: white; border: none; }
        .loader { border: 4px solid #333; border-top: 4px solid #4CAF50; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        /* --- 1. å±±è±¬ç‰¹æœè¼‰å…¥å‹•ç•« --- */
        #boar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(26, 26, 26, 0.95); /* æ·±è‰²åŠé€æ˜èƒŒæ™¯ */
            z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .boar-scene {
            font-size: 80px; /* èª¿æ•´å¤§å° */
            margin-bottom: 20px;
            animation: bounce 1s infinite alternate;
        }
        .boar-text {
            color: #4CAF50; font-weight: bold; font-size: 1.2rem;
            animation: pulse 1.5s infinite;
        }
        @keyframes bounce {
            0% { transform: translateY(0); }
            100% { transform: translateY(-10px); }
        }

        /* --- 2. æŒ‰éˆ•é–å®šç‹€æ…‹ --- */
        .btn:disabled {
            opacity: 0.6; cursor: not-allowed; filter: grayscale(80%);
        }

        /* --- 3. ä»»å‹™çœ‹æ¿å±•é–‹ç´°ç¯€ (Accordion) --- */
        .mission-detail {
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;
            background-color: #333; border-radius: 0 0 12px 12px;
        }
        .mission-detail.open {
            max-height: 500px; /* è¶³å¤ é¡¯ç¤ºå…§å®¹çš„é«˜åº¦ */
            border-top: 1px solid #444;
        }
        .detail-row {
            padding: 8px 16px; font-size: 0.9rem; color: #ccc; border-bottom: 1px solid #444;
            display: flex; align-items: center; gap: 8px;
        }
        .detail-row:last-child { border-bottom: none; }
        .badge {
            padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; color: white;
        }
        .bg-blue { background-color: #2196F3; }
        .bg-orange { background-color: #FF9800; }
        /* --- 4. ä»»å‹™æ‘˜è¦æŠ˜ç–Šæ•ˆæœ --- */
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3; /* å¯¦éš›é‹ä½œé é€™è¡Œ */
            line-clamp: 3;         /* ğŸ”¥ æ–°å¢é€™è¡Œï¼šå–®ç´”ç‚ºäº†è®“ç·¨è¼¯å™¨é–‰å˜´ */
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        /* è®“å±•é–‹æ”¶åˆæœ‰æ»‘é †çš„å‹•ç•« */
        .transition-height {
            transition: max-height 0.3s ease-in-out;
        }
        /* --- 5. è£å‚™å€Ÿç”¨ç®¡ç†æ¨£å¼ --- */
        .input-dark {
            width: 100%; background-color: #374151; color: white; padding: 10px; border-radius: 6px; border: 1px solid #4b5563; outline: none;
        }
        .input-dark:focus { border-color: #f59e0b; }
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 4px; }
        .tag-blue { background: #1e3a8a; color: #93c5fd; }
        .tag-green { background: #064e3b; color: #6ee7b7; }
    </style>
</head>
<body class="p-4">

    <div id="boar-overlay" class="hidden">
        <div id="boar-anim" class="boar-scene">ğŸ—</div> 
        <p id="boar-text" class="boar-text">æœæ•‘è³‡æ–™åˆ†æä¸­...</p>
    </div>

    <div id="header" class="mb-4 text-center">
        <h1 class="text-xl font-bold text-green-400">ğŸš’ èŠ±è“®ç‰¹æœè¡Œå‹•ç³»çµ±</h1>
        <p id="user-info" class="text-sm text-gray-400">è­˜åˆ¥ä¸­...</p>
    </div>

    <div id="loader" class="loader"></div>
    <!-- --- é é¢ 1: ä»»å‹™å›å ± --- -->
    <div id="view-report" class="hidden">
        <h2 class="text-lg font-bold mb-2">ğŸ“ æ‚¨çš„ä»»å‹™å›å ±</h2>
        <div id="report-list"></div>
    </div>
    <!-- --- é é¢ 2: ä»»å‹™æŸ¥è©¢ --- -->
    <div id="view-query" class="hidden">
        <h2 class="text-lg font-bold mb-2">ğŸ” é€²è¡Œä¸­ä»»å‹™çœ‹æ¿</h2>
        <div id="query-list"></div>
    </div>
     <!-- --- é é¢ 3: AI æˆ°æƒ…å®¤ --- -->
    <div id="view-ai" class="hidden">
        <h2 class="text-lg font-bold mb-2">ğŸ¤– AI æˆ°æƒ…/ç°¡å ±ä¸­å¿ƒ</h2>
        
        <div class="bg-gray-800 p-3 rounded mb-3 border border-gray-700">
            <p class="text-sm text-gray-400 mb-1">è«‹è¼¸å…¥ç›®æ¨™ (æ”¯æ´ GPS: 24.12, 121.55)</p>
            <input type="text" id="ai-input" class="w-full p-2 bg-gray-700 rounded text-white border border-gray-600 focus:border-green-500 outline-none" placeholder="ä¾‹å¦‚: åœŸè€³å…¶ã€èŠ±è“®ç§€æ—é„‰...">
        </div>

        <div class="flex gap-2 mb-3">
            <button onclick="safeExecute(this, () => askAI('text'))" class="btn btn-blue flex-1">ğŸ’¬ æ–‡å­—åˆ†æ</button>
            <button onclick="safeExecute(this, () => askAI('ppt'))" class="btn btn-red flex-1">ğŸ“Š ç”Ÿæˆç°¡å ±</button>
        </div>

        <a href="https://drive.google.com/drive/folders/1XAtHLGeo2fQH3wO5Lfq5_IjunbkIqzn_" target="_blank" class="btn block text-center mb-4" style="background-color: #FF9800; text-decoration: none; color: white;">
            ğŸ“‚ é–‹å•Ÿã€Œæ­·å²æƒ…è³‡æ­¸æª”ã€è³‡æ–™å¤¾
        </a>

        <div id="ai-response" class="mt-4 p-4 bg-gray-800 rounded border-l-4 border-green-500 hidden"></div>
    </div>
    <!-- --- é é¢ 4: è£å‚™å€Ÿç”¨ç®¡ç† --- -->
    <div id="view-equipment" class="hidden pb-20">
        <div class="flex justify-between items-center mb-3">
            <h2 class="text-lg font-bold text-yellow-400">ğŸ’ è£å‚™å€Ÿç”¨ç®¡ç†</h2>
            <div class="flex gap-2">
                <button onclick="fetchHistory()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold shadow hover:bg-blue-500">
                    ğŸ“œ æ­·å²
                </button>
                <button onclick="fetchEquipmentData(true)" class="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold shadow hover:bg-green-500">
                    ğŸ”„ åˆ·æ–°
                </button>
            </div>
        </div>

        <div class="bg-gray-800 p-2 rounded-lg mb-3 border border-gray-700">
            <input type="text" id="eq-search" oninput="renderEquipmentList()" 
                   class="w-full bg-gray-700 text-white p-2 rounded mb-2 border border-gray-600 focus:border-yellow-500 outline-none" 
                   placeholder="ğŸ” æœå°‹è£å‚™åç¨±ã€å‹è™Ÿ...">
            
            <div id="category-filter-container" class="flex gap-2 overflow-x-auto pb-1 custom-scrollbar">
            </div>
        </div>

        <button onclick="openEditModal('create')" class="w-full bg-yellow-600 text-white py-2 rounded mb-3 font-bold shadow-lg hover:bg-yellow-500 transition">
            â• æ–°å¢è£å‚™ (ç®¡ç†å“¡)
        </button>

        <div id="equipment-list" class="space-y-3 min-h-[200px]"></div>
    </div>

    <div id="loan-modal" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-5 rounded-lg w-full max-w-sm border border-gray-600">
            <h3 id="loan-modal-title" class="text-xl font-bold mb-4 text-white">è£å‚™å€Ÿå‡º</h3>
            <input type="hidden" id="loan-eq-id">
            
            <div class="mb-3">
                <label class="block text-gray-400 text-sm mb-1">å€Ÿç”¨äººå§“å</label>
                <input type="text" id="loan-borrower" class="w-full bg-gray-700 text-white p-2 rounded" placeholder="è«‹è¼¸å…¥å§“å">
            </div>
            <div class="mb-4">
                <label class="block text-gray-400 text-sm mb-1">å€Ÿç”¨æ•¸é‡ (å‰©é¤˜: <span id="loan-max-qty"></span>)</label>
                <input type="number" id="loan-qty" class="w-full bg-gray-700 text-white p-2 rounded" value="1" min="1">
            </div>
            
            <div class="flex gap-2">
                <button onclick="closeModal('loan-modal')" class="flex-1 bg-gray-600 text-white py-2 rounded">å–æ¶ˆ</button>
                <button onclick="submitLoan()" class="flex-1 bg-blue-500 text-white py-2 rounded font-bold">ç¢ºèªå€Ÿå‡º</button>
            </div>
        </div>
    </div>

    <div id="edit-eq-modal" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-5 rounded-lg w-full max-w-sm border border-yellow-600 h-3/4 overflow-y-auto">
            <h3 id="edit-modal-title" class="text-xl font-bold mb-4 text-yellow-400">æ–°å¢è£å‚™</h3>
            <input type="hidden" id="edit-eq-id">
            <input type="hidden" id="edit-mode"> <div class="space-y-3">
                <input type="text" id="eq-name" class="input-dark" placeholder="å™¨æåç¨± (å¿…å¡«)">
                <input type="text" id="eq-category" list="category-options" class="input-dark" placeholder="é¸æ“‡åˆ†é¡æˆ–è¼¸å…¥æ–°åˆ†é¡ (å¿…å¡«)">
                <datalist id="category-options">
                    </datalist>
                <input type="text" id="eq-model" class="input-dark" placeholder="å‹è™Ÿ (é¸å¡«)">
                <input type="text" id="eq-location" class="input-dark" placeholder="å­˜æ”¾ä½ç½®">
                <div class="flex items-center gap-2">
                    <label class="text-gray-400 w-20">ç¸½æ•¸é‡:</label>
                    <input type="number" id="eq-total" class="input-dark flex-1" value="1" min="1">
                </div>
            </div>
            
            <div class="flex gap-2 mt-6">
                <button onclick="closeModal('edit-eq-modal')" class="flex-1 bg-gray-600 text-white py-2 rounded">å–æ¶ˆ</button>
                <button onclick="submitEquipmentEdit()" class="flex-1 bg-yellow-600 text-white py-2 rounded font-bold">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-95 hidden items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-4 rounded-lg w-full max-w-md border border-blue-500 h-4/5 flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <h3 class="text-xl font-bold text-blue-400">ğŸ“œ å€Ÿé‚„æ­·å²ç´€éŒ„</h3>
                <button onclick="closeModal('history-modal')" class="text-gray-400 text-2xl">&times;</button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-2">
                </div>
            <button onclick="fetchHistory()" class="mt-3 w-full bg-gray-700 text-white py-2 rounded hover:bg-gray-600">ğŸ”„ åˆ·æ–°ç´€éŒ„</button>
        </div>
    </div>
    <script>
        const GAS_API_URL = "https://line-bot-liff-lovat.vercel.app/api/webhook";

        let userId = "";
        let displayName = "";

        // --- æ ¸å¿ƒåŠŸèƒ½: å±±è±¬ç‰¹æœå‹•ç•«æ§åˆ¶ ---
        let loaderInterval;
        function toggleLoader(show, text = "è³‡æ–™è™•ç†ä¸­...") {
            const overlay = document.getElementById('boar-overlay');
            const anim = document.getElementById('boar-anim');
            const textDiv = document.getElementById('boar-text');
            
            if (show) {
                overlay.classList.remove('hidden');
                textDiv.innerText = text;
                
                // ğŸ”¥ å‡ç´šç‰ˆå‹•ä½œåºåˆ—ï¼šæ“¬äººåŒ–å±±è±¬ç‰¹æœ
                const actions = [
                    'ğŸ—ğŸ’¨ (å‡ºå‹¤ä¸­...)', 
                    'ğŸ—ğŸ—ºï¸ (å®šä½ä¸­...)', 
                    'ğŸ—ğŸ‘€ (æœç´¢ä¸­...)', 
                    'ğŸ—ğŸš‘ (å¾Œé€ä¸­...)', 
                    'ğŸ—ğŸ“¡ (é€šè¨Šä¸­...)'
                ]; 
                let idx = 0;
                
                // æ¸…é™¤èˆŠå‹•ç•«
                if (loaderInterval) clearInterval(loaderInterval);
                
                // å•Ÿå‹•å¾ªç’° (æ¯ 0.6 ç§’æ›ä¸€å€‹å‹•ä½œï¼Œè®“å®ƒçœ‹èµ·ä¾†å¾ˆå¿™)
                loaderInterval = setInterval(() => {
                    anim.innerText = actions[idx].split(' ')[0]; // åªå–åœ–æ¡ˆ
                    // å¦‚æœä½ æƒ³é€£æ–‡å­—ä¸€èµ·è®Šï¼Œå¯ä»¥ç”¨ innerText = actions[idx]
                    idx = (idx + 1) % actions.length;
                }, 600); 
            } else {
                overlay.classList.add('hidden');
                if (loaderInterval) clearInterval(loaderInterval);
            }
        }

        // åˆå§‹åŒ– LIFF
        async function main() {
            try {
                // è¨˜å¾—å¡«å…¥ LIFF ID
                await liff.init({ liffId: "2008804963-FBGT1ktJ" }); 
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                userId = profile.userId;
                displayName = profile.displayName;
                document.getElementById('user-info').innerText = `éšŠå“¡ï¼š${displayName}`;

                // æ ¹æ“š URL åƒæ•¸åˆ¤æ–·è¦é¡¯ç¤ºå“ªä¸€é 

                const urlParams = new URLSearchParams(window.location.search);
                const path = urlParams.get('path'); // æœƒæŠ“åˆ° 'report', 'query', 'ai', æˆ– 'equipment'

                document.getElementById('loader').classList.add('hidden'); // é—œé–‰è½‰åœˆåœˆ

                // ğŸ”¥ ä¿®æ”¹é€™è£¡ï¼šåŠ å…¥è£å‚™é é¢çš„åˆ¤æ–·
                if (path === 'report') {
                    showReportPage();
                } else if (path === 'query') {
                    showQueryPage();
                } else if (path === 'ai') {
                    showAiPage();
                } else if (path === 'equipment') {
                    // âœ… é€™è£¡åªéœ€è¦é€™è¡Œ
                    loadEquipment('All');
                } else {
                    // é è¨­é¡¯ç¤ºæŸ¥è©¢ (æˆ–æ˜¯ä½ å¯ä»¥æ”¹æˆé è¨­é¡¯ç¤ºè£å‚™)
                    showQueryPage();
                }

            } catch (err) {
                alert("LIFF åˆå§‹åŒ–å¤±æ•—: " + err);
            }
        }

        // --- é é¢ 1: ä»»å‹™å›å ± ---
        async function showReportPage() {
            document.getElementById('view-report').classList.remove('hidden');
            
            // âŒ åˆªé™¤é€™è¡Œ (æ‹”æ‰é­šéª¨)
            // showSkeleton('report-list', 3);

            // âœ… æ–°å¢é€™è¡Œ (å‘¼å«å±±è±¬)
            toggleLoader(true, "æ­£åœ¨åŒæ­¥ä»»å‹™å›å ±ç´€éŒ„..."); 

            try {
                const data = await callGasApi({ action: 'get_my_assignments', userId: userId });
                const listDiv = document.getElementById('report-list');
                listDiv.innerHTML = "";

                if (!data || data.length === 0) {
                    listDiv.innerHTML = "<p class='text-center text-gray-500'>ğŸ’¤ ç›®å‰æ²’æœ‰æŒ‡æ´¾çµ¦æ‚¨çš„ä»»å‹™</p>";
                } else {
                    data.forEach(task => {
                        // ... (åŸæœ¬ç”¢ç”Ÿå¡ç‰‡çš„ç¨‹å¼ç¢¼ä¿æŒä¸è®Š) ...
                        const div = document.createElement('div');
                        div.className = "card";
                        div.innerHTML = `
                            <h3 class="font-bold text-lg">${task.mission_title}</h3>
                            <p class="text-sm text-gray-300 mb-2">æ¢¯æ¬¡: ${task.batch_no} | ${task.assignment_note || ''}</p>
                            <input type="text" id="note-${task.assignment_id}" class="w-full p-2 bg-gray-700 rounded text-white mb-2" placeholder="è¼¸å…¥å›å ±å…§å®¹ (ä¾‹å¦‚: æŠµé”)">
                            <div class="flex gap-2">
                                <button onclick="submitReport(${task.assignment_id}, '${task.mission_id}', false)" class="btn btn-blue flex-1">åƒ…å›å ±</button>
                                <button onclick="submitReport(${task.assignment_id}, '${task.mission_id}', true)" class="btn btn-green flex-1">ä»»å‹™å®Œæˆ</button>
                            </div>
                        `;
                        listDiv.appendChild(div);
                    });
                }
            } catch (e) {
                alert("è®€å–å¤±æ•—: " + e.message);
            } finally {
                // âœ… ä»»å‹™çµæŸï¼Œå±±è±¬é€€å ´
                toggleLoader(false);
            }
        }

        async function submitReport(assignmentId, missionId, isFinished) {
            const note = document.getElementById(`note-${assignmentId}`).value;
            if (!note && !isFinished) { alert("è«‹è¼¸å…¥å›å ±å…§å®¹"); return; }

            const confirmMsg = isFinished ? "ç¢ºå®šè¦å›å ±ã€Œä»»å‹™å®Œæˆã€å—ï¼Ÿ" : "ç¢ºå®šè¦é€å‡ºå›å ±å—ï¼Ÿ";
            if (!confirm(confirmMsg)) return;

            // é¡¯ç¤º Loading
            liff.sendMessages([{ type: 'text', text: isFinished ? 'ä»»å‹™å®Œæˆå›å ±ä¸­...' : 'é€²åº¦å›å ±ä¸­...' }]);
            
            await callGasApi({
                action: 'submit_report',
                userId: userId,
                assignmentId: assignmentId,
                missionId: missionId,
                isFinished: isFinished,
                note: note || (isFinished ? "ä»»å‹™å®Œæˆ" : "")
            });

            alert("âœ… å›å ±æˆåŠŸï¼");
            liff.closeWindow(); // é—œé–‰è¦–çª—
        }


        // --- é é¢ 2: ä»»å‹™æŸ¥è©¢ ---
        // --- åŠŸèƒ½ 3: äº’å‹•å¼ä»»å‹™çœ‹æ¿ (å¯æŠ˜ç–Šæ‘˜è¦ç‰ˆ) ---
        async function showQueryPage() {
            document.getElementById('view-query').classList.remove('hidden');
            toggleLoader(true, "æ­£åœ¨é€£ç·šæˆ°æƒ…ä¸­å¿ƒ...");

            try {
                const data = await callGasApi({ action: 'get_public_missions', userId: userId });
                const listDiv = document.getElementById('query-list');
                listDiv.innerHTML = "";

                if (!data || data.length === 0) {
                    listDiv.innerHTML = "<p class='text-center text-gray-500 mt-4'>ğŸ“­ ç›®å‰ç„¡é€²è¡Œä¸­ä»»å‹™</p>";
                } else {
                    data.forEach(task => {
                        const cardId = `mission-${Math.random().toString(36).substr(2, 9)}`;
                        // ğŸ”¥ æ–°å¢ï¼šæ‘˜è¦å°ˆç”¨çš„ ID
                        const summaryId = `summary-${cardId}`;
                        
                        const div = document.createElement('div');
                        div.className = "card";
                        div.style.borderLeftColor = "#2196F3"; 
                        div.style.cursor = "pointer";
                        
                        const title = task.title || "æœªå‘½åä»»å‹™";
                        const desc = task.description || "å°šç„¡è©³ç´°æè¿°";
                        let timeDisplay = "æ™‚é–“æœªå®š";
                        if (task.start_time) timeDisplay = task.start_time.replace('T', ' ').substring(0, 16);

                        // --- è™•ç†å›å ±ç´€éŒ„ (ä¿æŒä¸è®Š) ---
                        let logsHtml = '';
                        const logs = task.progress_logs || []; 

                        if (logs.length > 0) {
                            logsHtml = `<div class="mt-3 pt-3 border-t border-gray-600">
                                          <p class="text-xs text-gray-400 mb-2 flex items-center justify-between">
                                            <span>ğŸ“¡ ç¾å ´å›å ±æ—¥èªŒ (å®Œæ•´ç´€éŒ„)</span>
                                            <span class="text-gray-500 text-[10px]">â–¼ æ™‚é–“å€’åº</span>
                                          </p>
                                          <div class="space-y-2 max-h-96 overflow-y-auto pr-1 custom-scrollbar">`; 
                            
                            logs.forEach(log => {
                                let statusColor = "text-gray-400";
                                let statusIcon = "âšª";
                                let borderClass = "border-gray-500";

                                if (log.status === 'å·²å®Œæˆ') {
                                    statusColor = "text-green-400";
                                    statusIcon = "ğŸŸ¢";
                                    borderClass = "border-green-600";
                                } else if (log.status === 'é€²è¡Œä¸­') {
                                    statusColor = "text-blue-400";
                                    statusIcon = "ğŸ”µ"; 
                                    borderClass = "border-blue-600";
                                } else {
                                    statusColor = "text-yellow-400";
                                    statusIcon = "ğŸŸ¡";
                                }

                                const batchBadge = log.batch_num !== 'æœªçŸ¥' 
                                    ? `<span class="bg-gray-600 text-white px-1 rounded ml-2">ç¬¬${log.batch_num}æ¢¯</span>` 
                                    : '';

                                logsHtml += `
                                    <div class="p-2 bg-gray-700 rounded-md text-sm border-l-4 ${borderClass}">
                                        <div class="flex justify-between items-center mb-1">
                                            <div class="flex items-center">
                                                <span class="font-bold ${statusColor} mr-1">${statusIcon} ${log.status}</span>
                                                <span class="text-[10px] bg-gray-800 px-1 rounded text-gray-400">${log.time_str}</span>
                                                ${batchBadge}
                                            </div>
                                        </div>
                                        <div class="text-gray-200 pl-1 mb-1 leading-relaxed">${log.note}</div>
                                        <div class="text-xs text-gray-400 text-right border-t border-gray-600 pt-1 mt-1">
                                            å›å ±äºº: <span class="text-gray-300">${log.reporter_name}</span>
                                        </div>
                                    </div>
                                `;
                            });
                            logsHtml += `</div></div>`;
                        } else {
                            logsHtml = `<div class="mt-3 pt-2 border-t border-gray-600 text-center text-xs text-gray-500">(å°šç„¡å›å ±ç´€éŒ„)</div>`;
                        }

                        div.innerHTML = `
                            <div onclick="toggleDetail('${cardId}')" class="flex justify-between items-center select-none">
                                <div class="flex-1">
                                    <h3 class="font-bold text-lg text-white">${title}</h3>
                                    <p class="text-sm text-gray-400">ğŸ•’ å•Ÿå‹•: ${timeDisplay}</p>
                                </div>
                                <div class="text-2xl text-gray-500 transition-transform duration-300 ml-2" id="icon-${cardId}">â–¼</div>
                            </div>
                            
                            <div id="${cardId}" class="mission-detail mt-0">
                                <div class="p-3 bg-gray-800 rounded-b-lg">
                                    <div class="text-sm text-gray-400 mb-2">
                                        <span class="block mb-1 font-bold text-gray-500">ğŸ“ ä»»å‹™æ‘˜è¦:</span>
                                        
                                        <div id="${summaryId}" class="text-gray-300 bg-gray-900 p-2 rounded text-xs leading-relaxed line-clamp-3">
                                            ${desc}
                                        </div>
                                        
                                        <button onclick="toggleSummary('${summaryId}', this)" class="text-blue-400 text-xs mt-1 w-full text-center hover:text-blue-300 focus:outline-none py-1">
                                            å±•é–‹å…¨æ–‡ â–¼
                                        </button>
                                    </div>
                                    ${logsHtml}
                                </div>
                            </div>
                        `;
                        listDiv.appendChild(div);
                    });
                }
            } catch (e) {
                console.error(e);
                alert("è®€å–å¤±æ•—: " + e.message);
            } finally {
                toggleLoader(false);
            }
        }

        // --- æ–°å¢å·¥å…·ï¼šåˆ‡æ›æ‘˜è¦å±•é–‹/æ”¶åˆ ---
        function toggleSummary(id, btn) {
            // é˜»æ­¢å†’æ³¡ï¼Œé¿å…è§¸ç™¼å¡ç‰‡æ”¶åˆ
            event.stopPropagation();
            
            const el = document.getElementById(id);
            if (el.classList.contains('line-clamp-3')) {
                // å±•é–‹
                el.classList.remove('line-clamp-3');
                btn.innerText = "æ”¶åˆæ‘˜è¦ â–²";
            } else {
                // æ”¶åˆ
                el.classList.add('line-clamp-3');
                btn.innerText = "å±•é–‹å…¨æ–‡ â–¼";
            }
        }

        // åˆ‡æ›å±•é–‹/æ”¶åˆçš„å°å·¥å…·
        function toggleDetail(id) {
            const el = document.getElementById(id);
            const icon = document.getElementById(`icon-${id}`);
            
            if (el.classList.contains('open')) {
                el.classList.remove('open');
                icon.style.transform = "rotate(0deg)";
            } else {
                // é—œé–‰å…¶ä»–å·²å±•é–‹çš„ (å¦‚æœæƒ³è¦ä¸€æ¬¡åªé–‹ä¸€å€‹)
                document.querySelectorAll('.mission-detail.open').forEach(d => {
                    d.classList.remove('open');
                    // é€™è£¡æ‡¶å¾—æŠ“ icon å¾©åŸï¼Œç°¡å–®åš
                });
                
                el.classList.add('open');
                icon.style.transform = "rotate(180deg)";
            }
        }
        // --- é é¢ 3: AI æˆ°æƒ…å®¤ ---
        function showAiPage() {
            document.getElementById('view-ai').classList.remove('hidden');
        }

        // --- æ ¸å¿ƒæ”¹å‹•ï¼šAI è«‹æ±‚å‡½å¼ ---
        async function askAI(mode) {
            const input = document.getElementById('ai-input');
            const responseDiv = document.getElementById('ai-response');
            const query = input.value.trim();

            if (!query) { alert("è«‹è¼¸å…¥å…§å®¹ï¼"); return; }

            // å•Ÿå‹•å±±è±¬å‹•ç•«
            toggleLoader(true, mode === 'ppt' ? "æ­£åœ¨èª¿é–±åœ–è³‡èˆ‡ç”Ÿæˆç°¡å ±..." : "æˆ°æƒ…å®˜åˆ†æä¸­...");
            
            try {
                const action = mode === 'ppt' ? 'make_briefing_ppt' : 'ask_ai';
                const data = await callGasApi({ 
                    action: action, 
                    userId: userId, 
                    question: query, 
                    query: query 
                });
                
                // é—œé–‰å‹•ç•«
                toggleLoader(false);
                responseDiv.classList.remove('hidden');

                if (mode === 'text') {
                    responseDiv.innerHTML = `<strong class="text-blue-400">ğŸ¤– åˆ†æï¼š</strong><div class="text-gray-200 mt-2">${data.answer}</div>`;
                } else {
                    if (data.url) {
                        responseDiv.innerHTML = `
                            <p class="text-green-400 font-bold mb-2">âœ… ç°¡å ±å®Œæˆï¼</p>
                            <a href="${data.url}" target="_blank" class="btn btn-green text-center block no-underline">ğŸ“‚ ä¸‹è¼‰ç°¡å ±</a>
                        `;
                    } else {
                        throw new Error("ç”Ÿæˆå¤±æ•—");
                    }
                }
            } catch (e) {
                toggleLoader(false); // ç™¼ç”ŸéŒ¯èª¤ä¹Ÿè¦é—œé–‰
                // éŒ¯èª¤è™•ç†é‚è¼¯ (åŸæœ¬çš„ timeout æç¤ºæ”¾é€™è£¡)
                if (mode === 'ppt') {
                    responseDiv.classList.remove('hidden');
                    responseDiv.innerHTML = `<p class="text-yellow-400">âš ï¸ é€£ç·šé€¾æ™‚ï¼Œè«‹ç¨å¾Œè‡³é›²ç«¯è³‡æ–™å¤¾æŸ¥çœ‹ã€‚</p>`;
                } else {
                    alert("éŒ¯èª¤: " + e.message);
                }
            }
        }
                
        // --- å·¥å…·: å‘¼å« GAS API (é€é POST) ---
        async function callGasApi(payload) {
            // source: 'liff' æ˜¯ç‚ºäº†è®“ GAS å€åˆ†é€™ä¸æ˜¯ LINE Webhook
            const body = JSON.stringify({ ...payload, source: 'liff' });
            
            const res = await fetch(GAS_API_URL, {
                method: "POST",
                body: body
            });
            return await res.json();
        }

        // --- åŠŸèƒ½ 2: æŒ‰éˆ•é˜²å‘†é– (é˜²æ­¢é€£é») ---
        // btn: æŒ‰éˆ•å…ƒç´  (this), asyncFn: è¦åŸ·è¡Œçš„éåŒæ­¥å‡½å¼
        async function safeExecute(btn, asyncFn) {
            const originalText = btn.innerText;
            
            // 1. é–å®š
            btn.disabled = true;
            btn.innerHTML = `â³ è™•ç†ä¸­...`;
            
            try {
                // 2. åŸ·è¡Œä¸¦ç­‰å¾…
                await asyncFn();
            } catch (e) {
                console.error(e);
                alert("åŸ·è¡Œç™¼ç”ŸéŒ¯èª¤: " + e.message);
            } finally {
                // 3. è§£é– (ç„¡è«–æˆåŠŸå¤±æ•—)
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }
        // --- ğŸ’ è£å‚™ç®¡ç†ç³»çµ± JS (å®Œæ•´é«˜æ•ˆèƒ½ç‰ˆ) ---

        // å…¨åŸŸè®Šæ•¸ï¼šå¿«å–è³‡æ–™
        let equipmentCache = [];  // å„²å­˜æ‰€æœ‰è£å‚™
        let currentCategory = 'All'; // ç›®å‰é¸ä¸­çš„åˆ†é¡
        
        // 1. åˆå§‹è¼‰å…¥å…¥å£ (åˆ‡æ›åˆ†é æˆ–é»æ“Šåˆ·æ–°æ™‚å‘¼å«)
        function loadEquipment(initialCategory = 'All') {
            document.getElementById('view-equipment').classList.remove('hidden'); // ç¢ºä¿é¡¯ç¤º
            
            // è¨­å®šæŒ‰éˆ•ç‹€æ…‹
            switchCategory(initialCategory); 
            
            // å¦‚æœå¿«å–æ˜¯ç©ºçš„ï¼Œæ‰å‘¼å«å±±è±¬å»æŠ“è³‡æ–™
            if (equipmentCache.length === 0) {
                fetchEquipmentData(true);
            } else {
                renderEquipmentList(); // æœ‰è³‡æ–™ç›´æ¥é¡¯ç¤º (ç§’é–‹)
            }
        }

        // 2. å¾å¾Œç«¯æŠ“å–è³‡æ–™ (Fetch) - æŠ“ä¸€æ¬¡å…¨éƒ¨
        async function fetchEquipmentData(showLoading = false) {
            if(showLoading) toggleLoader(true, "æ­£åœ¨ç›¤é»è£å‚™åº«...");
            const listDiv = document.getElementById('equipment-list');
            
            try {
                const data = await callGasApi({ 
                    action: 'get_equipment_list', 
                    userId: userId, 
                    category: 'All' 
                });

                if (!data || data.length === 0) {
                    listDiv.innerHTML = "<p class='text-center text-gray-500'>æŸ¥ç„¡è£å‚™</p>";
                    equipmentCache = [];
                } else {
                    equipmentCache = data;
                    renderCategoryUI(); // ğŸ”¥ é—œéµï¼šè³‡æ–™å›ä¾†å¾Œï¼Œç”¢ç”Ÿåˆ†é¡æŒ‰éˆ•
                    renderEquipmentList();
                    // if(showLoading) alert("âœ… è³‡æ–™å·²åŒæ­¥");
                }
            } catch (e) {
                alert("è®€å–å¤±æ•—: " + e.message);
                listDiv.innerHTML = `<p class="text-center text-red-400">é€£ç·šéŒ¯èª¤</p>`;
            } finally {
                if(showLoading) toggleLoader(false);
            }
        }

        // 3. åˆ‡æ›åˆ†é¡ (UI æ“ä½œï¼Œä¸é€£ç·š)
        function switchCategory(category) {
            currentCategory = category;
            
            // é‡æ–°æ¸²æŸ“ UI (é€™æ¨£æŒ‰éˆ•é¡è‰²æ‰æœƒè®Š)
            renderCategoryUI();
            
            // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            renderEquipmentList();
        }

        // 4. æ¸²æŸ“åˆ—è¡¨ (æ ¸å¿ƒï¼šåŒ…å«æœå°‹éæ¿¾ + HTMLç”Ÿæˆ + UIå„ªåŒ–)
        function renderEquipmentList() {
            const listDiv = document.getElementById('equipment-list');
            const searchInput = document.getElementById('eq-search');
            const searchText = searchInput ? searchInput.value.toLowerCase() : "";
            
            const filteredData = equipmentCache.filter(eq => {
                const matchCategory = currentCategory === 'All' || eq.category === currentCategory;
                const matchSearch = (eq.name && eq.name.toLowerCase().includes(searchText)) || 
                                    (eq.model && eq.model.toLowerCase().includes(searchText));
                return matchCategory && matchSearch;
            });

            if (filteredData.length === 0) {
                listDiv.innerHTML = "<p class='text-center text-gray-500 mt-4'>æ²’æœ‰ç¬¦åˆçš„è£å‚™</p>";
                return;
            }

            let htmlContent = '';
            
            filteredData.forEach(eq => {
                const isFull = eq.available_qty === eq.total_qty;
                const isEmpty = eq.available_qty === 0;
                
                // ç‹€æ…‹ç‡ˆè™Ÿ
                let statusBadge = isFull 
                    ? `<span class="text-green-400 font-bold text-sm">ğŸŸ¢ åœ¨éšŠ (${eq.available_qty})</span>` 
                    : (isEmpty ? `<span class="text-red-400 font-bold text-sm">ğŸ”´ å…¨éƒ¨å€Ÿå‡º</span>` 
                               : `<span class="text-blue-400 font-bold text-sm">ğŸ”µ éƒ¨åˆ†å€Ÿå‡º (${eq.available_qty}/${eq.total_qty})</span>`);

                // --- ğŸ”¥ å„ªåŒ– 3: å€Ÿç”¨äººåå–® (é è¨­æ”¶åˆ + æŒ‰éˆ•å±•é–‹) ---
                let loansHtml = '';
                if (eq.active_loans && eq.active_loans.length > 0) {
                    const collapseId = `loans-${eq.id}`;
                    const count = eq.active_loans.length;
                    
                    // æ¨™é¡Œåˆ— (é»æ“Šå¯å±•é–‹)
                    loansHtml = `
                        <div class="mt-3 pt-2 border-t border-gray-600">
                            <button onclick="toggleLoanList('${collapseId}')" class="w-full flex justify-between items-center text-xs text-gray-400 hover:text-white p-1">
                                <span>ğŸ“‹ å€Ÿç”¨ä¸­ (${count} ç­†)</span>
                                <span>â–¼</span>
                            </button>
                            <div id="${collapseId}" class="hidden space-y-2 mt-1 bg-gray-900 rounded p-2">`;
                    
                    // å€Ÿç”¨åˆ—è¡¨å…§å®¹
                    eq.active_loans.forEach(loan => {
                        loansHtml += `
                            <div class="flex justify-between items-center text-sm mb-1 text-gray-300 border-b border-gray-800 pb-1 last:border-0">
                                <div class="flex flex-col">
                                    <span class="font-bold">ğŸ‘¤ ${loan.borrower} <span class="text-yellow-500">x${loan.qty}</span></span>
                                    <span class="text-[10px] text-gray-500">${loan.date}</span>
                                </div>
                                <button onclick="returnItem('${loan.loan_id}', '${loan.borrower}')" class="bg-green-700 text-white px-4 py-2 rounded shadow active:bg-green-800 transition">
                                    æ­¸é‚„
                                </button>
                            </div>`;
                    });
                    loansHtml += `</div></div>`;
                }

                // æ‹¼æ¥ HTML å¡ç‰‡
                htmlContent += `
                    <div class="card bg-gray-800 p-4 rounded-lg border-l-4 ${isEmpty ? "border-red-500" : "border-green-500"} shadow-md">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="text-lg font-bold text-white leading-tight">${eq.name}</h3>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-xs text-gray-400 bg-gray-700 px-1 rounded">${eq.model || 'ç„¡å‹è™Ÿ'}</span>
                                    <span class="text-xs text-gray-400">ğŸ“ ${eq.location || 'æœªæ¨™è¨»'}</span>
                                </div>
                            </div>
                            
                            <div class="flex gap-2">
                                <button onclick="fetchItemHistory('${eq.id}', '${eq.name}')" class="text-blue-400 hover:text-blue-300 p-1" title="æŸ¥çœ‹æ­·å²">
                                    ğŸ“œ
                                </button>
                                <button onclick="openEditModal('update', '${eq.id}', '${eq.name}', '${eq.category}', '${eq.model}', '${eq.location}', ${eq.total_qty})" class="text-gray-500 hover:text-white p-1">
                                    âš™ï¸
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-3">
                            ${statusBadge}
                            ${!isEmpty ? `<button onclick="openLoanModal('${eq.id}', '${eq.name}', ${eq.available_qty})" class="bg-blue-600 text-white px-4 py-1.5 rounded text-sm font-bold shadow hover:bg-blue-500">å€Ÿå‡º</button>` : ''}
                        </div>
                        
                        ${loansHtml}
                    </div>
                `;
            });

            listDiv.innerHTML = htmlContent;
        }

        // --- æ–°å¢å·¥å…·å‡½å¼ï¼šå±•é–‹/æ”¶åˆå€Ÿç”¨åå–® ---
        function toggleLoanList(id) {
            const el = document.getElementById(id);
            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        }

        // 5. æ­·å²ç´€éŒ„åŠŸèƒ½ (å‘¼å«å¾Œç«¯ get_loan_history)
        async function fetchHistory() {
            const modal = document.getElementById('history-modal');
            const list = document.getElementById('history-list');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            list.innerHTML = '<div class="loader"></div>'; // å°è½‰åœˆåœˆ

            try {
                // é€™è£¡æœƒå»æ’ˆ Supabase çš„ equipment_loans è¡¨
                const data = await callGasApi({ 
                    action: 'get_loan_history', 
                    userId: userId 
                });

                if (!data || data.length === 0) {
                    list.innerHTML = "<p class='text-center text-gray-500 mt-10'>å°šç„¡æ­·å²ç´€éŒ„</p>";
                } else {
                    let html = '';
                    data.forEach(log => {
                        const isReturn = log.status === 'å·²æ­¸é‚„';
                        const colorClass = isReturn ? 'border-green-500' : 'border-blue-500';
                        const icon = isReturn ? 'âœ…' : 'ğŸ“¤';
                        
                        html += `
                            <div class="bg-gray-700 p-3 rounded border-l-4 ${colorClass} text-sm">
                                <div class="flex justify-between font-bold text-gray-200">
                                    <span>${icon} ${log.item_name || 'è£å‚™'}</span>
                                    <span>${log.borrower}</span>
                                </div>
                                <div class="flex justify-between text-gray-400 mt-1 text-xs">
                                    <span>æ•¸é‡: ${log.qty}</span>
                                    <span>${log.time}</span>
                                </div>
                            </div>
                        `;
                    });
                    list.innerHTML = html;
                }

            } catch (e) {
                list.innerHTML = `<p class="text-red-400 text-center mt-10">ç„¡æ³•è®€å–æ­·å²: ${e.message}</p>`;
            }
        }

        // 5. å–®é …è£å‚™æ­·å²ç´€éŒ„ (é»æ“Šå¡ç‰‡å³ä¸Šè§’ğŸ“œè§¸ç™¼)
        async function fetchItemHistory(eqId, eqName) {
            const modal = document.getElementById('history-modal');
            const list = document.getElementById('history-list');
            const title = modal.querySelector('h3'); // æŠ“æ¨™é¡Œå…ƒç´ 
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            title.innerText = `ğŸ“œ ${eqName} çš„æ­·å²ç´€éŒ„`; // é¡¯ç¤ºè£å‚™åç¨±
            list.innerHTML = '<div class="loader"></div>';

            try {
                // ğŸ”¥ å‘¼å«å¾Œç«¯ï¼šé€™æ¬¡å¤šå¸¶ä¸€å€‹ eqId åƒæ•¸
                const data = await callGasApi({ 
                    action: 'get_loan_history', 
                    userId: userId,
                    eqId: eqId  // æŒ‡å®šæŸ¥é€™é …è£å‚™
                });

                if (!data || data.length === 0) {
                    list.innerHTML = "<p class='text-center text-gray-500 mt-10'>æ­¤è£å‚™å°šç„¡å€Ÿé‚„ç´€éŒ„</p>";
                } else {
                    let html = '';
                    data.forEach(log => {
                        const isReturn = log.status === 'å·²æ­¸é‚„';
                        const colorClass = isReturn ? 'border-green-500' : 'border-blue-500';
                        const icon = isReturn ? 'âœ…' : 'ğŸ“¤';
                        
                        html += `
                            <div class="bg-gray-700 p-3 rounded border-l-4 ${colorClass} text-sm">
                                <div class="flex justify-between font-bold text-gray-200">
                                    <span>${icon} ${log.status}</span> <span>${log.borrower}</span>
                                </div>
                                <div class="flex justify-between text-gray-400 mt-1 text-xs">
                                    <span>æ•¸é‡: ${log.qty}</span>
                                    <span>${log.time}</span>
                                </div>
                            </div>
                        `;
                    });
                    list.innerHTML = html;
                }
            } catch (e) {
                list.innerHTML = `<p class="text-red-400 text-center mt-10">ç„¡æ³•è®€å–: ${e.message}</p>`;
            }
        }
        // 6. é–‹å•Ÿå€Ÿå‡ºè¦–çª—
        function openLoanModal(id, name, maxQty) {
            document.getElementById('loan-modal').classList.remove('hidden');
            document.getElementById('loan-modal').classList.add('flex');
            document.getElementById('loan-modal-title').innerText = `å€Ÿç”¨: ${name}`;
            document.getElementById('loan-eq-id').value = id;
            document.getElementById('loan-max-qty').innerText = maxQty;
            const qtyInput = document.getElementById('loan-qty');
            qtyInput.max = maxQty;
            qtyInput.value = 1;
            document.getElementById('loan-borrower').value = ""; // æ¸…ç©º
        }

        // 7. é€å‡ºå€Ÿç”¨
        async function submitLoan() {
            const id = document.getElementById('loan-eq-id').value;
            const borrower = document.getElementById('loan-borrower').value;
            const qty = document.getElementById('loan-qty').value;
            if(!borrower) { alert("è«‹è¼¸å…¥å€Ÿç”¨äººå§“å"); return; }

            // ğŸ”¥ å‘¼å«å±±è±¬
            toggleLoader(true, "ç™»è¨˜å€Ÿå‡ºä¸­...");
            closeModal('loan-modal');

            try {
                const res = await callGasApi({
                    action: 'borrow_equipment',
                    userId: userId,
                    displayName: displayName,
                    eqId: id,
                    borrower: borrower,
                    qty: qty
                });
                if(res.success) {
                    // alert("âœ… å€Ÿå‡ºæˆåŠŸï¼");
                    // æˆåŠŸå¾Œï¼Œéœé»˜åˆ·æ–°å¿«å– (ä¸é¡¯ç¤ºå±±è±¬ï¼Œä½†åœ¨èƒŒæ™¯æ›´æ–°)
                    fetchEquipmentData(false); 
                } else {
                    alert("âŒ å¤±æ•—: " + res.message);
                }
            } catch(e) { 
                alert("é€£ç·šéŒ¯èª¤: " + e.message); 
            } finally { 
                toggleLoader(false); 
            }
        }

        // 8. æ­¸é‚„è£å‚™
        async function returnItem(loanId, borrowerName) {
            if(!confirm(`ç¢ºå®šæ”¶åˆ° ${borrowerName} çš„æ­¸é‚„äº†å—ï¼Ÿ`)) return;

            // ğŸ”¥ å‘¼å«å±±è±¬
            toggleLoader(true, "è™•ç†æ­¸é‚„ä¸­...");
            try {
                const res = await callGasApi({
                    action: 'return_equipment',
                    userId: userId,
                    displayName: displayName,
                    loanId: loanId
                });
                if(res.success) {
                    // alert("âœ… æ­¸é‚„ç¢ºèªå®Œç•¢ï¼");
                    // æˆåŠŸå¾Œï¼Œéœé»˜åˆ·æ–°å¿«å–
                    fetchEquipmentData(false);
                } else {
                    alert("âŒ å¤±æ•—: " + res.message);
                }
            } catch(e) { 
                alert("éŒ¯èª¤: " + e.message); 
            } finally { 
                toggleLoader(false); 
            }
        }

        // 9. ç®¡ç†å“¡åŠŸèƒ½ï¼šæ–°å¢/ç·¨è¼¯è£å‚™è¦–çª—
        function openEditModal(mode, id, name, cat, model, loc, total) {
            const modal = document.getElementById('edit-eq-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            document.getElementById('edit-mode').value = mode;
            
            if(mode === 'create') {
                document.getElementById('edit-modal-title').innerText = "â• æ–°å¢è£å‚™";
                document.getElementById('edit-eq-id').value = "";
                document.getElementById('eq-name').value = "";
                document.getElementById('eq-category').value = ""; // ğŸ”¥ ç•™ç™½è®“ä½¿ç”¨è€…é¸æˆ–å¡«
                document.getElementById('eq-model').value = "";
                document.getElementById('eq-location').value = "";
                document.getElementById('eq-total').value = 1;
            } else {
                document.getElementById('edit-modal-title').innerText = "âš™ï¸ ç·¨è¼¯è£å‚™";
                document.getElementById('edit-eq-id').value = id;
                document.getElementById('eq-name').value = name;
                document.getElementById('eq-category').value = cat; // å¡«å…¥èˆŠåˆ†é¡
                document.getElementById('eq-model').value = model || "";
                document.getElementById('eq-location').value = loc || "";
                document.getElementById('eq-total').value = total;
            }
        }

        // 10. é€å‡ºç·¨è¼¯
        async function submitEquipmentEdit() {
            const mode = document.getElementById('edit-mode').value;
            const payload = {
                action: 'manage_equipment',
                userId: userId,
                displayName: displayName,
                mode: mode,
                eqId: document.getElementById('edit-eq-id').value,
                name: document.getElementById('eq-name').value,
                category: document.getElementById('eq-category').value,
                model: document.getElementById('eq-model').value,
                location: document.getElementById('eq-location').value,
                totalQty: document.getElementById('eq-total').value
            };
            
            if(!payload.name) { alert("åç¨±å¿…å¡«"); return; }

            // ğŸ”¥ å‘¼å«å±±è±¬
            toggleLoader(true, "å¯«å…¥è³‡æ–™åº«ä¸­...");
            closeModal('edit-eq-modal');
            
            try {
                const res = await callGasApi(payload);
                if(res.success) {
                    // alert(res.message);
                    fetchEquipmentData(false); // éœé»˜æ›´æ–°å¿«å–
                } else {
                    alert("âŒ å¤±æ•—: " + res.message);
                }
            } catch(e) { 
                alert("éŒ¯èª¤: " + e.message); 
            } finally { 
                toggleLoader(false); 
            }
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            document.getElementById(id).classList.remove('flex');
        }

        // --- ğŸ”¥ æ–°åŠŸèƒ½: å‹•æ…‹ç”¢ç”Ÿåˆ†é¡æŒ‰éˆ•èˆ‡é¸å–® ---
        function renderCategoryUI() {
            // é è¨­äº”å¤§çµ„ + ç¾æœ‰è³‡æ–™çš„åˆ†é¡
            const defaultCats = ['ç®¡ç†', 'æœç´¢', 'æ•‘æ´', 'é†«ç™‚', 'å¾Œå‹¤'];
            const existCats = equipmentCache.map(eq => eq.category);
            const allCats = [...new Set([...defaultCats, ...existCats])]; // å»é™¤é‡è¤‡

            // A. æ¸²æŸ“ä¸Šæ–¹æŒ‰éˆ•
            const container = document.getElementById('category-filter-container');
            if (!container) return; // é˜²å‘†

            let btnHtml = '';
            // å…¨éƒ¨æŒ‰éˆ•
            const allActive = currentCategory === 'All' ? 'bg-yellow-600 text-white' : 'bg-gray-700 text-gray-300';
            btnHtml += `<button onclick="switchCategory('All')" class="btn-filter ${allActive} px-3 py-1 rounded-full text-sm whitespace-nowrap transition-colors">å…¨éƒ¨</button>`;

            // å…¶ä»–åˆ†é¡æŒ‰éˆ•
            allCats.forEach(cat => {
                const active = currentCategory === cat ? 'bg-yellow-600 text-white' : 'bg-gray-700 text-gray-300';
                btnHtml += `<button onclick="switchCategory('${cat}')" class="btn-filter ${active} px-3 py-1 rounded-full text-sm whitespace-nowrap transition-colors">${cat}</button>`;
            });
            container.innerHTML = btnHtml;

            // B. æ›´æ–°æ–°å¢è¦–çª—çš„ä¸‹æ‹‰é¸å–®
            const dataList = document.getElementById('category-options');
            if (dataList) {
                dataList.innerHTML = allCats.map(cat => `<option value="${cat}">`).join('');
            }
        }
        // å•Ÿå‹•ä¸»ç¨‹å¼
        main();
    </script>
</body>
</html>
