<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠ±è“®ç‰¹æœæˆ°æƒ…ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #1a1a1a; color: #e0e0e0; font-family: sans-serif; }
        .card { background-color: #2d2d2d; border-radius: 12px; padding: 16px; margin-bottom: 12px; border-left: 5px solid #4CAF50; }
        .btn { width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; margin-top: 8px; cursor: pointer; }
        .btn-green { background-color: #4CAF50; color: white; border: none; }
        .btn-red { background-color: #f44336; color: white; border: none; }
        .btn-blue { background-color: #2196F3; color: white; border: none; }
        .loader { border: 4px solid #333; border-top: 4px solid #4CAF50; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none; }
    </style>
</head>
<body class="p-4">

    <div id="header" class="mb-4 text-center">
        <h1 class="text-xl font-bold text-green-400">ğŸš’ èŠ±è“®ç‰¹æœè¡Œå‹•ç³»çµ±</h1>
        <p id="user-info" class="text-sm text-gray-400">è­˜åˆ¥ä¸­...</p>
    </div>

    <div id="loader" class="loader"></div>

    <div id="view-report" class="hidden">
        <h2 class="text-lg font-bold mb-2">ğŸ“ æ‚¨çš„ä»»å‹™å›å ±</h2>
        <div id="report-list"></div>
    </div>

    <div id="view-query" class="hidden">
        <h2 class="text-lg font-bold mb-2">ğŸ” é€²è¡Œä¸­ä»»å‹™çœ‹æ¿</h2>
        <div id="query-list"></div>
    </div>

    <div id="view-ai" class="hidden">
        <h2 class="text-lg font-bold mb-2">ğŸ¤– AI æˆ°æƒ…/ç°¡å ±ä¸­å¿ƒ</h2>
        
        <div class="bg-gray-800 p-3 rounded mb-3 border border-gray-700">
            <p class="text-sm text-gray-400 mb-1">è«‹è¼¸å…¥ç›®æ¨™åœ‹å®¶æˆ–åœ°å€ï¼š</p>
            <input type="text" id="ai-input" class="w-full p-2 bg-gray-700 rounded text-white border border-gray-600 focus:border-green-500 outline-none" placeholder="ä¾‹å¦‚: åœŸè€³å…¶ã€æ—¥æœ¬çŸ³å·ç¸£ã€èŠ±è“®å¤ªé­¯é–£...">
            
            <p class="text-xs text-gray-500 mt-2">ğŸ’¡ æç¤ºï¼šè¼¸å…¥åœ°é»è¶Šç²¾ç¢ºï¼Œæƒ…è³‡è¶Šæº–ç¢ºã€‚</p>
        </div>

        <div class="flex gap-3">
            <button onclick="askAI('text')" class="btn btn-blue flex-1 flex flex-col items-center justify-center gap-1">
                <span class="text-xl">ğŸ’¬</span>
                <span class="text-sm">æ–‡å­—åˆ†æ</span>
            </button>
            
            <button onclick="askAI('ppt')" class="btn btn-red flex-1 flex flex-col items-center justify-center gap-1">
                <span class="text-xl">ğŸ“Š</span>
                <span class="text-sm">ç”Ÿæˆç°¡å ±</span>
            </button>
        </div>

        <div id="ai-response" class="mt-4 p-4 bg-gray-800 rounded border-l-4 border-green-500 hidden"></div>
    </div>

    <script>
        const GAS_API_URL = "https://line-bot-liff-lovat.vercel.app/api/webhook";

        let userId = "";
        let displayName = "";

        // åˆå§‹åŒ– LIFF
        async function main() {
            try {
                // è¨˜å¾—å¡«å…¥ LIFF ID
                await liff.init({ liffId: "2008804963-FBGT1ktJ" }); 
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                userId = profile.userId;
                displayName = profile.displayName;
                document.getElementById('user-info').innerText = `éšŠå“¡ï¼š${displayName}`;

                // æ ¹æ“š URL åƒæ•¸åˆ¤æ–·è¦é¡¯ç¤ºå“ªä¸€é 
                const urlParams = new URLSearchParams(window.location.search);
                const path = urlParams.get('path'); // æœƒæŠ“åˆ° 'report', 'query', æˆ– 'ai'

                document.getElementById('loader').classList.add('hidden');

                if (path === 'report') {
                    showReportPage();
                } else if (path === 'query') {
                    showQueryPage();
                } else if (path === 'ai') {
                    showAiPage();
                } else {
                    // é è¨­é¡¯ç¤ºæŸ¥è©¢
                    showQueryPage();
                }

            } catch (err) {
                alert("LIFF åˆå§‹åŒ–å¤±æ•—: " + err);
            }
        }

        // --- é é¢ 1: ä»»å‹™å›å ± ---
        async function showReportPage() {
            document.getElementById('view-report').classList.remove('hidden');
            document.getElementById('report-list').innerHTML = '<div class="loader"></div>';

            const data = await callGasApi({ action: 'get_my_assignments', userId: userId });
            const listDiv = document.getElementById('report-list');
            listDiv.innerHTML = "";

            if (!data || data.length === 0) {
                listDiv.innerHTML = "<p class='text-center text-gray-500'>ğŸ’¤ ç›®å‰æ²’æœ‰æŒ‡æ´¾çµ¦æ‚¨çš„ä»»å‹™</p>";
                return;
            }

            data.forEach(task => {
                const div = document.createElement('div');
                div.className = "card";
                div.innerHTML = `
                    <h3 class="font-bold text-lg">${task.mission_title}</h3>
                    <p class="text-sm text-gray-300 mb-2">æ¢¯æ¬¡: ${task.batch_no} | ${task.assignment_note || ''}</p>
                    <input type="text" id="note-${task.assignment_id}" class="w-full p-2 bg-gray-700 rounded text-white mb-2" placeholder="è¼¸å…¥å›å ±å…§å®¹ (ä¾‹å¦‚: æŠµé”)">
                    <div class="flex gap-2">
                        <button onclick="submitReport(${task.assignment_id}, '${task.mission_id}', false)" class="btn btn-blue flex-1">åƒ…å›å ±</button>
                        <button onclick="submitReport(${task.assignment_id}, '${task.mission_id}', true)" class="btn btn-green flex-1">ä»»å‹™å®Œæˆ</button>
                    </div>
                `;
                listDiv.appendChild(div);
            });
        }

        async function submitReport(assignmentId, missionId, isFinished) {
            const note = document.getElementById(`note-${assignmentId}`).value;
            if (!note && !isFinished) { alert("è«‹è¼¸å…¥å›å ±å…§å®¹"); return; }

            const confirmMsg = isFinished ? "ç¢ºå®šè¦å›å ±ã€Œä»»å‹™å®Œæˆã€å—ï¼Ÿ" : "ç¢ºå®šè¦é€å‡ºå›å ±å—ï¼Ÿ";
            if (!confirm(confirmMsg)) return;

            // é¡¯ç¤º Loading
            liff.sendMessages([{ type: 'text', text: isFinished ? 'ä»»å‹™å®Œæˆå›å ±ä¸­...' : 'é€²åº¦å›å ±ä¸­...' }]);
            
            await callGasApi({
                action: 'submit_report',
                userId: userId,
                assignmentId: assignmentId,
                missionId: missionId,
                isFinished: isFinished,
                note: note || (isFinished ? "ä»»å‹™å®Œæˆ" : "")
            });

            alert("âœ… å›å ±æˆåŠŸï¼");
            liff.closeWindow(); // é—œé–‰è¦–çª—
        }

        // --- é é¢ 2: ä»»å‹™æŸ¥è©¢ ---
        async function showQueryPage() {
            document.getElementById('view-query').classList.remove('hidden');
            document.getElementById('query-list').innerHTML = '<div class="loader"></div>';

            const data = await callGasApi({ action: 'get_public_missions', userId: userId });
            const listDiv = document.getElementById('query-list');
            listDiv.innerHTML = "";

            if (!data || data.length === 0) {
                listDiv.innerHTML = "<p class='text-center text-gray-500'>ğŸ“­ ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„ä»»å‹™</p>";
                return;
            }

            data.forEach(task => {
                const div = document.createElement('div');
                div.className = "card";
                div.style.borderLeftColor = "#2196F3";
                div.innerHTML = `
                    <h3 class="font-bold text-lg">${task.title}</h3>
                    <p class="text-sm text-gray-400">å•Ÿå‹•æ™‚é–“: ${task.start_time.split('T')[0]}</p>
                `;
                listDiv.appendChild(div);
            });
        }

        // --- é é¢ 3: AI æˆ°æƒ…å®¤ ---
        function showAiPage() {
            document.getElementById('view-ai').classList.remove('hidden');
        }

        // --- æ ¸å¿ƒæ”¹å‹•ï¼šAI è«‹æ±‚å‡½å¼ ---
        async function askAI(mode) {
            const input = document.getElementById('ai-input');
            const responseDiv = document.getElementById('ai-response');
            const query = input.value.trim();

            if (!query) { alert("è«‹è¼¸å…¥åœ°é»æˆ–é—œéµå­—ï¼"); return; }

            // é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹
            responseDiv.classList.remove('hidden');
            responseDiv.style.borderLeftColor = mode === 'ppt' ? '#f44336' : '#2196F3'; // ç´…è‰²æˆ–è—è‰²é‚Šæ¡†
            
            if (mode === 'ppt') {
                responseDiv.innerHTML = `
                    <div class="loader"></div>
                    <p class="text-center text-green-400 font-bold animate-pulse">æ­£åœ¨ç”Ÿæˆ Google Slides ç°¡å ±...</p>
                    <p class="text-center text-xs text-gray-400 mt-1">AI æ­£åœ¨æ’°å¯«æ²»å®‰ã€äº¤é€šã€æ°£å€™åˆ†æ<br>è«‹ç¨å€™ç´„ 10~15 ç§’</p>
                `;
            } else {
                responseDiv.innerHTML = `
                    <div class="loader"></div>
                    <p class="text-center text-blue-400">æ­£åœ¨é€£ç·šæˆ°æƒ…ä¸­å¿ƒåˆ†æä¸­...</p>
                `;
            }

            try {
                // æ ¹æ“šæ¨¡å¼å‘¼å«ä¸åŒçš„ GAS Action
                // mode 'text' -> action 'ask_ai'
                // mode 'ppt'  -> action 'make_briefing_ppt'
                const action = mode === 'ppt' ? 'make_briefing_ppt' : 'ask_ai';
                
                // å‘¼å« API (é€™è£¡åƒæ•¸åç¨±ç¨å¾®çµ±ä¸€ä¸€ä¸‹ï¼Œå¾Œç«¯å¦‚æœæ˜¯ç”¨ query å°±å‚³ queryï¼Œç”¨ question å°±å‚³ question)
                // ç‚ºäº†ä¿éšªï¼Œæˆ‘å…©å€‹éƒ½å‚³
                const data = await callGasApi({ 
                    action: action, 
                    userId: userId, 
                    question: query, // çµ¦ ask_ai ç”¨
                    query: query     // çµ¦ make_briefing_ppt ç”¨
                });
                
                if (mode === 'text') {
                    // --- æ–‡å­—æ¨¡å¼çµæœ ---
                    responseDiv.innerHTML = `
                        <strong class="text-blue-400 text-lg">ğŸ¤– åˆ†æå ±å‘Šï¼š${query}</strong><br>
                        <div class="whitespace-pre-wrap mt-2 text-gray-200 leading-relaxed">${data.answer || "âš ï¸ åˆ†æå¤±æ•—ï¼Œè«‹é‡è©¦ã€‚"}</div>
                    `;
                } else {
                    // --- PPT æ¨¡å¼çµæœ ---
                    if (data.url) {
                        responseDiv.innerHTML = `
                            <div class="text-center">
                                <p class="text-green-400 font-bold text-lg mb-2">âœ… æƒ…è³‡ç°¡å ±è£½ä½œå®Œæˆï¼</p>
                                <p class="text-sm text-gray-400 mb-4">ç›®æ¨™å€ï¼š${query}</p>
                                
                                <a href="${data.url}" target="_blank" class="block w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded shadow-lg transition duration-200" style="text-decoration:none;">
                                    ğŸ“‚ é»æ“Šé–‹å•Ÿ Google Slides
                                </a>
                                
                                <p class="text-xs text-gray-500 mt-3 border-t border-gray-700 pt-2">
                                    é€£çµå·²è¨­å®šç‚ºã€ŒçŸ¥é“é€£çµè€…å¯æª¢è¦–ã€ï¼Œæ‚¨å¯ä»¥ç›´æ¥è¤‡è£½é€£çµå›å ±çµ¦æŒ‡æ®å®˜ã€‚
                                </p>
                            </div>
                        `;
                    } else {
                        responseDiv.innerHTML = `<p class="text-red-400 font-bold text-center">âŒ ç”Ÿæˆå¤±æ•—</p><p class="text-sm text-gray-400 text-center">å¯èƒ½æ˜¯ AI å¿™ç·šä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>`;
                    }
                }
            } catch (e) {
                console.error(e);
                responseDiv.innerHTML = `<p class="text-red-500">é€£ç·šéŒ¯èª¤: ${e.message}</p>`;
            }
        }

        // --- å·¥å…·: å‘¼å« GAS API (é€é POST) ---
        async function callGasApi(payload) {
            // source: 'liff' æ˜¯ç‚ºäº†è®“ GAS å€åˆ†é€™ä¸æ˜¯ LINE Webhook
            const body = JSON.stringify({ ...payload, source: 'liff' });
            
            const res = await fetch(GAS_API_URL, {
                method: "POST",
                body: body
            });
            return await res.json();
        }

        main();
    </script>
</body>
</html>
