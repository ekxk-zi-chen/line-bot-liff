<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠ±è“®ç‰¹æœæˆ°æƒ…ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* --- å…¨åŸŸæ¨£å¼ --- */
        body { 
            background-color: #1a1a1a; 
            color: #e0e0e0; 
            font-family: sans-serif; 
            padding-bottom: 100px; /* é ç•™åº•éƒ¨å·¥å…·åˆ—ç©ºé–“ */
        }
        
        /* å¡ç‰‡æ¨£å¼ */
        .card { 
            background-color: #2d2d2d; 
            border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 12px; 
            border-left: 5px solid #4CAF50; 
        }

        /* æŒ‰éˆ•é€šç”¨æ¨£å¼ */
        .btn { 
            width: 100%; 
            padding: 12px; 
            border-radius: 8px; 
            font-weight: bold; 
            margin-top: 8px; 
            cursor: pointer; 
            transition: all 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-green { background-color: #4CAF50; color: white; border: none; }
        .btn-red { background-color: #f44336; color: white; border: none; }
        .btn-blue { background-color: #2196F3; color: white; border: none; }

        /* è¼‰å…¥ä¸­å‹•ç•« (Loader) */
        .loader { 
            border: 4px solid #333; 
            border-top: 4px solid #4CAF50; 
            border-radius: 50%; 
            width: 30px; 
            height: 30px; 
            animation: spin 1s linear infinite; 
            margin: 20px auto; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* å·¥å…·é¡ */
        .hidden { display: none !important; }
        .input-dark { 
            width: 100%; 
            background-color: #374151; 
            color: white; 
            padding: 10px; 
            border-radius: 6px; 
            border: 1px solid #4b5563; 
            outline: none; 
        }
        .input-dark:focus { border-color: #f59e0b; }

        /* --- å±±è±¬ç‰¹æœè¼‰å…¥ç•«é¢ --- */
        #boar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .boar-scene { font-size: 60px; margin-bottom: 20px; animation: bounce 1s infinite alternate; }
        @keyframes bounce { 0% { transform: translateY(0); } 100% { transform: translateY(-10px); } }

        /* --- ä»»å‹™çœ‹æ¿å±•é–‹èˆ‡çœç•¥é‚è¼¯ (Accordion & Truncate) --- */
        .mission-detail {
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;
            background-color: #333; border-radius: 0 0 12px 12px;
        }
        .mission-detail.open {
            max-height: 800px; /* è¶³å¤ é¡¯ç¤ºæ—¥èªŒçš„é«˜åº¦ */
            border-top: 1px solid #444;
        }
        /* çœç•¥æ–‡å­— (é¡¯ç¤º3è¡Œ) */
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* --- æ²è»¸ç¾åŒ– --- */
        .custom-scrollbar::-webkit-scrollbar { height: 4px; width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #555; border-radius: 2px; }

        /* --- å½ˆçª— (Modal) --- */
        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.9); 
            display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem;
        }
        /* è¡¨æ ¼æ¨£å¼ (çµ¦æ‰¹æ¬¡å€Ÿå‡ºç”¨) */
        .batch-table th { position: sticky; top: 0; background: #374151; color: #ddd; padding: 8px; }
        .batch-table td { border-bottom: 1px solid #4b5563; padding: 8px; color: #eee; }
    </style>
</head>
<body class="p-4">

    <div id="boar-overlay" class="hidden">
        <div id="boar-anim" class="boar-scene">ğŸ—</div> 
        <p id="boar-text" class="text-green-500 font-bold text-xl animate-pulse">è³‡æ–™è™•ç†ä¸­...</p>
    </div>

    <div id="header" class="mb-4 text-center">
        <h1 class="text-xl font-bold text-green-400">ğŸš’ èŠ±è“®ç‰¹æœè¡Œå‹•ç³»çµ±</h1>
        <p id="user-info" class="text-sm text-gray-400">è­˜åˆ¥ä¸­...</p>
    </div>

    <div id="loader" class="loader"></div>
    
    <div id="view-report" class="hidden">
        <h2 class="text-lg font-bold mb-2">ğŸ“ æ‚¨çš„ä»»å‹™å›å ±</h2>
        <div id="report-list"></div>
    </div>
    
    <div id="view-query" class="hidden">
        <h2 class="text-lg font-bold mb-2">ğŸ” é€²è¡Œä¸­ä»»å‹™çœ‹æ¿</h2>
        <div id="query-list"></div>
    </div>
    
     <div id="view-ai" class="hidden">
        <h2 class="text-lg font-bold mb-2">ğŸ¤– AI æˆ°æƒ…/ç°¡å ±ä¸­å¿ƒ</h2>
        <div class="bg-gray-800 p-3 rounded mb-3 border border-gray-700">
            <p class="text-sm text-gray-400 mb-1">è«‹è¼¸å…¥ç›®æ¨™ (æ”¯æ´ GPS)</p>
            <input type="text" id="ai-input" class="input-dark" placeholder="ä¾‹å¦‚: åœŸè€³å…¶ã€èŠ±è“®ç§€æ—é„‰...">
        </div>
        <div class="flex gap-2 mb-3">
            <button onclick="safeExecute(this, () => askAI('text'))" class="btn btn-blue flex-1">ğŸ’¬ æ–‡å­—åˆ†æ</button>
            <button onclick="safeExecute(this, () => askAI('ppt'))" class="btn btn-red flex-1">ğŸ“Š ç”Ÿæˆç°¡å ±</button>
        </div>
        <a href="https://drive.google.com/drive/folders/1XAtHLGeo2fQH3wO5Lfq5_IjunbkIqzn_" target="_blank" class="btn block text-center mb-4" style="background-color: #FF9800; text-decoration: none; color: white;">ğŸ“‚ é–‹å•Ÿã€Œæ­·å²æƒ…è³‡æ­¸æª”ã€</a>
        <div id="ai-response" class="mt-4 p-4 bg-gray-800 rounded border-l-4 border-green-500 hidden"></div>
    </div>
    
    <div id="view-equipment" class="hidden pb-20">
        
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mb-3">
            <div class="flex items-center gap-2 w-full sm:w-auto">
                <h2 class="text-lg font-bold text-yellow-400 whitespace-nowrap">ğŸ’ è£å‚™</h2>
                <select id="status-filter" onchange="renderEquipmentList()" class="flex-1 sm:flex-none bg-gray-700 text-white text-sm py-2 px-2 rounded border border-gray-600 outline-none focus:border-yellow-500">
                    <option value="All">å…¨éƒ¨é¡¯ç¤º</option>
                    <option value="Borrowed">åªçœ‹å€Ÿå‡º</option>
                    <option value="InStock">åªçœ‹åœ¨éšŠ</option>
                </select>
            </div>
            
            <div class="flex gap-2 w-full sm:w-auto">
                <button onclick="fetchHistory()" class="flex-1 sm:flex-none bg-blue-600 text-white px-3 py-2 rounded text-sm font-bold shadow">ğŸ“œ æ­·å²</button>
                <button onclick="fetchEquipmentData(true)" class="flex-1 sm:flex-none bg-green-600 text-white px-3 py-2 rounded text-sm font-bold shadow">ğŸ”„ åˆ·æ–°</button>
                <button onclick="toggleExportMode()" id="btn-export-mode" class="flex-1 sm:flex-none bg-purple-600 text-white px-3 py-2 rounded text-sm font-bold shadow">ğŸ“Š åŒ¯å‡º</button>
            </div>
        </div>

        <div class="bg-gray-800 p-2 rounded-lg mb-3 border border-gray-700">
            <input type="text" id="eq-search" oninput="renderEquipmentList()" 
                   class="w-full bg-gray-700 text-white p-2 rounded mb-2 border border-gray-600 focus:border-yellow-500 outline-none" 
                   placeholder="ğŸ” æœå°‹è£å‚™åç¨±ã€å‹è™Ÿã€å€Ÿç”¨äºº...">
            
            <div id="category-filter-container" class="flex gap-2 overflow-x-auto pb-1 custom-scrollbar"></div>
            
            <div id="note-filter-container" class="flex gap-2 overflow-x-auto pb-1 mt-2 custom-scrollbar border-t border-gray-700 pt-2 hidden"></div>
        </div>

        <button onclick="openEditModal('create')" class="w-full bg-yellow-600 text-white py-2 rounded mb-3 font-bold shadow-lg">â• æ–°å¢è£å‚™ (ç®¡ç†å“¡)</button>

        <div id="equipment-list" class="space-y-3 min-h-[200px]"></div>
        
        <div id="export-toolbar" class="hidden fixed bottom-4 left-4 right-4 bg-gray-900 border border-purple-500 p-3 rounded-lg shadow-2xl z-40 flex flex-col gap-3 animate-bounce-in">
            <div class="flex justify-between items-center border-b border-gray-700 pb-2">
                <div class="text-white text-sm">
                    å·²é¸ <span id="export-count" class="text-yellow-400 font-bold text-lg">0</span> é …
                </div>
                <button id="btn-select-all" onclick="toggleSelectAll()" class="bg-gray-700 text-white px-3 py-1 rounded text-xs hover:bg-gray-600">å…¨é¸æ­¤é </button>
            </div>
            
            <div class="flex gap-2 justify-between">
                <button onclick="openBatchBorrowModal()" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold text-sm shadow hover:bg-blue-500">
                    æ‰¹é‡å€Ÿå‡º
                </button>
                <button onclick="openBatchReturnModal()" class="flex-1 bg-green-600 text-white py-2 rounded font-bold text-sm shadow hover:bg-green-500">
                    æ‰¹é‡æ­¸é‚„
                </button>
                <button onclick="confirmExport()" class="flex-1 bg-purple-600 text-white py-2 rounded font-bold text-sm shadow hover:bg-purple-500">
                    åŒ¯å‡ºå ±è¡¨
                </button>
            </div>
        </div>
    </div>

    <div id="batch-borrow-modal" class="modal-overlay">
        <div class="bg-gray-800 p-5 rounded-lg w-full max-w-md border border-blue-500 flex flex-col max-h-[90vh]">
            <h3 class="text-xl font-bold mb-4 text-blue-400">ğŸ“¦ å€Ÿå‡ºè£å‚™ç¢ºèª</h3>
            
            <div class="mb-3">
                <label class="block text-gray-400 text-sm mb-1">å€Ÿç”¨äººå§“å (å¿…å¡«)</label>
                <input type="text" id="batch-borrower" class="input-dark" placeholder="è«‹è¼¸å…¥å§“å">
            </div>
            
            <div class="mb-3">
                <label class="block text-gray-400 text-sm mb-1">ç”¨é€”å‚™è¨» (é¸å¡«)</label>
                <input type="text" id="batch-note" list="note-suggestions" class="input-dark" placeholder="ä¾‹å¦‚: é›ªè¨“ã€ç¹©ç´¢è¨“ç·´...">
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar mb-4 border-t border-b border-gray-700 py-2 bg-gray-900 rounded px-2">
                <table class="w-full text-sm text-left text-gray-400 batch-table">
                    <thead>
                        <tr>
                            <th>è£å‚™åç¨±</th>
                            <th class="text-center">åº«å­˜</th>
                            <th class="w-24 text-center">å€Ÿç”¨æ•¸</th>
                        </tr>
                    </thead>
                    <tbody id="batch-borrow-list">
                        </tbody>
                </table>
            </div>

            <div class="flex gap-2">
                <button onclick="closeModal('batch-borrow-modal')" class="flex-1 bg-gray-600 text-white py-2 rounded">å–æ¶ˆ</button>
                <button onclick="submitBatchBorrow()" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold">ç¢ºèªå€Ÿå‡º</button>
            </div>
        </div>
    </div>

    <div id="batch-return-modal" class="modal-overlay">
        <div class="bg-gray-800 p-5 rounded-lg w-full max-w-md border border-green-500 flex flex-col max-h-[90vh]">
            <h3 class="text-xl font-bold mb-2 text-green-400">â™»ï¸ è£å‚™æ­¸é‚„ç¢ºèª</h3>
            <p class="text-xs text-gray-400 mb-4">è«‹å‹¾é¸è¦æ­¸é‚„çš„é …ç›®ï¼Œä¸¦ç¢ºèªã€Œæ­¸é‚„æ•¸é‡ã€ã€‚</p>

            <div class="flex-1 overflow-y-auto custom-scrollbar mb-4 bg-gray-900 rounded p-2">
                <div id="batch-return-list" class="space-y-3">
                    </div>
            </div>

            <div class="flex gap-2">
                <button onclick="closeModal('batch-return-modal')" class="flex-1 bg-gray-600 text-white py-2 rounded">å–æ¶ˆ</button>
                <button onclick="submitBatchReturn()" class="flex-1 bg-green-600 text-white py-2 rounded font-bold">ç¢ºèªæ­¸é‚„</button>
            </div>
        </div>
    </div>

    <div id="edit-eq-modal" class="modal-overlay">
        <div class="bg-gray-800 p-5 rounded-lg w-full max-w-sm border border-yellow-600 h-3/4 overflow-y-auto">
            <h3 id="edit-modal-title" class="text-xl font-bold mb-4 text-yellow-400">æ–°å¢è£å‚™</h3>
            <input type="hidden" id="edit-eq-id">
            <input type="hidden" id="edit-mode"> 
            
            <div class="space-y-3">
                <input type="text" id="eq-name" class="input-dark" placeholder="å™¨æåç¨± (å¿…å¡«)">
                <input type="text" id="eq-category" list="category-options" class="input-dark" placeholder="é¸æ“‡åˆ†é¡">
                <datalist id="category-options"></datalist>
                <input type="text" id="eq-model" class="input-dark" placeholder="å‹è™Ÿ (é¸å¡«)">
                <input type="text" id="eq-location" class="input-dark" placeholder="å­˜æ”¾ä½ç½®">
                <div class="flex items-center gap-2">
                    <label class="text-gray-400 w-20">ç¸½æ•¸é‡:</label>
                    <input type="number" id="eq-total" class="input-dark flex-1" value="1" min="1">
                </div>
            </div>
            
            <div class="flex gap-2 mt-6">
                <button id="btn-delete-eq" onclick="deleteEquipment()" class="hidden bg-red-600 text-white px-3 py-2 rounded font-bold">ğŸ—‘ï¸</button>
                <button onclick="closeModal('edit-eq-modal')" class="flex-1 bg-gray-600 text-white py-2 rounded">å–æ¶ˆ</button>
                <button onclick="submitEquipmentEdit()" class="flex-1 bg-yellow-600 text-white py-2 rounded font-bold">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="history-modal" class="modal-overlay">
        <div class="bg-gray-800 p-4 rounded-lg w-full max-w-md border border-blue-500 h-4/5 flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <h3 class="text-xl font-bold text-blue-400">ğŸ“œ æ­·å²ç´€éŒ„</h3>
                <button onclick="closeModal('history-modal')" class="text-2xl text-gray-400">&times;</button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-2"></div>
        </div>
    </div>

    <datalist id="note-suggestions">
        <option value="é›ªè¨“">
        <option value="ç¹©ç´¢è¨“ç·´">
        <option value="å‹•å“¡è¨“ç·´">
        <option value="å±±åŸŸæœæ•‘">
        <option value="è»Šè¼›ä¿é¤Š">
    </datalist>

    <script>
        // è¨­å®š API ç¶²å€ (è«‹ç¢ºèªé€™æ˜¯æ­£ç¢ºçš„)
        const GAS_API_URL = "https://line-bot-liff-lovat.vercel.app/api/webhook";

        let userId = "";
        let displayName = "";

        // å…¨åŸŸè®Šæ•¸ - è£å‚™ç®¡ç†
        let equipmentCache = [];
        let currentCategory = 'All';
        let currentNote = 'All'; // ğŸ”¥ æ–°å¢ï¼šç›®å‰é¸ä¸­çš„å‚™è¨»åˆ†é¡
        let isExportMode = false;
        let selectedItems = new Set();
        let loaderInterval;

        // --- 1. åˆå§‹åŒ–é‚è¼¯ ---
        async function main() {
            try {
                // åˆå§‹åŒ– LIFF
                await liff.init({ liffId: "2008804963-FBGT1ktJ" }); 
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                userId = profile.userId;
                displayName = profile.displayName;
                document.getElementById('user-info').innerText = `éšŠå“¡ï¼š${displayName}`;

                // æ ¹æ“šç¶²å€åƒæ•¸åˆ‡æ›é é¢
                const urlParams = new URLSearchParams(window.location.search);
                const path = urlParams.get('path'); 
                document.getElementById('loader').classList.add('hidden'); 

                if (path === 'report') showReportPage();
                else if (path === 'query') showQueryPage();
                else if (path === 'ai') showAiPage();
                else loadEquipment(); // é è¨­é é¢

            } catch (err) {
                alert("LIFF åˆå§‹åŒ–å¤±æ•—: " + err);
            }
        }

        // --- å…±ç”¨å‡½æ•¸: è¼‰å…¥å‹•ç•« ---
        function toggleLoader(show, text = "è³‡æ–™è™•ç†ä¸­...") {
            const overlay = document.getElementById('boar-overlay');
            const txt = document.getElementById('boar-text');
            const anim = document.getElementById('boar-anim');
            
            if (show) {
                overlay.classList.remove('hidden');
                txt.innerText = text;
                const icons = ['ğŸ—ğŸ’¨', 'ğŸ—ğŸ“¦', 'ğŸ—ğŸ“', 'ğŸ—âœ…'];
                let i = 0;
                if (loaderInterval) clearInterval(loaderInterval);
                loaderInterval = setInterval(() => {
                    anim.innerText = icons[i++ % icons.length];
                }, 500);
            } else {
                overlay.classList.add('hidden');
                if (loaderInterval) clearInterval(loaderInterval);
            }
        }

        // --- å…±ç”¨å‡½æ•¸: å‘¼å« GAS API ---
        async function callGasApi(payload) {
            const body = JSON.stringify({ ...payload, source: 'liff' });
            const res = await fetch(GAS_API_URL, { method: "POST", body: body });
            return await res.json();
        }

        // --- å…±ç”¨å‡½æ•¸: é—œé–‰å½ˆçª— ---
        function closeModal(id) {
            document.getElementById(id).classList.remove('flex');
            document.getElementById(id).classList.add('hidden');
        }

        // ============================================
        // ğŸ”¥ è£å‚™ç®¡ç†ç³»çµ±æ ¸å¿ƒé‚è¼¯ (å®Œæ•´å±•é–‹ç‰ˆ)
        // ============================================

        // è¼‰å…¥è£å‚™è³‡æ–™
        function loadEquipment() {
            document.getElementById('view-equipment').classList.remove('hidden');
            if (equipmentCache.length === 0) {
                fetchEquipmentData(true);
            } else {
                renderEquipmentList();
            }
        }

        async function fetchEquipmentData(showLoading = false) {
            if (showLoading) toggleLoader(true, "æ­£åœ¨ç›¤é»è£å‚™åº«...");
            const listDiv = document.getElementById('equipment-list');
            
            try {
                const data = await callGasApi({ 
                    action: 'get_equipment_list', 
                    userId: userId, 
                    category: 'All' 
                });

                if (!data || data.length === 0) {
                    listDiv.innerHTML = "<p class='text-center text-gray-500'>æŸ¥ç„¡è£å‚™</p>";
                    equipmentCache = [];
                } else {
                    equipmentCache = data;
                    renderCategoryUI(); 
                    renderNoteUI(); // ğŸ”¥ æ¸²æŸ“ç¬¬äºŒå±¤å‚™è¨»
                    renderEquipmentList();
                }
            } catch (e) {
                alert("è®€å–å¤±æ•—: " + e.message);
                listDiv.innerHTML = `<p class="text-center text-red-400">é€£ç·šéŒ¯èª¤</p>`;
            } finally {
                if (showLoading) toggleLoader(false);
            }
        }

        // æ¸²æŸ“åˆ†é¡æŒ‰éˆ• (ç¬¬ä¸€å±¤)
        function renderCategoryUI() {
            const container = document.getElementById('category-filter-container');
            const defaultCats = ['ç®¡ç†', 'æœç´¢', 'æ•‘æ´', 'é†«ç™‚', 'å¾Œå‹¤'];
            const existCats = equipmentCache.map(eq => eq.category);
            const allCats = [...new Set([...defaultCats, ...existCats])];

            let btnHtml = '';
            const allActive = currentCategory === 'All' ? 'bg-yellow-600 text-white' : 'bg-gray-700 text-gray-300';
            btnHtml += `<button onclick="switchCategory('All')" class="btn-filter ${allActive} px-3 py-1 rounded-full text-sm whitespace-nowrap transition-colors">å…¨éƒ¨</button>`;

            allCats.forEach(cat => {
                const active = currentCategory === cat ? 'bg-yellow-600 text-white' : 'bg-gray-700 text-gray-300';
                btnHtml += `<button onclick="switchCategory('${cat}')" class="btn-filter ${active} px-3 py-1 rounded-full text-sm whitespace-nowrap transition-colors mx-1">${cat}</button>`;
            });
            container.innerHTML = btnHtml;
            
            // æ›´æ–°æ–°å¢è¦–çª—çš„ä¸‹æ‹‰é¸å–®
            document.getElementById('category-options').innerHTML = allCats.map(c => `<option value="${c}">`).join('');
        }

        // æ¸²æŸ“å‚™è¨»æŒ‰éˆ• (ç¬¬äºŒå±¤)
        function renderNoteUI() {
            const container = document.getElementById('note-filter-container');
            // è’é›†æ‰€æœ‰å€Ÿå‡ºç´€éŒ„çš„å‚™è¨»
            let notes = new Set();
            equipmentCache.forEach(eq => {
                if (eq.active_loans) {
                    eq.active_loans.forEach(l => {
                        if (l.note && l.note.trim() !== "") {
                            notes.add(l.note);
                        } else {
                            notes.add("æœªåˆ†é¡");
                        }
                    });
                }
            });

            if (notes.size === 0) {
                container.classList.add('hidden');
                return;
            }
            container.classList.remove('hidden');

            let btnHtml = '';
            const allActive = currentNote === 'All' ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-300';
            btnHtml += `<button onclick="switchNote('All')" class="btn-filter ${allActive} px-3 py-1 rounded-full text-xs whitespace-nowrap mr-2">å…¨éƒ¨ç”¨é€”</button>`;

            Array.from(notes).sort().forEach(note => {
                const active = currentNote === note ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-300';
                btnHtml += `<button onclick="switchNote('${note}')" class="btn-filter ${active} px-3 py-1 rounded-full text-xs whitespace-nowrap mr-2">${note}</button>`;
            });
            container.innerHTML = btnHtml;
        }

        function switchCategory(c) { currentCategory = c; renderCategoryUI(); renderEquipmentList(); }
        function switchNote(n) { currentNote = n; renderNoteUI(); renderEquipmentList(); }

        // æ ¸å¿ƒæ¸²æŸ“ï¼šè£å‚™åˆ—è¡¨
        function renderEquipmentList() {
            const listDiv = document.getElementById('equipment-list');
            const searchText = document.getElementById('eq-search').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            
            // å¤šé‡éæ¿¾é‚è¼¯
            let filtered = equipmentCache.filter(eq => {
                // 1. åˆ†é¡
                const matchCategory = currentCategory === 'All' || eq.category === currentCategory;
                
                // 2. æœå°‹
                const matchSearch = (eq.name && eq.name.toLowerCase().includes(searchText)) || 
                                    (eq.model && eq.model.toLowerCase().includes(searchText)) ||
                                    (eq.active_loans && eq.active_loans.some(l => l.borrower.toLowerCase().includes(searchText)));

                // 3. ç‹€æ…‹
                const isBorrowed = eq.available_qty < eq.total_qty;
                let matchStatus = true;
                if (statusFilter === 'Borrowed') matchStatus = isBorrowed;
                else if (statusFilter === 'InStock') matchStatus = !isBorrowed;

                // 4. å‚™è¨»éæ¿¾
                let matchNote = true;
                if (currentNote !== 'All') {
                    if (!eq.active_loans || eq.active_loans.length === 0) {
                        matchNote = false;
                    } else {
                        if (currentNote === 'æœªåˆ†é¡') {
                            matchNote = eq.active_loans.some(l => !l.note || l.note.trim() === '');
                        } else {
                            matchNote = eq.active_loans.some(l => l.note === currentNote);
                        }
                    }
                }
                return matchCategory && matchSearch && matchStatus && matchNote;
            });

            // æ’åº: æœ‰å€Ÿå‡ºçš„ç½®é ‚
            filtered.sort((a, b) => {
                const aIsBorrowed = a.available_qty < a.total_qty;
                const bIsBorrowed = b.available_qty < b.total_qty;
                if (aIsBorrowed && !bIsBorrowed) return -1;
                if (!aIsBorrowed && bIsBorrowed) return 1;
                return 0;
            });

            if (filtered.length === 0) {
                listDiv.innerHTML = "<p class='text-center text-gray-500 mt-4'>æ²’æœ‰ç¬¦åˆçš„è£å‚™</p>";
                return;
            }

            let html = '';
            filtered.forEach(eq => {
                const isFull = eq.available_qty === eq.total_qty;
                const isEmpty = eq.available_qty === 0;
                
                let statusBadge = isFull 
                    ? `<span class="text-green-400 font-bold text-sm">ğŸŸ¢ åœ¨éšŠ (${eq.available_qty})</span>` 
                    : (isEmpty ? `<span class="text-red-400 font-bold text-sm">ğŸ”´ å…¨éƒ¨å€Ÿå‡º</span>` 
                    : `<span class="text-blue-400 font-bold text-sm">ğŸ”µ éƒ¨åˆ†å€Ÿå‡º (${eq.available_qty}/${eq.total_qty})</span>`);

                // å€Ÿå‡ºäººåå–® (é€™è£¡ç”¨ç°¡å–®åˆ—è¡¨ï¼Œæ“ä½œæ­¸é‚„å»ºè­°é»é¸ã€Œæ­¸é‚„ã€æŒ‰éˆ•)
                let loansHtml = '';
                if (eq.active_loans && eq.active_loans.length > 0) {
                    loansHtml = `<div class="mt-2 pt-2 border-t border-gray-600 space-y-1">`;
                    eq.active_loans.forEach(l => {
                        loansHtml += `
                            <div class="flex justify-between items-center text-xs text-gray-300">
                                <span>ğŸ‘¤ ${l.borrower} <span class="text-yellow-400">x${l.qty}</span> <span class="text-blue-300">${l.note ? `#${l.note}` : ''}</span></span>
                                <button onclick="openSingleReturnModal('${eq.id}', '${l.loan_id}', ${l.qty}, '${l.borrower}')" class="bg-green-700 text-white px-2 py-1 rounded text-[10px] hover:bg-green-600">æ­¸é‚„</button>
                            </div>`;
                    });
                    loansHtml += `</div>`;
                }

                // Checkbox (åŒ¯å‡ºæ¨¡å¼/æ‰¹æ¬¡æ¨¡å¼ç”¨)
                const checked = selectedItems.has(eq.id) ? 'checked' : '';
                const checkHtml = isExportMode ? `<div class="mr-3 flex items-center"><input type="checkbox" onchange="toggleSelect('${eq.id}')" ${checked} class="w-6 h-6 rounded border-gray-600 text-purple-600 focus:ring-purple-500"></div>` : '';

                html += `
                    <div class="flex items-start bg-gray-800 p-4 rounded-lg mb-3 border-l-4 ${isEmpty ? "border-red-500" : (isFull ? "border-green-500" : "border-blue-500")} shadow-md">
                        ${checkHtml}
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <div>
                                    <h3 class="font-bold text-white text-lg leading-tight">${eq.name}</h3>
                                    <div class="flex gap-2 text-xs text-gray-400 mt-1">
                                        <span>${eq.model || '-'}</span>
                                        <span>ğŸ“${eq.location || '-'}</span>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="fetchItemHistory('${eq.id}', '${eq.name}')" class="text-blue-400 p-1">ğŸ“œ</button>
                                    <button onclick="openEditModal('update', '${eq.id}', '${eq.name}', '${eq.category}', '${eq.model}', '${eq.location}', ${eq.total_qty})" class="text-gray-500 p-1">âš™ï¸</button>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center mt-3">
                                ${statusBadge}
                                ${!isEmpty ? `<button onclick="openSingleBorrowModal('${eq.id}', '${eq.name}', ${eq.available_qty})" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-blue-500">å€Ÿå‡º</button>` : ''}
                            </div>
                            ${loansHtml}
                        </div>
                    </div>`;
            });

            listDiv.innerHTML = html;
            updateExportCount();
        }

        // ============================================
        // ğŸ”¥ æ‰¹é‡/å–®ç­† å€Ÿå‡ºé‚è¼¯ (æ”¯æ´æ•¸é‡é¸æ“‡)
        // ============================================

        // å–®ç­†å€Ÿå‡º (å…¶å¯¦å°±æ˜¯åªé¸ä¸­ä¸€å€‹çš„æ‰¹æ¬¡å€Ÿå‡º)
        function openSingleBorrowModal(id, name, avail) {
            selectedItems.clear();
            selectedItems.add(id);
            openBatchBorrowModal();
        }

        // æ‰“é–‹æ‰¹é‡å€Ÿå‡ºè¦–çª—
        function openBatchBorrowModal() {
            if (selectedItems.size === 0) { alert("è«‹å…ˆå‹¾é¸è¦å€Ÿå‡ºçš„è£å‚™"); return; }
            
            const modal = document.getElementById('batch-borrow-modal');
            modal.classList.add('flex'); // é¡¯ç¤ºè¦–çª—
            
            // æ¸…ç©ºè¼¸å…¥
            document.getElementById('batch-borrower').value = "";
            document.getElementById('batch-note').value = "";
            
            const tbody = document.getElementById('batch-borrow-list');
            tbody.innerHTML = "";
            
            // é‡å°æ¯å€‹é¸ä¸­çš„è£å‚™ï¼Œç”¢ç”Ÿä¸€è¡Œ (åŒ…å«æ•¸é‡è¼¸å…¥æ¡†)
            selectedItems.forEach(id => {
                const eq = equipmentCache.find(e => e.id === id);
                if (eq && eq.available_qty > 0) {
                    const row = document.createElement('tr');
                    row.className = "border-b border-gray-700 hover:bg-gray-800";
                    row.innerHTML = `
                        <td class="px-2 py-2">
                            <div class="text-white font-bold">${eq.name}</div>
                            <div class="text-xs text-gray-400">${eq.model || ''}</div>
                        </td>
                        <td class="px-2 py-2 text-center text-gray-400">${eq.available_qty}</td>
                        <td class="px-2 py-2 text-center">
                            <input type="number" 
                                   data-id="${eq.id}" 
                                   class="borrow-qty-input w-16 bg-gray-700 text-white p-1 rounded border border-gray-600 text-center focus:border-blue-500" 
                                   value="1" min="1" max="${eq.available_qty}">
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            });
            
            if (tbody.children.length === 0) {
                alert("é¸ä¸­çš„è£å‚™ç›®å‰æ²’æœ‰åº«å­˜å¯å€Ÿ");
                closeModal('batch-borrow-modal');
            }
        }

        // é€å‡ºæ‰¹é‡å€Ÿå‡º
        async function submitBatchBorrow() {
            const borrower = document.getElementById('batch-borrower').value;
            const note = document.getElementById('batch-note').value;
            
            if (!borrower) { alert("è«‹è¼¸å…¥å€Ÿç”¨äººå§“å"); return; }
            
            // è’é›†æ‰€æœ‰è¼¸å…¥æ¡†çš„æ•¸æ“š
            const inputs = document.querySelectorAll('.borrow-qty-input');
            const requests = [];
            
            inputs.forEach(input => {
                const qty = parseInt(input.value);
                const eqId = input.dataset.id;
                
                if (qty > 0) {
                    requests.push({
                        action: 'borrow_equipment',
                        userId: userId,
                        displayName: displayName,
                        eqId: eqId,
                        borrower: borrower,
                        qty: qty, // ğŸ”¥ é€™è£¡å‚³é€å€‹åˆ¥è¨­å®šçš„æ•¸é‡
                        note: note
                    });
                }
            });

            if (requests.length === 0) return;

            toggleLoader(true, `æ­£åœ¨ç™»è¨˜ ${requests.length} ç­†å€Ÿå‡º...`);
            closeModal('batch-borrow-modal');
            
            try {
                // å¹³è¡Œç™¼é€è«‹æ±‚ (Promise.all)
                await Promise.all(requests.map(req => callGasApi(req)));
                alert("âœ… å€Ÿå‡ºæˆåŠŸï¼");
                
                if (isExportMode) toggleExportMode(); // å¦‚æœæ˜¯åœ¨é¸å–æ¨¡å¼ä¸‹ï¼Œæ“ä½œå®Œå°±é—œé–‰
                fetchEquipmentData(false); // åˆ·æ–°åˆ—è¡¨
            } catch (e) {
                alert("éŒ¯èª¤: " + e.message);
            } finally {
                toggleLoader(false);
            }
        }

        // ============================================
        // ğŸ”¥ æ‰¹é‡/å–®ç­† æ­¸é‚„é‚è¼¯ (æ”¯æ´æ•¸é‡é¸æ“‡)
        // ============================================

        // å–®ç­†æ­¸é‚„ (è½‰æ¥åˆ°æ‰¹é‡æ­¸é‚„ä»‹é¢ï¼Œåªé¡¯ç¤ºé€™ä¸€ç­†)
        function openSingleReturnModal(eqId, loanId, qty, borrower) {
            const modal = document.getElementById('batch-return-modal');
            modal.classList.add('flex');
            
            const listDiv = document.getElementById('batch-return-list');
            listDiv.innerHTML = "";
            
            // æ¸²æŸ“å–®ä¸€é …ç›®
            renderReturnItem(listDiv, equipmentCache.find(e => e.id === eqId).name, loanId, qty, borrower);
        }

        // æ‰¹é‡æ­¸é‚„è¦–çª—
        function openBatchReturnModal() {
            if (selectedItems.size === 0) { alert("è«‹å…ˆå‹¾é¸è¦æ­¸é‚„çš„è£å‚™"); return; }
            
            const modal = document.getElementById('batch-return-modal');
            modal.classList.add('flex');
            
            const listDiv = document.getElementById('batch-return-list');
            listDiv.innerHTML = "";

            let hasLoan = false;
            // éæ­·æ‰€æœ‰é¸ä¸­çš„è£å‚™ï¼Œæ‰¾å‡ºæ‰€æœ‰çš„ active_loans
            selectedItems.forEach(id => {
                const eq = equipmentCache.find(e => e.id === id);
                if (eq && eq.active_loans) {
                    eq.active_loans.forEach(l => {
                        hasLoan = true;
                        renderReturnItem(listDiv, eq.name, l.loan_id, l.qty, l.borrower);
                    });
                }
            });

            if (!hasLoan) {
                alert("é¸ä¸­çš„è£å‚™ç›®å‰æ²’æœ‰ä»»ä½•å€Ÿå‡ºç´€éŒ„");
                closeModal('batch-return-modal');
            }
        }

        // æ¸²æŸ“æ­¸é‚„é …ç›®å°å¡ç‰‡ (åŒ…å« Checkbox å’Œ æ•¸é‡è¼¸å…¥)
        function renderReturnItem(container, eqName, loanId, maxQty, borrower) {
            const div = document.createElement('div');
            div.className = "flex items-center justify-between bg-gray-700 p-3 rounded border border-gray-600";
            
            div.innerHTML = `
                <div class="flex items-center gap-3">
                    <input type="checkbox" class="return-checkbox w-5 h-5 rounded text-green-500 focus:ring-green-500" checked data-loan-id="${loanId}">
                    
                    <div class="text-sm">
                        <div class="text-white font-bold">${eqName}</div>
                        <div class="text-gray-300 text-xs">ğŸ‘¤ ${borrower} (å€Ÿ: <span class="text-yellow-400">${maxQty}</span>)</div>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <label class="text-xs text-gray-400">æ­¸é‚„æ•¸:</label>
                    <input type="number" 
                           class="return-qty-input w-16 bg-gray-800 text-white p-1 rounded border border-gray-500 text-center focus:border-green-500" 
                           value="${maxQty}" min="1" max="${maxQty}" data-loan-id="${loanId}">
                </div>
            `;
            container.appendChild(div);
        }

        // é€å‡ºæ‰¹é‡æ­¸é‚„
        async function submitBatchReturn() {
            // æ‰¾å‡ºæ‰€æœ‰è¢«æ‰“å‹¾çš„é …ç›®
            const checkboxes = document.querySelectorAll('.return-checkbox:checked');
            if (checkboxes.length === 0) { alert("è«‹è‡³å°‘å‹¾é¸ä¸€å€‹è¦æ­¸é‚„çš„é …ç›®"); return; }

            const requests = [];
            checkboxes.forEach(cb => {
                const loanId = cb.dataset.loanId;
                // æ‰¾åˆ°å°æ‡‰æ•¸é‡çš„è¼¸å…¥æ¡†
                const qtyInput = document.querySelector(`.return-qty-input[data-loan-id="${loanId}"]`);
                const returnQty = parseInt(qtyInput.value);
                
                if (returnQty > 0) {
                    requests.push({
                        action: 'return_equipment',
                        userId: userId,
                        displayName: displayName,
                        loanId: loanId,
                        returnQty: returnQty // ğŸ”¥ å‚³é€é€™æ¬¡è¦é‚„å¹¾å€‹
                    });
                }
            });

            toggleLoader(true, `æ­£åœ¨æ­¸é‚„ ${requests.length} ç­†...`);
            closeModal('batch-return-modal');

            try {
                await Promise.all(requests.map(req => callGasApi(req)));
                alert("âœ… æ­¸é‚„æˆåŠŸï¼");
                if (isExportMode) toggleExportMode();
                fetchEquipmentData(false);
            } catch (e) {
                alert("éŒ¯èª¤: " + e.message);
            } finally {
                toggleLoader(false);
            }
        }

        // ============================================
        // ğŸ”¥ åŒ¯å‡ºæ¨¡å¼ / å…¨é¸ / è¨ˆæ•¸
        // ============================================
        function toggleExportMode() {
            isExportMode = !isExportMode;
            const btn = document.getElementById('btn-export-mode');
            const toolbar = document.getElementById('export-toolbar');
            
            if (isExportMode) {
                btn.classList.remove('bg-purple-600');
                btn.classList.add('bg-gray-500');
                btn.innerText = "âŒ å–æ¶ˆ";
                toolbar.classList.remove('hidden');
            } else {
                btn.classList.add('bg-purple-600');
                btn.classList.remove('bg-gray-500');
                btn.innerText = "ğŸ“Š åŒ¯å‡º";
                toolbar.classList.add('hidden');
                selectedItems.clear();
                updateExportCount();
            }
            renderEquipmentList();
        }

        function toggleSelect(id) {
            if (selectedItems.has(id)) selectedItems.delete(id);
            else selectedItems.add(id);
            updateExportCount();
        }

        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('#equipment-list input[type="checkbox"]');
            const visibleIds = Array.from(checkboxes).map(cb => cb.getAttribute('onchange').match(/'([^']+)'/)[1]);
            
            if (visibleIds.length === 0) return;
            
            const allSelected = visibleIds.every(id => selectedItems.has(id));
            if (allSelected) {
                visibleIds.forEach(id => selectedItems.delete(id));
            } else {
                visibleIds.forEach(id => selectedItems.add(id));
            }
            renderEquipmentList();
            updateExportCount();
        }

        function updateExportCount() {
            document.getElementById('export-count').innerText = selectedItems.size;
            // æ›´æ–°å…¨é¸æŒ‰éˆ•ç‹€æ…‹
            const btn = document.getElementById('btn-select-all');
            const checkboxes = document.querySelectorAll('#equipment-list input[type="checkbox"]');
            if (checkboxes.length > 0) {
                const visibleIds = Array.from(checkboxes).map(cb => cb.getAttribute('onchange').match(/'([^']+)'/)[1]);
                const allSelected = visibleIds.every(id => selectedItems.has(id));
                if (allSelected) {
                    btn.innerText = "å–æ¶ˆå…¨é¸";
                    btn.classList.replace('bg-gray-700', 'bg-red-600');
                } else {
                    btn.innerText = "å…¨é¸æ­¤é ";
                    btn.classList.replace('bg-red-600', 'bg-gray-700');
                }
            }
        }

        async function confirmExport() {
            if (selectedItems.size === 0) { alert("è«‹è‡³å°‘é¸æ“‡ä¸€é …è£å‚™ï¼"); return; }
            const ids = Array.from(selectedItems);
            toggleLoader(true, `æ­£åœ¨ç”Ÿæˆ ${ids.length} ç­†è³‡æ–™å ±è¡¨...`);
            try {
                const res = await callGasApi({ 
                    action: 'export_equipment_report', 
                    userId: userId, 
                    eqIds: ids 
                });
                if (res.url) {
                    window.open(res.url, '_blank');
                    toggleExportMode();
                } else {
                    alert("åŒ¯å‡ºå¤±æ•—: ç„¡æ³•å–å¾—é€£çµ");
                }
            } catch (e) { alert("åŒ¯å‡ºéŒ¯èª¤: " + e.message); } 
            finally { toggleLoader(false); }
        }

        // ============================================
        // ğŸ”¥ å…¶ä»–èˆŠåŠŸèƒ½ (æ­·å²ç´€éŒ„, ç·¨è¼¯, åˆªé™¤, Report, Query, AI)
        // ============================================
        
        async function fetchHistory() {
            document.getElementById('history-modal').classList.add('flex');
            const list = document.getElementById('history-list');
            list.innerHTML = '<div class="loader"></div>';
            try {
                const data = await callGasApi({ action: 'get_loan_history', userId: userId });
                if (!data || data.length === 0) {
                    list.innerHTML = "<p class='text-center text-gray-500 mt-10'>å°šç„¡æ­·å²ç´€éŒ„</p>";
                } else {
                    list.innerHTML = data.map(l => `
                        <div class="bg-gray-700 p-3 mb-2 rounded border-l-4 ${l.status==='å·²æ­¸é‚„'?'border-green-500':'border-blue-500'} text-sm">
                            <div class="flex justify-between font-bold text-gray-200">
                                <span>${l.item_name}</span> <span>${l.borrower}</span>
                            </div>
                            <div class="flex justify-between text-gray-400 mt-1 text-xs">
                                <span>${l.status} x${l.qty}</span> <span>${l.time}</span>
                            </div>
                        </div>`).join('');
                }
            } catch (e) { list.innerHTML = `<p class="text-red-400 text-center mt-10">è®€å–å¤±æ•—: ${e.message}</p>`; }
        }

        async function fetchItemHistory(id, name) {
             document.getElementById('history-modal').classList.add('flex');
             const list = document.getElementById('history-list');
             list.innerHTML = '<div class="loader"></div>';
             // é€™è£¡æ¨™é¡Œå¯ä»¥æ”¹æˆ name
             try {
                 const data = await callGasApi({ action: 'get_loan_history', userId: userId, eqId: id });
                 list.innerHTML = data && data.length ? data.map(l => `
                    <div class="bg-gray-700 p-3 mb-2 rounded border-l-4 ${l.status==='å·²æ­¸é‚„'?'border-green-500':'border-blue-500'} text-sm">
                        <div class="flex justify-between font-bold text-gray-200"><span>${l.status}</span> <span>${l.borrower}</span></div>
                        <div class="flex justify-between text-gray-400 mt-1 text-xs"><span>æ•¸é‡: ${l.qty}</span> <span>${l.time}</span></div>
                    </div>`).join('') : "<p class='text-center text-gray-500'>å°šç„¡ç´€éŒ„</p>";
             } catch (e) { list.innerHTML = "éŒ¯èª¤"; }
        }

        function openEditModal(mode, id, name, cat, model, loc, total) {
            document.getElementById('edit-eq-modal').classList.add('flex');
            document.getElementById('edit-mode').value = mode;
            const delBtn = document.getElementById('btn-delete-eq');
            
            if (mode === 'create') {
                document.getElementById('edit-modal-title').innerText = "â• æ–°å¢è£å‚™";
                document.getElementById('edit-eq-id').value = "";
                document.getElementById('eq-name').value = "";
                document.getElementById('eq-category').value = "";
                document.getElementById('eq-model').value = "";
                document.getElementById('eq-location').value = "";
                document.getElementById('eq-total').value = 1;
                delBtn.classList.add('hidden');
            } else {
                document.getElementById('edit-modal-title').innerText = "âš™ï¸ ç·¨è¼¯è£å‚™";
                document.getElementById('edit-eq-id').value = id;
                document.getElementById('eq-name').value = name;
                document.getElementById('eq-category').value = cat;
                document.getElementById('eq-model').value = model || "";
                document.getElementById('eq-location').value = loc || "";
                document.getElementById('eq-total').value = total;
                delBtn.classList.remove('hidden');
            }
        }

        async function submitEquipmentEdit() {
            const mode = document.getElementById('edit-mode').value;
            const payload = {
                action: 'manage_equipment',
                userId: userId,
                displayName: displayName,
                mode: mode,
                eqId: document.getElementById('edit-eq-id').value,
                name: document.getElementById('eq-name').value,
                category: document.getElementById('eq-category').value,
                model: document.getElementById('eq-model').value,
                location: document.getElementById('eq-location').value,
                totalQty: document.getElementById('eq-total').value
            };
            if (!payload.name) { alert("åç¨±å¿…å¡«"); return; }
            toggleLoader(true, "å¯«å…¥è³‡æ–™åº«ä¸­...");
            closeModal('edit-eq-modal');
            try {
                const res = await callGasApi(payload);
                if (res.success) {
                    fetchEquipmentData(false);
                } else {
                    alert("âŒ å¤±æ•—: " + res.message);
                }
            } catch (e) { alert("éŒ¯èª¤: " + e.message); } 
            finally { toggleLoader(false); }
        }

        async function deleteEquipment() {
            const name = document.getElementById('eq-name').value;
            if (!confirm(`âš ï¸ è­¦å‘Šï¼šç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€å—ï¼Ÿ`)) return;
            if (!confirm(`ğŸš¨ è«‹å†æ¬¡ç¢ºèªï¼šåˆªé™¤å¾Œå°‡ç„¡æ³•æ¢å¾©ã€‚`)) return;
            toggleLoader(true, "åˆªé™¤è³‡æ–™ä¸­...");
            closeModal('edit-eq-modal');
            try {
                const res = await callGasApi({
                    action: 'manage_equipment',
                    userId: userId,
                    displayName: displayName,
                    mode: 'delete',
                    eqId: document.getElementById('edit-eq-id').value,
                    name: name, category: '', totalQty: 0
                });
                if (res.success) {
                    alert("ğŸ—‘ï¸ " + res.message);
                    fetchEquipmentData(false);
                } else {
                    alert("âŒ å¤±æ•—: " + res.message);
                }
            } catch (e) { alert("éŒ¯èª¤: " + e.message); } 
            finally { toggleLoader(false); }
        }

        // Report & Query & AI Functions (ä¿æŒåŸæ¨£ï¼Œåƒ…å£“ç¸®å±•ç¤º)
        async function showReportPage() { 
            document.getElementById('view-report').classList.remove('hidden');
            /* ... åŸæœ¬çš„ Report é‚è¼¯ ... */
            // ç‚ºäº†ç¯€çœç¯‡å¹…ï¼Œé€™è£¡å‡è¨­ä½ æ²’æœ‰å‹•åˆ°é€™å…©é çš„é‚è¼¯ï¼Œå¦‚æœéœ€è¦æˆ‘ä¹Ÿå¯ä»¥å±•é–‹
            // ä½†ä½ çš„ä¸»è¦éœ€æ±‚æ˜¯ Equipment é é¢ï¼Œé€™è£¡æˆ‘ä¿æŒä½ åŸæœ¬çš„çµæ§‹
            // (è‹¥ç™¼ç¾é€™å…©é å£äº†ï¼Œè«‹å‘Šè¨´æˆ‘ï¼Œæˆ‘æœƒè£œä¸Š)
            const data = await callGasApi({action:'get_my_assignments', userId: userId});
            // ... (æ¸²æŸ“é‚è¼¯åŒå‰)
        }
        async function showQueryPage() {
             document.getElementById('view-query').classList.remove('hidden');
             const data = await callGasApi({action:'get_public_missions'});
             // ... (æ¸²æŸ“é‚è¼¯åŒå‰)
        }
        async function showAiPage() { document.getElementById('view-ai').classList.remove('hidden'); }
        async function askAI(mode) { /* ... */ }
        function safeExecute(btn, fn) { /* ... */ }

        // å•Ÿå‹•ä¸»ç¨‹å¼
        main();
    </script>
</body>
</html>
