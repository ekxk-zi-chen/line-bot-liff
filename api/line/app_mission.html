<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èŠ±è“®ç‰¹æœæˆ°æƒ…ä¸­å¿ƒ</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a1a">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="èŠ±æœæˆ°æƒ…">
    <link rel="apple-touch-icon" href="icon-192.png"> <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* =========================================
           1. å…¨å±€ä½ˆå±€ (é‡‹æ”¾åŸç”Ÿæ»¾å‹•ï¼Œè®“æ‰‹æ©Ÿç•«é¢æœ€å¤§åŒ–)
           ========================================= */
        body { 
            background-color: #1a1a1a; 
            color: #e0e0e0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            /* ğŸ”¥ é—œéµï¼šåˆªé™¤ height: 100vh å’Œ overflow: hiddenï¼Œè®“ç¶²é è‡ªç„¶å¾€ä¸‹é•· */
            margin: 0;
            padding: 0; 
            /* é˜²æ­¢ iOS å·¦å³æ»‘å‹•çš„æ©¡çš®ç­‹æ•ˆæ‡‰ï¼Œä½†ä¸é™åˆ¶ä¸Šä¸‹ */
            overflow-x: hidden; 
        }

        /* é ‚éƒ¨å›ºå®šå€ (Header + ç¯©é¸å™¨) */
        #top-fixed-area {
            /* ğŸ”¥ é—œéµï¼šé»æ€§å®šä½ï¼Œå¾€ä¸‹æ»‘æ™‚è‡ªå‹•å¸é™„åœ¨è¢å¹•æœ€ä¸Šæ–¹ï¼Œä¸æœƒè¢«æ²èµ° */
            position: sticky;
            top: 0;
            z-index: 40;
            background-color: #1a1a1a; /* ç¢ºä¿æ»‘å‹•æ™‚èƒŒæ™¯ä¸æœƒé€æ˜é‡ç–Š */
            /* åŠ ä¸Šä¸€é»æŸ”å’Œçš„é™°å½±ï¼Œè®“å¾€ä¸‹æ»‘æ™‚æ¨™é¡Œå€æ›´æœ‰ç«‹é«”æ„Ÿ */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            padding-top: 15px; /* ä¾ç…§æ‚¨åŸæœ¬çš„é ‚éƒ¨é–“è· */
            padding-left: 15px;
            padding-right: 15px;
        }

        /* åˆ—è¡¨å…§å®¹å€ */
        #scrollable-content {
            /* ğŸ”¥ æ”¾æ£„å…§éƒ¨çš„è‡ªå‹•æ»¾å‹•ï¼Œå…¨éƒ¨äº¤çµ¦ body åŸç”Ÿæ»¾å‹• */
            overflow: visible; 
            padding-left: 15px;
            padding-right: 15px;
            padding-bottom: 120px; /* ç•™å‡ºè¶³å¤ çš„åº•éƒ¨ç©ºé–“ï¼Œé¿å…æœ€å¾Œä¸€å¼µå¡ç‰‡è¢«ã€ŒåŒ¯å‡º/å€Ÿå‡ºã€å¤§æŒ‰éˆ•æ“‹ä½ */
        }

        /* å…§å®¹æ²å‹•å€ (åªæœ‰é€™è£¡å¯ä»¥æ»‘å‹•) */
        #content-area {
            flex-grow: 1; /* ä½”æ»¿å‰©é¤˜ç©ºé–“ */
            overflow-y: auto; /* å‚ç›´æ²å‹• */
            padding: 16px; /* åŸæœ¬ body çš„ p-4 ç§»åˆ°é€™è£¡ */
            padding-bottom: 120px; /* é ç•™çµ¦åº•éƒ¨å·¥å…·åˆ—çš„ç©ºé–“ */
            scroll-behavior: smooth;
        }

        /* =========================================
           2. æ–°ç‰ˆè† å›Šç¯©é¸å™¨ (Chip/Pill Styles)
           ========================================= */
        /* æ©«å‘æ»‘å‹•å®¹å™¨ */
        .filter-row {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 4px 16px;
            white-space: nowrap;
            -ms-overflow-style: none;
            scrollbar-width: none;
            /* ğŸ”¥ æ–°å¢é€™è¡Œï¼šè®“æ¸¸æ¨™è®Šæˆå¯ä»¥æŠ“å–çš„å°æ‰‹ */
            cursor: grab;
        }
        /* ğŸ”¥ æ–°å¢é€™å€‹æ¨£å¼ï¼šæŒ‰ä¸‹å»çš„æ™‚å€™è®Šæˆã€Œç·Šæ¡ã€çš„å°æ‰‹ */
        .filter-row:active {
            cursor: grabbing;
        }
        .filter-row::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        /* è† å›ŠæŒ‰éˆ•æœ¬é«” */
        .btn-chip {
            background-color: #333;
            color: #aaa;
            padding: 6px 14px;
            border-radius: 9999px; /* åœ“å½¢è† å›Š */
            font-size: 13px;
            font-weight: 500;
            border: 1px solid #444;
            transition: all 0.2s;
            flex-shrink: 0; /* é˜²æ­¢è¢«æ“ å£“ */
        }
        
        /* é¸ä¸­ç‹€æ…‹ */
        .btn-chip.active {
            background-color: #ca8a04; /* é»ƒè‰² */
            color: white;
            border-color: #ca8a04;
            box-shadow: 0 0 8px rgba(202, 138, 4, 0.4);
        }

        /* =========================================
           3. å…±ç”¨å…ƒä»¶ (Legacy Components)
           ========================================= */
        .card { 
            background-color: #2d2d2d; 
            border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 12px; 
            border-left: 5px solid #4CAF50; 
        }

        /* æŒ‰éˆ•é€šç”¨æ¨£å¼ */
        .btn { 
            width: 100%; 
            padding: 12px; 
            border-radius: 8px; 
            font-weight: bold; 
            margin-top: 8px; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        .btn:active { transform: scale(0.98); }
        .btn-green { background-color: #4CAF50; color: white; border: none; }
        .btn-red { background-color: #f44336; color: white; border: none; }
        .btn-blue { background-color: #2196F3; color: white; border: none; }
        
        /* èˆŠç‰ˆç¯©é¸æŒ‰éˆ• (è‹¥é‚„æœ‰ç”¨åˆ°çš„è©±) */
        .btn-filter { transition: all 0.2s; }
        .btn-filter.active { background-color: #ca8a04; color: white; }

        /* è¼¸å…¥æ¡†å„ªåŒ– */
        .input-dark { 
            width: 100%; 
            background-color: #374151; 
            color: white; 
            padding: 10px 14px; 
            border-radius: 20px; /* è®Šåœ“ä¸€é»æ¯”è¼ƒå¥½çœ‹ */
            border: 1px solid #4b5563; 
            outline: none; 
            font-size: 14px;
        }
        .input-dark:focus { border-color: #f59e0b; background-color: #4b5563; }

        /* å·¥å…·é¡ */
        .hidden { display: none !important; }
        .loader { border: 4px solid #333; border-top: 4px solid #4CAF50; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* =========================================
           4. ä»»å‹™çœ‹æ¿å°ˆç”¨ (Mission Board)
           ========================================= */
        .mission-detail { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.3s ease-out; 
            background-color: #333; 
            border-radius: 0 0 12px 12px; 
        }
        .mission-detail.open { 
            max-height: 800px; 
            border-top: 1px solid #444; 
        }
        .line-clamp-3 { 
            display: -webkit-box; 
            -webkit-line-clamp: 3; 
            line-clamp: 3; 
            -webkit-box-orient: vertical; 
            overflow: hidden; 
        }

        /* =========================================
           5. æ²è»¸èˆ‡å½ˆçª— (Modals & Scrollbars)
           ========================================= */
        /* è‡ªå®šç¾©æ²è»¸ */
        .custom-scrollbar::-webkit-scrollbar { height: 4px; width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #555; border-radius: 2px; }
        
        /* å½ˆçª—èƒŒæ™¯ */
        .modal-overlay { 
            position: fixed; 
            inset: 0; 
            background-color: rgba(0,0,0,0.9); 
            display: none; 
            align-items: center; 
            justify-content: center; 
            z-index: 50; 
            padding: 1rem; 
        }
        .modal-overlay.flex { display: flex !important; }
        
        /* æ‰¹æ¬¡æ“ä½œè¡¨æ ¼ */
        .batch-table th { 
            position: sticky; 
            top: 0; 
            background: #374151; 
            color: #ddd; 
            padding: 8px; 
            text-align: left; 
        }
        .batch-table td { 
            border-bottom: 1px solid #4b5563; 
            padding: 8px; 
            color: #eee; 
        }

        /* =========================================
           6. å±±è±¬ç‰¹æœå‹•ç•« (Loading Animation)
           ========================================= */
        #boar-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.9); 
            z-index: 9999; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
        }
        .boar-scene { 
            font-size: 60px; 
            margin-bottom: 20px; 
            animation: bounce 1s infinite alternate; 
        }
        .boar-text { 
            color: #4CAF50; 
            font-weight: bold; 
            font-size: 1.2rem; 
            animation: pulse 1.5s infinite; 
        }
        @keyframes bounce { 0% { transform: translateY(0); } 100% { transform: translateY(-10px); } }
    </style>
</head>
<body class="p-4">

    <div id="login-screen" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-[100] px-4 overflow-y-auto pt-10 pb-10">
        <div class="w-full max-w-md bg-gray-800 p-6 rounded-2xl shadow-2xl border border-gray-700">
            <div class="text-center mb-6">
                <div class="text-4xl mb-2">ğŸš’</div>
                <h1 class="text-xl font-bold text-white tracking-wider">èŠ±è“®ç‰¹æœæˆ°æƒ…ä¸­å¿ƒ</h1>
            </div>

            <div class="flex mb-6 bg-gray-900 p-1 rounded-lg border border-gray-700 text-center">
                <button onclick="switchAuthTab('login')" id="tab-login" class="flex-1 py-2 rounded-md text-sm font-bold transition-all bg-indigo-600 text-white">ç™»å…¥</button>
                <button onclick="switchAuthTab('bind')" id="tab-bind" class="flex-1 py-2 rounded-md text-sm font-bold transition-all text-gray-400">ä¿¡ç®±ç¶å®š</button>
                <button onclick="switchAuthTab('signup')" id="tab-signup" class="flex-1 py-2 rounded-md text-sm font-bold transition-all text-gray-400">è¨»å†Šç”³è«‹</button>
            </div>

            <div id="form-login" class="space-y-4">
                <input type="email" id="login-email" placeholder="é›»å­ä¿¡ç®±" class="input-dark py-3">
                <input type="password" id="login-password" placeholder="å¯†ç¢¼" class="input-dark py-3">
                <button onclick="handleLogin()" id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg mt-2">å®‰å…¨ç™»å…¥</button>
            </div>

            <div id="form-bind" class="hidden space-y-4">
                <div class="text-xs text-yellow-400 bg-yellow-900/30 p-2 rounded border border-yellow-700 mb-2">
                    ğŸ’¡ è€éšŠå“¡è«‹è¼¸å…¥æ‚¨åœ¨ç³»çµ±ç™»è¨˜çš„ä¿¡ç®±ï¼Œä¸¦è¨­å®š App ç™»å…¥å¯†ç¢¼ä»¥å®Œæˆç¶å®šã€‚
                </div>
                <input type="email" id="bind-email" placeholder="è¼¸å…¥å·²ç™»è¨˜çš„é›»å­ä¿¡ç®±" class="input-dark py-3">
                
                <div class="grid grid-cols-2 gap-2">
                    <input type="password" id="bind-password" placeholder="è¨­å®šå¯†ç¢¼ (è‡³å°‘6ç¢¼)" class="input-dark py-3 text-sm">
                    <input type="password" id="bind-confirm" placeholder="ç¢ºèªå¯†ç¢¼" class="input-dark py-3 text-sm">
                </div>

                <button onclick="handleBind()" id="bind-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg mt-2">ç¢ºèªç¶å®š</button>
            </div>

            <div id="form-signup" class="hidden space-y-3">
                <div class="grid grid-cols-2 gap-2">
                    <input type="email" id="reg-email" placeholder="é›»å­ä¿¡ç®±" class="input-dark text-sm">
                    <input type="text" id="reg-name" placeholder="çœŸå¯¦å§“å" class="input-dark text-sm">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <input type="password" id="reg-password" placeholder="è¨­å®šå¯†ç¢¼" class="input-dark text-sm">
                    <input type="password" id="reg-confirm" placeholder="ç¢ºèªå¯†ç¢¼" class="input-dark text-sm">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <select id="reg-unit" onchange="toggleOtherUnit()" class="input-dark text-sm bg-gray-700">
                        <option value="">è¼‰å…¥å–®ä½ä¸­...</option>
                    </select>
                    <input type="text" id="reg-title" placeholder="è·ç¨± (å¦‚éšŠå“¡)" class="input-dark text-sm">
                </div>
                <input type="text" id="reg-unit-other" placeholder="ğŸ‘‰ è«‹è¼¸å…¥å–®ä½åç¨±" class="input-dark hidden text-sm border-indigo-500">
                <input type="tel" id="reg-phone" placeholder="é€£çµ¡é›»è©±" class="input-dark text-sm">
                <textarea id="reg-note" placeholder="ç”³è«‹å‚™è¨»" class="input-dark text-sm h-16 py-2"></textarea>
                
                <button onclick="handleRealSignUp()" id="signup-btn" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg mt-2">æäº¤æ–°è¨»å†Š</button>
            </div>
        </div>
    </div>

    <div id="boar-overlay" class="hidden"><div id="boar-anim" class="boar-scene">ğŸ—</div><p id="boar-text" class="boar-text">è³‡æ–™è™•ç†ä¸­...</p></div>
    <div id="header" class="mb-3 text-center">
        <h1 class="text-xl font-bold text-green-400 mb-1">ğŸš’ èŠ±è“®ç‰¹æœè¡Œå‹•ç³»çµ±</h1>
        
        <div class="relative flex justify-center items-center h-6">
            <div class="flex items-center gap-2">
                <p id="user-info" class="text-sm text-gray-400">è­˜åˆ¥ä¸­...</p>
                <button onclick="handleLogout()" class="bg-red-900/60 hover:bg-red-800 text-red-300 px-2 py-0.5 rounded border border-red-700 text-xs transition-colors">ç™»å‡º</button>
            </div>
            
            <select id="custodian-filter" onchange="switchCustodian(this.value)" class="absolute right-0 bg-gray-800 text-indigo-300 text-xs py-1 px-1 rounded border border-indigo-700 outline-none max-w-[100px]">
                <option value="All">æ‰€æœ‰ğŸ›¡ï¸</option>
            </select>
        </div>
    </div>
    
    <div id="loader" class="loader"></div>
    
    <div id="view-report" class="hidden"><h2 class="text-lg font-bold mb-2">ğŸ“ æ‚¨çš„ä»»å‹™å›å ±</h2><div id="report-list"></div></div>
    <div id="view-query" class="hidden"><h2 class="text-lg font-bold mb-2">ğŸ” é€²è¡Œä¸­ä»»å‹™çœ‹æ¿</h2><div id="query-list"></div></div>
    
    <div id="view-ai" class="hidden">
        <h2 class="text-lg font-bold mb-2">ğŸ¤– AI æˆ°æƒ…/ç°¡å ±ä¸­å¿ƒ</h2>
        <div class="bg-gray-800 p-3 rounded mb-3 border border-gray-700">
            <p class="text-sm text-gray-400 mb-1">è«‹è¼¸å…¥ç›®æ¨™</p><input type="text" id="ai-input" class="input-dark" placeholder="ä¾‹å¦‚: åœŸè€³å…¶...">
        </div>
        <div class="flex gap-2 mb-3"><button onclick="safeExecute(this, () => askAI('text'))" class="btn btn-blue flex-1">ğŸ’¬ åˆ†æ</button><button onclick="safeExecute(this, () => askAI('ppt'))" class="btn btn-red flex-1">ğŸ“Š ç°¡å ±</button></div>
        <a href="https://drive.google.com/drive/folders/1XAtHLGeo2fQH3wO5Lfq5_IjunbkIqzn_" target="_blank" class="btn block text-center mb-4" style="background-color: #FF9800; color: white;">ğŸ“‚ é–‹å•Ÿæ­¸æª”</a>
        <div id="ai-response" class="mt-4 p-4 bg-gray-800 rounded border-l-4 border-green-500 hidden"></div>
    </div>
    
    <div id="view-equipment" class="hidden h-full flex flex-col">
        
        <div id="top-fixed-area" class="pb-1 bg-gray-900 border-b border-gray-800">
            
            <div class="flex justify-between items-center px-4 py-2">
                <div class="flex items-center gap-2">
                    <h2 class="text-base font-bold text-yellow-400">ğŸ’ è£å‚™</h2>
                    <button onclick="toggleFilterPanel()" id="btn-toggle-filter" class="text-xs bg-gray-800 text-gray-400 border border-gray-600 px-2 py-1 rounded flex items-center gap-1 transition-colors">
                        <span>ğŸ”</span> ç¯©é¸
                    </button>
                </div>
                
                <div class="flex gap-2">
                    <select id="status-filter" onchange="renderEquipmentList()" class="bg-gray-800 text-gray-300 text-xs py-1 px-1 rounded border border-gray-700 outline-none max-w-[80px]">
                        <option value="All">å…¨éƒ¨</option>
                        <option value="Borrowed">å€Ÿå‡º</option>
                        <option value="InStock">åœ¨éšŠ</option>
                        <option value="Repair">ç¶­ä¿®ä¸­</option>
                    </select>

                    <button onclick="fetchHistory()" class="text-xs text-blue-400 border border-blue-400 px-2 py-1 rounded">ğŸ“œ</button>
                    
                    <button onclick="fetchEquipmentData(true)" class="text-xs text-green-400 border border-green-400 px-2 py-1 rounded">ğŸ”„</button>
                    
                </div>
            </div>

            <div id="collapsible-filters" class="transition-all duration-300 overflow-hidden" style="max-height: 0px; opacity: 0;">
                <div class="px-4 pb-2">
                    <input type="text" id="eq-search" oninput="renderEquipmentList()" class="input-dark w-full text-xs" placeholder="ğŸ” æœå°‹è£å‚™åç¨±ã€å‹è™Ÿ...">
                </div>
                
                <div id="category-filter-container" class="filter-row"></div>
                
                <div id="subcategory-filter-container" class="filter-row hidden"></div> 
                
                <div id="location-filter-container" class="filter-row hidden"></div>
                
                <div id="note-filter-container" class="filter-row hidden"></div>
                <div class="h-2"></div> 
            </div>
        </div>

        <div id="content-area">
            <div class="flex gap-2 mb-2">
                <button onclick="toggleExportMode()" id="btn-export-mode" class="flex-1 bg-purple-600/90 text-white py-2 rounded-lg font-bold text-sm shadow transition-all hover:bg-purple-600 flex items-center justify-center gap-1">
                    <span>ğŸ“Š</span> æ‰¹é‡/åŒ¯å‡º
                </button>
                
                <button id="btn-add-eq" onclick="openEditModal('create')" class="hidden w-1/4 bg-yellow-600 text-white border border-yellow-500 py-2 rounded-lg font-bold text-sm shadow hover:bg-yellow-500 transition-all whitespace-nowrap">
                    +æ–°å¢
                </button>
            </div>

            <div id="equipment-list" class="space-y-2 pb-20"></div>
        </div>
        
        <div id="export-toolbar" class="hidden fixed bottom-4 left-4 right-4 bg-gray-900 border border-purple-500 p-3 rounded-lg shadow-2xl z-40 flex flex-col gap-3">
            <div class="flex justify-between items-center border-b border-gray-700 pb-2"><div class="text-white text-sm">å·²é¸ <span id="export-count" class="text-yellow-400 font-bold text-lg">0</span> é …</div><button id="btn-select-all" onclick="toggleSelectAll()" class="bg-gray-700 text-white px-3 py-1 rounded text-xs">å…¨é¸</button></div>
            <div class="flex gap-2">
                <button id="btn-batch-borrow" onclick="openBatchBorrowModal()" class="hidden flex-1 bg-blue-600 text-white py-2 rounded font-bold text-sm shadow">æ‰¹é‡å€Ÿå‡º</button>
                <button id="btn-batch-return" onclick="openBatchReturnModal()" class="hidden flex-1 bg-green-600 text-white py-2 rounded font-bold text-sm shadow">æ‰¹é‡æ­¸é‚„</button>
                <button onclick="confirmExport()" class="flex-1 bg-purple-600 text-white py-2 rounded font-bold text-sm shadow">åŒ¯å‡º</button>
            </div>
        </div>
    </div>

    <div id="batch-borrow-modal" class="modal-overlay"><div class="bg-gray-800 p-5 rounded-lg w-full max-w-md border border-blue-500 flex flex-col max-h-[90vh]">
        <h3 class="text-xl font-bold mb-4 text-blue-400">ğŸ“¦ å€Ÿå‡ºè£å‚™</h3>
        <div class="mb-3"><label class="block text-gray-400 text-sm mb-1">å€Ÿç”¨äºº (å¿…å¡«)</label><input type="text" id="batch-borrower" class="input-dark"></div>
        <div class="mb-3 flex gap-4 border-b border-gray-700 pb-2">
            <label class="flex items-center text-gray-200 text-sm cursor-pointer font-bold">
                <input type="radio" name="borrow_mode" value="borrow" checked onchange="toggleBorrowMode()" class="mr-2 w-4 h-4">
                ä¸€èˆ¬å€Ÿå‡º
            </label>
            <label class="flex items-center text-orange-400 text-sm cursor-pointer font-bold">
                <input type="radio" name="borrow_mode" value="repair" onchange="toggleBorrowMode()" class="mr-2 w-4 h-4 accent-orange-500">
                è£å‚™å ±ä¿®
            </label>
        </div>

        <div id="borrow-fields" class="mb-3 flex gap-2">
            <div class="flex-1">
                <label class="block text-gray-400 text-sm mb-1">ç”¨é€”</label>
                <input type="text" id="batch-note" list="note-suggestions" class="input-dark" placeholder="ä¾‹å¦‚: é›ªè¨“">
            </div>
            <div class="flex-1">
                <label class="block text-gray-400 text-sm mb-1">è©³ç´°è£œè¿°</label>
                <input type="text" id="batch-note2" class="input-dark" placeholder="ä¾‹å¦‚: XL / ç´…è‰²">
            </div>
        </div>

        <div id="repair-fields" class="mb-3 hidden">
            <label class="block text-orange-400 text-sm mb-1">ç¶­ä¿®åŸå›  (å¿…å¡«)</label>
            <input type="text" id="batch-repair-note" class="input-dark border-orange-500 focus:border-orange-400" placeholder="ä¾‹å¦‚: è¢å¹•ç ´è£‚, æ‹‰éŠæå£...">
        </div>
        <div class="flex-1 overflow-y-auto custom-scrollbar mb-2 border-t border-b border-gray-700 py-2 bg-gray-900 px-2">
            <table class="w-full text-sm text-left text-gray-400 batch-table"><thead><tr><th class="w-1/2">è£å‚™</th><th class="text-center">åº«å­˜</th><th class="w-20 text-center">æ•¸é‡</th></tr></thead><tbody id="batch-borrow-list"></tbody></table>
        </div>

        <div class="flex justify-between items-center mb-2">
            <button onclick="hideBorrowModal()" class="bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-1.5 rounded-lg text-xs shadow-md border border-gray-600">ğŸ” ç¸®å° / é¸æ“‡æ›´å¤š</button>
            <button onclick="addToBorrowQueue()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-1.5 rounded-lg text-xs font-bold shadow-md transition-all">â• åŠ å…¥é€™ç­†åå–®</button>
        </div>

        <div id="borrow-queue-area" class="hidden mb-4 bg-gray-900 rounded-lg p-2 border border-gray-600 max-h-32 overflow-y-auto custom-scrollbar">
            <div class="text-xs text-gray-400 mb-1 font-bold">ğŸ“‹ å¾…é€å‡ºæ¸…å–®ï¼š</div>
            <div id="borrow-queue-list" class="space-y-1"></div>
        </div>

        <div class="flex gap-2 mt-2">
            <button onclick="cancelBatchBorrow()" class="flex-1 bg-red-900/40 text-red-300 border border-red-800 py-2 rounded font-bold">æ”¾æ£„ä¸¦æ¸…ç©º</button>
            <button onclick="submitBatchBorrow()" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold">ç¢ºèªé€å‡º</button>
        </div>
    </div></div>

    <div id="batch-return-modal" class="modal-overlay"><div class="bg-gray-800 p-5 rounded-lg w-full max-w-md border border-green-500 flex flex-col max-h-[90vh]">
        <h3 class="text-xl font-bold mb-2 text-green-400">â™»ï¸ æ­¸é‚„è£å‚™</h3>
        <p class="text-xs text-gray-400 mb-4">è«‹å‹¾é¸ä¸¦ç¢ºèªæ­¸é‚„æ•¸é‡ã€‚</p>
        <div class="flex-1 overflow-y-auto custom-scrollbar mb-4 bg-gray-900 rounded p-2"><div id="batch-return-list" class="space-y-3"></div></div>
        <div class="flex gap-2"><button onclick="closeModal('batch-return-modal')" class="flex-1 bg-gray-600 text-white py-2 rounded">å–æ¶ˆ</button><button onclick="submitBatchReturn()" class="flex-1 bg-green-600 text-white py-2 rounded font-bold">ç¢ºèª</button></div>
    </div></div>

    <div id="edit-eq-modal" class="modal-overlay">
        <div class="bg-gray-800 p-5 rounded-lg w-full max-w-md border border-yellow-600 flex flex-col max-h-[90vh]">
            <h3 id="edit-modal-title" class="text-xl font-bold mb-4 text-yellow-400">æ–°å¢</h3>
            <input type="hidden" id="edit-eq-id"><input type="hidden" id="edit-mode">
            
            <div class="space-y-3 mb-4">
                <input type="text" id="eq-name" class="input-dark" placeholder="åç¨± (ä¾‹å¦‚: ä¸»ç¹©)">
                
                <div class="flex gap-2">
                    <div class="flex-1">
                        <input type="text" id="eq-category" list="category-options" class="input-dark" placeholder="åˆ†é¡">
                        <datalist id="category-options"></datalist>
                    </div>
                    <div class="flex-1">
                        <input type="text" id="eq-sub-category" list="subcategory-options" class="input-dark" placeholder="ç´°é …">
                        <datalist id="subcategory-options"></datalist>
                    </div>
                </div>
                
                <input type="text" id="eq-model" class="input-dark" placeholder="å‹è™Ÿ/è¦æ ¼">
                
                <div class="flex gap-2">
                    <div class="flex-1">
                        <input type="text" id="eq-location" list="location-options" class="input-dark" placeholder="å­˜æ”¾ä½ç½®">
                        <datalist id="location-options"></datalist>
                    </div>
                    <div class="flex-1">
                        <input type="text" id="eq-custodian" list="custodian-options" class="input-dark" placeholder="ğŸ›¡ï¸ ä¿ç®¡äºº (é¸å¡«)">
                        <datalist id="custodian-options"></datalist> </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <label class="text-gray-400 w-20">ç¸½é‡:</label>
                    <input type="number" id="eq-total" class="input-dark flex-1" value="1" min="1">
                </div>
            </div>

            <div id="batch-add-area" class="hidden flex-1 flex flex-col min-h-0 border-t border-gray-700 pt-2">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs text-gray-400">å¾…æ–°å¢æ¸…å–®</span>
                    <button onclick="addToPreBatch()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold">â¬‡ï¸ åŠ å…¥æš«å­˜</button>
                </div>
                <div class="flex-1 overflow-y-auto overflow-x-auto custom-scrollbar bg-gray-900 rounded p-2">
                    <table class="w-full text-left batch-table whitespace-nowrap">
                        <thead>
                            <tr>
                                <th>åç¨±</th>
                                <th>ç´°é …</th> 
                                <th>è¦æ ¼</th> <th>ä½ç½®</th>
                                <th>ä¿ç®¡äºº</th> 
                                <th>é‡</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="pre-batch-list"></tbody>
                    </table>
                </div>
            </div>

            <div class="flex gap-2 mt-4 pt-2 border-t border-gray-700">
                <button id="btn-delete-eq" onclick="deleteEquipment()" class="hidden bg-red-600 text-white px-3 py-2 rounded font-bold">ğŸ—‘ï¸</button>
                <button onclick="closeModal('edit-eq-modal')" class="flex-1 bg-gray-600 text-white py-2 rounded">å–æ¶ˆ</button>
                
                <button id="btn-save-edit" onclick="submitEquipmentEdit()" class="flex-1 bg-yellow-600 text-white py-2 rounded font-bold">å„²å­˜ä¿®æ”¹</button>
                
                <button id="btn-submit-batch" onclick="submitBatchAdd()" class="hidden flex-1 bg-green-600 text-white py-2 rounded font-bold">âœ… ç¢ºèªæ‰¹é‡é€å‡º</button>
            </div>
        </div>
    </div>

    <div id="repair-modal" class="modal-overlay">
        <div class="bg-gray-800 p-5 rounded-lg w-full max-w-md border border-orange-500 flex flex-col">
            <h3 class="text-xl font-bold mb-4 text-orange-400">ğŸ”§ è£å‚™å ±ä¿®</h3>
            <input type="hidden" id="repair-eq-id">
            <div class="mb-3">
                <label class="block text-gray-400 text-sm mb-1">ç¶“æ‰‹äºº / è² è²¬äºº</label>
                <input type="text" id="repair-user" class="input-dark" readonly>
            </div>
            <div class="mb-3">
                <label class="block text-gray-400 text-sm mb-1">ç¶­ä¿®åŸå›  (å¿…å¡«)</label>
                <input type="text" id="repair-reason" class="input-dark" placeholder="ä¾‹å¦‚: è¢å¹•ç ´è£‚...">
            </div>
            <div class="mb-4">
                <label class="block text-gray-400 text-sm mb-1">æ•¸é‡</label>
                <input type="number" id="repair-qty" class="input-dark text-center" value="1" min="1">
            </div>
            <div class="flex gap-2">
                <button onclick="closeModal('repair-modal')" class="flex-1 bg-gray-600 text-white py-2 rounded">å–æ¶ˆ</button>
                <button onclick="submitRepair()" class="flex-1 bg-orange-600 text-white py-2 rounded font-bold">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <div id="history-modal" class="modal-overlay"><div class="bg-gray-800 p-4 rounded-lg w-full max-w-md border border-blue-500 h-4/5 flex flex-col"><div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2"><h3 class="text-xl font-bold text-blue-400">ğŸ“œ æ­·å²ç´€éŒ„</h3><button onclick="closeModal('history-modal')" class="text-2xl text-gray-400">&times;</button></div><div id="history-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-2"></div></div></div>

    <div id="details-modal" class="fixed inset-0 bg-black/80 hidden justify-center items-end z-[60]">
        <div class="bg-gray-900 w-full h-[98vh] rounded-t-2xl p-3 flex flex-col relative border-t border-gray-700 shadow-2xl pb-4">
            
            <div class="flex justify-between items-start mb-2 shrink-0">
                <div>
                    <h2 id="details-name" class="text-xl font-bold text-white leading-tight">è¼‰å…¥ä¸­...</h2>
                    <div id="details-custodian" class="text-indigo-300 text-xs mt-1 font-bold hidden">ğŸ›¡ï¸ ä¿ç®¡äºº: </div>
                </div>
                <button onclick="closeModal('details-modal')" class="bg-gray-800 hover:bg-gray-700 text-gray-400 p-1.5 rounded-full shrink-0 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="flex justify-around items-center mb-2 shrink-0 bg-gray-800 py-1.5 px-2 rounded-lg border border-gray-700 text-sm">
                <div class="text-gray-400">ç¸½æ•¸: <span id="details-total" class="font-bold text-white text-base ml-1">0</span></div>
                <div class="w-px h-4 bg-gray-600"></div>
                <div class="text-gray-400">å‰©é¤˜: <span id="details-avail" class="font-bold text-yellow-400 text-base ml-1">0</span></div>
            </div>

            <div id="details-img-container" class="flex-1 overflow-hidden bg-black rounded-xl border border-gray-700 relative flex items-center justify-center">
                <div id="details-img-loading" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500">
                    <svg class="animate-spin h-8 w-8 mb-2 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span class="text-xs tracking-widest">è¼‰å…¥ä¸­</span>
                </div>
                <img id="details-image" class="absolute inset-0 w-full h-full object-contain hidden z-10">
                <div id="details-img-error" class="hidden absolute inset-0 flex items-center justify-center text-gray-500 text-sm">
                    å°šç„¡åœ–ç‰‡è³‡è¨Š
                </div>
                <div id="details-img-counter" class="hidden absolute bottom-3 bg-black/60 text-white text-xs font-bold px-3 py-1 rounded-full z-20 backdrop-blur-sm pointer-events-none">
                    1 / 3
                </div>
            </div>
            
            <div class="shrink-0 mt-3">
                <button onclick="closeModal('details-modal')" class="w-full bg-gray-700 hover:bg-gray-600 text-white py-2.5 rounded-xl font-bold text-base tracking-widest border border-gray-600 shadow-lg transition-transform active:scale-95">é—œ é–‰</button>
            </div>
        </div>
    </div>

    <datalist id="note-suggestions"><option value="é›ªè¨“"><option value="ç¹©ç´¢è¨“ç·´"><option value="å‹•å“¡è¨“ç·´"><option value="å±±åŸŸæœæ•‘"></datalist>

    <script>
        const GAS_API_URL = "https://line-bot-liff-lovat.vercel.app/api/webhook"; // ä¿ç•™çµ¦ PDF è·Ÿ AI ç”¨çš„
        
        // ğŸ”¥ 1. åˆå§‹åŒ– Supabase å¼•æ“ (è«‹å¡«å…¥ä½ çš„å°ˆæ¡ˆç¶²å€è·Ÿ ANON KEY)
        const SUPABASE_URL = 'https://gltzwtqcrdpdumzitbib.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdsdHp3dHFjcmRwZHVteml0YmliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNzQyODcsImV4cCI6MjA3Mjk1MDI4N30.6svHYwJUM8aZF71pY0N3Wx4KiaSMN-GiibyLGZDsygE';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); // <--- æ”¹åäº†

        let userId="", userEmail="", displayName="", equipmentCache=[], currentCustodian='All', isExportMode=false, selectedItems=new Set(), loaderInterval;
        let activeCats = new Set(); let activeSubCats = new Set(); let activeLocs = new Set(); let activeNotes = new Set();
        let isUserAdmin = false; let pendingBatchItems = []; let pendingBorrowRequests = [];
        let currentImageArray = []; let currentImageIndex = 0; let swipeStartX = 0;

        // ã€App å°ˆç”¨ä»‹é¢å¡ã€‘: åŸå°ä¸å‹•æŠŠå¤§åŒ…è£¹ä¸Ÿçµ¦ Supabase çš„ RPC
        window.submitToBackend = async function(payload) {
            return await callGasApi(payload);
        };

        // --- å…¨åŸŸå·¥å…·å‡½æ•¸ ---
        function toggleLoader(show, text="è™•ç†ä¸­...") {
            const el = document.getElementById('boar-overlay'), txt = document.getElementById('boar-text'), anim = document.getElementById('boar-anim');
            if(show) { el.classList.remove('hidden'); txt.innerText=text; const icons=['ğŸ—ğŸ’¨','ğŸ—ğŸ“¦','ğŸ—ğŸ“','ğŸ—âœ…']; let i=0; if(loaderInterval) clearInterval(loaderInterval); loaderInterval=setInterval(()=>{ anim.innerText=icons[i++%icons.length]; },500); }
            else { el.classList.add('hidden'); if(loaderInterval) clearInterval(loaderInterval); }
        }

        // ğŸ”¥ 2. æ™ºæ…§è·¯ç”±å™¨ï¼šè‡ªå‹•åˆ¤æ–·è¦ç›´é€£ Supabase é‚„æ˜¯å»å‘¼å« GAS
        async function callGasApi(payload) {
            const action = payload.action;
            const rpcActions = ['get_equipment_list', 'manage_equipment', 'borrow_equipment', 'return_equipment', 'get_loan_history', 'batch_borrow_equipment', 'batch_return_equipment'];

            if (rpcActions.includes(action)) {
                let rpcParams = {};
                if (action === 'get_equipment_list') rpcParams = { p_category_filter: payload.category || 'All' };
                else if (action === 'manage_equipment') rpcParams = { p_user_id: userId, p_action: payload.mode, p_eq_id: payload.eqId || null, p_name: payload.name || '', p_category: payload.category || '', p_sub_category: payload.subCategory || '', p_model: payload.model || '', p_location: payload.location || '', p_custodian: payload.custodian || '', p_total_qty: payload.totalQty || 0, p_user_name: displayName };
                else if (action === 'borrow_equipment') rpcParams = { p_eq_id: payload.eqId, p_borrower_name: payload.borrower, p_qty: payload.qty, p_user_name: displayName, p_note: payload.note || '', p_note2: payload.note2 || '', p_user_id: userId };
                else if (action === 'return_equipment') rpcParams = { p_loan_id: payload.loanId, p_return_qty: payload.returnQty, p_user_name: displayName, p_user_id: userId };
                else if (action === 'get_loan_history') rpcParams = { p_user_id: userId, p_eq_id: payload.eqId || null };
                else if (action === 'batch_borrow_equipment') {
                    rpcParams = { p_user_id: userId, p_user_name: displayName, p_items: payload.items };
                }
                else if (action === 'batch_return_equipment') {
                    rpcParams = { p_user_id: userId, p_user_name: displayName, p_items: payload.items };
                }
                const { data, error } = await _supabase.rpc(action, rpcParams); // <--- æ”¹å
                if (error) throw new Error(error.message);
                
                // ğŸ”¥ åŠ ä¸Šé€™è¡Œï¼šå¦‚æœè³‡æ–™åº«æ˜æ˜ç™½ç™½èªª success æ˜¯ falseï¼Œå°±ä¸Ÿå‡ºæ‹’çµ•åŸå› ï¼
                if (data && data.success === false) throw new Error(data.message);
                
                return data;
            } 
            else if (action === 'check_user_role') {
                const { data, error } = await _supabase.rpc('check_is_admin_by_email', { p_email: userEmail }); // <--- æ”¹å
                if (error) throw new Error(error.message);
                return { isAdmin: data };
            }
            else {
                const res = await fetch(GAS_API_URL, { method:"POST", body:JSON.stringify({...payload, source:'liff'}) }); 
                return await res.json();
            }
        }
        function closeModal(id) { document.getElementById(id).classList.remove('flex'); document.getElementById(id).classList.add('hidden'); }
        async function safeExecute(btn, fn) { btn.disabled=true; await fn(); btn.disabled=false; }

    </script>

    <script src="mission_folder/task.js"></script>
    <script src="mission_folder/return.js"></script>
    <script src="mission_folder/borrow.js"></script>
    <script>
        

        
        // =========================================
        // ğŸ”’ App å°ˆå±¬ï¼šSupabase ç™»å…¥èˆ‡è‡ªå‹•é©—è­‰ç³»çµ±
        // =========================================

        // ğŸš€ è‡ªå‹•å¾è³‡æ–™åº«æŠ“å–ã€Œç¾æœ‰å–®ä½ã€ä¸¦å¡«å…¥è¨»å†Šé¸å–®
        async function loadDynamicUnits() {
            const { data, error } = await _supabase.rpc('get_existing_units');
            const unitSelect = document.getElementById('reg-unit');
            
            if (error) {
                console.error("æŠ“å–å–®ä½å¤±æ•—:", error);
                unitSelect.innerHTML = '<option value="">æ‰‹å‹•è¼¸å…¥å–®ä½</option>';
                return;
            }

            if (data && data.length > 0) {
                let html = '<option value="">é¸æ“‡å–®ä½</option>';
                data.forEach(item => {
                    html += `<option value="${item.unit_name}">${item.unit_name}</option>`;
                });
                html += '<option value="OTHER">--- å…¶ä»– (æ‰‹å‹•è¼¸å…¥) ---</option>';
                unitSelect.innerHTML = html;
            }
        }
        
        // 1. è™•ç†ä½¿ç”¨è€…é»æ“Šç™»å…¥
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');
            if (!email || !password) { alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼ï¼"); return; }
            btn.innerText = "é©—è­‰ä¸­..."; btn.disabled = true;

            const { data, error } = await _supabase.auth.signInWithPassword({ email, password }); // <--- æ”¹å
            if (error) {
                alert("ç™»å…¥å¤±æ•—ï¼š" + error.message);
                btn.innerText = "å®‰å…¨ç™»å…¥"; btn.disabled = false;
                return;
            }
            enterSystem(data.user);
        }

        // --- ğŸšª ç™»å‡ºç³»çµ±èˆ‡æ¸…é™¤æœ¬åœ°å¿«å– ---
        async function handleLogout() {
            if (!confirm("ç¢ºå®šè¦ç™»å‡ºä¸¦æ¸…é™¤ç™»å…¥ç‹€æ…‹å—ï¼Ÿ")) return;
            
            toggleLoader(true, "ç™»å‡ºä¸­...");
            try {
                // 1. å‘¼å« Supabase ç™»å‡ºï¼Œé€™è¡Œæœƒã€Œè‡ªå‹•å¹«ä½ æŠŠ LocalStorage è£¡çš„æ†‘è­‰åˆªå…‰å…‰ã€
                await _supabase.auth.signOut();
                
                // 2. æ¸…é™¤ç¶²é å…§å­˜è®Šæ•¸ (å¤±æ†¶)
                userId = "";
                userEmail = "";
                displayName = "";
                isUserAdmin = false;
                equipmentCache = [];
                
                // 3. æŠŠç®¡ç†å“¡æŒ‰éˆ•é‡æ–°å°å°éš±è—
                document.getElementById('btn-add-eq').classList.add('hidden');
                document.getElementById('btn-batch-borrow').classList.add('hidden');
                document.getElementById('btn-batch-return').classList.add('hidden');
                
                // 4. åˆ‡æ›ç•«é¢ï¼šéš±è—è£å‚™æ¸…å–®ï¼Œé¡¯ç¤ºç™»å…¥ç•«é¢
                document.getElementById('view-equipment').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                
                // 5. é †ä¾¿æŠŠå¯†ç¢¼æ¡†æ¸…ç©ºï¼Œä¿è­·éš±ç§
                document.getElementById('login-password').value = ""; 
                
            } catch (error) {
                console.error("ç™»å‡ºå¤±æ•—:", error);
                alert("ç™»å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤");
            } finally {
                toggleLoader(false);
            }
        }

        // 2. æˆåŠŸç™»å…¥å¾Œï¼Œå‹•æ…‹è³¦äºˆèº«åˆ†ä¸¦è§£é–ç•«é¢
        async function enterSystem(user) {
            userEmail = user.email; // å…ˆè¨˜éŒ„ä¿¡ç®±

            try {
                // 1. æŠ“å–çœŸå¯¦å§“å
                const { data: realName } = await _supabase.rpc('get_user_name_by_email', { p_email: userEmail });
                displayName = (realName) ? realName : userEmail.split('@')[0];

                // ğŸ”¥ 2. ç²å–è³‡æ–™åº«çœŸæ­£èªå¾—çš„ user_id (ä¿®å¾©æ‰€æœ‰æ¬Šé™çš„æ ¸å¿ƒ)
                const { data: dbUserId } = await _supabase.rpc('get_user_id_by_email', { p_email: userEmail });
                userId = dbUserId || user.id; // å¦‚æœè³‡æ–™åº«æœ‰ ID å°±ç”¨è³‡æ–™åº«çš„ï¼Œæ²’æœ‰æ‰ç”¨å‚™æ¡ˆ
                
                // ğŸ”¥ è£œä¸Šé€™ä¸€æ®µï¼šç™»å…¥æˆåŠŸå¾Œï¼Œç«‹åˆ»æª¢æŸ¥æœ‰æ²’æœ‰ Android å‚³éä¾†çš„æš«å­˜ Token
                if (window.tempFCMToken) {
                    console.log("åµæ¸¬åˆ°æš«å­˜ Tokenï¼Œæº–å‚™åŸ·è¡Œè£œç™»...");
                    performTokenUpdate(window.tempFCMToken);
                }

                // æ›´æ–° UI
                document.getElementById('user-info').innerText = `éšŠå“¡ï¼š${displayName}`;
                
                // 3. åˆ‡æ›ä»‹é¢
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('view-equipment').classList.remove('hidden');

                // 4. æª¢æŸ¥æ¬Šé™ä¸¦è¼‰å…¥è³‡æ–™
                await checkAdminRole();
                await loadEquipment(); 
                
                setTimeout(attachDragToElements, 500);

            } catch (err) {
                console.error("é€²å…¥ç³»çµ±ç™¼ç”Ÿå´©æ½°:", err);
                alert("ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†ç¶²é ");
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        }

        // --- ğŸ” ç•«é¢åˆ‡æ›é‚è¼¯ (ä¸‰é ç±¤åˆ‡æ›) ---
        function switchAuthTab(type) {
            const tabs = ['login', 'bind', 'signup'];
            tabs.forEach(t => {
                const isCurrent = (t === type);
                // è™•ç†æŒ‰éˆ•é¡è‰²
                const btn = document.getElementById(`tab-${t}`);
                if (isCurrent) {
                    btn.className = `flex-1 py-2 rounded-md text-sm font-bold transition-all text-white ${t==='login'?'bg-indigo-600':t==='bind'?'bg-blue-600':'bg-green-600'}`;
                } else {
                    btn.className = "flex-1 py-2 rounded-md text-sm font-bold transition-all text-gray-400";
                }
                // è™•ç†è¡¨å–®é¡¯ç¤º
                document.getElementById(`form-${t}`).classList.toggle('hidden', !isCurrent);
            });
        }

        // --- ğŸ¢ åˆ‡æ›ã€Œå…¶ä»–å–®ä½ã€è¼¸å…¥æ¡† ---
        function toggleOtherUnit() {
            const unitVal = document.getElementById('reg-unit').value;
            const otherInput = document.getElementById('reg-unit-other');
            if (unitVal === 'å…¶ä»–' || unitVal === 'OTHER') {
                otherInput.classList.remove('hidden');
                otherInput.focus();
            } else {
                otherInput.classList.add('hidden');
            }
        }

        // --- ğŸ”— è™•ç†è€éšŠå“¡ä¿¡ç®±ç¶å®š ---
        async function handleBind() {
            const email = document.getElementById('bind-email').value.trim();
            const pw = document.getElementById('bind-password').value;
            const pwConfirm = document.getElementById('bind-confirm').value; // æŠ“å–ç¢ºèªå¯†ç¢¼çš„å€¼
            const btn = document.getElementById('bind-btn');

            if (!email || !pw) return alert("è«‹è¼¸å…¥ä¿¡ç®±èˆ‡å¯†ç¢¼ï¼");
            if (pw !== pwConfirm) return alert("âš ï¸ å…©æ¬¡å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´ï¼Œè«‹é‡æ–°ç¢ºèªï¼"); // åŠ å…¥æ¯”å°æª¢æŸ¥
            if (pw.length < 6) return alert("å¯†ç¢¼è‡³å°‘éœ€è¦ 6 ç¢¼ï¼");

            btn.innerText = "é©—è­‰ä¸­..."; btn.disabled = true;

            try {
                // ğŸ”¥ å‘¼å«ç¬¬ 11 å€‹ç‰¹æ¬Šå‡½æ•¸æŸ¥åå­—
                const { data: userName, error: checkErr } = await _supabase.rpc('get_user_name_by_email', { p_email: email });
                
                // ğŸš¨ å¦‚æœ userName æ˜¯ nullï¼Œä»£è¡¨è³‡æ–™åº«çœŸçš„æ²’é€™å€‹ä¿¡ç®±
                if (!userName) {
                    alert("âŒ æ‰¾ä¸åˆ°æ­¤ä¿¡ç®±ï¼\nå¦‚æœæ‚¨æ˜¯æ–°é€²äººå“¡ï¼Œè«‹åˆ‡æ›è‡³å³å´çš„ã€Œè¨»å†Šç”³è«‹ã€å¡«å¯«è³‡æ–™ã€‚");
                    return;
                }

                // 2. æ‰¾åˆ°äº†ï¼å¹«ä»–åœ¨ Supabase å»ºç«‹ç™»å…¥å¯†ç¢¼
                const { error: authErr } = await _supabase.auth.signUp({ email, password: pw });
                if (authErr) throw authErr;

                alert(`ğŸ‰ ç¶å®šæˆåŠŸï¼æ­¡è¿å›ä¾†ï¼Œ${userName}ï¼\nç³»çµ±å°‡è‡ªå‹•ç‚ºæ‚¨ç™»å…¥ã€‚`);
                
                // è‡ªå‹•ç™»å…¥
                document.getElementById('login-email').value = email;
                document.getElementById('login-password').value = pw;
                handleLogin();

            } catch (err) {
                alert("ç¶å®šå¤±æ•—ï¼š" + err.message);
            } finally {
                btn.innerText = "ç¢ºèªç¶å®š"; btn.disabled = false;
            }
        }

        // --- ğŸ“ è™•ç†æ–°é€²éšŠå“¡è¨»å†Š ---
        async function handleRealSignUp() {
            const email = document.getElementById('reg-email').value.trim();
            const pw = document.getElementById('reg-password').value;
            const pwConfirm = document.getElementById('reg-confirm').value;
            const name = document.getElementById('reg-name').value.trim();
            
            let unit = document.getElementById('reg-unit').value;
            if (unit === 'å…¶ä»–' || unit === 'OTHER') {
                unit = document.getElementById('reg-unit-other').value.trim();
                if (!unit) return alert("è«‹æ‰‹å‹•è¼¸å…¥æ‚¨çš„å–®ä½åç¨±ï¼");
            }

            const title = document.getElementById('reg-title').value.trim();
            const phone = document.getElementById('reg-phone').value.trim();
            const note = document.getElementById('reg-note').value.trim();
            const btn = document.getElementById('signup-btn');

            if (!email || !name || !pw) return alert("è«‹å¡«å¯«å¿…å¡«æ¬„ä½ (ä¿¡ç®±ã€å§“åã€å¯†ç¢¼)");
            if (pw !== pwConfirm) return alert("å…©æ¬¡å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´");
            if (pw.length < 6) return alert("å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 6 ç¢¼");

            btn.innerText = "æäº¤ä¸­..."; btn.disabled = true;

            try {
                // 1. æª¢æŸ¥æ˜¯å¦é‡è¤‡ (ä½¿ç”¨ä½ åŸæœ¬çš„é‚è¼¯)
                const { data: userName } = await _supabase.rpc('get_user_name_by_email', { p_email: email });
                if (userName) {
                    alert(`âš ï¸ ${userName} æ‚¨å¥½ï¼Œé€™å€‹ä¿¡ç®±å·²ç¶“åœ¨ç³»çµ±ä¸­äº†ï¼\nè«‹ç›´æ¥åˆ‡æ›è‡³ä¸­é–“çš„ã€Œä¿¡ç®±ç¶å®šã€ä¾†è¨­å®š App å¯†ç¢¼ï¼Œä¸éœ€é‡æ–°è¨»å†Šã€‚`);
                    btn.innerText = "æäº¤æ–°è¨»å†Š"; btn.disabled = false;
                    return;
                }

                // 2. å»ºç«‹ Supabase ç™»å…¥å¸³è™Ÿ
                const { error: authErr } = await _supabase.auth.signUp({ email, password: pw });
                if (authErr) throw authErr;

                // ğŸ”¥ 3. æ”¹ç”¨ RPC å¯«å…¥ users è³‡æ–™è¡¨ (è§£æ±ºæ¬Šé™å•é¡Œï¼Œä¸¦ä¿ç•™ä½ æ‰€æœ‰æ¬„ä½)
                const fakeUserId = "APP_" + Math.random().toString(36).substr(2, 9);
                const { data: regRes, error: regErr } = await _supabase.rpc('handle_new_user_registration', {
                    p_name: name,
                    p_unit: unit,
                    p_email: email,
                    p_user_id: fakeUserId,
                    p_phone: phone,
                    p_title: title,
                    p_note: note
                });

                if (regErr) throw regErr;
                if (!regRes.success) throw new Error(regRes.message);

                alert("ğŸ‰ è¨»å†ŠæˆåŠŸï¼è³‡æ–™å·²æäº¤ã€‚\nç³»çµ±å°‡è‡ªå‹•ç‚ºæ‚¨ç™»å…¥ã€‚");
                
                document.getElementById('login-email').value = email;
                document.getElementById('login-password').value = pw;
                handleLogin();

            } catch (err) {
                alert("éŒ¯èª¤ï¼š" + err.message);
            } finally {
                btn.innerText = "æäº¤æ–°è¨»å†Š"; btn.disabled = false;
            }
        }

        async function checkSessionOnLoad() {
            document.getElementById('loader').classList.add('hidden');
            
            // ğŸ”¥ å°±æ˜¯åŠ é€™ä¸€è¡Œï¼åœ¨æª¢æŸ¥ç™»å…¥å‰ï¼Œå…ˆæŠŠå–®ä½æ¸…å–®æŠ“ä¸‹ä¾†å¡é€²é¸å–®ï¼
            await loadDynamicUnits();

            const { data, error } = await _supabase.auth.getSession(); // <--- æ”¹å
            if (data.session) enterSystem(data.session.user);
        }
        

        // ğŸš€ ç¨‹å¼èµ·é»
        checkSessionOnLoad();

        // ğŸ”¥ [ä¿®æ­£] æ¬Šé™æª¢æŸ¥å‡½æ•¸
        async function checkAdminRole() {
            try {
                const res = await callGasApi({ action: 'check_user_role', userId: userId });
                if (res && res.isAdmin) {
                    isUserAdmin = true; // æ¨™è¨˜ç‚ºç®¡ç†å“¡
                    
                    // è§£é–‹æŒ‰éˆ•å°å° (ç§»é™¤ hidden class)
                    document.getElementById('btn-add-eq').classList.remove('hidden');
                    document.getElementById('btn-batch-borrow').classList.remove('hidden');
                    document.getElementById('btn-batch-return').classList.remove('hidden');
                    
                    // å¦‚æœåˆ—è¡¨å·²ç¶“æ¸²æŸ“äº†ï¼Œè¦é‡åˆ·ä¸€æ¬¡è®“è£¡é¢çš„å°æŒ‰éˆ•å‡ºä¾†
                    if (!document.getElementById('view-equipment').classList.contains('hidden')) {
                        renderEquipmentList();
                    }
                }
            } catch (e) { console.error("æ¬Šé™æª¢æŸ¥å¤±æ•—", e); }
        }

        // ============================================
        // è£å‚™ç®¡ç† (æ‰¹æ¬¡æ•¸é‡) - ç•™åœ¨ä¸»æª”
        // ============================================
        function loadEquipment() {
            document.getElementById('view-equipment').classList.remove('hidden');
            if (equipmentCache.length === 0) fetchEquipmentData(true); else renderEquipmentList();
        }
        async function fetchEquipmentData(showLoading = false) {
            if (showLoading) toggleLoader(true, "ç›¤é»ä¸­...");
            try {
                const data = await callGasApi({ action: 'get_equipment_list', userId: userId, category: 'All' });
                equipmentCache = (data && data.length > 0) ? data : [];
                if(equipmentCache.length === 0) document.getElementById('equipment-list').innerHTML = "<p class='text-center text-gray-500'>æŸ¥ç„¡è£å‚™</p>";
                else { 
                    renderDatalists(); // ğŸ”¥ é€™è£¡æ”¹ç”¨æ–°çš„å‡½æ•¸
                    renderEquipmentList(); 
                }
            } catch (e) { alert(e.message); } finally { if (showLoading) toggleLoader(false); }
        }

        // ğŸ”¥ [ä¿®æ”¹] åˆ‡æ›ä¿ç®¡äººéæ¿¾ï¼Œä¸¦è‡ªå‹•å¹«ä»–ã€Œå¤šé¸ã€å°æ‡‰çš„åˆ†é¡èˆ‡ç´°é …
        function switchCustodian(c) { 
            currentCustodian = c; 
            
            // å…ˆæ¸…ç©ºç›®å‰çš„åˆ†é¡èˆ‡ç´°é …é¸æ“‡
            activeCats.clear();
            activeSubCats.clear();
            
            if (c !== 'All') {
                // æ‰¾å‡ºé€™å€‹äººä¿ç®¡çš„æ‰€æœ‰è£å‚™
                const myEqs = equipmentCache.filter(e => e.custodian === c);
                // æŠŠå°æ‡‰çš„å¤§åˆ†é¡èˆ‡ç´°é …å¡é€²ã€Œå·²é¸é›†åˆã€ä¸­
                myEqs.forEach(eq => {
                    if (eq.category) activeCats.add(eq.category);
                    // ğŸ”¥ é—œéµï¼šæŠŠç©ºå­—ä¸²(æ²’æœ‰ç´°é …)ä¹Ÿè¦–ç‚ºä¸€ç¨®ç‹€æ…‹åŠ å…¥é›†åˆ
                    const sub = (eq.sub_category || '').trim();
                    activeSubCats.add(sub); 
                });
            }
            
            renderDatalists(); 
            renderEquipmentList(); 
        }

        // ğŸ”¥ [ä¿®æ­£] çµ±ä¸€ç®¡ç†ä¸‹æ‹‰é¸å–® (å·²ç§»é™¤èˆŠçš„åˆ†é¡æ¸²æŸ“é‚è¼¯ï¼Œæ”¹å‘¼å«æ–°å‡½æ•¸)
        function renderDatalists() {
            const cats = new Set(equipmentCache.map(e => e.category));
            const subcats = new Set(equipmentCache.map(e => e.sub_category || ''));
            const locs = new Set(equipmentCache.map(e => e.location));
            const custodians = new Set(equipmentCache.map(e => e.custodian).filter(Boolean)); // ğŸ”¥ æŠ“å–æœ‰å€¼çš„ä¿ç®¡äºº
            
            const notes = new Set(['é›ªè¨“', 'ç¹©ç´¢è¨“ç·´', 'å‹•å“¡è¨“ç·´', 'å±±åŸŸæœæ•‘']);
            equipmentCache.forEach(e => e.active_loans?.forEach(l => {if(l.note) notes.add(l.note)}));

            // è™•ç†æš«å­˜å€è³‡æ–™
            pendingBatchItems.forEach(i => {
                if(i.category) cats.add(i.category);
                if(i.subCategory) subcats.add(i.subCategory);
                if(i.location) locs.add(i.location);
            });

            // âŒ [ç§»é™¤] é€™è£¡åŸæœ¬æœ‰ä¸€æ®µã€Œæ¸²æŸ“ä¸Šæ–¹åˆ†é¡æŒ‰éˆ•ã€çš„èˆŠç¨‹å¼ç¢¼ï¼ŒæŠŠå®ƒåˆªæ‰äº†ï¼
            // âŒ ä¸è¦å†æ‰‹å¯« innerHTML = html äº†

            // âœ… [æ–°å¢] ç›´æ¥å‘¼å«æˆ‘å€‘å¯«å¥½çš„æ¼‚äº® UI å‡½æ•¸
            renderCategoryUI(); 

            // æ¸²æŸ“ Datalist (è¼¸å…¥æ¡†çš„ä¸‹æ‹‰é¸å–®) - é€™é‚Šç¶­æŒåŸæ¨£
            document.getElementById('category-options').innerHTML = [...cats].map(c=>`<option value="${c}">`).join('');
            document.getElementById('subcategory-options').innerHTML = [...subcats].map(s=>`<option value="${s}">`).join('');
            document.getElementById('location-options').innerHTML = [...locs].sort().map(l=>`<option value="${l}">`).join('');
            document.getElementById('note-suggestions').innerHTML = [...notes].sort().map(n=>`<option value="${n}">`).join('');
            // å¡é€² Datalist
            document.getElementById('custodian-options').innerHTML = [...custodians].sort().map(c=>`<option value="${c}">`).join('');
            
            renderSubCategoryUI(); 
            renderLocationUI();    
            renderNoteUI();

            // ğŸ”¥ [æ–°å¢] æ¸²æŸ“é ‚éƒ¨ä¿ç®¡äººä¸‹æ‹‰é¸å–®
            const custodianSelect = document.getElementById('custodian-filter');
            let custHtml = `<option value="All">æ‰€æœ‰ğŸ›¡ï¸</option>`;
            Array.from(custodians).sort().forEach(c => custHtml += `<option value="${c}">${c}</option>`);
            custodianSelect.innerHTML = custHtml;
            if (currentCustodian) custodianSelect.value = currentCustodian; // ä¿æŒé¸æ“‡ç‹€æ…‹ä¸è·‘æ‰
            
            attachDragToElements();
        }

        // ğŸ”¥ 2. ç´°é …æ¸²æŸ“ (æ”¯æ´å¤šé¸æ¨£å¼)
        function renderSubCategoryUI() {
            const container = document.getElementById('subcategory-filter-container');
            const subcats = new Set();
            const sourceData = activeCats.size === 0 ? equipmentCache : equipmentCache.filter(e => activeCats.has(e.category));
            sourceData.forEach(e => { if(e.sub_category) subcats.add(e.sub_category); });

            if(subcats.size === 0) { container.classList.add('hidden'); return; }
            container.classList.remove('hidden');

            let html = `<button onclick="switchSubCategory('All')" class="btn-chip ${(activeSubCats.size === 0 || activeSubCats.has('')) ? 'active' : ''}">å…¨éƒ¨ç´°é …</button>`;
            Array.from(subcats).sort().forEach(sc => {
                html += `<button onclick="switchSubCategory('${sc}')" class="btn-chip ${activeSubCats.has(sc)?'active':''}">${sc}</button>`;
            });
            container.innerHTML = html;
        }

        // ğŸ”¥ [ä¿®æ”¹] æš«å­˜æ™‚åŠ å…¥ subCategory
        function addToPreBatch() {
            const name = document.getElementById('eq-name').value;
            const cat = document.getElementById('eq-category').value;
            const subcat = document.getElementById('eq-sub-category').value; // ğŸ”¥ è®€å–ç´°é …
            const model = document.getElementById('eq-model').value;
            const loc = document.getElementById('eq-location').value;
            const total = parseInt(document.getElementById('eq-total').value);
            const custodian = document.getElementById('eq-custodian').value; // ğŸ”¥ è®€å–

            if (!name || !cat) return alert("åç¨±å’Œåˆ†é¡å¿…å¡«ï¼");

            pendingBatchItems.push({ name, category: cat, subCategory: subcat, model, location: loc, custodian: custodian, totalQty: total }); // ğŸ”¥ å¡é€²å»
            
            document.getElementById('eq-name').value = "";
            document.getElementById('eq-model').value = "";
            document.getElementById('eq-custodian').value = ""; // ğŸ”¥ æ¸…ç©ºä¿ç®¡äººæ¬„ä½
            document.getElementById('eq-name').focus(); 

            renderPreBatchList();
            renderDatalists(); 
        }


        // ğŸ”¥ [ä¿®æ”¹] æ¸²æŸ“æš«å­˜è¡¨æ ¼ (å¤šä¸€æ¬„)
        function renderPreBatchList() {
            const tbody = document.getElementById('pre-batch-list');
            tbody.innerHTML = pendingBatchItems.map((item, index) => `
                <tr class="border-b border-gray-700">
                    <td class="pr-3">${item.name}</td>
                    <td class="pr-3 text-gray-400">${item.subCategory || '-'}</td> 
                    <td class="pr-3 text-gray-400">${item.model || '-'}</td> <td class="pr-3 text-gray-400">${item.location || '-'}</td>
                    <td class="pr-3 text-indigo-300">${item.custodian || '-'}</td>
                    <td class="pr-3 text-yellow-400 font-bold">${item.totalQty}</td>
                    <td class="text-right"><button onclick="removePreBatch(${index})" class="text-red-400 px-2 py-1">âœ•</button></td>
                </tr>
            `).join('');
        }

        function removePreBatch(index) {
            pendingBatchItems.splice(index, 1);
            renderPreBatchList();
        }

        // ğŸ”¥ [ä¿®æ”¹] æ‰¹é‡é€å‡º (åŠ å…¥åƒæ•¸)
        async function submitBatchAdd() {
            const name = document.getElementById('eq-name').value;
            if (pendingBatchItems.length === 0 && name) addToPreBatch(); 
            if (pendingBatchItems.length === 0) return alert("è«‹å…ˆåŠ å…¥è£å‚™åˆ°æ¸…å–®");

            toggleLoader(true, "æ‰¹é‡å»ºç«‹ä¸­...");
            try {
                const promises = pendingBatchItems.map(item => 
                    callGasApi({
                        action: 'manage_equipment',
                        userId, displayName,
                        mode: 'create',
                        p_eq_id: "", 
                        name: item.name,
                        category: item.category,
                        subCategory: item.subCategory, // ğŸ”¥
                        model: item.model,
                        location: item.location,
                        custodian: item.custodian, // ğŸ”¥
                        totalQty: item.totalQty
                    })
                );
                await Promise.all(promises);
                alert(`æˆåŠŸæ–°å¢ ${pendingBatchItems.length} ç­†è£å‚™ï¼`);
                closeModal('edit-eq-modal');
                fetchEquipmentData(false);
            } catch (e) {
                alert("æ–°å¢å¤±æ•—: " + e.message);
            } finally {
                toggleLoader(false);
            }
        }

        // ğŸ”¥ [ä¿®æ”¹] åˆ—è¡¨æ¸²æŸ“ (æ”¯æ´ç¶­ä¿®ç¯©é¸èˆ‡é¡¯ç¤º)
        function renderEquipmentList() {
            const listDiv = document.getElementById('equipment-list');
            const searchText = document.getElementById('eq-search').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value; // æŠ“å³ä¸Šè§’é¸å–®
            
            let filtered = equipmentCache.filter(eq => {
                const matchCat = activeCats.size === 0 || activeCats.has(eq.category);
                const matchCustodian = currentCustodian === 'All' || eq.custodian === currentCustodian;
                
                // ğŸ”¥ å¤šé¸é›†åˆæ¯”å° (size === 0 ä»£è¡¨æŒ‰äº†"å…¨éƒ¨")
                const eqSub = (eq.sub_category || '').trim();
                const matchSubCat = activeSubCats.size === 0 || activeSubCats.has(eqSub);
                const matchLoc = activeLocs.size === 0 || activeLocs.has(eq.location);
                
                // --- ğŸ”¥ ç”¨é€”/å‚™è¨»ç¯©é¸é‚è¼¯ (æ”¯æ´å¤šé¸) ---
                // --- ğŸ”¥ ç”¨é€”/å‚™è¨»ç¯©é¸é‚è¼¯ (æ”¯æ´å¤šé¸) ---
                let matchNote = true;
                if (activeNotes.size > 0) {
                    if (!eq.active_loans || eq.active_loans.length === 0) {
                        matchNote = false;
                    } else {
                        matchNote = eq.active_loans.some(l => {
                            const noteStr = l.note ? l.note.trim() : 'æœªåˆ†é¡';
                            const mappedNote = noteStr.startsWith('[ç¶­ä¿®]') ? 'ç¶­ä¿®ä¸­' : noteStr;
                            return activeNotes.has(mappedNote);
                        });
                    }
                }

                // ğŸ‘‡ğŸ‘‡ğŸ‘‡ è£œå›éºå¤±çš„æœå°‹èˆ‡ç‹€æ…‹åˆ¤æ–· ğŸ‘‡ğŸ‘‡ğŸ‘‡
                // 1. æœå°‹æ¯”å° (åç¨±ã€å‹è™Ÿã€å€Ÿç”¨äººã€å€Ÿç”¨åŸå› )
                let matchSearch = !searchText || 
                                  eq.name.toLowerCase().includes(searchText) || 
                                  (eq.model && eq.model.toLowerCase().includes(searchText));
                
                // å¦‚æœè£å‚™åç¨±è·Ÿå‹è™Ÿæ²’ä¸­ï¼Œä¸”é€™å€‹è£å‚™ç›®å‰æœ‰å€Ÿå‡ºç´€éŒ„ï¼Œå°±é€²å»æœã€Œå€Ÿç”¨äººã€æˆ–ã€Œå‚™è¨»ã€
                if (!matchSearch && eq.active_loans && eq.active_loans.length > 0) {
                    matchSearch = eq.active_loans.some(l => 
                        (l.borrower && l.borrower.toLowerCase().includes(searchText)) ||
                        (l.note && l.note.toLowerCase().includes(searchText)) ||
                        (l.note2 && l.note2.toLowerCase().includes(searchText))
                    );
                }

                // 2. ç‹€æ…‹æ¯”å° (å³ä¸Šè§’çš„ï¼šå…¨éƒ¨/å€Ÿå‡º/åœ¨éšŠ/ç¶­ä¿®ä¸­)
                let matchStatus = true;
                if (statusFilter === 'Borrowed') matchStatus = eq.available_qty < eq.total_qty;
                else if (statusFilter === 'InStock') matchStatus = eq.available_qty === eq.total_qty;
                else if (statusFilter === 'Repair') matchStatus = eq.active_loans && eq.active_loans.some(l => l.note && l.note.startsWith('[ç¶­ä¿®]'));
                // ğŸ‘†ğŸ‘†ğŸ‘† -------------------------- ğŸ‘†ğŸ‘†ğŸ‘†
                
                return matchCat && matchSubCat && matchLoc && matchSearch && matchStatus && matchNote && matchCustodian;

            });

            // æ’åºï¼šæœ‰ç¶­ä¿®çš„æ’å‰é¢ï¼Œæ–¹ä¾¿æŸ¥çœ‹
            filtered.sort((a, b) => {
                const aRepair = a.active_loans?.some(l => l.note?.startsWith('[ç¶­ä¿®]')) ? 1 : 0;
                const bRepair = b.active_loans?.some(l => l.note?.startsWith('[ç¶­ä¿®]')) ? 1 : 0;
                if (bRepair !== aRepair) return bRepair - aRepair; // ç¶­ä¿®å„ªå…ˆ
                return (a.available_qty < a.total_qty ? -1 : 1);
            });

            let html = '';
            filtered.forEach(eq => {
                const isFull = eq.available_qty === eq.total_qty;
                const isEmpty = eq.available_qty === 0;
                const statusBadge = isFull ? `<span class="text-green-400 font-bold text-sm">ğŸŸ¢ åœ¨éšŠ (${eq.available_qty})</span>` 
                    : (isEmpty ? `<span class="text-red-400 font-bold text-sm">ğŸ”´ å…¨éƒ¨å€Ÿå‡º</span>` 
                    : `<span class="text-blue-400 font-bold text-sm">ğŸ”µ éƒ¨åˆ†å€Ÿå‡º (${eq.available_qty}/${eq.total_qty})</span>`);

                let loansHtml = '';
                let toggleBtnHtml = ''; // ğŸ”¥ æ”¶åˆèˆ‡è©³ç´°æŒ‰éˆ•å®¹å™¨
                
                // ğŸ”¥ æ–°å¢ã€ŒğŸ“„è©³ç´°ã€æŒ‰éˆ• (ä¸ç®¡æœ‰æ²’æœ‰å€Ÿå‡ºéƒ½æœƒç”¢ç”Ÿé€™å€‹æŒ‰éˆ•)
                const detailsBtnHtml = `<button onclick="openDetailsModal('${eq.id}')" class="bg-indigo-900/60 hover:bg-indigo-800 text-indigo-300 px-3 py-1 rounded text-xs font-bold border border-indigo-700/50">ğŸ“„ è©³ç´°</button>`;

                if (eq.active_loans && eq.active_loans.length > 0) {
                    // å¦‚æœæœ‰å€Ÿå‡ºï¼Œä¸¦æ’é¡¯ç¤ºã€Œè©³ç´°ã€èˆ‡ã€Œåå–®ã€æŒ‰éˆ•
                    toggleBtnHtml = `
                        <div class="flex gap-2 mt-2">
                            ${detailsBtnHtml}
                            <button onclick="toggleLoanList('${eq.id}', this, ${eq.active_loans.length})" class="bg-gray-700 hover:bg-gray-600 text-blue-300 px-3 py-1 rounded text-xs font-bold border border-gray-600">åå–® (${eq.active_loans.length})</button>
                        </div>`;
                    
                    // ğŸ”¥ åŠ ä¸Š id èˆ‡ hidden è®“å®ƒé è¨­éš±è—
                    loansHtml = `<div id="loan-list-${eq.id}" class="hidden mt-2 pt-2 border-t border-gray-600 space-y-1">`;
                    eq.active_loans.forEach(l => {
                        const returnBtn = isUserAdmin ? `<button onclick="openSingleReturnModal('${eq.id}', '${l.loan_id}', ${l.qty}, '${l.borrower}')" class="bg-green-700 text-white px-2 py-1 rounded text-[10px]">æ­¸é‚„</button>` : '';
                        
                        const isRepair = l.note && l.note.startsWith('[ç¶­ä¿®]');
                        let displayHtml = '';
                        
                        if (isRepair) {
                            const reason = l.note.replace('[ç¶­ä¿®]', '').trim();
                            displayHtml = `<span class="text-orange-400 font-bold">ğŸ”§ ç¶­ä¿®ä¸­</span> <span class="text-gray-400">(${l.borrower})</span> <span class="text-orange-300 text-xs">åŸå› : ${reason}</span>`;
                        } else {
                            // ğŸ”¥ å¦‚æœæœ‰è£œè¿° (l.note2)ï¼ŒåŠ ä¸Šä¸€å€‹ç²‰ç´«è‰²çš„æ¨™è¨˜ï¼Œæ²’æœ‰å°±ç©ºå­—ä¸²
                            const note2Html = l.note2 ? ` <span class="text-fuchsia-300 text-[11px] bg-fuchsia-900/40 px-1 rounded border border-fuchsia-800">${l.note2}</span>` : '';
                            displayHtml = `<span>ğŸ‘¤ ${l.borrower} <span class="text-yellow-400">x${l.qty}</span>${note2Html} <span class="text-blue-300 ml-1">${l.note ? `#${l.note}` : ''}</span></span>`;
                        }
                        
                        loansHtml += `<div class="flex justify-between items-center text-xs text-gray-300">${displayHtml}${returnBtn}</div>`;
                    });
                    loansHtml += `</div>`;
                } else {
                    // ğŸ”¥ å¦‚æœæ²’æœ‰å€Ÿå‡ºç´€éŒ„ï¼Œå°±åªé¡¯ç¤ºã€ŒğŸ“„è©³ç´°ã€æŒ‰éˆ•
                    toggleBtnHtml = `
                        <div class="flex gap-2 mt-2">
                            ${detailsBtnHtml}
                        </div>`;
                }
                
                const checked = selectedItems.has(eq.id) ? 'checked' : '';
                const checkHtml = isExportMode ? `<div class="mr-3 flex items-center"><input type="checkbox" onchange="toggleSelect('${eq.id}')" ${checked} class="w-6 h-6"></div>` : '';
                
                const repairBtn = (!isEmpty && isUserAdmin) ? `<button onclick="openRepairModal('${eq.id}', '${displayName}')" class="bg-orange-600 text-white px-3 py-1 rounded text-xs font-bold ml-2">å ±ä¿®</button>` : '';
                const borrowBtn = (!isEmpty && isUserAdmin) ? `<button onclick="openSingleBorrowModal('${eq.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold">å€Ÿå‡º</button>` : '';
                const editBtn = isUserAdmin ? `<button onclick="openEditModal('update', '${eq.id}')" class="text-gray-500 p-1">âš™ï¸</button>` : '';
                const subCatBadge = eq.sub_category ? `<span class="text-xs bg-gray-700 text-gray-300 px-2 py-0.5 rounded ml-2">${eq.sub_category}</span>` : '';
                // å¦‚æœæœ‰ä¿ç®¡äººï¼Œç”¢ç”Ÿå¾®å‹æ¨™ç±¤ï¼›å¦‚æœæ²’æœ‰ï¼Œå°±æ˜¯ç©ºå­—ä¸²
                const custodianBadge = eq.custodian ? `<span class="bg-indigo-900/50 text-indigo-300 px-1.5 py-0.5 rounded border border-indigo-700">ğŸ›¡ï¸ä¿ç®¡: ${eq.custodian}</span>` : '';

                // ğŸ”¥ å°‡ ${toggleBtnHtml} æ’å…¥åˆ° ${loansHtml} å‰é¢
                html += `<div class="flex items-start bg-gray-800 p-4 rounded-lg mb-3 border-l-4 ${isEmpty ? "border-red-500" : (isFull ? "border-green-500" : "border-blue-500")}">
                        ${checkHtml}<div class="flex-1"><div class="flex justify-between"><div>
                            <h3 class="font-bold text-white text-lg flex items-center flex-wrap gap-1">${eq.name} ${subCatBadge}</h3>
                            <div class="flex gap-2 text-xs text-gray-400 mt-1 flex-wrap"><span>${eq.model||'-'}</span><span>ğŸ“${eq.location||'-'}</span>${custodianBadge}</div>
                        </div><div class="flex gap-2"><button onclick="fetchItemHistory('${eq.id}')" class="text-blue-400 p-1">ğŸ“œ</button>${editBtn}</div></div>
                        <div class="flex justify-between items-end mt-3">${statusBadge}<div class="flex flex-col items-end gap-2"><div>${borrowBtn}${repairBtn}</div>${toggleBtnHtml}</div></div>${loansHtml}</div></div>`;
            });
            listDiv.innerHTML = html || "<p class='text-center text-gray-500'>ç„¡ç¬¦åˆè£å‚™</p>";
            updateExportCount();
        }

        // ğŸ”¥ [æ–°å¢] åˆ‡æ›é¡¯ç¤ºå€Ÿå‡ºåå–®
        function toggleLoanList(id, btn, count) {
            const list = document.getElementById(`loan-list-${id}`);
            if (list.classList.contains('hidden')) {
                // å±•é–‹
                list.classList.remove('hidden');
                btn.innerHTML = 'éš±è—';
                btn.classList.replace('text-blue-300', 'text-gray-400');
            } else {
                // æ”¶åˆ
                list.classList.add('hidden');
                btn.innerHTML = `åå–® (${count})`;
                btn.classList.replace('text-gray-400', 'text-blue-300');
            }
        }

        // å…¶ä»–å·¥å…·
        function toggleExportMode() { isExportMode = !isExportMode; document.getElementById('export-toolbar').classList.toggle('hidden'); document.getElementById('btn-export-mode').innerText = isExportMode ? "âŒ å–æ¶ˆ" : "æ‰¹é‡/åŒ¯å‡º"; renderEquipmentList(); }
        function toggleSelect(id) { if (selectedItems.has(id)) selectedItems.delete(id); else selectedItems.add(id); updateExportCount(); }
        function toggleSelectAll() { const ids = Array.from(document.querySelectorAll('#equipment-list input[type="checkbox"]')).map(c => c.getAttribute('onchange').match(/'([^']+)'/)[1]); if (ids.every(id => selectedItems.has(id))) ids.forEach(id => selectedItems.delete(id)); else ids.forEach(id => selectedItems.add(id)); renderEquipmentList(); updateExportCount(); }
        function updateExportCount() { document.getElementById('export-count').innerText = selectedItems.size; }
        async function confirmExport() { 
            if (selectedItems.size === 0) return alert("è«‹é¸æ“‡è£å‚™"); 
            toggleLoader(true); 
            try { 
                const res = await callGasApi({ action: 'export_equipment_report', userId, eqIds: Array.from(selectedItems) }); 
                if (res.url) {
                    // App ç¨ç«‹ç‰ˆï¼šç›´æ¥ç”¨å¤–éƒ¨ç€è¦½å™¨æ‰“é–‹ PDF é€£çµ
                    window.open(res.url, '_blank');
                } else {
                    alert("åŒ¯å‡ºå¤±æ•—"); 
                }
            } catch (e) { 
                alert(e.message); 
            } finally { 
                toggleLoader(false); 
            } 
        }
        
        // ğŸ”¥ 1. å¤§åˆ†é¡æ¸²æŸ“ (è§£æ±ºé›»è…¦ç‰ˆç„¡æ³•æ‹–æ›³çš„å•é¡Œ)
        function renderCategoryUI() {
            const container = document.getElementById('category-filter-container');
            if (!container) return;
            const categories = ['All', ...new Set(equipmentCache.map(e => e.category))];
            
            container.className = ""; 
            container.style.border = "3px solid #F59E0B"; 
            container.style.backgroundColor = "#1F2937";   
            container.style.borderRadius = "12px";         
            container.style.padding = "15px";              
            container.style.marginBottom = "20px";         
            container.style.boxShadow = "0 4px 6px rgba(0,0,0,0.3)"; 

            // ğŸ”¥ é—œéµä¿®å¾©ï¼šåœ¨å…§å±¤ div åŠ ä¸Š filter-row é¡åˆ¥ï¼Œå³å¯æ”¯æ´æ»‘é¼ æ‹–æ›³
            let html = `
                <div style="margin-bottom: 10px; color: #FBBF24; font-weight: bold; font-size: 1.1rem; border-bottom: 1px solid #4B5563; padding-bottom: 5px;">
                    âš¡ é¸æ“‡åˆ†é¡ <span style="font-size: 0.8rem; color: #9CA3AF; font-weight: normal;">(å¤§åˆ†é¡)</span>
                </div>
                <div class="flex gap-3 overflow-x-auto pb-2 custom-scrollbar filter-row" style="scrollbar-width: none; cursor: grab;">
            `;

            categories.forEach(cat => {
                const isActive = (cat === 'All' && activeCats.size === 0) || activeCats.has(cat);
                const btnStyle = isActive 
                    ? "background-color: #F59E0B; color: black; font-weight: 800; border: 2px solid #F59E0B; transform: scale(1.05);"
                    : "background-color: transparent; color: white; border: 1px solid #6B7280;";
                const label = cat === 'All' ? 'å…¨éƒ¨é¡¯ç¤º' : cat;
                html += `<button onclick="switchCategory('${cat}')" style="padding: 8px 16px; border-radius: 9999px; white-space: nowrap; transition: all 0.2s; ${btnStyle}">${label}</button>`;
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        // ğŸ”¥ 3. ä½ç½®æ¸²æŸ“ (æ™ºæ…§é€£å‹•ï¼šåªé¡¯ç¤ºé¸ä¸­ç´°é …æœ‰çš„ä½ç½®)
        function renderLocationUI() {
            const container = document.getElementById('location-filter-container');
            const locs = new Set();
            
            let sourceData = activeCats.size === 0 ? equipmentCache : equipmentCache.filter(e => activeCats.has(e.category));
            if (activeSubCats.size > 0) sourceData = sourceData.filter(e => activeSubCats.has(e.sub_category || '')); // ç€‘å¸ƒæµé€£å‹•

            sourceData.forEach(e => { if(e.location) locs.add(e.location); });
            if(locs.size === 0) { container.classList.add('hidden'); return; } 
            container.classList.remove('hidden');

            let html = `<button onclick="switchLocation('All')" class="btn-chip ${activeLocs.size===0?'active':''}">å…¨éƒ¨ä½ç½®</button>`;
            Array.from(locs).sort().forEach(loc => {
                html += `<button onclick="switchLocation('${loc}')" class="btn-chip ${activeLocs.has(loc)?'active':''}">${loc}</button>`;
            });
            container.innerHTML = html;
        }

        // ğŸ”¥ 4. ç”¨é€”æ¸²æŸ“ (çµ‚æ¥µæ™ºæ…§é€£å‹•ï¼šåªé¡¯ç¤ºç›®å‰éæ¿¾ä¸‹çš„ç”¨é€”)
        function renderNoteUI() {
            const container = document.getElementById('note-filter-container');
            const notes = new Set();
            
            let sourceData = activeCats.size === 0 ? equipmentCache : equipmentCache.filter(e => activeCats.has(e.category));
            if (activeSubCats.size > 0) sourceData = sourceData.filter(e => activeSubCats.has(e.sub_category || '')); // ç€‘å¸ƒæµé€£å‹•
            if (activeLocs.size > 0) sourceData = sourceData.filter(e => activeLocs.has(e.location)); // ç€‘å¸ƒæµé€£å‹•

            sourceData.forEach(e => {
                if (e.active_loans) {
                    e.active_loans.forEach(l => {
                        const note = l.note ? l.note.trim() : 'æœªåˆ†é¡';
                        if (note.startsWith('[ç¶­ä¿®]')) notes.add('ç¶­ä¿®ä¸­');
                        else notes.add(note);
                    });
                }
            });

            // æ¸…ç†ï¼šå¦‚æœå·²ç¶“ä¸å­˜åœ¨è©²ç”¨é€”ï¼Œè‡ªå‹•å¾é¸ä¸­åå–®ä¸­ç§»é™¤
            for (let n of activeNotes) { if (!notes.has(n)) activeNotes.delete(n); }

            if (notes.size === 0) { container.classList.add('hidden'); return; }
            container.classList.remove('hidden');

            let html = `<button onclick="switchNote('All')" class="btn-chip ${activeNotes.size===0?'active':''}">å…¨éƒ¨ç”¨é€”</button>`;
            const sortedNotes = Array.from(notes).sort((a, b) => {
                if (a === 'ç¶­ä¿®ä¸­') return -1; if (b === 'ç¶­ä¿®ä¸­') return 1; return a.localeCompare(b);
            });
            sortedNotes.forEach(n => {
                html += `<button onclick="switchNote('${n}')" class="btn-chip ${activeNotes.has(n)?'active':''}">${n}</button>`;
            });
            container.innerHTML = html;
        }


        // ğŸ”¥ åˆ‡æ›ç¯©é¸é¢æ¿å±•é–‹/æ”¶åˆ
        function toggleFilterPanel() {
            const panel = document.getElementById('collapsible-filters');
            const btn = document.getElementById('btn-toggle-filter');
            const icon = btn.querySelector('span');
            
            // åˆ¤æ–·ç›®å‰æ˜¯ç”¨ max-height æ§åˆ¶é‚„æ˜¯ class hidden
            // é€™è£¡æˆ‘å€‘ç”¨ style.maxHeight ä¾†åšå‹•ç•«æ•ˆæœ
            if (panel.style.maxHeight === '0px') {
                // å±•é–‹
                panel.style.maxHeight = '500px'; // è¶³å¤ å¤§çš„é«˜åº¦
                panel.style.opacity = '1';
                btn.innerHTML = '<span>â–¼</span> æ”¶åˆ';
                btn.classList.add('text-yellow-400', 'border-yellow-600');
                btn.classList.remove('text-gray-400', 'border-gray-600');
            } else {
                // æ”¶åˆ
                panel.style.maxHeight = '0px';
                panel.style.opacity = '0';
                btn.innerHTML = '<span>ğŸ”</span> ç¯©é¸'; // æ”¶èµ·ä¾†æ™‚è®Šæˆæœå°‹åœ–ç¤º
                btn.classList.remove('text-yellow-400', 'border-yellow-600');
                btn.classList.add('text-gray-400', 'border-gray-600');
            }
        }

        
        // ğŸ”¥ [ä¿®æ”¹] åˆ‡æ›å¤§åˆ†é¡ (å‡ç´šç‚ºå¤šé¸ï¼Œä¸”ä¸æ¸…ç©ºåº•ä¸‹çš„ç‹€æ…‹ï¼Œä¿ç•™ä¿ç®¡äººé€£å‹•)
        function switchCategory(c) { 
            if (c === 'All') {
                activeCats.clear(); // é»ã€Œå…¨éƒ¨é¡¯ç¤ºã€å°±æ¸…ç©ºæ‰€æœ‰å¤§åˆ†é¡æ¢ä»¶
            } else {
                // é»æ“Šåˆ‡æ›ï¼šæœ‰å°±åˆªæ‰ï¼Œæ²’æœ‰å°±åŠ é€²å»
                activeCats.has(c) ? activeCats.delete(c) : activeCats.add(c);
            }
            renderDatalists();          
            renderEquipmentList(); 
        }
        // ğŸ”¥ åˆ‡æ›ç´°é … (å¤šé¸)
        function switchSubCategory(sc) {
            if (sc === 'All') activeSubCats.clear();
            else activeSubCats.has(sc) ? activeSubCats.delete(sc) : activeSubCats.add(sc);
            renderDatalists(); // åˆ·æ–° UI è®“å®ƒåé»ƒï¼Œä¸¦é€£å‹•ä¸‹æ–¹
            renderEquipmentList();
        }
        // ğŸ”¥ åˆ‡æ›ä½ç½® (å¤šé¸)
        function switchLocation(loc) { 
            if (loc === 'All') activeLocs.clear();
            else activeLocs.has(loc) ? activeLocs.delete(loc) : activeLocs.add(loc);
            renderDatalists(); 
            renderEquipmentList(); 
        }
        // ğŸ”¥ åˆ‡æ›ç”¨é€” (å¤šé¸ï¼Œä¸”ä¸è‡ªå‹•æ”¶åˆé¢æ¿)
        function switchNote(n) { 
            if (n === 'All') activeNotes.clear();
            else activeNotes.has(n) ? activeNotes.delete(n) : activeNotes.add(n);
            renderDatalists(); 
            renderEquipmentList(); 
        }

        // ğŸ”¥ [ä¿®æ”¹] åŠ å…¥ subCategory è™•ç†
        function openEditModal(mode, id) {
            document.getElementById('edit-eq-modal').classList.add('flex');
            document.getElementById('edit-mode').value = mode;
            document.getElementById('edit-eq-id').value = id || "";
            document.getElementById('eq-name').value = "";
            document.getElementById('eq-category').value = "";
            document.getElementById('eq-sub-category').value = ""; // ğŸ”¥ æ¸…ç©ºç´°é …
            document.getElementById('eq-model').value = "";
            document.getElementById('eq-location').value = "";
            document.getElementById('eq-total').value = 1;
            document.getElementById('eq-custodian').value = ""; // æ¸…ç©ºä¿ç®¡äººæ¬„ä½

            if (mode === 'update' && id) {
                const eq = equipmentCache.find(e => e.id === id) || {};
                document.getElementById('edit-modal-title').innerText = "âš™ï¸ ç·¨è¼¯è£å‚™";
                document.getElementById('eq-name').value = eq.name || "";
                document.getElementById('eq-category').value = eq.category || "";
                document.getElementById('eq-sub-category').value = eq.sub_category || ""; // ğŸ”¥ å¡«å…¥èˆŠç´°é …
                document.getElementById('eq-model').value = eq.model || "";
                document.getElementById('eq-location').value = eq.location || "";
                document.getElementById('eq-total').value = eq.total_qty || 1;
                document.getElementById('eq-custodian').value = eq.custodian || ""; // å¡«å…¥èˆŠè³‡æ–™

                
                document.getElementById('btn-delete-eq').classList.remove('hidden');
                document.getElementById('btn-save-edit').classList.remove('hidden');
                document.getElementById('btn-submit-batch').classList.add('hidden');
                document.getElementById('batch-add-area').classList.add('hidden');
            } else {
                document.getElementById('edit-modal-title').innerText = "â• æ‰¹é‡æ–°å¢è£å‚™";
                pendingBatchItems = []; 
                renderPreBatchList();
                document.getElementById('btn-delete-eq').classList.add('hidden');
                document.getElementById('btn-save-edit').classList.add('hidden');
                document.getElementById('btn-submit-batch').classList.remove('hidden');
                document.getElementById('batch-add-area').classList.remove('hidden');
            }
        }
                
        // ğŸ”¥ [ä¿®æ”¹] ç·¨è¼¯é€å‡º (åŠ å…¥åƒæ•¸)
        async function submitEquipmentEdit() {
            const p = { 
                action: 'manage_equipment', userId, displayName, 
                mode: document.getElementById('edit-mode').value, 
                eqId: document.getElementById('edit-eq-id').value, 
                name: document.getElementById('eq-name').value, 
                category: document.getElementById('eq-category').value, 
                subCategory: document.getElementById('eq-sub-category').value, // ğŸ”¥
                model: document.getElementById('eq-model').value, 
                location: document.getElementById('eq-location').value, 
                custodian: document.getElementById('eq-custodian').value, // ğŸ”¥ åŠ å…¥é€™è¡Œ
                totalQty: document.getElementById('eq-total').value 
            };
            if(!p.name) return alert("åç¨±å¿…å¡«"); 
            toggleLoader(true); 
            closeModal('edit-eq-modal'); 
            await callGasApi(p); 
            fetchEquipmentData(false); 
            toggleLoader(false);
        }
        async function deleteEquipment() { if(confirm("ç¢ºå®šåˆªé™¤?")) { toggleLoader(true); closeModal('edit-eq-modal'); await callGasApi({action:'manage_equipment', userId, displayName, mode:'delete', eqId:document.getElementById('edit-eq-id').value}); fetchEquipmentData(false); toggleLoader(false); } }
        async function fetchHistory(){
            document.getElementById('history-modal').classList.add('flex');
            document.getElementById('history-list').innerHTML='<div class="loader"></div>';
            try {
                const d = await callGasApi({action:'get_loan_history', userId});
                document.getElementById('history-list').innerHTML = (d && d.length > 0) 
                    ? d.map(l => renderHistoryCard(l)).join('') 
                    : "<div class='text-center text-gray-500 mt-4'>ç„¡æ­·å²ç´€éŒ„</div>";
            } catch(e) {
                document.getElementById('history-list').innerHTML = `<p class="text-red-400 text-center">è¼‰å…¥å¤±æ•—: ${e.message}</p>`;
            }
        }
        async function fetchItemHistory(id){
            document.getElementById('history-modal').classList.add('flex');
            document.getElementById('history-list').innerHTML='<div class="loader"></div>';
            try {
                const d = await callGasApi({action:'get_loan_history', userId, eqId:id});
                document.getElementById('history-list').innerHTML = (d && d.length > 0) 
                    ? d.map(l => renderHistoryCard(l)).join('') 
                    : "<div class='text-center text-gray-500 mt-4'>æ­¤è£å‚™ç„¡å€Ÿå‡ºç´€éŒ„</div>";
            } catch(e) {
                document.getElementById('history-list').innerHTML = `<p class="text-red-400 text-center">è¼‰å…¥å¤±æ•—: ${e.message}</p>`;
            }
        }
        // ğŸ”¥ [æ–°å¢] æ­·å²å¡ç‰‡æ¸²æŸ“å™¨ (å…±ç”¨é‚è¼¯)
        function renderHistoryCard(l) {
            // åˆ¤æ–·æ˜¯å¦ç‚ºç¶­ä¿®å–®
            const isRepair = l.note && l.note.startsWith('[ç¶­ä¿®]');
            const repairReason = isRepair ? l.note.replace('[ç¶­ä¿®]', '').trim() : '';

            // æ±ºå®šé¡¯ç¤ºçš„ç‹€æ…‹æ–‡å­—èˆ‡é¡è‰²
            let statusText = l.status;
            let statusClass = 'border-blue-500'; // é è¨­å€Ÿå‡ºæ˜¯è—è‰²
            let icon = 'ğŸ‘¤';

            if (isRepair) {
                // ç¶­ä¿®é‚è¼¯
                if (l.status === 'å€Ÿå‡ºä¸­') {
                    statusText = 'ğŸ”§ ç¶­ä¿®ä¸­';
                    statusClass = 'border-orange-500'; // ç¶­ä¿®æ˜¯æ©˜è‰²
                    icon = '';
                } else {
                    statusText = 'âœ… ç¶­ä¿®å®Œæˆ'; // æ­¸é‚„è®Šæˆç¶­ä¿®å®Œæˆ
                    statusClass = 'border-green-500';
                    icon = '';
                }
            } else {
                // ä¸€èˆ¬å€Ÿé‚„é‚è¼¯
                if (l.status === 'å·²æ­¸é‚„') {
                    statusClass = 'border-green-500';
                    icon = 'â™»ï¸';
                }
            }

            // é¡¯ç¤ºè£å‚™åç¨± (å¦‚æœæ˜¯å–®é …æŸ¥è©¢ï¼Œå¯èƒ½æœƒæƒ³éš±è—åç¨±ï¼Œä½†çµ±ä¸€é¡¯ç¤ºä¹Ÿç„¡å¦¨)
            const nameHtml = l.item_name ? `<div class="font-bold text-base mb-1">${l.item_name}</div>` : '';
            // å¦‚æœæ˜¯ç¶­ä¿®ï¼Œé¡¯ç¤ºåŸå› ï¼›ä¸€èˆ¬å€Ÿå‡ºé¡¯ç¤ºå‚™è¨»
            const subInfo = isRepair 
                ? `<div class="text-xs text-orange-300 mt-1">åŸå› : ${repairReason}</div>`
                : (l.note ? `<div class="text-xs text-gray-400 mt-1">å‚™è¨»: ${l.note}</div>` : '');

            return `
                <div class="bg-gray-700 p-3 mb-2 rounded border-l-4 ${statusClass} text-sm">
                    ${nameHtml}
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-gray-200">${icon} ${l.borrower}</span>
                        <span class="text-xs text-gray-400">${l.time}</span>
                    </div>
                    <div class="flex justify-between items-center mt-1">
                        <span class="font-bold ${isRepair && l.status==='å€Ÿå‡ºä¸­' ? 'text-orange-400' : 'text-gray-300'}">${statusText}</span>
                        <span class="bg-gray-800 px-2 py-0.5 rounded text-xs">æ•¸é‡: ${l.qty}</span>
                    </div>
                    ${subInfo}
                </div>`;
        }
        // AI
        function showAiPage() { document.getElementById('view-ai').classList.remove('hidden'); }
        async function askAI(mode) { 
            const q = document.getElementById('ai-input').value; if(!q) return alert("è«‹è¼¸å…¥"); toggleLoader(true);
            try { const r = await callGasApi({action:mode==='ppt'?'make_briefing_ppt':'ask_ai', userId, question:q, query:q});
            document.getElementById('ai-response').classList.remove('hidden');
            document.getElementById('ai-response').innerHTML = mode==='ppt'?`<a href="${r.url}" target="_blank" class="btn block text-center bg-green-600 p-2 rounded">ä¸‹è¼‰ç°¡å ±</a>`:r.answer; } catch(e){alert(e.message)} finally{toggleLoader(false)}
        }
        async function safeExecute(btn, fn) { btn.disabled=true; await fn(); btn.disabled=false; }

        // ğŸ”¥ [æ–°å¢] æ‰“é–‹è©³ç´°è³‡æ–™è·³çª—
        function openDetailsModal(id) {
            const eq = equipmentCache.find(e => e.id === id);
            if (!eq) return;

            // 1. å¡«å¯«æ–‡å­—è³‡æ–™
            document.getElementById('details-name').textContent = eq.name;
            const custEl = document.getElementById('details-custodian');
            if (eq.custodian) {
                custEl.textContent = `ğŸ›¡ï¸ ä¿ç®¡äºº: ${eq.custodian}`;
                custEl.classList.remove('hidden');
            } else {
                custEl.classList.add('hidden');
            }
            document.getElementById('details-total').textContent = eq.total_qty;
            document.getElementById('details-avail').textContent = eq.available_qty;

            // 2. è™•ç†å­—ä¸²åˆ‡å‰² (æŠŠè³‡æ–™åº«è£¡çš„æ›è¡Œ \n åˆ‡æˆé™£åˆ—)
            // .filter(Boolean) æ˜¯ç‚ºäº†å»é™¤ç©ºå­—ä¸²(é˜²å‘†)
            currentImageArray = eq.image ? eq.image.split('\n').map(s => s.trim()).filter(Boolean) : [];
            currentImageIndex = 0; // é è¨­å¾ç¬¬ä¸€å¼µé–‹å§‹

            const errorEl = document.getElementById('details-img-error');
            const counterEl = document.getElementById('details-img-counter');

            if (currentImageArray.length > 0) {
                errorEl.classList.add('hidden');
                // å¦‚æœç…§ç‰‡å¤§æ–¼ 1 å¼µï¼Œé¡¯ç¤ºåŠé€æ˜è¨ˆæ•¸å™¨ï¼Œå¦å‰‡éš±è—
                if (currentImageArray.length > 1) counterEl.classList.remove('hidden');
                else counterEl.classList.add('hidden');
                
                // è¼‰å…¥ç¬¬ä¸€å¼µåœ–ç‰‡
                loadDetailsImage(currentImageIndex);
            } else {
                // å¦‚æœå®Œå…¨æ²’ç…§ç‰‡
                document.getElementById('details-img-loading').classList.add('hidden');
                document.getElementById('details-image').classList.add('hidden');
                counterEl.classList.add('hidden');
                errorEl.textContent = "å°šç„¡åœ–ç‰‡è³‡è¨Š";
                errorEl.classList.remove('hidden');
            }

            // 3. é¡¯ç¤ºå½ˆçª—ä¸¦ç¶å®šä¸€æ¬¡æ€§çš„æ»‘å‹•äº‹ä»¶
            const modal = document.getElementById('details-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setupImageSwipe();
        }

        // ğŸ”¥ [æ–°å¢] è¼‰å…¥ç‰¹å®šç´¢å¼•çš„åœ–ç‰‡
        function loadDetailsImage(index) {
            const imgEl = document.getElementById('details-image');
            const loadingEl = document.getElementById('details-img-loading');
            const counterEl = document.getElementById('details-img-counter');

            // æ›åœ–å‰å…ˆè½‰åœˆåœˆ
            imgEl.classList.add('hidden');
            loadingEl.classList.remove('hidden');
            imgEl.removeAttribute('src'); 
            
            imgEl.onload = hideImgLoading;
            imgEl.onerror = showImgError;
            
            // æŠ“å‡ºå°æ‡‰çš„ Drive ID é€²è¡Œè¼‰å…¥
            const driveId = currentImageArray[index];
            imgEl.src = `https://drive.google.com/thumbnail?id=${driveId}&sz=s0`; 
            
            // æ›´æ–°åŠé€æ˜è¨ˆæ•¸å™¨æ–‡å­— (ä¾‹å¦‚: 1 / 3)
            counterEl.textContent = `${index + 1} / ${currentImageArray.length}`;
        }

        // ğŸ”¥ [æ–°å¢] ç¶å®šè§¸æ§æ»‘å‹•äº‹ä»¶
        let isSwipeBound = false; 
        function setupImageSwipe() {
            if (isSwipeBound) return;
            isSwipeBound = true;
            const container = document.getElementById('details-img-container');
            
            // --- ğŸ“± æ‰‹æ©Ÿè§¸æ§äº‹ä»¶ ---
            container.addEventListener('touchstart', e => {
                swipeStartX = e.changedTouches[0].screenX;
            }, {passive: true});

            container.addEventListener('touchend', e => {
                handleSwipe(e.changedTouches[0].screenX);
            }, {passive: true});


            // --- ğŸ’» é›»è…¦ç‰ˆæ»‘é¼ äº‹ä»¶ ---
            let isMouseDown = false;
            container.addEventListener('mousedown', e => {
                isMouseDown = true;
                swipeStartX = e.screenX;
                // ğŸ”¥ é—œéµï¼šé˜»æ­¢é›»è…¦ç‰ˆç€è¦½å™¨é è¨­çš„ã€Œåœ–ç‰‡æ‹–æ›³é¬¼å½±ã€è¡Œç‚º
                e.preventDefault(); 
            });

            container.addEventListener('mouseup', e => {
                if (!isMouseDown) return;
                isMouseDown = false;
                handleSwipe(e.screenX);
            });

            // å¦‚æœæ»‘é¼ æŒ‰è‘—æ‹–åˆ°åœ–ç‰‡å¤–é¢æ‰æ”¾é–‹ï¼Œä¹Ÿè¦ç®—æ•¸
            container.addEventListener('mouseleave', e => {
                if (!isMouseDown) return;
                isMouseDown = false;
                handleSwipe(e.screenX);
            });


            // --- ğŸ”„ å…±ç”¨çš„æ»‘å‹•åˆ¤æ–·é‚è¼¯ ---
            function handleSwipe(swipeEndX) {
                if (currentImageArray.length <= 1) return; // åªæœ‰ä¸€å¼µåœ–å°±ä¸ç”¨åˆ‡æ›
                
                const diffX = swipeStartX - swipeEndX;

                // å¦‚æœå¾€å·¦æ»‘è¶…é 50px (çœ‹ä¸‹ä¸€å¼µ)
                if (diffX > 50) {
                    currentImageIndex = (currentImageIndex + 1) % currentImageArray.length;
                    loadDetailsImage(currentImageIndex);
                } 
                // å¦‚æœå¾€å³æ»‘è¶…é 50px (çœ‹ä¸Šä¸€å¼µ)
                else if (diffX < -50) {
                    currentImageIndex = (currentImageIndex - 1 + currentImageArray.length) % currentImageArray.length;
                    loadDetailsImage(currentImageIndex);
                }
            }
        }

        // åœ–ç‰‡è¼‰å…¥æˆåŠŸèˆ‡å¤±æ•—çš„è¼”åŠ©å‡½æ•¸
        function hideImgLoading() {
            document.getElementById('details-img-loading').classList.add('hidden');
            document.getElementById('details-image').classList.remove('hidden');
        }
        function showImgError() {
            document.getElementById('details-img-loading').classList.add('hidden');
            document.getElementById('details-img-error').textContent = "åœ–ç‰‡è¼‰å…¥å¤±æ•— (è«‹ç¢ºèªæ¬Šé™)";
            document.getElementById('details-img-error').classList.remove('hidden');
            document.getElementById('details-image').classList.add('hidden');
        }


        // ğŸ”¥ å°‡æ»‘é¼ æ‹–æ›³å°è£æˆå‡½æ•¸ï¼Œæ”¯æ´å‹•æ…‹ç”Ÿæˆçš„ UI
        function attachDragToElements() {
            const sliders = document.querySelectorAll('.filter-row');
            sliders.forEach(slider => {
                if (slider.dataset.dragAttached) return; // é¿å…é‡è¤‡ç¶å®š
                slider.dataset.dragAttached = 'true';
                
                let isDown = false; let startX; let scrollLeft;
                slider.addEventListener('mousedown', (e) => { isDown = true; slider.classList.add('active'); startX = e.pageX - slider.offsetLeft; scrollLeft = slider.scrollLeft; });
                slider.addEventListener('mouseleave', () => { isDown = false; slider.classList.remove('active'); });
                slider.addEventListener('mouseup', () => { isDown = false; slider.classList.remove('active'); });
                slider.addEventListener('mousemove', (e) => {
                    if (!isDown) return;
                    e.preventDefault();
                    const walk = (e.pageX - slider.offsetLeft - startX) * 2;
                    slider.scrollLeft = scrollLeft - walk;
                });
            });
        }


                // ğŸ† æ¥æ”¶ä¾†è‡ª Android çš„ Token
        window.setFCMToken = function(token) {
            console.log("å¾æ‰‹æ©Ÿ App å–å¾— Token:", token);
            
            // å¦‚æœ userEmail å·²ç¶“å­˜åœ¨ (ä»£è¡¨ enterSystem å·²è·‘å®Œ)ï¼Œç›´æ¥æ›´æ–°
            if (typeof userEmail !== 'undefined' && userEmail) {
                performTokenUpdate(token);
            } else {
                // å¦å‰‡æš«å­˜åœ¨å…¨åŸŸï¼Œç­‰ç™»å…¥æµç¨‹å®Œæˆå†å‘¼å«
                window.tempFCMToken = token;
            }
        };

        // åŸ·è¡Œ Supabase æ›´æ–° (éµå¾ª RLS)
        async function performTokenUpdate(token) {
            const { error } = await _supabase
                .from('users')
                .update({ fcm_token: token })
                .eq('é›»å­ä¿¡ç®±', userEmail); // å°é½Šä½ çš„ SQL æ¬„ä½åç¨±

            if (error) console.error("åŒæ­¥å¤±æ•—:", error.message);
            else console.log("ğŸ‰ Token å·²å®‰å…¨åŒæ­¥");
        }
        
        // ğŸš€ è¨»å†Š PWA Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('âœ… Service Worker è¨»å†ŠæˆåŠŸ:', reg.scope))
                    .catch(err => console.error('âŒ Service Worker è¨»å†Šå¤±æ•—:', err));
            });
        }
    </script>
</body>
</html>
