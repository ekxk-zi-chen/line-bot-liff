<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DJI æœæ•‘èˆªç·šå„ªåŒ–è½‰æª”</title>
    <style>
        :root { --primary: #ff9800; --bg: #1a1a1a; --card: #2d2d2d; --text: #eee; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 15px; }
        .card { background: var(--card); padding: 25px; border-radius: 15px; border: 2px solid var(--primary); box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        h2 { color: var(--primary); margin: 0 0 10px 0; text-align: center; }
        .warning { background: #442222; border-left: 5px solid #ff4444; padding: 10px; font-size: 0.85em; margin-bottom: 20px; color: #ffcccc; }
        .setting { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input[type="file"] { background: #3d3d3d; width: 100%; padding: 10px; border-radius: 8px; border: 1px dashed #666; color: white; }
        button { background: var(--primary); color: #000; border: none; padding: 15px; border-radius: 10px; cursor: pointer; width: 100%; font-size: 1.1em; font-weight: bold; transition: 0.2s; }
        button:active { transform: scale(0.98); opacity: 0.8; }
        #status { margin-top: 20px; text-align: center; font-weight: bold; color: #4caf50; }
        small { color: #888; display: block; margin-top: 4px; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ›¸ DJI èˆªç·šè½‰æª”å™¨</h2>
    <div class="warning">
        âš ï¸ <b>æ³¨æ„ï¼š</b> æœ¬å·¥å…·ç”Ÿæˆçš„ KML åƒ…ä¾›ã€Œåœ°åœ–åƒè€ƒã€ï¼Œè«‹å‹¿åœ¨ DJI APP ä¸­é»æ“Šã€Œé–‹å§‹åŸ·è¡Œã€è‡ªå‹•èˆªç·šï¼Œä»¥å…ç™¼ç”Ÿæ’å±±å±éšªã€‚
    </div>
    
    <div class="setting">
        <label>1. é¸æ“‡ GPX æª”æ¡ˆ</label>
        <input type="file" id="fileInput" accept=".gpx">
    </div>

    <div class="setting">
        <label>2. æŠ½ç¨€éˆæ•åº¦</label>
        <input type="number" id="epsilon" value="0.0005" step="0.0001" style="width: 100%; padding: 10px; border-radius: 5px; border:none;">
        <small>æ•¸å­—è¶Šå¤§é»è¶Šå°‘ã€‚0.0005 = ç´„ 50m èª¤å·® (æ¨è–¦)</small>
    </div>

    <button onclick="processFile()">è½‰æ›ä¸¦ä¸‹è¼‰ KML</button>
    <div id="status"></div>
</div>

<script>
    function processFile() {
        const fileInput = document.getElementById('fileInput');
        const status = document.getElementById('status');
        const epsilon = parseFloat(document.getElementById('epsilon').value);

        if (!fileInput.files.length) { alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆ"); return; }
        
        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = function(e) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(e.target.result, "text/xml");
            let coords = [];
            const trkpts = xmlDoc.getElementsByTagName("trkpt");
            
            for (let i = 0; i < trkpts.length; i++) {
                const lat = trkpts[i].getAttribute("lat");
                const lon = trkpts[i].getAttribute("lon");
                const ele = trkpts[i].getElementsByTagName("ele")[0]?.textContent || "0";
                coords.push({lon, lat, ele});
            }

            if (!coords.length) { alert("ç„¡æ•ˆ GPX"); return; }

            // æ™ºæ…§æŠ½ç¨€ (RDP ç°¡åŒ–é‚è¼¯)
            let simplified = [coords[0]];
            for (let i = 1; i < coords.length; i++) {
                const last = simplified[simplified.length - 1];
                const curr = coords[i];
                const dist = Math.sqrt(Math.pow(curr.lon - last.lon, 2) + Math.pow(curr.lat - last.lat, 2));
                if (dist > epsilon) simplified.push(curr);
            }
            if (coords.length > 1) simplified.push(coords[coords.length-1]);

            // ç”Ÿæˆ KML
            const coordStr = simplified.map(c => `${c.lon},${c.lat},${c.ele}`).join("\n");
            const kmlBody = `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>DJI_READY</name><Style id="s"><LineStyle><color>ff00ffff</color><width>6</width></LineStyle></Style><Placemark><name>âš ï¸æ‰‹å‹•åƒè€ƒç·š(å‹¿é»åŸ·è¡Œ)</name><styleUrl>#s</styleUrl><LineString><tessellate>1</tessellate><altitudeMode>clampToGround</altitudeMode><coordinates>${coordStr}</coordinates></LineString></Placemark></Document></kml>`;

            const blob = new Blob([kmlBody], {type: 'application/vnd.google-earth.kml+xml'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `DJI_REF_${file.name.replace('.gpx','')}.kml`;
            a.click();
            status.innerText = "âœ… è½‰æ›æˆåŠŸï¼é»æ•¸ï¼š" + simplified.length;
        };
        reader.readAsText(file);
    }
</script>
</body>
</html>
