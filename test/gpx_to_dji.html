<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DJI æœæ•‘èˆªç·šè½‰æª”å™¨</title>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; background: #f4f4f4; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h2 { color: #333; margin-top: 0; }
        .setting { margin-bottom: 15px; }
        label { display: block; font-weight: bold; font-size: 0.9em; }
        input[type="number"], input[type="text"] { width: 100%; padding: 8px; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; width: 100%; font-size: 1em; }
        button:hover { background: #0056b3; }
        #status { margin-top: 15px; font-weight: bold; color: #28a745; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ›¸ DJI æœæ•‘èˆªç·šè½‰æª”</h2>
    <p style="font-size: 0.8em; color: #666;">å°‡åŸå§‹ GPX è½‰ç‚º DJI å°ˆç”¨å„ªåŒ– KML (ä¸å¡é “ã€äº®é»ƒè‰²)</p>
    
    <div class="setting">
        <label>1. é¸æ“‡åŸå§‹ GPX æª”æ¡ˆ</label>
        <input type="file" id="fileInput" accept=".gpx">
    </div>

    <div class="setting">
        <label>2. æŠ½ç¨€éˆæ•åº¦ (Epsilon)</label>
        <input type="number" id="epsilon" value="0.0005" step="0.0001">
        <small>æ•¸å­—è¶Šå¤§è¶Šé †æš¢ï¼Œå»ºè­° 0.0005</small>
    </div>

    <div class="setting">
        <label>3. æœ€å¤§é»æ•¸é™åˆ¶</label>
        <input type="number" id="maxPoints" value="500">
    </div>

    <button onclick="processFile()">é–‹å§‹è½‰æª”ä¸¦ä¸‹è¼‰</button>
    <div id="status"></div>
</div>

<script>
    function processFile() {
        const fileInput = document.getElementById('fileInput');
        const status = document.getElementById('status');
        const epsilon = parseFloat(document.getElementById('epsilon').value);
        const maxPoints = parseInt(document.getElementById('maxPoints').value);

        if (!fileInput.files.length) {
            alert("è«‹å…ˆé¸æ“‡ GPX æª”æ¡ˆï¼");
            return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = function(e) {
            const content = e.target.result;
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(content, "text/xml");
            
            // 1. æå–åº§æ¨™
            let coords = [];
            const trkpts = xmlDoc.getElementsByTagName("trkpt");
            
            for (let i = 0; i < trkpts.length; i++) {
                const lat = trkpts[i].getAttribute("lat");
                const lon = trkpts[i].getAttribute("lon");
                const eleEl = trkpts[i].getElementsByTagName("ele")[0];
                const ele = eleEl ? eleEl.textContent : "0";
                coords.push({lon, lat, ele});
            }

            if (coords.length === 0) {
                alert("æ‰¾ä¸åˆ°æœ‰æ•ˆçš„åº§æ¨™é»ï¼");
                return;
            }

            // 2. æ™ºæ…§æŠ½ç¨€
            let simplified = [coords[0]];
            for (let i = 1; i < coords.length; i++) {
                const last = simplified[simplified.length - 1];
                const curr = coords[i];
                const dist = Math.sqrt(Math.pow(curr.lon - last.lon, 2) + Math.pow(curr.lat - last.lat, 2));
                if (dist > epsilon) {
                    simplified.push(curr);
                }
            }
            if (coords.length > 1) simplified.push(coords[coords.length-1]);

            // 3. å¼·åˆ¶é»æ•¸é™åˆ¶
            if (simplified.length > maxPoints) {
                const step = Math.floor(simplified.length / maxPoints);
                let finalCoords = [];
                for (let i = 0; i < simplified.length; i += step) {
                    finalCoords.push(simplified[i]);
                }
                simplified = finalCoords;
            }

            // 4. ç”Ÿæˆ KML å­—ä¸²
            const coordString = simplified.map(c => `${c.lon},${c.lat},${c.ele}`).join("\n");
            const kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>DJI_SAR_Route</name>
    <Style id="djiStyle">
      <LineStyle>
        <color>ff00ffff</color>
        <width>6</width>
      </LineStyle>
    </Style>
    <Placemark>
      <name>æ‰‹å‹•åƒè€ƒè»Œè·¡ (å‹¿é»åŸ·è¡Œ)</name>
      <styleUrl>#djiStyle</styleUrl>
      <LineString>
        <tessellate>1</tessellate>
        <altitudeMode>clampToGround</altitudeMode>
        <coordinates>${coordString}</coordinates>
      </LineString>
    </Placemark>
  </Document>
</kml>`;

            // 5. ä¸‹è¼‰æª”æ¡ˆ
            const blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "DJI_READY_" + file.name.replace(".gpx", ".kml");
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            status.innerText = `âœ… è½‰æ›å®Œæˆï¼é»æ•¸ï¼š${simplified.length}`;
        };

        reader.readAsText(file);
    }
</script>
</body>
</html>
