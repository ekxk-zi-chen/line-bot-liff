
<div class="table-container">
<style>
  div.table-container {
      overflow-x: auto;
  }
  table {
      width: 100%;
      max-width: 100%;
      border-collapse: collapse;
  }
  th, td {
      padding: 4px;
      text-align: left;
      word-break: break-word;
      border: 1px solid #ccc;
      vertical-align: top;
  }
  td div, th div {
      width: 100%;
      height: 100%;
  }
  .recorder-cell button {
      margin-right: 4px;
  }
  #exportBtn {
      margin: 10px 0;
      padding: 6px 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
  }
</style>

<button id="exportBtn">ğŸ’¾ åŒ¯å‡º ZIP</button>

<table border="1" style="border-collapse:collapse; width:100%;"><thead><tr><th><div data-gjs-editable="true">æ„å¤–å‚·ç—…ç¾å ´ç´€éŒ„/SOP</div></th><th><div data-gjs-editable="true">Unnamed: 1</div></th><th><div data-gjs-editable="true">Unnamed: 2</div></th><th><div data-gjs-editable="true">Unnamed: 3</div></th><th><div data-gjs-editable="true">Unnamed: 4</div></th><th><div data-gjs-editable="true">Unnamed: 5</div></th><th><div data-gjs-editable="true">Unnamed: 6</div></th><th><div data-gjs-editable="true">Unnamed: 7</div></th></tr></thead><tbody><tr><td><div data-gjs-editable="true">å‚·ç—…æ‚£å§“å</div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true">å¹´é½¡</div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true">æ€§åˆ¥</div></td><td><div class='radio-question'><label><input type='radio' name='q0' value='ç”·ç”Ÿ'> ç”·ç”Ÿ</label><br><label><input type='radio' name='q0' value='å¥³ç”Ÿ'> å¥³ç”Ÿ</label><br></div></td><td><div data-gjs-editable="true">é«”é‡</div></td><td><div data-gjs-editable="true"></div></td></tr><tr><td><div data-gjs-editable="true">ç·Šæ€¥è¯çµ¡äºº</div></td>
                <td>
                  <div class="recorder-cell">
                    <button onclick="startRecording(this)">ğŸ¤ éŒ„éŸ³</button>
                    <button onclick="stopRecording(this)" disabled>â¹ åœæ­¢</button>
                    <button onclick="playRecording(this)" disabled>â–¶ æ’­æ”¾</button>
                    <audio controls style="display:none;"></audio>
                  </div>
                </td>
                <td><div data-gjs-editable="true">å‚·ç—…æ‚£è¡Œç¨‹ç¸½å¤©æ•¸</div></td><td><div class='radio-question'><label><input type='radio' name='q1' value='ä¸€æ—¥'> ä¸€æ—¥</label><br><label><input type='radio' name='q1' value='äºŒæ—¥'> äºŒæ—¥</label><br><label><input type='radio' name='q1' value='ä¸‰æ—¥'> ä¸‰æ—¥</label><br></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td></tr><tr><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true">123.0</div></td></tr><tr><td><div data-gjs-editable="true">ä¸»è¨´</div></td>
                <td>
                  <div class="recorder-cell">
                    <button onclick="startRecording(this)">ğŸ¤ éŒ„éŸ³</button>
                    <button onclick="stopRecording(this)" disabled>â¹ åœæ­¢</button>
                    <button onclick="playRecording(this)" disabled>â–¶ æ’­æ”¾</button>
                    <audio controls style="display:none;"></audio>
                  </div>
                </td>
                <td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true">å¤šé¸æ¸¬è©¦</div></td><td><div data-gjs-editable="true"></div></td><td><div class='multi-question' style='position:relative;'><button type='button' class='multi-toggle'>è«‹é¸æ“‡ â–¼</button><div class='multi-dropdown' style='display:none; border:1px solid #ccc; padding:6px; background:#fff; position:absolute; z-index:999; max-height:200px; overflow:auto;'><label style='display:block;'><input type='checkbox' value='ä½ å¥½'> ä½ å¥½</label><label style='display:block;'><input type='checkbox' value='ä»–å¥½'> ä»–å¥½</label><label style='display:block;'><input type='checkbox' value='æˆ‘å¥½'> æˆ‘å¥½</label><label style='display:block;'><input type='checkbox' value='æ²’æœ‰äººå¥½'> æ²’æœ‰äººå¥½</label><label style='display:block;'><input type='checkbox' value='å¤§å®¶éƒ½å¥½'> å¤§å®¶éƒ½å¥½</label><button type='button' class='multi-confirm'>ç¢ºå®š</button></div><div class='multi-result' style='margin-top:4px; color:#333;'></div></div></td><td><div data-gjs-editable="true"></div></td></tr><tr><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true">è¼¸å…¥æ¸¬è©¦</div></td><td><div data-gjs-editable="true"></div></td>
                <td>
                  <div class="text-input-cell">
                    <textarea placeholder="è«‹è¼¸å…¥æ–‡å­—..." rows="3" style="width:100%"></textarea>
                  </div>
                </td>
                <td><div data-gjs-editable="true"></div></td></tr></tbody></table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
let mediaRecorder;
let recordedChunks = [];
let latestBlob = null;

// === éŒ„éŸ³åŠŸèƒ½ ===
function startRecording(btn) {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("âš ï¸ é€™å€‹ç€è¦½å™¨ä¸æ”¯æ´éŒ„éŸ³ (è«‹ä½¿ç”¨ iOS14+ Safari æˆ– Android Chrome)");
        return;
    }
    const cell = btn.closest(".recorder-cell");
    const stopBtn = cell.querySelector("button[onclick^='stopRecording']");
    const playBtn = cell.querySelector("button[onclick^='playRecording']");
    const audio = cell.querySelector("audio");

    recordedChunks = [];
    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/mp4' });
            mediaRecorder.start();

            mediaRecorder.ondataavailable = e => {
                if (e.data.size > 0) recordedChunks.push(e.data);
            };
            mediaRecorder.onstop = () => {
                latestBlob = new Blob(recordedChunks, { type: 'audio/mp4' });
                audio.src = URL.createObjectURL(latestBlob);
                audio.style.display = "block";
                playBtn.disabled = false;
            };

            btn.disabled = true;
            stopBtn.disabled = false;
            playBtn.disabled = true;
        })
        .catch(err => {
            console.error("éŒ„éŸ³å¤±æ•—:", err);
            alert("ç„¡æ³•å•Ÿå‹•éŒ„éŸ³: " + err.message);
        });
}

function stopRecording(btn) {
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
    }
    const cell = btn.closest(".recorder-cell");
    const startBtn = cell.querySelector("button[onclick^='startRecording']");
    const playBtn = cell.querySelector("button[onclick^='playRecording']");
    startBtn.disabled = false;
    btn.disabled = true;
    playBtn.disabled = false;
}

function playRecording(btn) {
    const cell = btn.closest(".recorder-cell");
    const audio = cell.querySelector("audio");
    audio.play();
}

// === å¤šé¸é¡Œæ§åˆ¶ ===
document.addEventListener("click", function(e) {
    // å±•é–‹/æ”¶åˆé¸å–®
    if (e.target.classList.contains("multi-toggle")) {
        const dropdown = e.target.nextElementSibling;
        dropdown.style.display = (dropdown.style.display === "none" || dropdown.style.display === "") ? "block" : "none";
    }

    // ç¢ºå®šé¸æ“‡
    if (e.target.classList.contains("multi-confirm")) {
        const dropdown = e.target.parentElement;
        const checkboxes = dropdown.querySelectorAll("input[type=checkbox]:checked");
        const values = Array.from(checkboxes).map(cb => cb.value);
        const resultDiv = dropdown.parentElement.querySelector(".multi-result");
        resultDiv.textContent = values.length > 0 ? values.join("ã€") : "æœªé¸æ“‡";
        dropdown.style.display = "none";
    }
});

// === åŒ¯å‡º ===
document.getElementById("exportBtn").addEventListener("click", async () => {
    const container = document.querySelector(".table-container").cloneNode(true);
    container.querySelector("#exportBtn")?.remove();

    const tasks = Array.from(container.querySelectorAll("td")).map(cell => {
        // å–®é¸é¡Œ
        if (cell.querySelector(".radio-question")) {
            const selected = cell.querySelector("input[type=radio]:checked");
            cell.innerHTML = selected ? `<span>${selected.value}</span>` : "<span>æœªé¸æ“‡</span>";
            return Promise.resolve();
        }
        // å¤šé¸é¡Œ
        if (cell.querySelector(".multi-question")) {
            const resultDiv = cell.querySelector(".multi-result");
            const text = resultDiv.textContent.trim();
            cell.innerHTML = text ? `<span>${text}</span>` : "<span>æœªé¸æ“‡</span>";
            return Promise.resolve();
        }
        // è¼¸å…¥æ–‡å­—
        if (cell.querySelector(".text-input-cell")) {
            const textarea = cell.querySelector("textarea");
            const text = textarea.value.trim();
            cell.innerHTML = text ? `<div>${text}</div>` : "<span>å°šæœªè¼¸å…¥</span>";
            return Promise.resolve();
        }
        // éŒ„éŸ³
        if (cell.querySelector(".recorder-cell")) {
            const audio = cell.querySelector("audio");
            if (audio && audio.src.startsWith("blob:")) {
                return fetch(audio.src).then(r => r.blob()).then(blob => new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = function() {
                        const base64data = reader.result;
                        cell.innerHTML = `<audio controls src="${base64data}"></audio>`;
                        resolve();
                    };
                    reader.readAsDataURL(blob);
                }));
            } else {
                cell.innerHTML = "<span>å°šæœªéŒ„éŸ³</span>";
                return Promise.resolve();
            }
        }
        return Promise.resolve();
    });

    await Promise.all(tasks);

    const exportHTML = `<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>å·²åŒ¯å‡ºè¡¨æ ¼</title></head>
<body>${container.outerHTML}</body>
</html>`;

    const zip = new JSZip();
    zip.file("exported_table.html", exportHTML);

    zip.generateAsync({type:"blob"}).then(async function(content) {
        const file = new File([content], "exported_table.zip", {type:"application/zip"});
        
        if (navigator.canShare && navigator.canShare({files:[file]})) {
            try {
                await navigator.share({
                    files: [file],
                    title: "åŒ¯å‡ºè¡¨æ ¼",
                    text: "é€™æ˜¯ä½ åŒ¯å‡ºçš„è¡¨æ ¼ ZIP æª”"
                });
                return;
            } catch(err) {
                console.error("åˆ†äº«å¤±æ•—:", err);
            }
        }

        const a = document.createElement("a");
        a.href = URL.createObjectURL(content);
        a.download = "exported_table.zip";
        a.click();
    });
});
</script>
</div>
