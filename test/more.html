
<div class="table-container">
<style>
  div.table-container { overflow-x: auto; }
  table { width: 100%; max-width: 100%; border-collapse: collapse; }
  th, td { padding: 6px; text-align: left; word-break: break-word; border: 1px solid #ccc; vertical-align: top; cursor: default; }
  .editable-cell { background: #fff8dc; cursor: pointer; font-weight: bold; }
  .editable-cell:hover { background: #ffe69c; }
  #exportBtn { margin: 10px 0; padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 6px; font-size: 16px; }

  /* Modal 手機優化 */
  .modal { display: none; position: fixed; z-index: 1000; left:0; top:0; width:100%; height:100%; background-color: rgba(0,0,0,0.6); }
  .modal-content { position: absolute; bottom:0; left:0; width:100%; background-color:#fff; max-height:50%; display:flex; flex-direction:column; border-radius:12px 12px 0 0; overflow:hidden; }
  #modalHeader { padding:10px; border-bottom:1px solid #ccc; }
  #modalBodyWrapper { flex:1; overflow-y:auto; padding:10px; }
  #modalFooter { padding:10px; background:#f1f1f1; display:flex; justify-content:flex-end; gap:10px; }
  #modalFooter button { flex:none; padding:10px 20px; font-size:16px; }
  audio { width:100%; height:40px; }
  textarea { width:100%; font-size:18px; padding:8px; }
  select[multiple] { width:100%; font-size:18px; }
</style>

<button id="exportBtn">💾 匯出 ZIP</button>

<table border="1" style="border-collapse:collapse; width:100%;"><thead><tr><th><div data-gjs-editable="true">意外傷病現場紀錄/SOP</div></th><th><div data-gjs-editable="true">None</div></th><th><div data-gjs-editable="true">None</div></th><th><div data-gjs-editable="true">None</div></th><th><div data-gjs-editable="true">None</div></th><th><div data-gjs-editable="true">None</div></th><th><div data-gjs-editable="true">None</div></th><th><div data-gjs-editable="true">None</div></th></tr></thead><tbody><tr><td><div data-gjs-editable="true">傷病患姓名</div></td><td class="editable-cell" data-type="text" onclick="openModal(this,'text')">✏️ 輸入文字</td><td><div data-gjs-editable="true">年齡</div></td><td class="editable-cell" data-type="text" onclick="openModal(this,'text')">✏️ 輸入文字</td><td><div data-gjs-editable="true">性別</div></td><td class="editable-cell" data-type="radio" data-options="男生,女生" onclick="openModal(this,'radio')">📌 選擇答案</td><td><div data-gjs-editable="true">體重</div></td><td class="editable-cell" data-type="text" onclick="openModal(this,'text')">✏️ 輸入文字</td></tr><tr><td rowspan="2"><div data-gjs-editable="true">緊急聯絡人</div></td>
                <td rowspan="2" class='editable-cell'>
                  <div class="recorder-cell">
                    <button onclick="startRecording(this)">🎤 錄音</button>
                    <button onclick="stopRecording(this)" disabled>⏹ 停止</button>
                    <button onclick="playRecording(this)" disabled>▶ 播放</button>
                    <audio controls style="display:none;"></audio>
                  </div>
                </td>
                <td rowspan="2"><div data-gjs-editable="true">傷病患行程總天數</div></td><td rowspan="2" colspan="5" class="editable-cell" data-type="radio" data-options="一日,二日,三日" onclick="openModal(this,'radio')">📌 選擇答案</td></tr><tr></tr><tr><td rowspan="3"><div data-gjs-editable="true">主訴</div></td>
                <td rowspan="3" colspan="3" class='editable-cell'>
                  <div class="recorder-cell">
                    <button onclick="startRecording(this)">🎤 錄音</button>
                    <button onclick="stopRecording(this)" disabled>⏹ 停止</button>
                    <button onclick="playRecording(this)" disabled>▶ 播放</button>
                    <audio controls style="display:none;"></audio>
                  </div>
                </td>
                <td colspan="2"><div data-gjs-editable="true">多選測試</div></td><td colspan="2" class="editable-cell" data-type="multi" data-options="你好,他好,我好,沒有人好,大家都好" onclick="openModal(this,'multi')">📌 選擇答案</td></tr><tr><td rowspan="2" colspan="2"><div data-gjs-editable="true">輸入測試</div></td><td rowspan="2" colspan="2" class="editable-cell" data-type="text" onclick="openModal(this,'text')">✏️ 輸入文字</td></tr><tr></tr></tbody></table>

<div id="modal" class="modal">
  <div class="modal-content">
    <div id="modalHeader"><h3 id="modalTitle"></h3></div>
    <div id="modalBodyWrapper"><div id="modalBody"></div></div>
    <div id="modalFooter">
      <button onclick="confirmModal()">確定</button>
      <button onclick="closeModal()">取消</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
let mediaRecorder, recordedChunks=[], latestBlob=null, currentCell=null, currentType='';
const isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

function startRecording(btn){
    const cell=btn.closest(".recorder-cell");
    const stopBtn=cell.querySelector("button[onclick^='stopRecording']");
    const playBtn=cell.querySelector("button[onclick^='playRecording']");
    const audio=cell.querySelector("audio");
    recordedChunks=[];
    navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
        mediaRecorder=new MediaRecorder(stream,{mimeType:'audio/mp4'});
        mediaRecorder.start();
        mediaRecorder.ondataavailable=e=>{if(e.data.size>0) recordedChunks.push(e.data);}
        mediaRecorder.onstop=()=>{
            latestBlob=new Blob(recordedChunks,{type:'audio/mp4'});
            audio.src=URL.createObjectURL(latestBlob);
            audio.style.display="block";
            playBtn.disabled=false;
            stopBtn.disabled=true;
            btn.disabled=false;
            stream.getTracks().forEach(track=>track.stop());
        };
        btn.disabled=true; stopBtn.disabled=false; playBtn.disabled=true;
    }).catch(err=>alert("錄音失敗:"+err.message));
}
function stopRecording(btn){ if(mediaRecorder&&mediaRecorder.state!=='inactive') mediaRecorder.stop(); }
function playRecording(btn){ const audio=btn.closest(".recorder-cell").querySelector("audio"); audio.play(); }

function openModal(cell,type){
    currentCell=cell; currentType=type;
    const options=cell.dataset.options?cell.dataset.options.split(','):[];
    const value=cell.dataset.value||'';
    document.getElementById('modalTitle').innerText=type==='text'?'請輸入文字':'請選擇答案';
    let body='';
    if(type==='text'){ body='<textarea id="modalInput" rows="5">'+value+'</textarea>'; }
    else if(type==='radio'){ body=options.map(o=>' <label style="font-size:18px;display:block;"><input type="radio" name="modalRadio" value="'+o+'" '+(o===value?'checked':'')+'> '+o+'</label>').join(''); }
    else if(type==='multi'){
        if(isMobile){ body='<select id="modalSelect" multiple>'+options.map(o=>'<option value="'+o+'" '+(value.split('、').includes(o)?'selected':'')+'>'+o+'</option>').join('')+'</select>'; }
        else{ body=options.map(o=>' <label style="font-size:18px;display:block;"><input type="checkbox" value="'+o+'" '+(value.split('、').includes(o)?'checked':'')+'> '+o+'</label>').join(''); }
    }
    document.getElementById('modalBody').innerHTML=body;
    document.getElementById('modal').style.display='block';

    if(isMobile && type==='text'){ setTimeout(()=>document.getElementById('modalInput').focus(),300); }
}

function closeModal(){ document.getElementById('modal').style.display='none'; }

function confirmModal(){
    if(!currentCell) return;
    let newValue='';
    if(currentType==='text'){ newValue=document.getElementById('modalInput').value.trim(); }
    else if(currentType==='radio'){ const sel=document.querySelector('input[name="modalRadio"]:checked'); newValue=sel?sel.value:''; }
    else if(currentType==='multi'){
        if(isMobile){ newValue=Array.from(document.getElementById('modalSelect').selectedOptions).map(i=>i.value).join('、'); }
        else{ newValue=Array.from(document.querySelectorAll('#modalBody input[type=checkbox]:checked')).map(i=>i.value).join('、'); }
    }
    currentCell.dataset.value=newValue;
    currentCell.innerText=newValue||(currentType==='multi'?'未選擇':'尚未輸入');
    closeModal();
}

// 匯出 ZIP
document.getElementById("exportBtn").addEventListener("click",async()=>{
    const container=document.querySelector(".table-container").cloneNode(true);
    container.querySelector("#exportBtn")?.remove();
    const tasks=Array.from(container.querySelectorAll("td")).map(cell=>{
        if(cell.querySelector(".recorder-cell")){
            const audio=cell.querySelector("audio");
            if(audio && audio.src.startsWith("blob:")){
                return fetch(audio.src).then(r=>r.blob()).then(blob=>new Promise(resolve=>{
                    const reader=new FileReader();
                    reader.onload=function(){ cell.innerHTML='<audio controls src="'+reader.result+'"></audio>'; resolve(); };
                    reader.readAsDataURL(blob);
                }));
            } else { cell.innerHTML=''; return Promise.resolve(); }
        }
        if(cell.classList.contains('editable-cell')){
            if(['text','radio','multi'].includes(cell.dataset.type)){ cell.innerHTML='<div>'+ (cell.dataset.value||'')+'</div>'; }
        }
        return Promise.resolve();
    });
    await Promise.all(tasks);
    const exportHTML='<!DOCTYPE html><html><head><meta charset="utf-8"><title>已匯出表格</title></head><body>'+container.outerHTML+'</body></html>';
    const zip=new JSZip(); zip.file("exported_table.html",exportHTML);
    zip.generateAsync({type:"blob"}).then(async content=>{
        const file=new File([content],"exported_table.zip",{type:"application/zip"});
        if(navigator.canShare && navigator.canShare({files:[file]})){
            try{ await navigator.share({files:[file],title:"匯出表格",text:"這是你匯出的表格 ZIP 檔"}); return; }catch(err){console.error(err);}
        }
        const a=document.createElement("a"); a.href=URL.createObjectURL(content); a.download="exported_table.zip"; a.click();
    });
});
</script>
</div>
