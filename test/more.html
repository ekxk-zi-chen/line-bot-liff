
<div class="table-container">
<style>
div.table-container { overflow-x:auto; }
table { width:100%; max-width:100%; border-collapse:collapse; }
th, td { padding:6px; text-align:left; word-break:break-word; border:1px solid #ccc; vertical-align:top; cursor:default; }
.editable-cell { background:#fff8dc; font-weight:bold; }
.editable-cell:hover { background:#ffe69c; }
/* 單選題 & 多選題按鈕容器自動換行 */
.editable-cell[data-type="radio"],
.editable-cell[data-type="multi"] {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    width: 100%;
    box-sizing: border-box;
}
.option-button {
    margin: 2px 0;         /* 保留原本 margin */
    padding: 6px 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background: #fff;
    cursor: pointer;
    white-space: normal;   /* 🔹允許文字換行 */
}
.option-button.selected { background:#4CAF50; color:white; }

#exportBtn { margin:10px 0; padding:8px 16px; background:#4CAF50; color:white; border:none; border-radius:6px; font-size:16px; }

/* Modal 手機優化 */
.modal {
    display: none;
    position: absolute; /* 🔹改成絕對定位，跟隨 cell */
    z-index: 1000;
    background-color: rgba(0,0,0,0.6);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

.modal-content {
    position: relative;
    width: 90%;
    max-height: 60%;
    background: #fff;
    padding: 10px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    border-radius: 8px;
}
/* 🔹只改倒數提醒的 modal */
#reminder {
    position: fixed;       /* 固定在螢幕，不受滾動影響 */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;   /* 垂直置中 */
    justify-content: center; /* 水平置中 */
    z-index: 1000;
}

#reminder .modal-content {
    max-width: 80%;
    text-align: center;
    border-radius: 16px;
    padding: 20px;
    background: #fff;
}

#reminder .reminder-message {
    font-size: 24px;
    margin-bottom: 30px;
}

#reminder button {
    padding: 20px 40px;      /* 🔹按鈕大 */
    font-size: 32px;         /* 🔹文字大 */
    border: none;
    border-radius: 12px;
    background: #4CAF50;
    color: white;
    cursor: pointer;
}


#modalInput, #numberInput { width:100%; font-size:18px; padding:8px; flex:1; }
#modalFooter { display:flex; justify-content:space-between; }
#modalFooter button { padding:10px 20px; font-size:16px; }
</style>

<button id="exportBtn">💾 匯出 ZIP</button>

<table border="1" style="border-collapse:collapse; width:100%;"><thead><tr><th><div data-gjs-editable="true">意外傷病現場紀錄/SOP</div></th><th><div data-gjs-editable="true">None</div></th><th><div data-gjs-editable="true">None</div></th><th><div data-gjs-editable="true">None</div></th><th><div data-gjs-editable="true">None</div></th><th><div data-gjs-editable="true">None</div></th><th><div data-gjs-editable="true">None</div></th><th><div data-gjs-editable="true">None</div></th></tr></thead><tbody><tr><td><div data-gjs-editable="true">傷病患姓名</div></td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td><div data-gjs-editable="true">年齡</div></td><td class="editable-cell" data-type="number" data-value="*" onclick="openNumberModal(this)">*</td><td><div data-gjs-editable="true">性別</div></td><td class="editable-cell" data-type="radio" data-value="" data-options="男生,女生"><div style="display:flex; flex-wrap:wrap; gap:4px; width:100%; box-sizing:border-box;"><button class="option-button" onclick="selectInlineOption(this,'radio')">男生</button><button class="option-button" onclick="selectInlineOption(this,'radio')">女生</button></div></td><td><div data-gjs-editable="true">體重</div></td><td class="editable-cell" data-type="number" data-value="*" onclick="openNumberModal(this)">*</td></tr><tr><td rowspan="2"><div data-gjs-editable="true">緊急聯絡人</div></td>
                <td rowspan="2" class='editable-cell'>
                  <div class="recorder-cell">
                    <button onclick="startRecording(this)">🎤 錄音</button>
                    <button onclick="stopRecording(this)" disabled>⏹ 停止</button>
                    <button onclick="playRecording(this)" disabled>▶ 播放</button>
                    <audio controls style="display:none;"></audio>
                  </div>
                </td>
                <td><div data-gjs-editable="true">傷病患行程總天數</div></td><td colspan="5" style="width:62.50%;" class="editable-cell" data-type="radio" data-value="" data-options="一日,二日,三日,四日,五日,六日,七日"><div style="display:flex; flex-wrap:wrap; gap:4px; width:100%; box-sizing:border-box;"><button class="option-button" onclick="selectInlineOption(this,'radio')">一日</button><button class="option-button" onclick="selectInlineOption(this,'radio')">二日</button><button class="option-button" onclick="selectInlineOption(this,'radio')">三日</button><button class="option-button" onclick="selectInlineOption(this,'radio')">四日</button><button class="option-button" onclick="selectInlineOption(this,'radio')">五日</button><button class="option-button" onclick="selectInlineOption(this,'radio')">六日</button><button class="option-button" onclick="selectInlineOption(this,'radio')">七日</button></div></td></tr><tr><td><div data-gjs-editable="true">總行程天數</div></td><td colspan="5" class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">可以填寫預計的天數等等計畫</td></tr><tr><td><div data-gjs-editable="true">發生日期</div></td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td><div data-gjs-editable="true">發生時間</div></td><td colspan="2" class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td colspan="2"><div data-gjs-editable="true">第幾天發生</div></td><td class="editable-cell" data-type="number" data-value="*" onclick="openNumberModal(this)">*</td></tr><tr><td><div data-gjs-editable="true">發生地點</div></td><td colspan="2" class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">詳細地點</td><td><div data-gjs-editable="true">座標</div></td><td colspan="2" class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">手動填寫座標</td><td><div data-gjs-editable="true">直接採用目前的座標</div></td><td class="editable-cell" data-type="location" onclick="fillCurrentLocation(this)">📍 點擊取得座標</td></tr><tr><td><div data-gjs-editable="true">傷病機轉</div></td><td colspan="3" style="width:37.50%;" class="editable-cell" data-type="multi" data-value="" data-options="創傷,疾病,高處墜落,生物咬螫傷"><div style="display:flex; flex-wrap:wrap; gap:4px; width:100%; box-sizing:border-box;"><button class="option-button" onclick="selectInlineOption(this,'multi')">創傷</button><button class="option-button" onclick="selectInlineOption(this,'multi')">疾病</button><button class="option-button" onclick="selectInlineOption(this,'multi')">高處墜落</button><button class="option-button" onclick="selectInlineOption(this,'multi')">生物咬螫傷</button></div></td><td colspan="2"><div data-gjs-editable="true">其他補述</div></td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">✏️ 輸入文字</td>
                <td class='editable-cell'>
                  <div class="recorder-cell">
                    <button onclick="startRecording(this)">🎤 錄音</button>
                    <button onclick="stopRecording(this)" disabled>⏹ 停止</button>
                    <button onclick="playRecording(this)" disabled>▶ 播放</button>
                    <audio controls style="display:none;"></audio>
                  </div>
                </td>
                </tr><tr><td><div data-gjs-editable="true">救援人員
現場描述</div></td><td colspan="3" class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">(含氣候、氣溫、現場環境、所見事件)</td><td colspan="2"><div data-gjs-editable="true">現場其他補述</div></td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">✏️ 輸入文字</td>
                <td class='editable-cell'>
                  <div class="recorder-cell">
                    <button onclick="startRecording(this)">🎤 錄音</button>
                    <button onclick="stopRecording(this)" disabled>⏹ 停止</button>
                    <button onclick="playRecording(this)" disabled>▶ 播放</button>
                    <audio controls style="display:none;"></audio>
                  </div>
                </td>
                </tr><tr><td colspan="8"><div data-gjs-editable="true">SAMPLE/病史詢問</div></td></tr><tr><td><div data-gjs-editable="true">S/感:症狀</div></td><td colspan="3" class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td colspan="2"><div data-gjs-editable="true">A/敏:過敏</div></td><td colspan="2" class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td></tr><tr><td><div data-gjs-editable="true">M/藥:藥物</div></td><td colspan="3" class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td colspan="2"><div data-gjs-editable="true">P/過:過去相關病史</div></td><td colspan="2" class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td></tr><tr><td><div data-gjs-editable="true">L/吃:最後的進出</div></td><td colspan="3" class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td colspan="2"><div data-gjs-editable="true">E/之前:發生意外之前的事件</div></td><td colspan="2" class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td></tr><tr><td rowspan="3"><div data-gjs-editable="true">主訴</div></td><td rowspan="3" colspan="3" class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">可填寫簡單就好</td><td colspan="2"><div data-gjs-editable="true">主訴簡易多選</div></td><td class="editable-cell" data-type="multi" data-value="" data-options="正面,頭痛,頸椎痛,胸痛,腹痛,背痛,骨盆壓痛,左上肢疼痛,左下肢疼痛,右上肢疼痛,右下肢疼痛"><div style="display:flex; flex-wrap:wrap; gap:4px; width:100%; box-sizing:border-box;"><button class="option-button" onclick="selectInlineOption(this,'multi')">正面</button><button class="option-button" onclick="selectInlineOption(this,'multi')">頭痛</button><button class="option-button" onclick="selectInlineOption(this,'multi')">頸椎痛</button><button class="option-button" onclick="selectInlineOption(this,'multi')">胸痛</button><button class="option-button" onclick="selectInlineOption(this,'multi')">腹痛</button><button class="option-button" onclick="selectInlineOption(this,'multi')">背痛</button><button class="option-button" onclick="selectInlineOption(this,'multi')">骨盆壓痛</button><button class="option-button" onclick="selectInlineOption(this,'multi')">左上肢疼痛</button><button class="option-button" onclick="selectInlineOption(this,'multi')">左下肢疼痛</button><button class="option-button" onclick="selectInlineOption(this,'multi')">右上肢疼痛</button><button class="option-button" onclick="selectInlineOption(this,'multi')">右下肢疼痛</button></div></td><td class="editable-cell" data-type="multi" data-value="" data-options="背面,頭痛,頸椎痛,胸痛,腹痛,背痛,骨盆壓痛,左上肢疼痛,左下肢疼痛,右上肢疼痛,右下肢疼痛"><div style="display:flex; flex-wrap:wrap; gap:4px; width:100%; box-sizing:border-box;"><button class="option-button" onclick="selectInlineOption(this,'multi')">背面</button><button class="option-button" onclick="selectInlineOption(this,'multi')">頭痛</button><button class="option-button" onclick="selectInlineOption(this,'multi')">頸椎痛</button><button class="option-button" onclick="selectInlineOption(this,'multi')">胸痛</button><button class="option-button" onclick="selectInlineOption(this,'multi')">腹痛</button><button class="option-button" onclick="selectInlineOption(this,'multi')">背痛</button><button class="option-button" onclick="selectInlineOption(this,'multi')">骨盆壓痛</button><button class="option-button" onclick="selectInlineOption(this,'multi')">左上肢疼痛</button><button class="option-button" onclick="selectInlineOption(this,'multi')">左下肢疼痛</button><button class="option-button" onclick="selectInlineOption(this,'multi')">右上肢疼痛</button><button class="option-button" onclick="selectInlineOption(this,'multi')">右下肢疼痛</button></div></td></tr><tr><td rowspan="2" colspan="2"><div data-gjs-editable="true">主訴錄音</div></td>
                <td rowspan="2" colspan="2" class='editable-cell'>
                  <div class="recorder-cell">
                    <button onclick="startRecording(this)">🎤 錄音</button>
                    <button onclick="stopRecording(this)" disabled>⏹ 停止</button>
                    <button onclick="playRecording(this)" disabled>▶ 播放</button>
                    <audio controls style="display:none;"></audio>
                  </div>
                </td>
                </tr><tr></tr><tr><td><div data-gjs-editable="true">主訴補充</div></td><td colspan="3" class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">✏️ 輸入文字</td>
                <td colspan="2" class='editable-cell'>
                  <div class="recorder-cell">
                    <button onclick="startRecording(this)">🎤 錄音</button>
                    <button onclick="stopRecording(this)" disabled>⏹ 停止</button>
                    <button onclick="playRecording(this)" disabled>▶ 播放</button>
                    <audio controls style="display:none;"></audio>
                  </div>
                </td>
                <td><div data-gjs-editable="true">目前人員座標</div></td><td class="editable-cell" data-type="location" onclick="fillCurrentLocation(this)">📍 點擊取得座標</td></tr><tr><td><div data-gjs-editable="true">時間</div></td><td><div data-gjs-editable="true">意識</div></td><td><div data-gjs-editable="true">呼吸</div></td><td colspan="2"><div data-gjs-editable="true">脈搏</div></td><td><div data-gjs-editable="true">體溫</div></td><td><div data-gjs-editable="true">膚色</div></td><td><div data-gjs-editable="true">其他</div></td></tr><tr><td class="editable-cell" data-type="datetime" onclick="fillCurrentTime(this)">⏰ 現在時間</td><td class="editable-cell" data-type="radio" data-value="" data-options="清,聲,痛,否"><div style="display:flex; flex-wrap:wrap; gap:4px; width:100%; box-sizing:border-box;"><button class="option-button" onclick="selectInlineOption(this,'radio')">清</button><button class="option-button" onclick="selectInlineOption(this,'radio')">聲</button><button class="option-button" onclick="selectInlineOption(this,'radio')">痛</button><button class="option-button" onclick="selectInlineOption(this,'radio')">否</button></div></td><td class="editable-cell" data-type="number" data-value="次/分" onclick="openNumberModal(this)">次/分</td><td colspan="2" class="editable-cell" data-type="number" data-value="次/分" onclick="openNumberModal(this)">次/分</td><td class="editable-cell" data-type="number" data-value="*" onclick="openNumberModal(this)">*</td><td class="editable-cell" data-type="radio" data-value="" data-options="正常,蒼白,是否有發紅,發紺（紫灰色）,黃疸,異常顏色"><div style="display:flex; flex-wrap:wrap; gap:4px; width:100%; box-sizing:border-box;"><button class="option-button" onclick="selectInlineOption(this,'radio')">正常</button><button class="option-button" onclick="selectInlineOption(this,'radio')">蒼白</button><button class="option-button" onclick="selectInlineOption(this,'radio')">是否有發紅</button><button class="option-button" onclick="selectInlineOption(this,'radio')">發紺（紫灰色）</button><button class="option-button" onclick="selectInlineOption(this,'radio')">黃疸</button><button class="option-button" onclick="selectInlineOption(this,'radio')">異常顏色</button></div></td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td></tr><tr><td class="editable-cell" data-type="datetime" onclick="fillCurrentTime(this)">⏰ 現在時間</td><td class="editable-cell" data-type="radio" data-value="" data-options="清,聲,痛,否"><div style="display:flex; flex-wrap:wrap; gap:4px; width:100%; box-sizing:border-box;"><button class="option-button" onclick="selectInlineOption(this,'radio')">清</button><button class="option-button" onclick="selectInlineOption(this,'radio')">聲</button><button class="option-button" onclick="selectInlineOption(this,'radio')">痛</button><button class="option-button" onclick="selectInlineOption(this,'radio')">否</button></div></td><td class="editable-cell" data-type="number" data-value="次/分" onclick="openNumberModal(this)">次/分</td><td colspan="2" class="editable-cell" data-type="number" data-value="次/分" onclick="openNumberModal(this)">次/分</td><td class="editable-cell" data-type="number" data-value="*" onclick="openNumberModal(this)">*</td><td class="editable-cell" data-type="radio" data-value="" data-options="正常,蒼白,是否有發紅,發紺（紫灰色）,黃疸,異常顏色"><div style="display:flex; flex-wrap:wrap; gap:4px; width:100%; box-sizing:border-box;"><button class="option-button" onclick="selectInlineOption(this,'radio')">正常</button><button class="option-button" onclick="selectInlineOption(this,'radio')">蒼白</button><button class="option-button" onclick="selectInlineOption(this,'radio')">是否有發紅</button><button class="option-button" onclick="selectInlineOption(this,'radio')">發紺（紫灰色）</button><button class="option-button" onclick="selectInlineOption(this,'radio')">黃疸</button><button class="option-button" onclick="selectInlineOption(this,'radio')">異常顏色</button></div></td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td></tr><tr><td class="editable-cell" data-type="datetime" onclick="fillCurrentTime(this)">⏰ 現在時間</td><td class="editable-cell" data-type="radio" data-value="" data-options="清,聲,痛,否"><div style="display:flex; flex-wrap:wrap; gap:4px; width:100%; box-sizing:border-box;"><button class="option-button" onclick="selectInlineOption(this,'radio')">清</button><button class="option-button" onclick="selectInlineOption(this,'radio')">聲</button><button class="option-button" onclick="selectInlineOption(this,'radio')">痛</button><button class="option-button" onclick="selectInlineOption(this,'radio')">否</button></div></td><td class="editable-cell" data-type="number" data-value="次/分" onclick="openNumberModal(this)">次/分</td><td colspan="2" class="editable-cell" data-type="number" data-value="次/分" onclick="openNumberModal(this)">次/分</td><td class="editable-cell" data-type="number" data-value="*" onclick="openNumberModal(this)">*</td><td class="editable-cell" data-type="radio" data-value="" data-options="正常,蒼白,是否有發紅,發紺（紫灰色）,黃疸,異常顏色"><div style="display:flex; flex-wrap:wrap; gap:4px; width:100%; box-sizing:border-box;"><button class="option-button" onclick="selectInlineOption(this,'radio')">正常</button><button class="option-button" onclick="selectInlineOption(this,'radio')">蒼白</button><button class="option-button" onclick="selectInlineOption(this,'radio')">是否有發紅</button><button class="option-button" onclick="selectInlineOption(this,'radio')">發紺（紫灰色）</button><button class="option-button" onclick="selectInlineOption(this,'radio')">黃疸</button><button class="option-button" onclick="selectInlineOption(this,'radio')">異常顏色</button></div></td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td></tr><tr><td class="editable-cell" data-type="datetime" onclick="fillCurrentTime(this)">⏰ 現在時間</td><td class="editable-cell" data-type="radio" data-value="" data-options="清,聲,痛,否"><div style="display:flex; flex-wrap:wrap; gap:4px; width:100%; box-sizing:border-box;"><button class="option-button" onclick="selectInlineOption(this,'radio')">清</button><button class="option-button" onclick="selectInlineOption(this,'radio')">聲</button><button class="option-button" onclick="selectInlineOption(this,'radio')">痛</button><button class="option-button" onclick="selectInlineOption(this,'radio')">否</button></div></td><td class="editable-cell" data-type="number" data-value="次/分" onclick="openNumberModal(this)">次/分</td><td colspan="2" class="editable-cell" data-type="number" data-value="次/分" onclick="openNumberModal(this)">次/分</td><td class="editable-cell" data-type="number" data-value="*" onclick="openNumberModal(this)">*</td><td class="editable-cell" data-type="radio" data-value="" data-options="正常,蒼白,是否有發紅,發紺（紫灰色）,黃疸,異常顏色"><div style="display:flex; flex-wrap:wrap; gap:4px; width:100%; box-sizing:border-box;"><button class="option-button" onclick="selectInlineOption(this,'radio')">正常</button><button class="option-button" onclick="selectInlineOption(this,'radio')">蒼白</button><button class="option-button" onclick="selectInlineOption(this,'radio')">是否有發紅</button><button class="option-button" onclick="selectInlineOption(this,'radio')">發紺（紫灰色）</button><button class="option-button" onclick="selectInlineOption(this,'radio')">黃疸</button><button class="option-button" onclick="selectInlineOption(this,'radio')">異常顏色</button></div></td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td></tr><tr><td class="editable-cell" data-type="datetime" onclick="fillCurrentTime(this)">⏰ 現在時間</td><td class="editable-cell" data-type="radio" data-value="" data-options="清,聲,痛,否"><div style="display:flex; flex-wrap:wrap; gap:4px; width:100%; box-sizing:border-box;"><button class="option-button" onclick="selectInlineOption(this,'radio')">清</button><button class="option-button" onclick="selectInlineOption(this,'radio')">聲</button><button class="option-button" onclick="selectInlineOption(this,'radio')">痛</button><button class="option-button" onclick="selectInlineOption(this,'radio')">否</button></div></td><td class="editable-cell" data-type="number" data-value="次/分" onclick="openNumberModal(this)">次/分</td><td colspan="2" class="editable-cell" data-type="number" data-value="次/分" onclick="openNumberModal(this)">次/分</td><td class="editable-cell" data-type="number" data-value="*" onclick="openNumberModal(this)">*</td><td class="editable-cell" data-type="radio" data-value="" data-options="正常,蒼白,是否有發紅,發紺（紫灰色）,黃疸,異常顏色"><div style="display:flex; flex-wrap:wrap; gap:4px; width:100%; box-sizing:border-box;"><button class="option-button" onclick="selectInlineOption(this,'radio')">正常</button><button class="option-button" onclick="selectInlineOption(this,'radio')">蒼白</button><button class="option-button" onclick="selectInlineOption(this,'radio')">是否有發紅</button><button class="option-button" onclick="selectInlineOption(this,'radio')">發紺（紫灰色）</button><button class="option-button" onclick="selectInlineOption(this,'radio')">黃疸</button><button class="option-button" onclick="selectInlineOption(this,'radio')">異常顏色</button></div></td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td></tr><tr><td class="editable-cell" data-type="datetime" onclick="fillCurrentTime(this)">⏰ 現在時間</td><td class="editable-cell" data-type="radio" data-value="" data-options="清,聲,痛,否"><div style="display:flex; flex-wrap:wrap; gap:4px; width:100%; box-sizing:border-box;"><button class="option-button" onclick="selectInlineOption(this,'radio')">清</button><button class="option-button" onclick="selectInlineOption(this,'radio')">聲</button><button class="option-button" onclick="selectInlineOption(this,'radio')">痛</button><button class="option-button" onclick="selectInlineOption(this,'radio')">否</button></div></td><td class="editable-cell" data-type="number" data-value="次/分" onclick="openNumberModal(this)">次/分</td><td colspan="2" class="editable-cell" data-type="number" data-value="次/分" onclick="openNumberModal(this)">次/分</td><td class="editable-cell" data-type="number" data-value="*" onclick="openNumberModal(this)">*</td><td class="editable-cell" data-type="radio" data-value="" data-options="正常,蒼白,是否有發紅,發紺（紫灰色）,黃疸,異常顏色"><div style="display:flex; flex-wrap:wrap; gap:4px; width:100%; box-sizing:border-box;"><button class="option-button" onclick="selectInlineOption(this,'radio')">正常</button><button class="option-button" onclick="selectInlineOption(this,'radio')">蒼白</button><button class="option-button" onclick="selectInlineOption(this,'radio')">是否有發紅</button><button class="option-button" onclick="selectInlineOption(this,'radio')">發紺（紫灰色）</button><button class="option-button" onclick="selectInlineOption(this,'radio')">黃疸</button><button class="option-button" onclick="selectInlineOption(this,'radio')">異常顏色</button></div></td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td></tr><tr><td class="editable-cell" data-type="datetime" onclick="fillCurrentTime(this)">⏰ 現在時間</td><td class="editable-cell" data-type="radio" data-value="" data-options="清,聲,痛,否"><div style="display:flex; flex-wrap:wrap; gap:4px; width:100%; box-sizing:border-box;"><button class="option-button" onclick="selectInlineOption(this,'radio')">清</button><button class="option-button" onclick="selectInlineOption(this,'radio')">聲</button><button class="option-button" onclick="selectInlineOption(this,'radio')">痛</button><button class="option-button" onclick="selectInlineOption(this,'radio')">否</button></div></td><td class="editable-cell" data-type="number" data-value="次/分" onclick="openNumberModal(this)">次/分</td><td colspan="2" class="editable-cell" data-type="number" data-value="次/分" onclick="openNumberModal(this)">次/分</td><td class="editable-cell" data-type="number" data-value="*" onclick="openNumberModal(this)">*</td><td class="editable-cell" data-type="radio" data-value="" data-options="正常,蒼白,是否有發紅,發紺（紫灰色）,黃疸,異常顏色"><div style="display:flex; flex-wrap:wrap; gap:4px; width:100%; box-sizing:border-box;"><button class="option-button" onclick="selectInlineOption(this,'radio')">正常</button><button class="option-button" onclick="selectInlineOption(this,'radio')">蒼白</button><button class="option-button" onclick="selectInlineOption(this,'radio')">是否有發紅</button><button class="option-button" onclick="selectInlineOption(this,'radio')">發紺（紫灰色）</button><button class="option-button" onclick="selectInlineOption(this,'radio')">黃疸</button><button class="option-button" onclick="selectInlineOption(this,'radio')">異常顏色</button></div></td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td></tr><tr><td class="editable-cell" data-type="datetime" onclick="fillCurrentTime(this)">⏰ 現在時間</td><td class="editable-cell" data-type="radio" data-value="" data-options="清,聲,痛,否"><div style="display:flex; flex-wrap:wrap; gap:4px; width:100%; box-sizing:border-box;"><button class="option-button" onclick="selectInlineOption(this,'radio')">清</button><button class="option-button" onclick="selectInlineOption(this,'radio')">聲</button><button class="option-button" onclick="selectInlineOption(this,'radio')">痛</button><button class="option-button" onclick="selectInlineOption(this,'radio')">否</button></div></td><td class="editable-cell" data-type="number" data-value="次/分" onclick="openNumberModal(this)">次/分</td><td colspan="2" class="editable-cell" data-type="number" data-value="次/分" onclick="openNumberModal(this)">次/分</td><td class="editable-cell" data-type="number" data-value="*" onclick="openNumberModal(this)">*</td><td class="editable-cell" data-type="radio" data-value="" data-options="正常,蒼白,是否有發紅,發紺（紫灰色）,黃疸,異常顏色"><div style="display:flex; flex-wrap:wrap; gap:4px; width:100%; box-sizing:border-box;"><button class="option-button" onclick="selectInlineOption(this,'radio')">正常</button><button class="option-button" onclick="selectInlineOption(this,'radio')">蒼白</button><button class="option-button" onclick="selectInlineOption(this,'radio')">是否有發紅</button><button class="option-button" onclick="selectInlineOption(this,'radio')">發紺（紫灰色）</button><button class="option-button" onclick="selectInlineOption(this,'radio')">黃疸</button><button class="option-button" onclick="selectInlineOption(this,'radio')">異常顏色</button></div></td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td></tr><tr><td colspan="8"><div data-gjs-editable="true">評估，處置與撤退計畫</div></td></tr><tr><td><div data-gjs-editable="true">時間</div></td><td><div data-gjs-editable="true">主要問題(當下)</div></td><td><div data-gjs-editable="true">預期問題(惡化)</div></td><td colspan="2"><div data-gjs-editable="true">給藥</div></td><td><div data-gjs-editable="true">給藥的歷史紀錄</div></td><td><div data-gjs-editable="true">處置計畫</div></td><td><div data-gjs-editable="true">撤退計畫</div></td></tr><tr><td class="editable-cell" data-type="datetime" onclick="fillCurrentTime(this)">⏰ 現在時間</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">請藥物名稱</td><td class="editable-cell" data-type="countdown" onclick="promptCountdown(this)">⏳倒數計時</td><td><div data-gjs-editable="true"></div></td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td></tr><tr><td class="editable-cell" data-type="datetime" onclick="fillCurrentTime(this)">⏰ 現在時間</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">請藥物名稱</td><td class="editable-cell" data-type="countdown" onclick="promptCountdown(this)">⏳倒數計時</td><td><div data-gjs-editable="true"></div></td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td></tr><tr><td class="editable-cell" data-type="datetime" onclick="fillCurrentTime(this)">⏰ 現在時間</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">請藥物名稱</td><td class="editable-cell" data-type="countdown" onclick="promptCountdown(this)">⏳倒數計時</td><td><div data-gjs-editable="true"></div></td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td></tr><tr><td class="editable-cell" data-type="datetime" onclick="fillCurrentTime(this)">⏰ 現在時間</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">請藥物名稱</td><td class="editable-cell" data-type="countdown" onclick="promptCountdown(this)">⏳倒數計時</td><td><div data-gjs-editable="true"></div></td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td></tr><tr><td class="editable-cell" data-type="datetime" onclick="fillCurrentTime(this)">⏰ 現在時間</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">請藥物名稱</td><td class="editable-cell" data-type="countdown" onclick="promptCountdown(this)">⏳倒數計時</td><td><div data-gjs-editable="true"></div></td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td></tr><tr><td class="editable-cell" data-type="datetime" onclick="fillCurrentTime(this)">⏰ 現在時間</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">請藥物名稱</td><td class="editable-cell" data-type="countdown" onclick="promptCountdown(this)">⏳倒數計時</td><td><div data-gjs-editable="true"></div></td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td></tr><tr><td class="editable-cell" data-type="datetime" onclick="fillCurrentTime(this)">⏰ 現在時間</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">請藥物名稱</td><td class="editable-cell" data-type="countdown" onclick="promptCountdown(this)">⏳倒數計時</td><td><div data-gjs-editable="true"></div></td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td></tr><tr><td class="editable-cell" data-type="datetime" onclick="fillCurrentTime(this)">⏰ 現在時間</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">請藥物名稱</td><td class="editable-cell" data-type="countdown" onclick="promptCountdown(this)">⏳倒數計時</td><td><div data-gjs-editable="true"></div></td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td><td class="editable-cell" data-type="text" data-value="" onclick="openTextModal(this)">*</td></tr></tbody></table>

<!-- 文字輸入 Modal -->
<div id="modal" class="modal">
  <div class="modal-content">
    <textarea id="modalInput" rows="5"></textarea>
    <div id="modalFooter">
      <button onclick="confirmModal()">確定</button>
      <button onclick="closeModal()">取消</button>
    </div>
  </div>
</div>

<!-- 數字輸入 Modal -->
<div id="numberModal" class="modal">
  <div class="modal-content">
    <input type="number" id="numberInput" />
    <div id="modalFooter">
      <button onclick="confirmNumberModal()">確定</button>
      <button onclick="closeNumberModal()">取消</button>
    </div>
  </div>
</div>

<!-- 倒數計時提醒 -->
<div id="reminder" class="modal" style="display:none; align-items:center; justify-content:center;">
  <div class="modal-content" style="max-width:80%; text-align:center; border-radius:16px; padding:20px;">
    <div class="reminder-message" style="font-size:24px; margin-bottom:30px;">提醒</div>
    <button onclick="closeReminder()" 
            style="padding:20px 40px; font-size:32px; border:none; border-radius:12px; background:#4CAF50; color:white; cursor:pointer;">
      OK
    </button>
  </div>
</div>




<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
let mediaRecorder, recordedChunks=[], latestBlob=null, currentCell=null;

// 錄音
function startRecording(btn){ 
    const cell=btn.closest(".recorder-cell");
    const stopBtn=cell.querySelector("button[onclick^='stopRecording']");
    const playBtn=cell.querySelector("button[onclick^='playRecording']");
    const audio=cell.querySelector("audio");
    recordedChunks=[];
    navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
        mediaRecorder=new MediaRecorder(stream,{mimeType:'audio/mp4'});
        mediaRecorder.start();
        mediaRecorder.ondataavailable=e=>{if(e.data.size>0) recordedChunks.push(e.data);}
        mediaRecorder.onstop=()=>{
            latestBlob=new Blob(recordedChunks,{type:'audio/mp4'});
            audio.src=URL.createObjectURL(latestBlob);
            audio.style.display="block";
            playBtn.disabled=false; stopBtn.disabled=true; btn.disabled=false;
            stream.getTracks().forEach(track=>track.stop());
        };
        btn.disabled=true; stopBtn.disabled=false; playBtn.disabled=true;
    }).catch(err=>alert("錄音失敗:"+err.message));
}
function stopRecording(btn){ if(mediaRecorder&&mediaRecorder.state!=='inactive') mediaRecorder.stop(); }
function playRecording(btn){ const audio=btn.closest(".recorder-cell").querySelector("audio"); audio.play(); }

// 內嵌選擇題
function selectInlineOption(btn,type){
    if(type==='radio'){
        const siblings = btn.parentNode.querySelectorAll('.option-button');
        siblings.forEach(b=>b.classList.remove('selected'));
        btn.classList.add('selected');
    } else if(type==='multi'){
        btn.classList.toggle('selected');
    }
    const values = Array.from(btn.parentNode.querySelectorAll('.option-button.selected')).map(b=>b.innerText);
    btn.parentNode.dataset.value = type==='radio'?values[0]||'':values.join('、');
}

// 文字輸入 Modal
function openTextModal(cell){
    currentCell = cell;
    const value = cell.dataset.value||'';
    const modal = document.getElementById('modal');
    const input = document.getElementById('modalInput');
    input.value = value;

    // 取得 cell 的可視位置
    const rect = cell.getBoundingClientRect();
    const scrollTop = window.scrollY || document.documentElement.scrollTop;
    const scrollLeft = window.scrollX || document.documentElement.scrollLeft;

    // 放置在 cell 下方 5px
    modal.style.top = (rect.bottom + scrollTop + 5) + 'px';
    modal.style.left = (rect.left + scrollLeft) + 'px';
    modal.style.display = 'block';
}
function closeModal(){ document.getElementById('modal').style.display='none'; }
function confirmModal(){
    if(!currentCell) return;
    const newValue = document.getElementById('modalInput').value.trim();
    currentCell.dataset.value = newValue;
    currentCell.innerText = newValue || '尚未輸入';
    closeModal();
}

// 數字輸入 Modal
function openNumberModal(cell){
    currentCell = cell;
    const value = cell.dataset.value||'';
    const modal = document.getElementById('numberModal');
    const input = document.getElementById('numberInput');
    input.value = value;

    const rect = cell.getBoundingClientRect();
    const scrollTop = window.scrollY || document.documentElement.scrollTop;
    const scrollLeft = window.scrollX || document.documentElement.scrollLeft;

    modal.style.top = (rect.bottom + scrollTop + 5) + 'px';
    modal.style.left = (rect.left + scrollLeft) + 'px';
    modal.style.display = 'block';
}
function closeNumberModal(){ document.getElementById('numberModal').style.display='none'; }
function confirmNumberModal(){
    if(!currentCell) return;
    const newValue = document.getElementById('numberInput').value.trim();

    if(currentCell.dataset.type === "countdown"){
        // 倒數計時自動取整數
        const seconds = Math.floor(parseFloat(newValue)) || 0;
        currentCell.dataset.seconds = seconds;
        currentCell.innerText = "⏳倒數計時";  // 顯示預設文字
        // 🔹立刻開始倒數
        if(seconds > 0){
            startCountdown(currentCell);
        }
    } else {
        // 普通數字題保留原值（可小數）
        currentCell.dataset.value = newValue;
        currentCell.innerText = newValue || '尚未輸入';
    }

    closeNumberModal();
}


// 現在時間
function fillCurrentTime(cell){
    const now = new Date();
    const formatted = now.getFullYear() + "-" + 
                      String(now.getMonth()+1).padStart(2,'0') + "-" +
                      String(now.getDate()).padStart(2,'0') + " " +
                      String(now.getHours()).padStart(2,'0') + ":" +
                      String(now.getMinutes()).padStart(2,'0') + ":" +
                      String(now.getSeconds()).padStart(2,'0');
    cell.dataset.value = formatted;
    cell.innerText = formatted;
}

// 🔔 倒數計時佇列模式
let reminderQueue = [];
let showingReminder = false;
let alarmAudio = null;

// 每個 cell 的倒數
function startCountdown(cell) {
    // 已經有倒數在跑就不重新開始
    if(cell._countdownInterval) return;

    let seconds = parseInt(cell.dataset.seconds) || 0;
    if (seconds <= 0) return;

    cell.innerText = "⏳剩" + seconds + "秒";

    let interval = setInterval(() => {
        seconds--;
        if (seconds > 0) {
            cell.innerText = "⏳剩" + seconds + "秒";
        } else {
            clearInterval(interval);
            cell._countdownInterval = null;
            cell.innerText = "⏳時間到！";

            // 🔹記錄歷史
            addCountdownHistory(cell);

            // 推入提醒佇列
            // 取前一格的值作為藥物名稱
            let prevCell = cell.previousElementSibling;
            let medName = prevCell ? prevCell.innerText.trim() : "藥物";
            reminderQueue.push({
                cell: cell,
                msg: medName + " 時間到，請給藥！"
            });

            processReminderQueue();
        }
    }, 1000);

    cell._countdownInterval = interval;
}

// 顯示倒數輸入視窗
function promptCountdown(cell){
    currentCell = cell;
    let lastSeconds = cell.dataset.seconds || ''; // 讀取上次填入的值
    const modal = document.getElementById('numberModal');
    const input = document.getElementById('numberInput');
    input.value = lastSeconds;  // 帶入上次值

    const rect = cell.getBoundingClientRect();
    const scrollTop = window.scrollY || document.documentElement.scrollTop;
    const scrollLeft = window.scrollX || document.documentElement.scrollLeft;

    modal.style.top = (rect.bottom + scrollTop + 5) + 'px';
    modal.style.left = (rect.left + scrollLeft) + 'px';
    modal.style.display = 'block';
}


// 🔹新增歷史紀錄功能
function addCountdownHistory(cell){
    let row = cell.parentNode;
    let idx = Array.from(row.children).indexOf(cell);

    // 找下一個欄位，如果不存在就新增一個 td
    let historyCell = row.children[idx+1];
    if(!historyCell){
        historyCell = document.createElement("td");
        row.appendChild(historyCell);
    }

    const now = new Date();
    const formatted = now.getFullYear() + "-" + 
                      String(now.getMonth()+1).padStart(2,'0') + "-" +
                      String(now.getDate()).padStart(2,'0') + " " +
                      String(now.getHours()).padStart(2,'0') + ":" +
                      String(now.getMinutes()).padStart(2,'0') + ":" +
                      String(now.getSeconds()).padStart(2,'0');

    // 計數第幾次給藥
    let count = historyCell.dataset.count ? parseInt(historyCell.dataset.count) + 1 : 1;
    historyCell.dataset.count = count;

    const prefix = count === 1 ? "第一次給藥時間:" : `第${count}次給藥時間:`;
    historyCell.innerHTML += prefix + formatted + "<br>";
}

// 處理提醒佇列
function processReminderQueue() {
    if (showingReminder || reminderQueue.length === 0) return;

    showingReminder = true;
    const obj = reminderQueue.shift();
    const msg = obj.msg;

    const reminder = document.getElementById("reminder");
    reminder.querySelector(".reminder-message").innerText = msg;
    reminder.style.display = "flex";

    // 播放提示音
    if (!alarmAudio) {
        alarmAudio = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
        alarmAudio.loop = true;
    }
    alarmAudio.play().catch(err => console.error("無法自動播放音效:", err));
}

// 關閉提醒
function closeReminder() {
    const reminder = document.getElementById("reminder");
    reminder.style.display = "none";

    if (alarmAudio) {
        alarmAudio.pause();
        alarmAudio.currentTime = 0;
    }

    showingReminder = false;

    // ⚡ 關掉後立即檢查下一個
    processReminderQueue();
}



// 目前座標
function fillCurrentLocation(cell){
    if(!navigator.geolocation){
        alert("❌ 此瀏覽器不支援定位功能");
        return;
    }
    cell.innerText = "📍 取得中...";
    navigator.geolocation.getCurrentPosition(
        pos=>{
            const lat = pos.coords.latitude.toFixed(6);
            const lng = pos.coords.longitude.toFixed(6);
            const coords = lng + "," + lat;  // 經度,緯度
            cell.dataset.value = coords;
            cell.innerText = coords;
        },
        err=>{
            cell.innerText = "📍 點擊取得座標";
            alert("定位失敗: " + err.message);
        },
        { enableHighAccuracy:true, timeout:10000 }
    );
}



// 顯示提醒視窗
function showReminder(msg){
    const reminder = document.getElementById("reminder");
    reminder.querySelector(".reminder-message").innerText = msg;
    reminder.style.display="flex";

    // 播放提示聲
    alarmAudio = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
    alarmAudio.loop = true;
    alarmAudio.play().catch(err=>console.error("無法自動播放音效:",err));
}







// 匯出 ZIP
document.getElementById("exportBtn").addEventListener("click",async()=>{
    const container=document.querySelector(".table-container").cloneNode(true);
    container.querySelector("#exportBtn")?.remove();

    const tasks=Array.from(container.querySelectorAll("td")).map(cell=>{
        if(cell.querySelector(".recorder-cell")){
            const audio=cell.querySelector("audio");
            if(audio && audio.src.startsWith("blob:")){
                return fetch(audio.src).then(r=>r.blob()).then(blob=>new Promise(resolve=>{
                    const reader=new FileReader();
                    reader.onload=function(){ cell.innerHTML='<audio controls src="'+reader.result+'"></audio>'; resolve(); };
                    reader.readAsDataURL(blob);
                }));
            } else { cell.innerHTML=''; return Promise.resolve(); }
        }
        if(cell.classList.contains('editable-cell')){
            if(['text','radio','multi','number','datetime'].includes(cell.dataset.type)){
                cell.innerHTML='<div>'+ (cell.dataset.value||'')+'</div>';
            }
        }
        return Promise.resolve();
    });
    await Promise.all(tasks);
    const exportHTML='<!DOCTYPE html><html><head><meta charset="utf-8"><title>已匯出表格</title></head><body>'+container.outerHTML+'</body></html>';
    const zip=new JSZip(); 
    zip.file("exported_table.html",exportHTML);

    // 🔹取得 B2 的值作為檔名
    let fileName="exported_table.zip";
    const b2 = document.querySelector("table tbody tr:nth-child(1) td:nth-child(2)");
    if(b2 && b2.innerText.trim()) fileName = b2.innerText.trim() + "的資料.zip";

    zip.generateAsync({type:"blob"}).then(async content=>{
        const file=new File([content], fileName,{type:"application/zip"});
        if(navigator.canShare && navigator.canShare({files:[file]})){
            try{ await navigator.share({files:[file],title:"匯出表格",text:"這是你匯出的表格 ZIP 檔"}); return; }catch(err){console.error(err);}
        }
        const a=document.createElement("a"); a.href=URL.createObjectURL(content); a.download=fileName; a.click();
    });
});

</script>
</div>
