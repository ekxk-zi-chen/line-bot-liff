
<div class="table-container">
<style>
div.table-container { overflow-x:auto; }
table { width:100%; max-width:100%; border-collapse:collapse; }
th, td { padding:6px; text-align:left; word-break:break-word; border:1px solid #ccc; vertical-align:top; cursor:default; }
.editable-cell { background:#fff8dc; font-weight:bold; }
.editable-cell:hover { background:#ffe69c; }
.option-button { margin:2px 0; padding:6px 10px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer; }
.option-button.selected { background:#4CAF50; color:white; }

#exportBtn { margin:10px 0; padding:8px 16px; background:#4CAF50; color:white; border:none; border-radius:6px; font-size:16px; }

/* æ–‡å­—è¼¸å…¥ Modal æ‰‹æ©Ÿå„ªåŒ– */
.modal { display:none; position:fixed; z-index:1000; top:0; left:0; width:100%; height:100%; background-color: rgba(0,0,0,0.6); }
.modal-content { position:absolute; top:0; left:0; width:100%; max-height:60%; background:#fff; padding:10px; box-sizing:border-box; display:flex; flex-direction:column; justify-content:space-between; }
#modalInput, #numberInput { width:100%; font-size:18px; padding:8px; flex:1; }
#modalFooter { display:flex; justify-content:space-between; }
#modalFooter button { padding:10px 20px; font-size:16px; }
</style>

<button id="exportBtn">ğŸ’¾ åŒ¯å‡º ZIP</button>

<table border="1" style="border-collapse:collapse; width:100%;"><thead><tr><th><div data-gjs-editable="true">æ„å¤–å‚·ç—…ç¾å ´ç´€éŒ„/SOP</div></th><th><div data-gjs-editable="true">None</div></th><th><div data-gjs-editable="true">None</div></th><th><div data-gjs-editable="true">None</div></th><th><div data-gjs-editable="true">None</div></th><th><div data-gjs-editable="true">None</div></th><th><div data-gjs-editable="true">None</div></th><th><div data-gjs-editable="true">None</div></th></tr></thead><tbody><tr><td><div data-gjs-editable="true">å‚·ç—…æ‚£å§“å</div></td><td class="editable-cell" data-type="text" onclick="openTextModal(this)">âœï¸ è¼¸å…¥æ–‡å­—</td><td><div data-gjs-editable="true">å¹´é½¡</div></td><td class="editable-cell" data-type="number" onclick="openNumberModal(this)">ğŸ”¢ è¼¸å…¥æ•¸å­—</td><td><div data-gjs-editable="true">æ€§åˆ¥</div></td><td class="editable-cell" data-type="radio" data-value="" data-options="ç”·ç”Ÿ,å¥³ç”Ÿ"><button class="option-button" onclick="selectInlineOption(this,'radio')">ç”·ç”Ÿ</button><button class="option-button" onclick="selectInlineOption(this,'radio')">å¥³ç”Ÿ</button></td><td><div data-gjs-editable="true">é«”é‡</div></td><td class="editable-cell" data-type="number" onclick="openNumberModal(this)">ğŸ”¢ è¼¸å…¥æ•¸å­—</td></tr><tr><td rowspan="2"><div data-gjs-editable="true">ç·Šæ€¥è¯çµ¡äºº</div></td>
                <td rowspan="2" class='editable-cell'>
                  <div class="recorder-cell">
                    <button onclick="startRecording(this)">ğŸ¤ éŒ„éŸ³</button>
                    <button onclick="stopRecording(this)" disabled>â¹ åœæ­¢</button>
                    <button onclick="playRecording(this)" disabled>â–¶ æ’­æ”¾</button>
                    <audio controls style="display:none;"></audio>
                  </div>
                </td>
                <td><div data-gjs-editable="true">å‚·ç—…æ‚£è¡Œç¨‹ç¸½å¤©æ•¸</div></td><td colspan="5" class="editable-cell" data-type="radio" data-value="" data-options="ä¸€æ—¥,äºŒæ—¥,ä¸‰æ—¥,å››æ—¥,äº”æ—¥,å…­æ—¥,ä¸ƒæ—¥"><button class="option-button" onclick="selectInlineOption(this,'radio')">ä¸€æ—¥</button><button class="option-button" onclick="selectInlineOption(this,'radio')">äºŒæ—¥</button><button class="option-button" onclick="selectInlineOption(this,'radio')">ä¸‰æ—¥</button><button class="option-button" onclick="selectInlineOption(this,'radio')">å››æ—¥</button><button class="option-button" onclick="selectInlineOption(this,'radio')">äº”æ—¥</button><button class="option-button" onclick="selectInlineOption(this,'radio')">å…­æ—¥</button><button class="option-button" onclick="selectInlineOption(this,'radio')">ä¸ƒæ—¥</button></td></tr><tr><td><div data-gjs-editable="true">ç¸½è¡Œç¨‹å¤©æ•¸</div></td><td colspan="5" class="editable-cell" data-type="text" onclick="openTextModal(this)">âœï¸ è¼¸å…¥æ–‡å­—</td></tr><tr><td><div data-gjs-editable="true">ç™¼ç”Ÿæ—¥æœŸ</div></td><td class="editable-cell" data-type="text" onclick="openTextModal(this)">âœï¸ è¼¸å…¥æ–‡å­—</td><td><div data-gjs-editable="true">ç™¼ç”Ÿæ™‚é–“</div></td><td colspan="2" class="editable-cell" data-type="text" onclick="openTextModal(this)">âœï¸ è¼¸å…¥æ–‡å­—</td><td colspan="2"><div data-gjs-editable="true">ç¬¬å¹¾å¤©ç™¼ç”Ÿ</div></td><td class="editable-cell" data-type="number" onclick="openNumberModal(this)">ğŸ”¢ è¼¸å…¥æ•¸å­—</td></tr><tr><td><div data-gjs-editable="true">ç™¼ç”Ÿåœ°é»</div></td><td colspan="3" class="editable-cell" data-type="text" onclick="openTextModal(this)">âœï¸ è¼¸å…¥æ–‡å­—</td><td colspan="2"><div data-gjs-editable="true">åº§æ¨™</div></td><td class="editable-cell" data-type="text" onclick="openTextModal(this)">âœï¸ è¼¸å…¥æ–‡å­—</td>
                <td class='editable-cell'>
                  <div class="recorder-cell">
                    <button onclick="startRecording(this)">ğŸ¤ éŒ„éŸ³</button>
                    <button onclick="stopRecording(this)" disabled>â¹ åœæ­¢</button>
                    <button onclick="playRecording(this)" disabled>â–¶ æ’­æ”¾</button>
                    <audio controls style="display:none;"></audio>
                  </div>
                </td>
                </tr><tr><td><div data-gjs-editable="true">å‚·ç—…æ©Ÿè½‰</div></td><td colspan="3" class="editable-cell" data-type="multi" data-value="" data-options="å‰µå‚·,ç–¾ç—…,é«˜è™•å¢œè½,ç”Ÿç‰©å’¬è«å‚·"><button class="option-button" onclick="selectInlineOption(this,'multi')">å‰µå‚·</button><button class="option-button" onclick="selectInlineOption(this,'multi')">ç–¾ç—…</button><button class="option-button" onclick="selectInlineOption(this,'multi')">é«˜è™•å¢œè½</button><button class="option-button" onclick="selectInlineOption(this,'multi')">ç”Ÿç‰©å’¬è«å‚·</button></td><td colspan="2"><div data-gjs-editable="true">å…¶ä»–è£œè¿°</div></td><td class="editable-cell" data-type="text" onclick="openTextModal(this)">âœï¸ è¼¸å…¥æ–‡å­—</td>
                <td class='editable-cell'>
                  <div class="recorder-cell">
                    <button onclick="startRecording(this)">ğŸ¤ éŒ„éŸ³</button>
                    <button onclick="stopRecording(this)" disabled>â¹ åœæ­¢</button>
                    <button onclick="playRecording(this)" disabled>â–¶ æ’­æ”¾</button>
                    <audio controls style="display:none;"></audio>
                  </div>
                </td>
                </tr><tr><td><div data-gjs-editable="true">æ•‘æ´äººå“¡
ç¾å ´æè¿°
(å«æ°£å€™ã€æ°£æº«ã€ç¾å ´ç’°å¢ƒã€æ‰€è¦‹äº‹ä»¶):</div></td><td colspan="3" class="editable-cell" data-type="text" onclick="openTextModal(this)">âœï¸ è¼¸å…¥æ–‡å­—</td><td colspan="2"><div data-gjs-editable="true">ç¾å ´å…¶ä»–è£œè¿°</div></td><td class="editable-cell" data-type="text" onclick="openTextModal(this)">âœï¸ è¼¸å…¥æ–‡å­—</td>
                <td class='editable-cell'>
                  <div class="recorder-cell">
                    <button onclick="startRecording(this)">ğŸ¤ éŒ„éŸ³</button>
                    <button onclick="stopRecording(this)" disabled>â¹ åœæ­¢</button>
                    <button onclick="playRecording(this)" disabled>â–¶ æ’­æ”¾</button>
                    <audio controls style="display:none;"></audio>
                  </div>
                </td>
                </tr><tr><td colspan="8"><div data-gjs-editable="true">SAMPLE/ç—…å²è©¢å•</div></td></tr><tr><td><div data-gjs-editable="true">S/æ„Ÿ:ç—‡ç‹€</div></td><td colspan="3" class="editable-cell" data-type="text" onclick="openTextModal(this)">âœï¸ è¼¸å…¥æ–‡å­—</td><td colspan="2"><div data-gjs-editable="true">A/æ•:éæ•</div></td><td colspan="2" class="editable-cell" data-type="text" onclick="openTextModal(this)">âœï¸ è¼¸å…¥æ–‡å­—</td></tr><tr><td><div data-gjs-editable="true">M/è—¥:è—¥ç‰©</div></td><td colspan="3" class="editable-cell" data-type="text" onclick="openTextModal(this)">âœï¸ è¼¸å…¥æ–‡å­—</td><td colspan="2"><div data-gjs-editable="true">P/é:éå»ç›¸é—œç—…å²</div></td><td colspan="2" class="editable-cell" data-type="text" onclick="openTextModal(this)">âœï¸ è¼¸å…¥æ–‡å­—</td></tr><tr><td><div data-gjs-editable="true">L/åƒ:æœ€å¾Œçš„é€²å‡º</div></td><td colspan="3" class="editable-cell" data-type="text" onclick="openTextModal(this)">âœï¸ è¼¸å…¥æ–‡å­—</td><td colspan="2"><div data-gjs-editable="true">E/ä¹‹å‰:ç™¼ç”Ÿæ„å¤–ä¹‹å‰çš„äº‹
ä»¶</div></td><td colspan="2" class="editable-cell" data-type="text" onclick="openTextModal(this)">âœï¸ è¼¸å…¥æ–‡å­—</td></tr><tr><td rowspan="3"><div data-gjs-editable="true">ä¸»è¨´</div></td>
                <td rowspan="3" colspan="3" class='editable-cell'>
                  <div class="recorder-cell">
                    <button onclick="startRecording(this)">ğŸ¤ éŒ„éŸ³</button>
                    <button onclick="stopRecording(this)" disabled>â¹ åœæ­¢</button>
                    <button onclick="playRecording(this)" disabled>â–¶ æ’­æ”¾</button>
                    <audio controls style="display:none;"></audio>
                  </div>
                </td>
                <td colspan="2"><div data-gjs-editable="true">å¤šé¸æ¸¬è©¦</div></td><td colspan="2" class="editable-cell" data-type="multi" data-value="" data-options="ä½ å¥½,ä»–å¥½,æˆ‘å¥½,æ²’æœ‰äººå¥½,å¤§å®¶éƒ½å¥½"><button class="option-button" onclick="selectInlineOption(this,'multi')">ä½ å¥½</button><button class="option-button" onclick="selectInlineOption(this,'multi')">ä»–å¥½</button><button class="option-button" onclick="selectInlineOption(this,'multi')">æˆ‘å¥½</button><button class="option-button" onclick="selectInlineOption(this,'multi')">æ²’æœ‰äººå¥½</button><button class="option-button" onclick="selectInlineOption(this,'multi')">å¤§å®¶éƒ½å¥½</button></td></tr><tr><td rowspan="2" colspan="2"><div data-gjs-editable="true">è¼¸å…¥æ¸¬è©¦</div></td><td rowspan="2" colspan="2" class="editable-cell" data-type="text" onclick="openTextModal(this)">âœï¸ è¼¸å…¥æ–‡å­—</td></tr><tr></tr><tr><td><div data-gjs-editable="true">ä¸»è¨´è£œå……</div></td><td colspan="3" class="editable-cell" data-type="text" onclick="openTextModal(this)">âœï¸ è¼¸å…¥æ–‡å­—</td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td></tr><tr><td><div data-gjs-editable="true">æ™‚é–“æ¸¬è©¦</div></td><td class="editable-cell" data-type="datetime" onclick="fillCurrentTime(this)">â° ç¾åœ¨æ™‚é–“</td><td><div data-gjs-editable="true">å€’æ•¸æ¸¬è©¦</div></td><td colspan="2" class="editable-cell" data-type="countdown" data-seconds="20" onclick="startCountdown(this)">â³ å€’æ•¸è¨ˆæ™‚ 20 ç§’</td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td></tr></tbody></table>

<!-- æ–‡å­—è¼¸å…¥ Modal -->
<div id="modal" class="modal">
  <div class="modal-content">
    <textarea id="modalInput" rows="5"></textarea>
    <div id="modalFooter">
      <button onclick="confirmModal()">ç¢ºå®š</button>
      <button onclick="closeModal()">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- æ•¸å­—è¼¸å…¥ Modal -->
<div id="numberModal" class="modal">
  <div class="modal-content">
    <input type="number" id="numberInput" />
    <div id="modalFooter">
      <button onclick="confirmNumberModal()">ç¢ºå®š</button>
      <button onclick="closeNumberModal()">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- å€’æ•¸è¨ˆæ™‚æé†’ -->
<div id="reminder" class="modal" style="display:none; align-items:center; justify-content:center;">
  <div class="modal-content" style="max-width:80%; text-align:center;">
    <div class="reminder-message" style="font-size:20px; margin-bottom:20px;">æé†’</div>
    <button onclick="closeReminder()" style="padding:10px 20px; font-size:18px;">OK</button>
  </div>
</div>



<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
let mediaRecorder, recordedChunks=[], latestBlob=null, currentCell=null;

// éŒ„éŸ³
function startRecording(btn){ 
    const cell=btn.closest(".recorder-cell");
    const stopBtn=cell.querySelector("button[onclick^='stopRecording']");
    const playBtn=cell.querySelector("button[onclick^='playRecording']");
    const audio=cell.querySelector("audio");
    recordedChunks=[];
    navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
        mediaRecorder=new MediaRecorder(stream,{mimeType:'audio/mp4'});
        mediaRecorder.start();
        mediaRecorder.ondataavailable=e=>{if(e.data.size>0) recordedChunks.push(e.data);}
        mediaRecorder.onstop=()=>{
            latestBlob=new Blob(recordedChunks,{type:'audio/mp4'});
            audio.src=URL.createObjectURL(latestBlob);
            audio.style.display="block";
            playBtn.disabled=false; stopBtn.disabled=true; btn.disabled=false;
            stream.getTracks().forEach(track=>track.stop());
        };
        btn.disabled=true; stopBtn.disabled=false; playBtn.disabled=true;
    }).catch(err=>alert("éŒ„éŸ³å¤±æ•—:"+err.message));
}
function stopRecording(btn){ if(mediaRecorder&&mediaRecorder.state!=='inactive') mediaRecorder.stop(); }
function playRecording(btn){ const audio=btn.closest(".recorder-cell").querySelector("audio"); audio.play(); }

// å…§åµŒé¸æ“‡é¡Œ
function selectInlineOption(btn,type){
    if(type==='radio'){
        const siblings = btn.parentNode.querySelectorAll('.option-button');
        siblings.forEach(b=>b.classList.remove('selected'));
        btn.classList.add('selected');
    } else if(type==='multi'){
        btn.classList.toggle('selected');
    }
    const values = Array.from(btn.parentNode.querySelectorAll('.option-button.selected')).map(b=>b.innerText);
    btn.parentNode.dataset.value = type==='radio'?values[0]||'':values.join('ã€');
}

// æ–‡å­—è¼¸å…¥ Modal
function openTextModal(cell){
    currentCell = cell;
    const value = cell.dataset.value||'';
    document.getElementById('modalInput').value = value;
    document.getElementById('modal').style.display='block';
    // ğŸš« ä¸å†å¼·åˆ¶ focusï¼Œé¿å…æ‰‹æ©Ÿé é¢è·³åˆ°å·¦ä¸Šè§’
    // document.getElementById('modalInput').focus();
}
function closeModal(){ document.getElementById('modal').style.display='none'; }
function confirmModal(){
    if(!currentCell) return;
    const newValue = document.getElementById('modalInput').value.trim();
    currentCell.dataset.value = newValue;
    currentCell.innerText = newValue || 'å°šæœªè¼¸å…¥';
    closeModal();
}

// æ•¸å­—è¼¸å…¥ Modal
function openNumberModal(cell){
    currentCell = cell;
    const value = cell.dataset.value||'';
    document.getElementById('numberInput').value = value;
    document.getElementById('numberModal').style.display='block';
    // ğŸš« ä¸å†å¼·åˆ¶ focusï¼Œé¿å…æ‰‹æ©Ÿé é¢è·³åˆ°å·¦ä¸Šè§’
    // document.getElementById('numberInput').focus();
}
function closeNumberModal(){ document.getElementById('numberModal').style.display='none'; }
function confirmNumberModal(){
    if(!currentCell) return;
    const newValue = document.getElementById('numberInput').value.trim();
    currentCell.dataset.value = newValue;
    currentCell.innerText = newValue || 'å°šæœªè¼¸å…¥';
    closeNumberModal();
}

// ç¾åœ¨æ™‚é–“
function fillCurrentTime(cell){
    const now = new Date();
    const formatted = now.getFullYear() + "-" + 
                      String(now.getMonth()+1).padStart(2,'0') + "-" +
                      String(now.getDate()).padStart(2,'0') + " " +
                      String(now.getHours()).padStart(2,'0') + ":" +
                      String(now.getMinutes()).padStart(2,'0') + ":" +
                      String(now.getSeconds()).padStart(2,'0');
    cell.dataset.value = formatted;
    cell.innerText = formatted;
}

// å€’æ•¸è¨ˆæ™‚
let countdownTimer = null;
let countdownInterval = null;
let alarmAudio = null;

function startCountdown(cell){
    let seconds = parseInt(cell.dataset.seconds)||0;
    if(seconds<=0) return;

    // å¦‚æœæœ‰èˆŠçš„å€’æ•¸ â†’ æ¸…æ‰
    if(countdownTimer) { clearTimeout(countdownTimer); countdownTimer=null; }
    if(countdownInterval) { clearInterval(countdownInterval); countdownInterval=null; }

    // æ›´æ–° cell é¡¯ç¤º
    cell.innerText = "â³ å‰©é¤˜ " + seconds + " ç§’";

    countdownInterval = setInterval(()=>{
        seconds--;
        if(seconds > 0){
            cell.innerText = "â³ å‰©é¤˜ " + seconds + " ç§’";
        } else {
            clearInterval(countdownInterval);
            countdownInterval = null;
            cell.innerText = "â³ æ™‚é–“åˆ°ï¼";
            showReminder("â³ æ™‚é–“åˆ°ï¼è«‹ç¢ºèªè¦çµ¦è—¥");
        }
    },1000);
}


// é¡¯ç¤ºæé†’è¦–çª—
function showReminder(msg){
    const reminder = document.getElementById("reminder");
    reminder.querySelector(".reminder-message").innerText = msg;
    reminder.style.display="flex";

    // æ’­æ”¾æç¤ºè²
    alarmAudio = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
    alarmAudio.loop = true;
    alarmAudio.play().catch(err=>console.error("ç„¡æ³•è‡ªå‹•æ’­æ”¾éŸ³æ•ˆ:",err));
}

function closeReminder(){
    document.getElementById("reminder").style.display="none";
    if(alarmAudio){ alarmAudio.pause(); alarmAudio.currentTime=0; alarmAudio=null; }
}





// åŒ¯å‡º ZIP
document.getElementById("exportBtn").addEventListener("click",async()=>{
    const container=document.querySelector(".table-container").cloneNode(true);
    container.querySelector("#exportBtn")?.remove();
    const tasks=Array.from(container.querySelectorAll("td")).map(cell=>{
        if(cell.querySelector(".recorder-cell")){
            const audio=cell.querySelector("audio");
            if(audio && audio.src.startsWith("blob:")){
                return fetch(audio.src).then(r=>r.blob()).then(blob=>new Promise(resolve=>{
                    const reader=new FileReader();
                    reader.onload=function(){ cell.innerHTML='<audio controls src="'+reader.result+'"></audio>'; resolve(); };
                    reader.readAsDataURL(blob);
                }));
            } else { cell.innerHTML=''; return Promise.resolve(); }
        }
        if(cell.classList.contains('editable-cell')){
            if(['text','radio','multi','number','datetime'].includes(cell.dataset.type)){
                cell.innerHTML='<div>'+ (cell.dataset.value||'')+'</div>';
            }
        }
        return Promise.resolve();
    });
    await Promise.all(tasks);
    const exportHTML='<!DOCTYPE html><html><head><meta charset="utf-8"><title>å·²åŒ¯å‡ºè¡¨æ ¼</title></head><body>'+container.outerHTML+'</body></html>';
    const zip=new JSZip(); zip.file("exported_table.html",exportHTML);
    zip.generateAsync({type:"blob"}).then(async content=>{
        const file=new File([content],"exported_table.zip",{type:"application/zip"});
        if(navigator.canShare && navigator.canShare({files:[file]})){
            try{ await navigator.share({files:[file],title:"åŒ¯å‡ºè¡¨æ ¼",text:"é€™æ˜¯ä½ åŒ¯å‡ºçš„è¡¨æ ¼ ZIP æª”"}); return; }catch(err){console.error(err);}
        }
        const a=document.createElement("a"); a.href=URL.createObjectURL(content); a.download="exported_table.zip"; a.click();
    });
});
</script>
</div>
