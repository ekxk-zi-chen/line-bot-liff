
<div class="table-container">
<style>
div.table-container { overflow-x:auto; }
table { width:100%; max-width:100%; border-collapse:collapse; }
th, td { padding:6px; text-align:left; word-break:break-word; border:1px solid #ccc; vertical-align:top; cursor:default; }
.editable-cell { background:#fff8dc; font-weight:bold; }
.editable-cell:hover { background:#ffe69c; }
.option-button { margin:2px 0; padding:6px 10px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer; }
.option-button.selected { background:#4CAF50; color:white; }

#exportBtn { margin:10px 0; padding:8px 16px; background:#4CAF50; color:white; border:none; border-radius:6px; font-size:16px; }

/* 文字輸入 Modal 手機優化 */
.modal { display:none; position:fixed; z-index:1000; top:0; left:0; width:100%; height:100%; background-color: rgba(0,0,0,0.6); }
.modal-content { position:absolute; top:0; left:0; width:100%; max-height:60%; background:#fff; padding:10px; box-sizing:border-box; display:flex; flex-direction:column; justify-content:space-between; }
#modalInput { width:100%; font-size:18px; padding:8px; flex:1; }
#modalFooter { display:flex; justify-content:space-between; }
#modalFooter button { padding:10px 20px; font-size:16px; }
</style>

<button id="exportBtn">💾 匯出 ZIP</button>

<table border="1" style="border-collapse:collapse; width:100%;"><thead><tr><th><div data-gjs-editable="true">意外傷病現場紀錄/SOP</div></th><th><div data-gjs-editable="true">None</div></th><th><div data-gjs-editable="true">None</div></th><th><div data-gjs-editable="true">None</div></th><th><div data-gjs-editable="true">None</div></th><th><div data-gjs-editable="true">None</div></th><th><div data-gjs-editable="true">None</div></th><th><div data-gjs-editable="true">None</div></th></tr></thead><tbody><tr><td><div data-gjs-editable="true">傷病患姓名</div></td><td class="editable-cell" data-type="text" onclick="openTextModal(this)">✏️ 輸入文字</td><td><div data-gjs-editable="true">年齡</div></td><td class="editable-cell" data-type="text" onclick="openTextModal(this)">✏️ 輸入文字</td><td><div data-gjs-editable="true">性別</div></td><td class="editable-cell" data-type="radio" data-value="" data-options="男生,女生"><button class="option-button" onclick="selectInlineOption(this,'radio')">男生</button><button class="option-button" onclick="selectInlineOption(this,'radio')">女生</button></td><td><div data-gjs-editable="true">體重</div></td><td class="editable-cell" data-type="text" onclick="openTextModal(this)">✏️ 輸入文字</td></tr><tr><td rowspan="2"><div data-gjs-editable="true">緊急聯絡人</div></td>
                <td rowspan="2" class='editable-cell'>
                  <div class="recorder-cell">
                    <button onclick="startRecording(this)">🎤 錄音</button>
                    <button onclick="stopRecording(this)" disabled>⏹ 停止</button>
                    <button onclick="playRecording(this)" disabled>▶ 播放</button>
                    <audio controls style="display:none;"></audio>
                  </div>
                </td>
                <td><div data-gjs-editable="true">傷病患行程總天數</div></td><td colspan="5" class="editable-cell" data-type="radio" data-value="" data-options="一日,二日,三日,四日,五日,六日,七日"><button class="option-button" onclick="selectInlineOption(this,'radio')">一日</button><button class="option-button" onclick="selectInlineOption(this,'radio')">二日</button><button class="option-button" onclick="selectInlineOption(this,'radio')">三日</button><button class="option-button" onclick="selectInlineOption(this,'radio')">四日</button><button class="option-button" onclick="selectInlineOption(this,'radio')">五日</button><button class="option-button" onclick="selectInlineOption(this,'radio')">六日</button><button class="option-button" onclick="selectInlineOption(this,'radio')">七日</button></td></tr><tr><td><div data-gjs-editable="true">總行程天數</div></td><td colspan="5" class="editable-cell" data-type="text" onclick="openTextModal(this)">✏️ 輸入文字</td></tr><tr><td><div data-gjs-editable="true">發生日期</div></td><td class="editable-cell" data-type="text" onclick="openTextModal(this)">✏️ 輸入文字</td><td><div data-gjs-editable="true">發生時間</div></td><td colspan="2"><div data-gjs-editable="true"></div></td><td colspan="2"><div data-gjs-editable="true">第幾天發生</div></td><td><div data-gjs-editable="true"></div></td></tr><tr><td><div data-gjs-editable="true">發生地點</div></td><td colspan="3" class="editable-cell" data-type="text" onclick="openTextModal(this)">✏️ 輸入文字</td><td colspan="2"><div data-gjs-editable="true">座標</div></td><td class="editable-cell" data-type="text" onclick="openTextModal(this)">✏️ 輸入文字</td>
                <td class='editable-cell'>
                  <div class="recorder-cell">
                    <button onclick="startRecording(this)">🎤 錄音</button>
                    <button onclick="stopRecording(this)" disabled>⏹ 停止</button>
                    <button onclick="playRecording(this)" disabled>▶ 播放</button>
                    <audio controls style="display:none;"></audio>
                  </div>
                </td>
                </tr><tr><td><div data-gjs-editable="true">傷病機轉</div></td><td colspan="3" class="editable-cell" data-type="multi" data-value="" data-options="創傷,疾病,高處墜落,生物咬螫傷"><button class="option-button" onclick="selectInlineOption(this,'multi')">創傷</button><button class="option-button" onclick="selectInlineOption(this,'multi')">疾病</button><button class="option-button" onclick="selectInlineOption(this,'multi')">高處墜落</button><button class="option-button" onclick="selectInlineOption(this,'multi')">生物咬螫傷</button></td><td colspan="2"><div data-gjs-editable="true">其他補述</div></td><td class="editable-cell" data-type="text" onclick="openTextModal(this)">✏️ 輸入文字</td>
                <td class='editable-cell'>
                  <div class="recorder-cell">
                    <button onclick="startRecording(this)">🎤 錄音</button>
                    <button onclick="stopRecording(this)" disabled>⏹ 停止</button>
                    <button onclick="playRecording(this)" disabled>▶ 播放</button>
                    <audio controls style="display:none;"></audio>
                  </div>
                </td>
                </tr><tr><td><div data-gjs-editable="true">救援人員
現場描述
(含氣候、氣溫、現場環境、所見事件):</div></td><td colspan="3" class="editable-cell" data-type="text" onclick="openTextModal(this)">✏️ 輸入文字</td><td colspan="2"><div data-gjs-editable="true">現場其他補述</div></td><td class="editable-cell" data-type="text" onclick="openTextModal(this)">✏️ 輸入文字</td>
                <td class='editable-cell'>
                  <div class="recorder-cell">
                    <button onclick="startRecording(this)">🎤 錄音</button>
                    <button onclick="stopRecording(this)" disabled>⏹ 停止</button>
                    <button onclick="playRecording(this)" disabled>▶ 播放</button>
                    <audio controls style="display:none;"></audio>
                  </div>
                </td>
                </tr><tr><td colspan="8"><div data-gjs-editable="true">SAMPLE/病史詢問</div></td></tr><tr><td><div data-gjs-editable="true">S/感:症狀</div></td><td colspan="3" class="editable-cell" data-type="text" onclick="openTextModal(this)">✏️ 輸入文字</td><td colspan="2"><div data-gjs-editable="true">A/敏:過敏</div></td><td colspan="2" class="editable-cell" data-type="text" onclick="openTextModal(this)">✏️ 輸入文字</td></tr><tr><td><div data-gjs-editable="true">M/藥:藥物</div></td><td colspan="3" class="editable-cell" data-type="text" onclick="openTextModal(this)">✏️ 輸入文字</td><td colspan="2"><div data-gjs-editable="true">P/過:過去相關病史</div></td><td colspan="2" class="editable-cell" data-type="text" onclick="openTextModal(this)">✏️ 輸入文字</td></tr><tr><td><div data-gjs-editable="true">L/吃:最後的進出</div></td><td colspan="3" class="editable-cell" data-type="text" onclick="openTextModal(this)">✏️ 輸入文字</td><td colspan="2"><div data-gjs-editable="true">E/之前:發生意外之前的事
件</div></td><td colspan="2" class="editable-cell" data-type="text" onclick="openTextModal(this)">✏️ 輸入文字</td></tr><tr><td rowspan="3"><div data-gjs-editable="true">主訴</div></td>
                <td rowspan="3" colspan="3" class='editable-cell'>
                  <div class="recorder-cell">
                    <button onclick="startRecording(this)">🎤 錄音</button>
                    <button onclick="stopRecording(this)" disabled>⏹ 停止</button>
                    <button onclick="playRecording(this)" disabled>▶ 播放</button>
                    <audio controls style="display:none;"></audio>
                  </div>
                </td>
                <td colspan="2"><div data-gjs-editable="true">多選測試</div></td><td colspan="2" class="editable-cell" data-type="multi" data-value="" data-options="你好,他好,我好,沒有人好,大家都好"><button class="option-button" onclick="selectInlineOption(this,'multi')">你好</button><button class="option-button" onclick="selectInlineOption(this,'multi')">他好</button><button class="option-button" onclick="selectInlineOption(this,'multi')">我好</button><button class="option-button" onclick="selectInlineOption(this,'multi')">沒有人好</button><button class="option-button" onclick="selectInlineOption(this,'multi')">大家都好</button></td></tr><tr><td rowspan="2" colspan="2"><div data-gjs-editable="true">輸入測試</div></td><td rowspan="2" colspan="2" class="editable-cell" data-type="text" onclick="openTextModal(this)">✏️ 輸入文字</td></tr><tr></tr><tr><td><div data-gjs-editable="true">主訴補充</div></td><td colspan="3" class="editable-cell" data-type="text" onclick="openTextModal(this)">✏️ 輸入文字</td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td></tr></tbody></table>

<!-- 文字輸入 Modal -->
<div id="modal" class="modal">
  <div class="modal-content">
    <textarea id="modalInput" rows="5"></textarea>
    <div id="modalFooter">
      <button onclick="confirmModal()">確定</button>
      <button onclick="closeModal()">取消</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
let mediaRecorder, recordedChunks=[], latestBlob=null, currentCell=null;

// 錄音
function startRecording(btn){ 
    const cell=btn.closest(".recorder-cell");
    const stopBtn=cell.querySelector("button[onclick^='stopRecording']");
    const playBtn=cell.querySelector("button[onclick^='playRecording']");
    const audio=cell.querySelector("audio");
    recordedChunks=[];
    navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
        mediaRecorder=new MediaRecorder(stream,{mimeType:'audio/mp4'});
        mediaRecorder.start();
        mediaRecorder.ondataavailable=e=>{if(e.data.size>0) recordedChunks.push(e.data);}
        mediaRecorder.onstop=()=>{
            latestBlob=new Blob(recordedChunks,{type:'audio/mp4'});
            audio.src=URL.createObjectURL(latestBlob);
            audio.style.display="block";
            playBtn.disabled=false; stopBtn.disabled=true; btn.disabled=false;
            stream.getTracks().forEach(track=>track.stop());
        };
        btn.disabled=true; stopBtn.disabled=false; playBtn.disabled=true;
    }).catch(err=>alert("錄音失敗:"+err.message));
}
function stopRecording(btn){ if(mediaRecorder&&mediaRecorder.state!=='inactive') mediaRecorder.stop(); }
function playRecording(btn){ const audio=btn.closest(".recorder-cell").querySelector("audio"); audio.play(); }

// 內嵌選擇題
function selectInlineOption(btn,type){
    if(type==='radio'){
        const siblings = btn.parentNode.querySelectorAll('.option-button');
        siblings.forEach(b=>b.classList.remove('selected'));
        btn.classList.add('selected');
    } else if(type==='multi'){
        btn.classList.toggle('selected');
    }
    const values = Array.from(btn.parentNode.querySelectorAll('.option-button.selected')).map(b=>b.innerText);
    btn.parentNode.dataset.value = type==='radio'?values[0]||'':values.join('、');
}

// 文字輸入 Modal
function openTextModal(cell){
    currentCell = cell;
    const value = cell.dataset.value||'';
    document.getElementById('modalInput').value = value;
    document.getElementById('modal').style.display='block';
    document.getElementById('modalInput').focus();
}
function closeModal(){ document.getElementById('modal').style.display='none'; }
function confirmModal(){
    if(!currentCell) return;
    const newValue = document.getElementById('modalInput').value.trim();
    currentCell.dataset.value = newValue;
    currentCell.innerText = newValue || '尚未輸入';
    closeModal();
}

// 匯出 ZIP
document.getElementById("exportBtn").addEventListener("click",async()=>{
    const container=document.querySelector(".table-container").cloneNode(true);
    container.querySelector("#exportBtn")?.remove();
    const tasks=Array.from(container.querySelectorAll("td")).map(cell=>{
        if(cell.querySelector(".recorder-cell")){
            const audio=cell.querySelector("audio");
            if(audio && audio.src.startsWith("blob:")){
                return fetch(audio.src).then(r=>r.blob()).then(blob=>new Promise(resolve=>{
                    const reader=new FileReader();
                    reader.onload=function(){ cell.innerHTML='<audio controls src="'+reader.result+'"></audio>'; resolve(); };
                    reader.readAsDataURL(blob);
                }));
            } else { cell.innerHTML=''; return Promise.resolve(); }
        }
        if(cell.classList.contains('editable-cell')){
            if(['text','radio','multi'].includes(cell.dataset.type)){
                cell.innerHTML='<div>'+ (cell.dataset.value||'')+'</div>';
            }
        }
        return Promise.resolve();
    });
    await Promise.all(tasks);
    const exportHTML='<!DOCTYPE html><html><head><meta charset="utf-8"><title>已匯出表格</title></head><body>'+container.outerHTML+'</body></html>';
    const zip=new JSZip(); zip.file("exported_table.html",exportHTML);
    zip.generateAsync({type:"blob"}).then(async content=>{
        const file=new File([content],"exported_table.zip",{type:"application/zip"});
        if(navigator.canShare && navigator.canShare({files:[file]})){
            try{ await navigator.share({files:[file],title:"匯出表格",text:"這是你匯出的表格 ZIP 檔"}); return; }catch(err){console.error(err);}
        }
        const a=document.createElement("a"); a.href=URL.createObjectURL(content); a.download="exported_table.zip"; a.click();
    });
});
</script>
</div>
