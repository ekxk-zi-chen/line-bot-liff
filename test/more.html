
<div class="table-container">
<style>
  div.table-container {
      overflow-x: auto;
  }
  table {
      width: 100%;
      max-width: 100%;
      border-collapse: collapse;
  }
  th, td {
      padding: 6px;
      text-align: left;
      word-break: break-word;
      border: 1px solid #ccc;
      vertical-align: top;
      cursor: default;
  }
  .editable-cell {
      background: #fff8dc;
      cursor: pointer;
      font-weight: bold;
  }
  .editable-cell:hover {
      background: #ffe69c;
  }
  #exportBtn {
      margin: 10px 0;
      padding: 6px 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
  }
  /* Modal */
  .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
  }
  .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 400px;
  }
  .modal-content h3 {
      margin-top:0;
  }
  .modal-content button {
      margin-top: 10px;
  }
</style>

<button id="exportBtn">ğŸ’¾ åŒ¯å‡º ZIP</button>

<table border="1" style="border-collapse:collapse; width:100%;"><thead><tr><th><div data-gjs-editable="true">æ„å¤–å‚·ç—…ç¾å ´ç´€éŒ„/SOP</div></th><th><div data-gjs-editable="true">Unnamed: 1</div></th><th><div data-gjs-editable="true">Unnamed: 2</div></th><th><div data-gjs-editable="true">Unnamed: 3</div></th><th><div data-gjs-editable="true">Unnamed: 4</div></th><th><div data-gjs-editable="true">Unnamed: 5</div></th><th><div data-gjs-editable="true">Unnamed: 6</div></th><th><div data-gjs-editable="true">Unnamed: 7</div></th></tr></thead><tbody><tr><td><div data-gjs-editable="true">å‚·ç—…æ‚£å§“å</div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true">å¹´é½¡</div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true">æ€§åˆ¥</div></td><td class='editable-cell' data-type='radio' data-options='ç”·ç”Ÿ,å¥³ç”Ÿ' onclick="openModal(this,'radio')">ğŸ“Œ é¸æ“‡ç­”æ¡ˆ</td><td><div data-gjs-editable="true">é«”é‡</div></td><td><div data-gjs-editable="true"></div></td></tr><tr><td><div data-gjs-editable="true">ç·Šæ€¥è¯çµ¡äºº</div></td>
                <td class='editable-cell'>
                  <div class="recorder-cell">
                    <button onclick="startRecording(this)">ğŸ¤ éŒ„éŸ³</button>
                    <button onclick="stopRecording(this)" disabled>â¹ åœæ­¢</button>
                    <button onclick="playRecording(this)" disabled>â–¶ æ’­æ”¾</button>
                    <audio controls style="display:none;"></audio>
                  </div>
                </td>
                <td><div data-gjs-editable="true">å‚·ç—…æ‚£è¡Œç¨‹ç¸½å¤©æ•¸</div></td><td class='editable-cell' data-type='radio' data-options='ä¸€æ—¥,äºŒæ—¥,ä¸‰æ—¥' onclick="openModal(this,'radio')">ğŸ“Œ é¸æ“‡ç­”æ¡ˆ</td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td></tr><tr><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true">123.0</div></td></tr><tr><td><div data-gjs-editable="true">ä¸»è¨´</div></td>
                <td class='editable-cell'>
                  <div class="recorder-cell">
                    <button onclick="startRecording(this)">ğŸ¤ éŒ„éŸ³</button>
                    <button onclick="stopRecording(this)" disabled>â¹ åœæ­¢</button>
                    <button onclick="playRecording(this)" disabled>â–¶ æ’­æ”¾</button>
                    <audio controls style="display:none;"></audio>
                  </div>
                </td>
                <td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true">å¤šé¸æ¸¬è©¦</div></td><td><div data-gjs-editable="true"></div></td><td class='editable-cell' data-type='multi' data-options='ä½ å¥½,ä»–å¥½,æˆ‘å¥½,æ²’æœ‰äººå¥½,å¤§å®¶éƒ½å¥½' onclick="openModal(this,'multi')">ğŸ“Œ é¸æ“‡ç­”æ¡ˆ</td><td><div data-gjs-editable="true"></div></td></tr><tr><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true"></div></td><td><div data-gjs-editable="true">è¼¸å…¥æ¸¬è©¦</div></td><td><div data-gjs-editable="true"></div></td><td class='editable-cell' data-type='text' onclick="openModal(this,'text')">âœï¸ è¼¸å…¥æ–‡å­—</td><td><div data-gjs-editable="true"></div></td></tr></tbody></table>

<!-- Modal -->
<div id="modal" class="modal">
  <div class="modal-content" id="modalContent">
    <h3 id="modalTitle"></h3>
    <div id="modalBody"></div>
    <button onclick="confirmModal()">ç¢ºå®š</button>
    <button onclick="closeModal()">å–æ¶ˆ</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
let mediaRecorder;
let recordedChunks = [];
let latestBlob = null;
let currentCell = null;
let currentType = '';

function startRecording(btn) {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("âš ï¸ é€™å€‹ç€è¦½å™¨ä¸æ”¯æ´éŒ„éŸ³ (è«‹ä½¿ç”¨ iOS14+ Safari æˆ– Android Chrome)");
        return;
    }
    const cell = btn.closest(".recorder-cell");
    const stopBtn = cell.querySelector("button[onclick^='stopRecording']");
    const playBtn = cell.querySelector("button[onclick^='playRecording']");
    const audio = cell.querySelector("audio");

    recordedChunks = [];
    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/mp4' });
            mediaRecorder.start();

            mediaRecorder.ondataavailable = e => {
                if (e.data.size > 0) recordedChunks.push(e.data);
            };
            mediaRecorder.onstop = () => {
                latestBlob = new Blob(recordedChunks, { type: 'audio/mp4' });
                audio.src = URL.createObjectURL(latestBlob);
                audio.style.display = "block";
                playBtn.disabled = false;
            };

            btn.disabled = true;
            stopBtn.disabled = false;
            playBtn.disabled = true;
        })
        .catch(err => {
            console.error("éŒ„éŸ³å¤±æ•—:", err);
            alert("ç„¡æ³•å•Ÿå‹•éŒ„éŸ³: " + err.message);
        });
}

function stopRecording(btn) {
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
    }
    const cell = btn.closest(".recorder-cell");
    const startBtn = cell.querySelector("button[onclick^='startRecording']");
    const playBtn = cell.querySelector("button[onclick^='playRecording']");
    startBtn.disabled = false;
    btn.disabled = true;
    playBtn.disabled = false;
}

function playRecording(btn) {
    const cell = btn.closest(".recorder-cell");
    const audio = cell.querySelector("audio");
    audio.play();
}

// Detect if mobile
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

// Modal functions
function openModal(cell,type){
    currentCell = cell;
    currentType = type;
    const options = cell.dataset.options ? cell.dataset.options.split(',') : [];
    const value = cell.dataset.value || '';

    // å¦‚æœæ˜¯æ‰‹æ©Ÿå¤šé¸é¡Œï¼Œç›´æ¥ç”¨ select multiple
    if(isMobile && type==='multi'){
        let selHtml = `<select id="modalSelect" multiple style="width:100%">`;
        options.forEach(opt=>{
            selHtml += `<option value="${opt}" ${value.split('ã€').includes(opt)?'selected':''}>${opt}</option>`;
        });
        selHtml += `</select>`;
        cell.innerHTML = selHtml;
        return;
    }

    document.getElementById('modalTitle').innerText = type==='text' ? 'è«‹è¼¸å…¥æ–‡å­—' : 'è«‹é¸æ“‡ç­”æ¡ˆ';
    let body = '';
    if(type==='text'){
        body = `<textarea id="modalInput" style="width:100%" rows="4">${value}</textarea>`;
    } else if(type==='radio'){
        body = options.map(opt=>`<label><input type="radio" name="modalRadio" value="${opt}" ${opt===value?'checked':''}> ${opt}</label><br>`).join('');
    } else if(type==='multi'){
        body = options.map(opt=>`<label><input type="checkbox" value="${opt}" ${value.split('ã€').includes(opt)?'checked':''}> ${opt}</label><br>`).join('');
    }
    document.getElementById('modalBody').innerHTML = body;
    document.getElementById('modal').style.display = 'block';
}

function closeModal(){
    document.getElementById('modal').style.display = 'none';
}

function confirmModal(){
    if(!currentCell) return;
    let newValue = '';
    if(currentType==='text'){
        newValue = document.getElementById('modalInput').value.trim();
    } else if(currentType==='radio'){
        const sel = document.querySelector('input[name="modalRadio"]:checked');
        newValue = sel ? sel.value : '';
    } else if(currentType==='multi'){
        const sel = Array.from(document.querySelectorAll('#modalBody input[type=checkbox]:checked')).map(i=>i.value);
        newValue = sel.join('ã€');
    }
    currentCell.dataset.value = newValue;
    currentCell.innerText = newValue || (currentType==='multi' ? 'æœªé¸æ“‡' : 'å°šæœªè¼¸å…¥');
    closeModal();
}

// Export ZIP
document.getElementById("exportBtn").addEventListener("click", async () => {
    const container = document.querySelector(".table-container").cloneNode(true);
    container.querySelector("#exportBtn")?.remove();

    const tasks = Array.from(container.querySelectorAll("td")).map(cell => {
        // å¯ç·¨è¼¯æ ¼å­
        if(cell.classList.contains('editable-cell')) {
            if(cell.dataset.type==='text' || cell.dataset.type==='radio' || cell.dataset.type==='multi'){
                const val = cell.dataset.value || '';
                cell.innerHTML = `<div>${val}</div>`;
            }
            return Promise.resolve();
        }
        // éŒ„éŸ³
        if(cell.querySelector(".recorder-cell")) {
            const audio = cell.querySelector("audio");
            if(audio && audio.src.startsWith("blob:")) {
                return fetch(audio.src).then(r=>r.blob()).then(blob=>new Promise(resolve=>{
                    const reader = new FileReader();
                    reader.onload = function(){
                        cell.innerHTML = `<audio controls src="${reader.result}"></audio>`;
                        resolve();
                    };
                    reader.readAsDataURL(blob);
                }));
            } else {
                cell.innerHTML = "<span>å°šæœªéŒ„éŸ³</span>";
                return Promise.resolve();
            }
        }
        return Promise.resolve();
    });

    await Promise.all(tasks);

    const exportHTML = `<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>å·²åŒ¯å‡ºè¡¨æ ¼</title></head>
<body>${container.outerHTML}</body>
</html>`;

    const zip = new JSZip();
    zip.file("exported_table.html", exportHTML);

    zip.generateAsync({type:"blob"}).then(async function(content){
        const file = new File([content], "exported_table.zip", {type:"application/zip"});
        if(navigator.canShare && navigator.canShare({files:[file]})){
            try {
                await navigator.share({files:[file], title:"åŒ¯å‡ºè¡¨æ ¼", text:"é€™æ˜¯ä½ åŒ¯å‡ºçš„è¡¨æ ¼ ZIP æª”"});
                return;
            } catch(err){
                console.error("åˆ†äº«å¤±æ•—:",err);
            }
        }
        const a=document.createElement("a");
        a.href = URL.createObjectURL(content);
        a.download = "exported_table.zip";
        a.click();
    });
});
</script>
</div>
