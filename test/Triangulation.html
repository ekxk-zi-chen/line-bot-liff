<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ‰‹æ©Ÿç¾…ç›¤ä¸‰è§’å®šä½</title>
<style>
  body { margin: 0; background: #111; color: #eee; font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
  
  /* ä¸ŠåŠéƒ¨ï¼šç¾…ç›¤å€ */
  #compass-container {
    flex: 1; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden;
    background: radial-gradient(circle at center 30%, #2a2a2a 0%, #000 70%); /* èª¿æ•´èƒŒæ™¯å…‰å½±è®“ä¸Šæ–¹æ›´æ¸…æ¥š */
  }

  /* --- æ–°å¢ï¼šä¸Šæ–¹ç„æº–æº–æ˜Ÿ --- */
  #aiming-sight {
    position: absolute;
    top: 15px; /* è²¼è¿‘è¢å¹•ä¸Šæ–¹é‚Šç·£ */
    left: 50%;
    transform: translateX(-50%);
    z-index: 50; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
    display: flex;
    flex-direction: column;
    align-items: center;
    filter: drop-shadow(0 0 8px rgba(0, 255, 255, 0.8)); /* å¼·çƒˆçš„ç™¼å…‰æ•ˆæœ */
    pointer-events: none;
  }
  /* ç®­é ­é ­éƒ¨ */
  #aim-arrowhead {
    width: 0; height: 0;
    border-left: 12px solid transparent;
    border-right: 12px solid transparent;
    border-bottom: 20px solid cyan; /* é’è‰²äº®çœ¼ */
  }
  /* ä¸­é–“æº–ç·š */
  #aim-line {
    width: 2px;
    height: 50px; /* å‘ä¸‹å»¶ä¼¸æŒ‡å‘ç¾…ç›¤ */
    background: cyan;
  }
  
  /* è½‰ç›¤ */
  #dial {
    width: 260px; height: 260px; 
    border: 4px solid #444; border-radius: 50%;
    position: relative; 
    box-shadow: 0 0 40px rgba(0,0,0,0.9), inset 0 0 30px rgba(0,0,0,0.9);
    transition: transform 0.1s linear;
    background: linear-gradient(to bottom, #222, #111);
    margin-top: 30px; /* ç¨å¾®å¾€ä¸‹ç§»ï¼Œè®“å‡ºç©ºé–“çµ¦ç„æº–å™¨ */
  }
  
  /* åˆ»åº¦èˆ‡æ–‡å­— */
  .mark { position: absolute; left: 50%; top: 0; width: 2px; height: 10px; background: #666; transform-origin: 50% 130px; }
  .mark.major { height: 15px; width: 3px; background: #eee; }
  
  .label { 
    position: absolute; left: 50%; top: 20px; 
    transform-origin: 50% 110px; 
    font-weight: bold; font-size: 14px; width: 30px; text-align: center; margin-left: -15px; color: #aaa; 
  }
  .north { color: #f44; font-size: 20px; }
  
  /* ç¾…ç›¤ä¸Šçš„è®€æ•¸ç´…ç·š (ä¾ç„¶ä¿ç•™ï¼Œä½œç‚ºå°æ‡‰åˆ»åº¦çš„æŒ‡ç¤º) */
  #pointer-arrow {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -150px); /* èª¿æ•´ä½ç½®å°é½Šæ–°è½‰ç›¤ */
    width: 0; height: 0;
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-top: 20px solid #f33; 
    z-index: 20;
  }
  /* ä¸­å¿ƒçš„æº–å¿ƒ (è£é£¾ç”¨) */
  #center-cross {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
    width: 16px; height: 16px;
    border: 1px solid rgba(255,255,255,0.15); border-radius: 50%; pointer-events: none;
  }
  #center-cross::before, #center-cross::after { content:''; position: absolute; background: rgba(255,255,255,0.15); }
  #center-cross::before { top:7px; left: -8px; width: 32px; height: 1px; }
  #center-cross::after { left:7px; top: -8px; height: 32px; width: 1px; }

  /* æ•¸å€¼é¡¯ç¤º */
  #readout {
    position: absolute; bottom: 15px; left: 0; right: 0; text-align: center;
    font-size: 36px; font-weight: bold; color: cyan; text-shadow: 0 0 15px rgba(0,255,255,0.5);
    font-family: monospace;
  }
  
  /* æ“ä½œå€ */
  #controls { padding: 12px; background: #1a1a1a; border-top: 1px solid #333; max-height: 45vh; overflow-y: auto; box-shadow: 0 -5px 25px rgba(0,0,0,0.6); z-index: 60; }
  .btn-row { display: flex; gap: 10px; margin-bottom: 10px; }
  button { flex: 1; padding: 14px; font-size: 16px; border: none; border-radius: 6px; background: #333; color: #eee; cursor: pointer; font-weight: bold; border: 1px solid #444; transition: all 0.2s;}
  button:active { transform: scale(0.98); }
  button.active { background: #0056b3; border-color: #007bff; color: white; box-shadow: 0 2px 8px rgba(0,123,255,0.4); }
  button.calc { background: #1e7e34; border-color: #28a745; color: white; box-shadow: 0 2px 8px rgba(40,167,69,0.4); }
  
  /* é–å®šåˆ—è¡¨ */
  .record { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; background: #2a2a2a; padding: 8px; border-radius: 6px; border: 1px solid #333; }
  .record input { background: #111; border: 1px solid #444; color: #ccc; padding: 8px; width: 100%; border-radius: 4px; font-size: 14px; }
  .record input:focus { border-color: cyan; color: white; outline: none; }
  .record .deg-box { width: 55px; text-align: center; font-weight: bold; color: cyan; flex-shrink: 0; font-size: 18px; font-family: monospace; }
  .record .del { width: 36px; height: 36px; background: #922; color: white; border: none; border-radius: 4px; font-weight: bold; padding: 0; font-size: 16px; }
  
  /* çµæœåœ–å±¤ */
  #result-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100;
    display: none;
    opacity: 0; transition: opacity 0.3s ease-in; /* æ·¡å…¥æ•ˆæœ */
  }
  #result-overlay.show { opacity: 1; }
  #close-res { position: absolute; top: 20px; right: 20px; z-index: 101; background: rgba(200,50,50,0.8); padding: 10px 25px; border-radius: 30px; color: white; font-weight: bold; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); }
</style>
</head>
<body>

<div id="compass-container">
  
  <div id="aiming-sight">
    <div id="aim-arrowhead"></div>
    <div id="aim-line"></div>
  </div>

  <div id="pointer-arrow"></div>
  
  <div id="dial">
    <div id="center-cross"></div>
    </div>
  
  <div id="readout">ç­‰å¾…è¨Šè™Ÿ...</div>
</div>

<div id="controls">
  <div class="btn-row">
    <button onclick="reqPerm()" id="permBtn">é–‹å•Ÿç¾…ç›¤ (iOS)</button>
    <button onclick="lockCurrent()" class="active">ğŸ“ é–å®šç›®æ¨™</button>
  </div>
  
  <div id="list">
    </div>

  <div class="btn-row" style="margin-top:15px">
    <button onclick="runCalculation()" class="calc">ğŸš€ è¨ˆç®—æˆ‘çš„ä½ç½®</button>
  </div>
</div>

<div id="result-overlay">
  <button id="close-res" onclick="closeResult()">âœ• é—œé–‰åœ°åœ–</button>
  <canvas id="cv"></canvas>
  <div id="res-text" style="position:absolute; bottom:25px; left:15px; right:15px; color:lime; font-size:16px; background:rgba(0,20,0,0.85); padding:15px; border-radius: 12px; text-align:center; font-family:monospace; border: 1px solid rgba(0,255,0,0.3); backdrop-filter: blur(10px);"></div>
</div>

<script>
// --- ç¾…ç›¤ UI åˆå§‹åŒ– ---
const dial = document.getElementById('dial');
for(let i=0; i<360; i+=10) {
  const isMajor = (i % 30 === 0);
  const mk = document.createElement('div');
  mk.className = isMajor ? 'mark major' : 'mark';
  mk.style.transform = `translateX(-50%) rotate(${i}deg)`;
  dial.appendChild(mk);
  if(isMajor) {
    const lb = document.createElement('div');
    lb.className = i===0 ? 'label north' : 'label';
    let txt = i;
    if(i===0) txt='N'; else if(i===90) txt='E'; else if(i===180) txt='S'; else if(i===270) txt='W';
    lb.innerHTML = `<div style="transform: rotate(${-i}deg)">${txt}</div>`;
    lb.style.transform = `translateX(-50%) rotate(${i}deg)`;
    dial.appendChild(lb);
  }
}

// --- å‚³æ„Ÿå™¨é‚è¼¯ ---
let currentHeading = 0;
function handleOrientation(e) {
  let compass = e.webkitCompassHeading || (e.alpha !== null ? (360 - e.alpha) : 0);
  currentHeading = compass;
  // ä½¿ç”¨ requestAnimationFrame è®“å‹•ç•«æ›´é †æš¢
  requestAnimationFrame(()=>{
    dial.style.transform = `rotate(${-currentHeading}deg)`;
    document.getElementById('readout').innerHTML = 
      `${Math.round(currentHeading).toString().padStart(3,'0')}<small style="font-size:0.5em">Â°</small>`;
  });
}

function reqPerm() {
  if (typeof DeviceOrientationEvent.requestPermission === 'function') {
    DeviceOrientationEvent.requestPermission().then(r => {
      if (r==='granted') { window.addEventListener('deviceorientation', handleOrientation, true); document.getElementById('permBtn').style.display='none'; }
      else alert('æ¬Šé™è¢«æ‹’çµ•');
    }).catch(console.error);
  } else {
    window.addEventListener('deviceorientation', handleOrientation, true); document.getElementById('permBtn').style.display='none';
  }
}

// --- é–å®šèˆ‡åˆ—è¡¨é‚è¼¯ ---
const list = document.getElementById('list');
let points = [];

function lockCurrent() {
  if(points.length >= 3) { alert("æœ€å¤šä¸‰å€‹é»"); return; }
  const id = Date.now();
  points.push({ id, b: currentHeading, lat: '', lon: '', name: '' });
  renderList();
  // UXå„ªåŒ–ï¼šéœ‡å‹•åé¥‹ (å¦‚æœè£ç½®æ”¯æŒ)
  if(navigator.vibrate) navigator.vibrate(50);
  setTimeout(() => { const i=document.querySelectorAll('#list input'); if(i.length>0) i[0].focus(); }, 100);
}

function updatePoint(id, f, v) { const p=points.find(x=>x.id===id); if(p) p[f]=v; }
function removePoint(id) { points=points.filter(x=>x.id!==id); renderList(); }

function renderList() {
  list.innerHTML = '';
  [...points].reverse().forEach((p) => {
    const el = document.createElement('div'); el.className = 'record';
    el.innerHTML = `
      <div class="deg-box">${Math.round(p.b)}Â°</div>
      <div style="flex:1">
        <input placeholder="åç¨± (ä¾‹å¦‚: ç‰å±±ä¸»å³°)" oninput="updatePoint(${p.id},'name',this.value)" value="${p.name}" style="margin-bottom:6px; font-weight:bold; color:#eee;">
        <div style="display:flex; gap:6px;">
          <input placeholder="ç·¯åº¦ Lat (åé€²ä½)" type="number" step="0.0001" oninput="updatePoint(${p.id},'lat',this.value)" value="${p.lat}">
          <input placeholder="ç¶“åº¦ Lon (åé€²ä½)" type="number" step="0.0001" oninput="updatePoint(${p.id},'lon',this.value)" value="${p.lon}">
        </div>
      </div>
      <button class="del" onclick="removePoint(${p.id})">âœ•</button>
    `;
    list.appendChild(el);
  });
}

// --- å®šä½æ¼”ç®—æ³• èˆ‡ ç¹ªåœ– ---
const cv = document.getElementById("cv"), ctx = cv.getContext("2d");
const R = 6371000, rad = d => d * Math.PI / 180;
let refLat = 0, refLon = 0;

function autoDeclination(){ return -2.5 + 0.02*(new Date().getFullYear()-2020); }
function ll2enu(lat,lon){ const dLat=rad(lat-refLat),dLon=rad(lon-refLon); return [R*dLon*Math.cos(rad(refLat)), R*dLat]; }
function enu2ll(x,y){ return [ refLat + y/R*180/Math.PI, refLon + x/(R*Math.cos(rad(refLat)))*180/Math.PI ]; }

function estimate(mnts){
  let x=0,y=0; mnts.forEach(m=>{x+=m.x;y+=m.y}); x/=mnts.length; y/=mnts.length;
  for(let i=0;i<80;i++){ let gx=0,gy=0; mnts.forEach(m=>{
      const back=rad(m.b+180), vx=Math.sin(back),vy=Math.cos(back), dx=x-m.x,dy=y-m.y, p=dx*vx+dy*vy;
      gx+=dx-p*vx; gy+=dy-p*vy; }); x-=gx*0.05; y-=gy*0.05; }
  return [x,y];
}

function simulate(mnts,err){
  let pts=[]; for(let i=0;i<300;i++){
    pts.push(estimate(mnts.map(m=>({...m,b:m.b+(Math.random()*2-1)*err})))); }
  return pts;
}

function draw(mnts,pts,center){
  cv.width = window.innerWidth; cv.height = window.innerHeight;
  ctx.clearRect(0,0,cv.width,cv.height);
  let all=[center, ...mnts.map(m=>[m.x,m.y])];
  let xs=all.map(p=>p[0]),ys=all.map(p=>p[1]);
  let minx=Math.min(...xs),maxx=Math.max(...xs), miny=Math.min(...ys),maxy=Math.max(...ys);
  const pad=0.4, w=maxx-minx, h=maxy-miny;
  minx-=w*pad; maxx+=w*pad; miny-=h*pad; maxy+=h*pad;
  const s=Math.min(cv.width/(maxx-minx||1),cv.height/(maxy-miny||1));
  const map=p=>[ (p[0]-minx)*s, cv.height-(p[1]-miny)*s ];

  // ç²’å­é›²
  ctx.fillStyle="rgba(0,255,255,0.3)"; pts.forEach(p=>{ const q=map(p); ctx.fillRect(q[0],q[1],2,2); });

  // å±±èˆ‡å…‰æŸ
  mnts.forEach((m,i)=>{
    const p=map([m.x,m.y]);
    ctx.fillStyle=`hsl(${i*60},80%,50%)`; ctx.beginPath(); ctx.arc(p[0],p[1],6,0,Math.PI*2); ctx.fill();
    ctx.fillStyle="#fff"; ctx.font="bold 12px sans-serif"; ctx.fillText(m.name||('å±±'+(i+1)), p[0]+8, p[1]+4);
    const b = rad(m.b + 180 - 90), err=rad(2), L=Math.max(cv.width,cv.height)*2;
    ctx.fillStyle=`hsla(${i*60},80%,50%,0.15)`; ctx.beginPath(); ctx.moveTo(p[0],p[1]); ctx.arc(p[0],p[1],L,b-err,b+err); ctx.fill();
    ctx.strokeStyle=`hsla(${i*60},80%,50%,0.6)`; ctx.setLineDash([4,4]); ctx.beginPath(); ctx.moveTo(p[0],p[1]); ctx.lineTo(p[0]+Math.cos(b)*L, p[1]+Math.sin(b)*L); ctx.stroke();
  });

  // ä¸­å¿ƒé»
  const c=map(center);
  ctx.strokeStyle="#0f0"; ctx.lineWidth=2; ctx.setLineDash([]);
  ctx.beginPath(); ctx.arc(c[0],c[1],12,0,Math.PI*2); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(c[0]-25,c[1]); ctx.lineTo(c[0]+25,c[1]); ctx.moveTo(c[0],c[1]-25); ctx.lineTo(c[0],c[1]+25); ctx.stroke();
  ctx.fillStyle="#0f0"; ctx.font="16px monospace"; ctx.fillText(" YOU", c[0]+15, c[1]);
}

function runCalculation(){
  const valid = points.filter(p => p.lat && p.lon);
  if(valid.length < 2){ alert("è«‹è‡³å°‘é–å®š 2 å€‹åº§æ¨™é»"); return; }
  const overlay = document.getElementById('result-overlay');
  overlay.style.display='block'; setTimeout(()=>overlay.classList.add('show'),10);
  
  const mnts = valid.map(p => ({ lat: +p.lat, lon: +p.lon, b: +p.b, name: p.name }));
  const decl = autoDeclination(); mnts.forEach(m => m.b += decl);
  refLat = mnts.reduce((s,m)=>s+m.lat,0)/mnts.length; refLon = mnts.reduce((s,m)=>s+m.lon,0)/mnts.length;
  mnts.forEach(m => { [m.x,m.y] = ll2enu(m.lat, m.lon); });

  const centerPts = simulate(mnts, 2.5);
  const center = centerPts.reduce((s,p)=>[s[0]+p[0],s[1]+p[1]],[0,0]).map(v=>v/centerPts.length);
  draw(mnts, centerPts, center);
  const finalLL = enu2ll(center[0], center[1]);
  document.getElementById('res-text').innerHTML = 
    `æ¨å®šåº§æ¨™<br><span style="color:#fff;font-size:1.3em;user-select:all">${finalLL[0].toFixed(5)}, ${finalLL[1].toFixed(5)}</span><br><span style="color:#aaa;font-size:0.8em">ç£åä¿®æ­£ ${decl.toFixed(1)}Â° (èª¤å·®ç¯„åœç´„ Â±${Math.round(centerPts.length/5)}m)</span>`;
}

function closeResult(){
  const overlay = document.getElementById('result-overlay');
  overlay.classList.remove('show'); setTimeout(()=>overlay.style.display='none',300);
}
</script>
</body>
</html>
