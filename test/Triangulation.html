<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ç²¾å¯†ç¾…ç›¤å®šä½ v6.1 (ç²¾ä¿®ç‰ˆ)</title>
  <style>
    /* --- 1. å…¨å±€åŸºç¤ (é«˜å°æ¯”é»‘åº•) --- */
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: "SF Mono", "Roboto Mono", monospace;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100vh;
      user-select: none;
      -webkit-user-select: none;
    }

    /* --- 2. ç¾…ç›¤å€ (è¦–è¦ºæ ¸å¿ƒ) --- */
    #compass-container {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: radial-gradient(circle at center, #2a2a2a 0%, #000 85%);
    }

    /* ç„æº–ç·š */
    #aiming-sight {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      z-index: 50;
      display: flex;
      flex-direction: column;
      align-items: center;
      pointer-events: none;
      filter: drop-shadow(0 0 8px cyan);
    }

    #aim-arrowhead {
      width: 0;
      height: 0;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-bottom: 20px solid #0ff;
    }

    #aim-line {
      width: 2px;
      height: 40vh;
      background: linear-gradient(to bottom, #0ff 0%, transparent 100%);
      opacity: 0.6;
    }

    /* --- 3. è½‰ç›¤çµæ§‹ --- */
    #dial-ring {
      width: 290px;
      height: 290px;
      border-radius: 50%;
      border: 4px solid #333;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.8), inset 0 0 20px rgba(0, 0, 0, 1);
      pointer-events: none;
      z-index: 10;
    }

    #dial {
      width: 290px;
      height: 290px;
      position: relative;
      will-change: transform;
      /* ç¡¬é«”åŠ é€Ÿ */
    }

    /* --- 4. ç²¾ç´°åˆ»åº¦èˆ‡æ•¸å­— --- */
    .mark {
      position: absolute;
      left: 50%;
      top: 0;
      width: 1px;
      height: 8px;
      background: #666;
      transform-origin: 50% 145px;
    }

    .mark.major {
      height: 12px;
      width: 2px;
      background: #aaa;
    }

    .mark.cardinal {
      height: 18px;
      width: 4px;
      background: #fff;
      box-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
    }

    .label {
      position: absolute;
      top: 24px;
      left: 50%;
      width: 40px;
      margin-left: -20px;
      text-align: center;
      font-weight: bold;
      font-size: 14px;
      color: #888;
      transform-origin: 50% 121px;
      line-height: 1;
    }

    .label-cardinal {
      font-size: 20px;
      color: #fff;
      top: 22px;
      transform-origin: 50% 123px;
      text-shadow: 0 0 5px #000;
    }

    .label-zero {
      color: #f33;
      text-shadow: 0 0 8px rgba(255, 0, 0, 0.6);
    }

    /* ä¸­å¤®æŒ‡é‡ */
    #pointer-fixed {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -158px);
      width: 0;
      height: 0;
      border-left: 9px solid transparent;
      border-right: 9px solid transparent;
      border-top: 16px solid #f22;
      z-index: 20;
      filter: drop-shadow(0 2px 4px #000);
    }

    /* è®€æ•¸é¡¯ç¤º */
    #readout {
      position: absolute;
      bottom: 20px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 56px;
      font-weight: 700;
      color: #0ff;
      text-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
      letter-spacing: 2px;
    }

    #readout small {
      font-size: 24px;
      color: #666;
      margin-left: 8px;
      font-weight: normal;
    }

    /* --- 5. æ“ä½œé¢æ¿ --- */
    #controls {
      padding: 12px;
      background: #111;
      border-top: 1px solid #333;
      max-height: 45vh;
      overflow-y: auto;
      z-index: 60;
      box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.8);
    }

    .row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      align-items: stretch;
    }

    button {
      flex: 1;
      padding: 14px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      background: #2a2a2a;
      color: #ddd;
      font-weight: bold;
      border: 1px solid #444;
      font-family: inherit;
      transition: background 0.2s;
    }

    button:active {
      background: #444;
      transform: scale(0.98);
    }

    button.active {
      background: #0062cc;
      border-color: #005cbf;
      color: #fff;
      box-shadow: 0 0 15px rgba(0, 100, 255, 0.3);
    }

    button.calc {
      background: #1e7e34;
      border-color: #1c7430;
      color: #fff;
      box-shadow: 0 0 15px rgba(40, 167, 69, 0.3);
    }

    /* èª¤å·®è¨­å®š */
    .err-box {
      display: flex;
      align-items: center;
      background: #000;
      padding: 0 10px;
      border: 1px solid #444;
      border-radius: 6px;
    }

    .err-input {
      width: 50px;
      background: transparent;
      color: #fa0;
      border: none;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      font-family: inherit;
    }

    /* --- åˆ—è¡¨æ¨£å¼ (æœ¬æ¬¡ä¿®æ”¹é‡é») --- */
    .record {
      position: relative;
      /* é—œéµï¼šè®“XæŒ‰éˆ•å¯ä»¥å°é½Šé€™è£¡ */
      display: flex;
      align-items: stretch;
      gap: 0;
      /* å®Œå…¨ç„¡ç¸«éš™ */
      margin-bottom: 6px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 2px;
      padding-right: 18px;
      /* å³é‚Šåªç•™ 18px çµ¦ Xï¼Œå…¶ä»–å…¨çµ¦è¼¸å…¥æ¡† */
      overflow: hidden;
    }

    .deg-wrapper {
      width: 68px;
      /* å†ç¸®çª„ä¸€é» */
      flex-shrink: 0;
      background: #000;
      border-right: 1px solid #444;
    }

    input.deg-input {
      width: 100%;
      height: 100%;
      background: transparent;
      border: none;
      color: #0ff;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      font-family: inherit;
      padding: 0;
    }

    input.deg-input:focus {
      background: #111;
      color: #fff;
      outline: none;
    }

    /* è¼¸å…¥æ¡†ç¾¤çµ„ */
    .inputs-group {
      flex: 1;
      /* åƒæ‰å‰©ä¸‹æ‰€æœ‰ç©ºé–“ */
      display: flex;
      flex-direction: column;
      gap: 1px;
      min-width: 0;
      /* é˜²æ­¢è¢«å…§å®¹æ’é–‹ */
    }

    .inputs-row {
      display: flex;
      gap: 1px;
    }

    input.text-in {
      background: #0a0a0a;
      border: none;
      color: #fff;
      padding: 0 4px;
      /* æ¥µé™å…§è· */
      font-size: 13px;
      font-family: inherit;
      font-weight: bold;
      width: 100%;
      height: 26px;
      /* å›ºå®šé«˜åº¦ */
    }

    input.text-in:focus {
      border-color: #0ff;
      outline: none;
      background: #000;
    }

    /* --- ä¿®æ”¹ï¼šåˆªé™¤æŒ‰éˆ•è®Šå°è®Šçª„ --- */
    .del-btn {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      /* æ‹‰æ»¿æ•´å€‹é«˜åº¦ */
      width: 18px;
      /* å¯¬åº¦é–æ­» */
      background: #611;
      color: #aaa;
      border: none;
      border-left: 1px solid #444;
      font-size: 10px;
      /* å­—é«”æ¥µå° */
      padding: 0;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5;
    }

    .del-btn:active {
      background: #f00;
      color: #fff;
    }

    /* --- 6. åœ°åœ–å±¤ --- */
    #result-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      z-index: 100;
      display: none;
      touch-action: none;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    #map-ui {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      padding: 15px;
    }

    .map-btn {
      pointer-events: auto;
      background: rgba(20, 20, 20, 0.8);
      border: 1px solid #666;
      color: #fff;
      margin: 5px;
      backdrop-filter: blur(5px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    }

    #res-readout {
      pointer-events: auto;
      margin-top: auto;
      margin-bottom: 30px;
      align-self: center;
      background: rgba(0, 30, 0, 0.95);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #0f0;
      text-align: center;
      color: #0f0;
      font-size: 14px;
      box-shadow: 0 0 25px rgba(0, 255, 0, 0.2);
    }

    .coord-big {
      font-size: 24px;
      color: #fff;
      font-weight: bold;
      display: block;
      margin-top: 8px;
      user-select: text;
      -webkit-user-select: text;
    }
  </style>
</head>

<body>

  <div id="compass-container">
    <div id="aiming-sight">
      <div id="aim-arrowhead"></div>
      <div id="aim-line"></div>
    </div>
    <div id="pointer-fixed"></div>

    <div id="dial-ring"></div>

    <div id="dial">
    </div>

    <div id="readout">0.00<small>Â°</small></div>
  </div>

  <div id="controls">
    <div class="row">
      <button id="permBtn" onclick="reqPerm()">å•Ÿå‹•ç¾…ç›¤ (iOS)</button>
      <button class="active" onclick="lockTarget()">ğŸ“ é–å®šç›®æ¨™</button>
    </div>
    <div id="list"></div>
    <div class="row">
      <div class="err-box">
        <span style="color:#888; font-size:12px; margin-right:5px;">èª¤å·®Â±</span>
        <input type="number" id="err-val" class="err-input" value="1.0" step="0.5">
        <span style="color:#888; font-size:12px;">Â°</span>
      </div>
      <button class="calc" onclick="runCalculation()">ğŸš€ è¨ˆç®—ä½ç½®</button>
    </div>
  </div>

  <div id="result-overlay">
    <canvas id="cv"></canvas>
    <div id="map-ui">
      <button class="map-btn"
        style="position:absolute;top:15px;left:15px;border-radius:20px;padding:10px 25px;background:#c22;border:none;font-weight:bold"
        onclick="closeResult()">âœ• é—œé–‰</button>
      <div style="position:absolute; top:80px; right:10px; display:flex; flex-direction:column;">
        <button class="map-btn" style="width:48px;height:48px;font-size:26px;border-radius:8px;"
          onclick="adjustZoom(1.5)">+</button>
        <button class="map-btn" style="width:48px;height:48px;font-size:20px;border-radius:8px;"
          onclick="resetView()">âŸ²</button>
        <button class="map-btn" style="width:48px;height:48px;font-size:26px;border-radius:8px;"
          onclick="adjustZoom(0.66)">-</button>
      </div>
      <div id="res-readout">å°šæœªè¨ˆç®—</div>
    </div>
  </div>

  <script>
    // --- A. ç¾…ç›¤ç”Ÿæˆ ---
    const dial = document.getElementById('dial');
    function createDial() {
      dial.innerHTML = '';
      for (let i = 0; i < 360; i++) {
        if (i % 2 !== 0) continue;
        const isCardinal = (i % 90 === 0);
        const isMajor = (i % 10 === 0);

        const mk = document.createElement('div');
        mk.className = isCardinal ? 'mark cardinal' : (isMajor ? 'mark major' : 'mark');
        mk.style.transform = `translateX(-50%) rotate(${i}deg)`;
        dial.appendChild(mk);

        if (i % 30 === 0) {
          const lb = document.createElement('div');
          lb.className = isCardinal ? 'label label-cardinal' : 'label';
          if (i === 0) lb.classList.add('label-zero');
          const txt = i.toString();
          lb.innerHTML = `<div style="transform: rotate(${-i}deg)">${txt}</div>`;
          lb.style.transform = `rotate(${i}deg)`;
          dial.appendChild(lb);
        }
      }
    }
    createDial();

    // --- B. æ„Ÿæ¸¬å™¨é‚è¼¯ (Raw Data) ---
    let currentHeading = 0;
    let displayHeading = 0;

    function handleOrientation(e) {
      let heading = 0;
      if (e.webkitCompassHeading) {
        heading = e.webkitCompassHeading;
      } else if (e.alpha !== null) {
        heading = 360 - e.alpha;
      }
      currentHeading = heading;
      let textVal = currentHeading % 360;
      if (textVal < 0) textVal += 360;
      document.getElementById('readout').innerHTML = `${textVal.toFixed(2)}<small>Â°</small>`;
    }

    function animateDial() {
      requestAnimationFrame(animateDial);
      let target = currentHeading;
      let current = displayHeading % 360;
      if (current < 0) current += 360;
      let diff = target - current;
      if (diff > 180) diff -= 360;
      if (diff < -180) diff += 360;
      displayHeading += diff * 0.3;
      dial.style.transform = `rotate(${-displayHeading}deg)`;
    }
    animateDial();

    function reqPerm() {
      if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission().then(r => {
          if (r === 'granted') {
            window.addEventListener('deviceorientation', handleOrientation, true);
            document.getElementById('permBtn').style.display = 'none';
          } else { alert('æ¬Šé™è¢«æ‹’'); }
        }).catch(err => { console.error(err); alert('ç„¡æ³•å–å¾—æ¬Šé™ (HTTPS?)'); });
      } else {
        window.addEventListener('deviceorientation', handleOrientation, true);
        document.getElementById('permBtn').style.display = 'none';
      }
    }

    // --- C. é–å®šèˆ‡åˆ—è¡¨ ---
    const list = document.getElementById('list');
    let points = [];

    function lockTarget() {
      if (points.length >= 3) { alert("æœ€å¤šä¸‰å€‹åƒè€ƒé»"); return; }
      const id = Date.now();
      const val = currentHeading;
      points.push({ id, b: val, name: '', lat: '', lon: '' });
      renderList();
      if (navigator.vibrate) navigator.vibrate(30);
      setTimeout(() => {
        const input = document.querySelector(`input[data-focus="${id}"]`);
        if (input) input.focus();
      }, 50);
    }

    function updatePt(id, key, val) {
      const p = points.find(x => x.id === id);
      if (p) p[key] = val;
    }
    function removePt(id) {
      points = points.filter(x => x.id !== id);
      renderList();
    }

    function renderList() {
      list.innerHTML = '';
      [...points].reverse().forEach(p => {
        const div = document.createElement('div');
        div.className = 'record';
        div.innerHTML = `
      <div class="deg-wrapper">
        <input class="deg-input" type="number" step="0.01" 
               value="${parseFloat(p.b).toFixed(2)}" 
               onchange="updatePt(${p.id}, 'b', this.value)">
      </div>
      
      <div class="inputs-group">
        <input class="text-in" data-focus="${p.id}" placeholder="åç¨± (ä¾‹: 101)" value="${p.name}" 
               oninput="updatePt(${p.id}, 'name', this.value)" style="color:#0ff;">
        <div class="inputs-row">
          <input class="text-in" type="number" step="0.0001" placeholder="ç·¯åº¦" value="${p.lat}" oninput="updatePt(${p.id}, 'lat', this.value)">
          <input class="text-in" type="number" step="0.0001" placeholder="ç¶“åº¦" value="${p.lon}" oninput="updatePt(${p.id}, 'lon', this.value)">
        </div>
      </div>
      <button class="del-btn" onclick="removePt(${p.id})">âœ•</button>
    `;
        list.appendChild(div);
      });
    }

    // --- D. è¨ˆç®—èˆ‡åœ°åœ– ---
    const cv = document.getElementById('cv');
    const ctx = cv.getContext('2d');
    const R = 6371000;
    const rad = d => d * Math.PI / 180;

    function ll2enu(lat, lon, refLat, refLon) {
      const dLat = rad(lat - refLat);
      const dLon = rad(lon - refLon);
      return [R * dLon * Math.cos(rad(refLat)), R * dLat];
    }
    function enu2ll(x, y, refLat, refLon) {
      const lat = refLat + (y / R) * (180 / Math.PI);
      const lon = refLon + (x / (R * Math.cos(rad(refLat)))) * (180 / Math.PI);
      return [lat, lon];
    }

    function estimateLocation(mnts) {
      let x = 0, y = 0; mnts.forEach(m => { x += m.x; y += m.y; }); x /= mnts.length; y /= mnts.length;
      for (let i = 0; i < 30; i++) {
        let gx = 0, gy = 0;
        mnts.forEach(m => {
          const b = rad(Number(m.b) + 180);
          const vx = Math.sin(b), vy = Math.cos(b);
          const dx = x - m.x, dy = y - m.y;
          const p = dx * vx + dy * vy;
          gx += dx - p * vx; gy += dy - p * vy;
        });
        x -= gx * 0.1; y -= gy * 0.1;
      }
      return [x, y];
    }

    function simulateCloud(mnts, errorDeg) {
      let pts = [];
      for (let i = 0; i < 150; i++) {
        const noisyMnts = mnts.map(m => ({
          ...m, b: Number(m.b) + (Math.random() * 2 - 1) * errorDeg
        }));
        pts.push(estimateLocation(noisyMnts));
      }
      return pts;
    }

    let gMnts = [], gPts = [], gCenter = [0, 0], gRefLat = 0, gRefLon = 0;
    let gZoom = 1.0, gPanX = 0, gPanY = 0;

    function runCalculation() {
      const valid = points.filter(p => p.lat && p.lon && !isNaN(p.lat) && !isNaN(p.lon));
      if (valid.length < 2) { alert("è«‹è‡³å°‘è¼¸å…¥ 2 å€‹å·²çŸ¥é»çš„åº§æ¨™"); return; }
      document.getElementById('result-overlay').style.display = 'flex';

      gRefLat = valid.reduce((s, p) => s + Number(p.lat), 0) / valid.length;
      gRefLon = valid.reduce((s, p) => s + Number(p.lon), 0) / valid.length;
      gMnts = valid.map(p => {
        const [xx, yy] = ll2enu(p.lat, p.lon, gRefLat, gRefLon);
        return { x: xx, y: yy, b: Number(p.b), name: p.name };
      });

      const errVal = parseFloat(document.getElementById('err-val').value) || 1.0;
      gPts = simulateCloud(gMnts, errVal);

      let sx = 0, sy = 0; gPts.forEach(p => { sx += p[0]; sy += p[1] });
      gCenter = [sx / gPts.length, sy / gPts.length];

      resetView();
      const ll = enu2ll(gCenter[0], gCenter[1], gRefLat, gRefLon);
      document.getElementById('res-readout').innerHTML =
        `æˆ‘çš„æ¨ç®—ä½ç½®<br><span class="coord-big">${ll[0].toFixed(5)}, ${ll[1].toFixed(5)}</span>`;
    }

    function draw() {
      cv.width = window.innerWidth; cv.height = window.innerHeight;
      ctx.clearRect(0, 0, cv.width, cv.height);
      if (!gMnts.length) return;

      const cx = cv.width / 2; const cy = cv.height / 2;
      let all = [...gPts, ...gMnts.map(m => [m.x, m.y])];
      let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
      all.forEach(p => {
        if (p[0] < minX) minX = p[0]; if (p[0] > maxX) maxX = p[0];
        if (p[1] < minY) minY = p[1]; if (p[1] > maxY) maxY = p[1];
      });
      const w = Math.max(maxX - minX, 50); const h = Math.max(maxY - minY, 50);
      const baseScale = Math.min(cv.width / w, cv.height / h) * 0.6;
      const scale = baseScale * gZoom;
      const map = (x, y) => [cx + gPanX + (x - gCenter[0]) * scale, cy + gPanY - (y - gCenter[1]) * scale];

      ctx.fillStyle = "rgba(0,255,255,0.4)";
      gPts.forEach(p => { const [px, py] = map(p[0], p[1]); ctx.fillRect(px, py, 2, 2); });

      const errRad = rad(parseFloat(document.getElementById('err-val').value) || 1);
      gMnts.forEach((m, i) => {
        const [mx, my] = map(m.x, m.y);
        const angle = rad(m.b + 180 - 90);
        const L = Math.max(cv.width, cv.height) * 1.5;

        ctx.beginPath(); ctx.moveTo(mx, my); ctx.arc(mx, my, L, angle - errRad, angle + errRad);
        ctx.fillStyle = `hsla(${i * 50}, 80%, 60%, 0.1)`; ctx.fill();

        ctx.beginPath(); ctx.moveTo(mx, my); ctx.lineTo(mx + Math.cos(angle) * L, my + Math.sin(angle) * L);
        ctx.strokeStyle = `hsla(${i * 50}, 80%, 60%, 0.6)`; ctx.setLineDash([4, 4]); ctx.stroke(); ctx.setLineDash([]);

        ctx.beginPath(); ctx.arc(mx, my, 6, 0, Math.PI * 2); ctx.fillStyle = `hsl(${i * 50}, 80%, 60%)`; ctx.fill();
        ctx.fillStyle = "#fff"; ctx.font = "bold 14px monospace"; ctx.fillText(m.name || (i + 1), mx + 10, my + 4);
      });

      const [ux, uy] = map(gCenter[0], gCenter[1]);
      ctx.strokeStyle = "#0f0"; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.arc(ux, uy, 12, 0, Math.PI * 2); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(ux - 20, uy); ctx.lineTo(ux + 20, uy); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(ux, uy - 20); ctx.lineTo(ux, uy + 20); ctx.stroke();
      ctx.fillStyle = "#0f0"; ctx.fillText("YOU", ux + 15, uy - 15);
    }

    function resetView() { gZoom = 1.0; gPanX = 0; gPanY = 0; draw(); }
    function adjustZoom(f) { gZoom *= f; draw(); }
    function closeResult() { document.getElementById('result-overlay').style.display = 'none'; }

    let isDrag = false, startX = 0, startY = 0, lastX = 0, lastY = 0;
    const overlay = document.getElementById('result-overlay');
    overlay.addEventListener('mousedown', e => { isDrag = true; startX = e.clientX; startY = e.clientY; lastX = gPanX; lastY = gPanY; });
    overlay.addEventListener('touchstart', e => { isDrag = true; startX = e.touches[0].clientX; startY = e.touches[0].clientY; lastX = gPanX; lastY = gPanY; }, { passive: false });
    window.addEventListener('mousemove', e => { if (!isDrag) return; gPanX = lastX + (e.clientX - startX); gPanY = lastY + (e.clientY - startY); draw(); });
    window.addEventListener('touchmove', e => { if (!isDrag) return; e.preventDefault(); gPanX = lastX + (e.touches[0].clientX - startX); gPanY = lastY + (e.touches[0].clientY - startY); draw(); }, { passive: false });
    window.addEventListener('mouseup', () => isDrag = false);
    window.addEventListener('touchend', () => isDrag = false);
    window.onresize = draw;
  </script>
</body>

</html>
