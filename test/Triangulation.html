<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ‰‹æ©Ÿç¾…ç›¤ä¸‰è§’å®šä½ v3.0</title>
<style>
  body { margin: 0; background: #000; color: #eee; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
  
  /* --- ç¾…ç›¤å€ --- */
  #compass-container {
    flex: 1; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden;
    background: radial-gradient(circle at center, #222 0%, #000 90%);
  }

  /* ç„æº–å™¨ */
  #aiming-sight {
    position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
    z-index: 50; display: flex; flex-direction: column; align-items: center; pointer-events: none;
    filter: drop-shadow(0 0 5px cyan);
  }
  #aim-arrowhead { width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 15px solid cyan; }
  #aim-line { width: 2px; height: 40px; background: cyan; }
  
  /* è½‰ç›¤ (ç§»é™¤ transition ä»¥ä¾¿ JS ç²¾ç¢ºæ§åˆ¶) */
  #dial {
    width: 280px; height: 280px; 
    border: 4px solid #444; border-radius: 50%; position: relative; 
    box-shadow: 0 0 60px rgba(0,0,0,1), inset 0 0 30px rgba(0,0,0,0.9);
    background: #111;
    margin-top: 20px;
    will-change: transform; /* ç¡¬é«”åŠ é€Ÿå„ªåŒ– */
  }
  
  /* åˆ»åº¦èˆ‡æ–‡å­— */
  .mark { position: absolute; left: 50%; top: 0; width: 2px; height: 10px; background: #555; transform-origin: 50% 140px; }
  .mark.major { height: 15px; width: 3px; background: #ddd; }
  
  .label { 
    position: absolute; left: 50%; top: 22px; 
    transform-origin: 50% 118px; 
    font-weight: bold; font-size: 16px; width: 40px; text-align: center; margin-left: -20px; color: #999; 
    line-height: 1;
  }
  .north-zero { color: #f44; font-size: 22px; } /* 0åº¦ç‰¹åˆ¥è‰² */
  
  /* ç¾…ç›¤ä¸Šçš„è®€æ•¸ç´…ç·š */
  #pointer-arrow {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -160px);
    width: 0; height: 0;
    border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 15px solid #f33; 
    z-index: 20;
  }

  /* æ•¸å€¼é¡¯ç¤º */
  #readout {
    position: absolute; bottom: 10px; left: 0; right: 0; text-align: center;
    font-size: 42px; font-weight: bold; color: cyan; text-shadow: 0 0 10px rgba(0,255,255,0.4);
    font-family: monospace; letter-spacing: -2px;
  }
  
  /* --- æ“ä½œå€ --- */
  #controls { 
    padding: 10px; background: #151515; border-top: 1px solid #333; 
    max-height: 45vh; overflow-y: auto; z-index: 60; 
  }
  .btn-row { display: flex; gap: 8px; margin-bottom: 8px; }
  button { 
    flex: 1; padding: 12px; font-size: 16px; border: none; border-radius: 6px; 
    background: #333; color: #ccc; font-weight: bold; border: 1px solid #444; 
  }
  button:active { background: #555; }
  button.active { background: #0062cc; border-color: #005cbf; color: white; }
  button.calc { background: #1e7e34; border-color: #1c7430; color: white; }
  
  /* è¨­å®šåˆ— */
  .setting-row { display: flex; align-items: center; justify-content: space-between; background: #222; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #333; }
  .err-input { width: 60px; background: #000; color: #fa0; border: 1px solid #555; padding: 4px; text-align: center; font-size: 16px; font-weight: bold; border-radius: 4px; }

  /* åˆ—è¡¨æ¨£å¼ */
  .record { display: flex; align-items: center; gap: 5px; margin-bottom: 6px; background: #252525; padding: 5px; border-radius: 4px; border: 1px solid #333; }
  .inputs-group { flex: 1; display: flex; flex-direction: column; gap: 4px; }
  .inputs-row { display: flex; gap: 4px; }
  input { background: #111; border: 1px solid #444; color: #fff; padding: 6px; border-radius: 3px; font-size: 14px; }
  input:focus { border-color: cyan; outline: none; }
  input.deg-input { width: 70px; text-align: center; font-weight: bold; color: cyan; font-family: monospace; font-size: 16px; border: 1px solid #333; background: #000; }
  .del { width: 30px; flex: none; align-self: stretch; background: #a33; color: white; border: none; border-radius: 3px; font-weight: bold; display: flex; align-items: center; justify-content: center; }

  /* --- çµæœåœ°åœ–åœ–å±¤ --- */
  #result-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100;
    display: none; flex-direction: column;
    /* é€™è£¡å¾ˆé—œéµï¼Œé˜²æ­¢ç§»å‹•åœ°åœ–æ™‚æ•´å€‹ç¶²é è¢«ä¸‹æ‹‰ */
    touch-action: none; 
  }
  #cv { cursor: grab; }
  #cv:active { cursor: grabbing; }

  #map-ui {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
    display: flex; flex-direction: column; justify-content: space-between; padding: 10px; box-sizing: border-box;
  }
  .map-ctrl {
    pointer-events: auto; background: rgba(30,30,30,0.8); color: white; border: 1px solid #555;
    width: 44px; height: 44px; font-size: 22px; font-weight: bold; border-radius: 8px; margin: 5px;
    backdrop-filter: blur(4px); box-shadow: 0 4px 6px rgba(0,0,0,0.5);
  }
  #close-res { 
    pointer-events: auto; position: absolute; top: 15px; left: 15px; 
    background: #c33; color: white; padding: 8px 20px; border-radius: 20px; border: none; font-weight: bold; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  }
  #zoom-controls {
    position: absolute; top: 70px; right: 10px; display: flex; flex-direction: column;
  }
  #res-text {
    pointer-events: auto; margin-bottom: 20px; background: rgba(0,20,0,0.9); padding: 12px; border-radius: 8px;
    color: lime; text-align: center; font-family: monospace; border: 1px solid #0f0; font-size: 15px;
    box-shadow: 0 0 15px rgba(0,0,0,0.8);
  }
</style>
</head>
<body>

<div id="compass-container">
  <div id="aiming-sight"><div id="aim-arrowhead"></div><div id="aim-line"></div></div>
  <div id="pointer-arrow"></div>
  <div id="dial"><div style="position:absolute;top:50%;left:50%;width:4px;height:4px;background:#333;border-radius:50%;transform:translate(-50%,-50%)"></div></div>
  <div id="readout">Wait...</div>
</div>

<div id="controls">
  <div class="btn-row">
    <button onclick="reqPerm()" id="permBtn">é–‹å•Ÿç¾…ç›¤ (iOS)</button>
    <button onclick="lockCurrent()" class="active">ğŸ“ é–å®šç›®æ¨™</button>
  </div>
  
  <div id="list"></div>

  <div class="setting-row">
    <span style="color:#aaa; font-size:14px;">å®šä½å®¹è¨±èª¤å·® (Â±åº¦)</span>
    <input type="number" id="err-val" class="err-input" value="2.0" step="0.5">
  </div>

  <div class="btn-row">
    <button onclick="runCalculation()" class="calc">ğŸš€ è¨ˆç®—æˆ‘çš„ä½ç½®</button>
  </div>
</div>

<div id="result-overlay">
  <canvas id="cv"></canvas>
  <div id="map-ui">
    <button id="close-res" onclick="closeResult()">âœ• é—œé–‰</button>
    <div id="zoom-controls">
      <button class="map-ctrl" onclick="adjustZoom(1.2)">+</button>
      <button class="map-ctrl" onclick="resetView()">âŸ²</button>
      <button class="map-ctrl" onclick="adjustZoom(0.8)">-</button>
    </div>
    <div style="flex:1"></div>
    <div id="res-text"></div>
  </div>
</div>

<script>
// --- 1. ç¾…ç›¤ç¹ªè£½èˆ‡å¹³æ»‘é‚è¼¯ ---
const dial = document.getElementById('dial');

// ç¹ªè£½åˆ»åº¦
for(let i=0; i<360; i+=2) { 
  const isMajor = (i % 10 === 0);
  const isLabel = (i % 30 === 0);
  
  if(isMajor || i%2===0) {
    const mk = document.createElement('div');
    mk.className = isMajor ? 'mark major' : 'mark';
    mk.style.transform = `translateX(-50%) rotate(${i}deg)`;
    if(!isMajor) { mk.style.height='6px'; mk.style.opacity='0.4'; }
    dial.appendChild(mk);
  }

  if(isLabel) {
    const lb = document.createElement('div');
    lb.className = i===0 ? 'label north-zero' : 'label';
    let txt = i.toString(); // çµ±ä¸€æ”¹æˆæ•¸å­—ï¼Œé€£0åº¦ä¹Ÿæ˜¯é¡¯ç¤º0
    
    // æ–‡å­—è‡ªè½‰ä¿®æ­£ï¼Œä¿æŒç›´ç«‹
    lb.innerHTML = `<div style="transform: rotate(${-i}deg)">${txt}</div>`;
    lb.style.transform = `translateX(-50%) rotate(${i}deg)`;
    dial.appendChild(lb);
  }
}

// è®Šæ•¸ï¼šå¹³æ»‘å‹•ç•«æ§åˆ¶
let currentRawHeading = 0; // å‚³æ„Ÿå™¨åŸå§‹å€¼ (0-360)
let smoothedRotation = 0;  // ç”¨æ–¼ CSS çš„ç´¯ç©æ—‹è½‰å€¼ (å¯è¶…é360æˆ–è² æ•¸)

function handleOrientation(e) {
  let compass = e.webkitCompassHeading || (e.alpha !== null ? (360 - e.alpha) : 0);
  currentRawHeading = compass; // åªè² è²¬æ›´æ–°ç›®æ¨™å€¼ï¼Œå‹•ç•«ç”± loop è™•ç†
}

// å‹•ç•«å¾ªç’° (è§£æ±ºæŠ–å‹•èˆ‡ 359->0 å•é¡Œ)
function animationLoop() {
  requestAnimationFrame(animationLoop);

  // 1. å–å¾—ç›®æ¨™è§’åº¦ (0-360)
  const target = currentRawHeading;

  // 2. è¨ˆç®—ç›®å‰çš„ã€Œè¦–è¦ºè§’åº¦ã€åœ¨ 0-360 çš„é¤˜æ•¸ä½ç½®
  // é€™æ¨£æˆ‘å€‘å¯ä»¥ç®—å‡ºå®ƒè·Ÿç›®æ¨™å·®å¤šé 
  let currentMod = smoothedRotation % 360;
  if (currentMod < 0) currentMod += 360; // è™•ç†è² æ•¸é¤˜æ•¸

  // 3. è¨ˆç®—æœ€çŸ­è·¯å¾‘èª¤å·® (Delta)
  let delta = target - currentMod;
  
  // ä¿®æ­£è·¨è¶Š 0/360 çš„é‚Šç•Œå•é¡Œ
  // å¦‚æœèª¤å·®å¤§æ–¼ 180ï¼Œä»£è¡¨èµ°å¦ä¸€é‚Šæ›´è¿‘
  if (delta > 180) delta -= 360;
  if (delta < -180) delta += 360;

  // 4. å¹³æ»‘ç§»å‹• (Lerp): æ¯æ¬¡åªç§»å‹•å·®è·çš„ 15%
  // æ•¸å€¼è¶Šå¤§è¶Šå¿«ä½†è¶ŠæŠ–ï¼Œè¶Šå°è¶Šæ»‘ä½†æœ‰å»¶é²ã€‚0.15 æ˜¯å¾ˆå¥½çš„å¹³è¡¡é»
  smoothedRotation += delta * 0.15;

  // 5. æ›´æ–° DOM
  // åå‘æ—‹è½‰ (-smoothedRotation) å› ç‚ºé€™æ˜¯èƒŒæ™¯ç›¤é¢
  dial.style.transform = `rotate(${-smoothedRotation}deg)`;
  
  // æ•¸å€¼é¡¯ç¤ºï¼šç›´æ¥é¡¯ç¤º Raw Data ä»¥æ±‚æœ€å¿«åæ‡‰ï¼Œæˆ–é¡¯ç¤º smoothedRotation % 360
  // ç‚ºäº†è®“æ‚¨è¦ºå¾—ã€Œåˆ»åº¦æœ‰åœ¨å‹•æ•¸å€¼æ‰è®Šã€ï¼Œé€™è£¡é¡¯ç¤ºåŸå§‹å€¼å…¶å¯¦æ¯”è¼ƒå¥½
  // åŠ ä¸Š toFixed(2) æ»¿è¶³ç²¾ç¢ºåº¦éœ€æ±‚
  document.getElementById('readout').innerText = `${currentRawHeading.toFixed(2)}Â°`;
}
// å•Ÿå‹•å‹•ç•«å¾ªç’°
animationLoop();


function reqPerm() {
  if (typeof DeviceOrientationEvent.requestPermission === 'function') {
    DeviceOrientationEvent.requestPermission().then(r => {
      if (r==='granted') { window.addEventListener('deviceorientation', handleOrientation, true); document.getElementById('permBtn').style.display='none'; }
      else alert('æ¬Šé™è¢«æ‹’çµ•');
    }).catch(console.error);
  } else {
    window.addEventListener('deviceorientation', handleOrientation, true); document.getElementById('permBtn').style.display='none';
  }
}

// --- 2. åˆ—è¡¨èˆ‡é–å®šé‚è¼¯ ---
const list = document.getElementById('list');
let points = [];

function lockCurrent() {
  if(points.length >= 3) { alert("æœ€å¤šä¸‰å€‹é»"); return; }
  const id = Date.now();
  points.push({ id, b: currentRawHeading.toFixed(2), lat: '', lon: '', name: '' });
  renderList();
  if(navigator.vibrate) navigator.vibrate(50);
  setTimeout(() => { 
    const inputs = document.querySelectorAll(`input[data-id="${id}"]`);
    if(inputs[0]) inputs[0].focus();
  }, 100);
}

function updatePoint(id, field, val) {
  const p = points.find(x=>x.id === id);
  if(p) p[field] = val;
}

function removePoint(id) {
  points = points.filter(x=>x.id !== id);
  renderList();
}

function renderList() {
  list.innerHTML = '';
  [...points].reverse().forEach((p) => {
    const el = document.createElement('div');
    el.className = 'record';
    el.innerHTML = `
      <input class="deg-input" type="number" step="0.01" value="${p.b}" 
             onchange="updatePoint(${p.id}, 'b', this.value)">
      <div class="inputs-group">
        <input data-id="${p.id}" placeholder="åç¨±" value="${p.name}" 
               oninput="updatePoint(${p.id}, 'name', this.value)" style="font-weight:bold;">
        <div class="inputs-row">
          <input placeholder="ç·¯åº¦" type="number" step="0.0001" value="${p.lat}" 
                 oninput="updatePoint(${p.id}, 'lat', this.value)" style="flex:1">
          <input placeholder="ç¶“åº¦" type="number" step="0.0001" value="${p.lon}" 
                 oninput="updatePoint(${p.id}, 'lon', this.value)" style="flex:1">
        </div>
      </div>
      <button class="del" onclick="removePoint(${p.id})">âœ•</button>
    `;
    list.appendChild(el);
  });
}

// --- 3. å®šä½æ¼”ç®—æ³•èˆ‡åœ°åœ–ç¹ªè£½ ---
const cv = document.getElementById("cv"), ctx = cv.getContext("2d");
const R = 6371000, rad = d => d * Math.PI / 180;
let refLat = 0, refLon = 0;

function ll2enu(lat,lon){
  const dLat=rad(lat-refLat),dLon=rad(lon-refLon);
  return [R*dLon*Math.cos(rad(refLat)), R*dLat];
}
function enu2ll(x,y){
  return [
    refLat + y/R*180/Math.PI,
    refLon + x/(R*Math.cos(rad(refLat)))*180/Math.PI
  ];
}

function estimate(mnts){
  let x=0,y=0; mnts.forEach(m=>{x+=m.x;y+=m.y}); x/=mnts.length; y/=mnts.length;
  for(let i=0;i<50;i++){ 
    let gx=0,gy=0; 
    mnts.forEach(m=>{
      const back=rad(Number(m.b)+180);
      const vx=Math.sin(back),vy=Math.cos(back);
      const dx=x-m.x,dy=y-m.y;
      const p=dx*vx+dy*vy;
      gx+=dx-p*vx; gy+=dy-p*vy;
    });
    x-=gx*0.05; y-=gy*0.05; 
  }
  return [x,y];
}

function simulate(mnts,err){
  let pts=[]; 
  for(let i=0;i<200;i++){
    const noisy = mnts.map(m=>({...m, b:Number(m.b) + (Math.random()*2-1)*err}));
    pts.push(estimate(noisy));
  }
  return pts;
}

// --- åœ°åœ–äº’å‹•æ§åˆ¶è®Šæ•¸ ---
let globalMnts = [], globalPts = [], globalCenter = [0,0];
let userZoom = 1.0;
let panX = 0, panY = 0; // æ‹–æ›³åç§»é‡

function draw(){
  cv.width = window.innerWidth; 
  cv.height = window.innerHeight;
  ctx.clearRect(0,0,cv.width,cv.height);

  if(!globalMnts.length) return;

  // è‡ªå‹•è¨ˆç®—åˆé©æ¯”ä¾‹
  let allPoints = [globalCenter, ...globalMnts.map(m=>[m.x,m.y])];
  let xs = allPoints.map(p=>p[0]), ys = allPoints.map(p=>p[1]);
  let w = Math.max(Math.max(...xs)-Math.min(...xs), 100);
  let h = Math.max(Math.max(...ys)-Math.min(...ys), 100);
  const baseScale = Math.min(cv.width/(w*1.4), cv.height/(h*1.4));
  const finalScale = baseScale * userZoom;

  const cx = cv.width / 2;
  const cy = cv.height / 2;
  
  // åº§æ¨™æ˜ å°„ï¼šåŠ ä¸Š panX, panY åç§»
  const map = (p) => [
    cx + panX + (p[0] - globalCenter[0]) * finalScale,
    cy + panY - (p[1] - globalCenter[1]) * finalScale
  ];

  // 1. ç²’å­é›²
  ctx.fillStyle="rgba(0,255,255,0.4)"; 
  globalPts.forEach(p=>{ 
    const q=map(p); 
    if(q[0]>0 && q[0]<cv.width && q[1]>0 && q[1]<cv.height) ctx.fillRect(q[0],q[1],2,2); 
  });

  // 2. å±±é ­èˆ‡å°„ç·š
  globalMnts.forEach((m,i)=>{
    const p=map([m.x,m.y]);
    
    // è§’åº¦ä¿®æ­£
    const b = rad(Number(m.b) + 180 - 90); 
    const L = Math.max(cv.width,cv.height) * 2;
    
    // è®€å–ä½¿ç”¨è€…è¨­å®šçš„èª¤å·®ç¯„åœä¾†ç•«æ‰‡å½¢
    const userErrDeg = parseFloat(document.getElementById('err-val').value) || 2;
    const err = rad(userErrDeg);

    ctx.fillStyle=`hsla(${i*60},80%,50%,0.15)`; 
    ctx.beginPath(); ctx.moveTo(p[0],p[1]); ctx.arc(p[0],p[1],L,b-err,b+err); ctx.fill();
    
    ctx.strokeStyle=`hsla(${i*60},80%,50%,0.8)`; ctx.lineWidth=1; ctx.setLineDash([5,5]);
    ctx.beginPath(); ctx.moveTo(p[0],p[1]); ctx.lineTo(p[0]+Math.cos(b)*L, p[1]+Math.sin(b)*L); ctx.stroke();
    ctx.setLineDash([]);

    ctx.fillStyle=`hsl(${i*60},80%,50%)`; ctx.beginPath(); ctx.arc(p[0],p[1],6,0,Math.PI*2); ctx.fill();
    ctx.fillStyle="#fff"; ctx.font="bold 14px sans-serif"; 
    ctx.shadowColor="black"; ctx.shadowBlur=4;
    ctx.fillText(m.name||('P'+(i+1)), p[0]+10, p[1]+5);
    ctx.shadowBlur=0;
  });

  // 3. ä½¿ç”¨è€…ä¸­å¿ƒ
  const c = map(globalCenter);
  ctx.strokeStyle="#0f0"; ctx.lineWidth=2;
  ctx.beginPath(); ctx.arc(c[0],c[1],12,0,Math.PI*2); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(c[0]-20,c[1]); ctx.lineTo(c[0]+20,c[1]); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(c[0],c[1]-20); ctx.lineTo(c[0],c[1]+20); ctx.stroke();
  
  ctx.fillStyle="#0f0"; ctx.font="16px monospace"; 
  ctx.fillText("YOU", c[0]+15, c[1]-15);
}

// --- äº’å‹•æ§åˆ¶é‚è¼¯ ---
function adjustZoom(factor) { userZoom *= factor; draw(); }
function resetView() { userZoom = 1.0; panX = 0; panY = 0; draw(); }

function runCalculation(){
  const valid = points.filter(p => p.lat && p.lon);
  if(valid.length < 2){ alert("è«‹è‡³å°‘é–å®š 2 å€‹åº§æ¨™é»"); return; }
  
  document.getElementById('result-overlay').style.display='flex';
  
  globalMnts = valid.map(p => ({ lat: +p.lat, lon: +p.lon, b: +p.b, name: p.name }));
  refLat = globalMnts.reduce((s,m)=>s+m.lat,0)/globalMnts.length;
  refLon = globalMnts.reduce((s,m)=>s+m.lon,0)/globalMnts.length;
  globalMnts.forEach(m => { [m.x,m.y] = ll2enu(m.lat, m.lon); });

  // å‚³å…¥ä½¿ç”¨è€…è‡ªè¨‚èª¤å·®
  const errVal = parseFloat(document.getElementById('err-val').value) || 2;
  globalPts = simulate(globalMnts, errVal);
  
  globalCenter = globalPts.reduce((s,p)=>[s[0]+p[0],s[1]+p[1]],[0,0]).map(v=>v/globalPts.length);
  
  resetView();
  
  const finalLL = enu2ll(globalCenter[0], globalCenter[1]);
  document.getElementById('res-text').innerHTML = 
    `æˆ‘çš„ä½ç½®<br><span style="color:white;font-size:1.4em;user-select:all">${finalLL[0].toFixed(5)}, ${finalLL[1].toFixed(5)}</span>`;
}

function closeResult(){
  document.getElementById('result-overlay').style.display='none';
}

// --- æ‹–æ›³äº‹ä»¶è™•ç† ---
let isDragging = false;
let startX, startY;
let lastPanX, lastPanY;

cv.addEventListener('mousedown', startDrag);
cv.addEventListener('touchstart', startDrag, {passive: false});

window.addEventListener('mousemove', doDrag);
window.addEventListener('touchmove', doDrag, {passive: false});

window.addEventListener('mouseup', stopDrag);
window.addEventListener('touchend', stopDrag);

function startDrag(e) {
  isDragging = true;
  const evt = e.touches ? e.touches[0] : e;
  startX = evt.clientX;
  startY = evt.clientY;
  lastPanX = panX;
  lastPanY = panY;
}

function doDrag(e) {
  if(!isDragging) return;
  const evt = e.touches ? e.touches[0] : e;
  const dx = evt.clientX - startX;
  const dy = evt.clientY - startY;
  
  panX = lastPanX + dx;
  panY = lastPanY + dy;
  draw();
  
  if(e.cancelable) e.preventDefault(); // é˜²æ­¢æ‰‹æ©Ÿä¸‹æ‹‰åˆ·æ–°
}

function stopDrag() {
  isDragging = false;
}

window.onresize = draw;
</script>
</body>
</html>
