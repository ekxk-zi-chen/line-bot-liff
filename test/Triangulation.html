<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ‰‹æ©Ÿç¾…ç›¤ä¸‰è§’å®šä½ v2.0</title>
<style>
  body { margin: 0; background: #000; color: #eee; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
  
  /* --- ç¾…ç›¤å€ --- */
  #compass-container {
    flex: 1; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden;
    background: radial-gradient(circle at center, #2a2a2a 0%, #000 80%);
  }

  /* ç„æº–å™¨ */
  #aiming-sight {
    position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
    z-index: 50; display: flex; flex-direction: column; align-items: center; pointer-events: none;
    filter: drop-shadow(0 0 5px cyan);
  }
  #aim-arrowhead { width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 15px solid cyan; }
  #aim-line { width: 2px; height: 40px; background: cyan; }
  
  /* è½‰ç›¤ */
  #dial {
    width: 280px; height: 280px; 
    border: 4px solid #444; border-radius: 50%; position: relative; 
    box-shadow: 0 0 50px rgba(0,0,0,1), inset 0 0 20px rgba(0,0,0,0.8);
    transition: transform 0.05s linear; /* æ›´è·Ÿæ‰‹ */
    background: #111;
    margin-top: 20px;
  }
  
  /* åˆ»åº¦èˆ‡æ–‡å­— */
  .mark { position: absolute; left: 50%; top: 0; width: 2px; height: 10px; background: #666; transform-origin: 50% 140px; }
  .mark.major { height: 15px; width: 3px; background: #eee; }
  
  .label { 
    position: absolute; left: 50%; top: 22px; 
    transform-origin: 50% 118px; /* å¾®èª¿åœ“å¿ƒè·é›¢ */
    font-weight: bold; font-size: 16px; width: 40px; text-align: center; margin-left: -20px; color: #aaa; 
    line-height: 1;
  }
  .north { color: #f44; font-size: 22px; }
  
  /* ç¾…ç›¤ä¸Šçš„è®€æ•¸ç´…ç·š */
  #pointer-arrow {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -160px);
    width: 0; height: 0;
    border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 15px solid #f33; 
    z-index: 20;
  }

  /* æ•¸å€¼é¡¯ç¤º */
  #readout {
    position: absolute; bottom: 10px; left: 0; right: 0; text-align: center;
    font-size: 40px; font-weight: bold; color: cyan; text-shadow: 0 0 10px rgba(0,255,255,0.4);
    font-family: monospace; letter-spacing: -1px;
  }
  
  /* --- æ“ä½œå€ --- */
  #controls { 
    padding: 10px; background: #181818; border-top: 1px solid #333; 
    max-height: 45vh; overflow-y: auto; z-index: 60; 
  }
  .btn-row { display: flex; gap: 8px; margin-bottom: 8px; }
  button { 
    flex: 1; padding: 12px; font-size: 16px; border: none; border-radius: 6px; 
    background: #333; color: #ddd; font-weight: bold; border: 1px solid #444; 
  }
  button:active { background: #555; }
  button.active { background: #0069d9; border-color: #0062cc; color: white; }
  button.calc { background: #218838; border-color: #1e7e34; color: white; }
  
  /* åˆ—è¡¨æ¨£å¼èª¿æ•´ */
  .record { display: flex; align-items: center; gap: 5px; margin-bottom: 6px; background: #252525; padding: 5px; border-radius: 4px; border: 1px solid #333; }
  
  /* è¼¸å…¥æ¡†ç¾¤çµ„ */
  .inputs-group { flex: 1; display: flex; flex-direction: column; gap: 4px; }
  .inputs-row { display: flex; gap: 4px; }
  
  input { background: #111; border: 1px solid #444; color: #fff; padding: 6px; border-radius: 3px; font-size: 14px; }
  input:focus { border-color: cyan; outline: none; }
  
  /* è§’åº¦è¼¸å…¥æ¡† (å¯ä¿®æ”¹) */
  input.deg-input { 
    width: 60px; text-align: center; font-weight: bold; color: cyan; font-family: monospace; font-size: 16px;
    border: 1px solid #333; background: #000;
  }
  
  /* åˆªé™¤æŒ‰éˆ• (è®Šå°) */
  .del { 
    width: 30px; flex: none; align-self: stretch; 
    background: #a33; color: white; border: none; border-radius: 3px; 
    font-weight: bold; font-size: 14px; display: flex; align-items: center; justify-content: center;
  }

  /* --- çµæœåœ°åœ–åœ–å±¤ --- */
  #result-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100;
    display: none; flex-direction: column;
  }
  #map-ui {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
    display: flex; flex-direction: column; justify-content: space-between; pading: 10px;
  }
  /* åœ°åœ–æ§åˆ¶æŒ‰éˆ• */
  .map-ctrl {
    pointer-events: auto; background: rgba(50,50,50,0.8); color: white; border: 1px solid #666;
    width: 40px; height: 40px; font-size: 20px; font-weight: bold; border-radius: 5px; margin: 10px;
    backdrop-filter: blur(4px);
  }
  #close-res { 
    pointer-events: auto; position: absolute; top: 15px; left: 15px; 
    background: #c33; color: white; padding: 8px 16px; border-radius: 20px; border: none; font-weight: bold; 
  }
  #zoom-controls {
    position: absolute; top: 60px; right: 10px; display: flex; flex-direction: column; gap: 10px;
  }
  #res-text {
    pointer-events: auto; margin: 10px; background: rgba(0,20,0,0.9); padding: 12px; border-radius: 8px;
    color: lime; text-align: center; font-family: monospace; border: 1px solid #0f0;
    font-size: 14px;
  }
</style>
</head>
<body>

<div id="compass-container">
  <div id="aiming-sight"><div id="aim-arrowhead"></div><div id="aim-line"></div></div>
  <div id="pointer-arrow"></div>
  <div id="dial"><div style="position:absolute;top:50%;left:50%;width:4px;height:4px;background:#333;border-radius:50%;transform:translate(-50%,-50%)"></div></div>
  <div id="readout">ç­‰å¾…è¨Šè™Ÿ...</div>
</div>

<div id="controls">
  <div class="btn-row">
    <button onclick="reqPerm()" id="permBtn">é–‹å•Ÿç¾…ç›¤ (iOS)</button>
    <button onclick="lockCurrent()" class="active">ğŸ“ é–å®šç›®æ¨™</button>
  </div>
  <div id="list"></div>
  <div class="btn-row" style="margin-top:10px">
    <button onclick="runCalculation()" class="calc">ğŸš€ è¨ˆç®—æˆ‘çš„ä½ç½®</button>
  </div>
</div>

<div id="result-overlay">
  <canvas id="cv"></canvas>
  
  <div id="map-ui">
    <button id="close-res" onclick="closeResult()">âœ• é—œé–‰</button>
    
    <div id="zoom-controls">
      <button class="map-ctrl" onclick="adjustZoom(1.2)">+</button>
      <button class="map-ctrl" onclick="resetView()">âŸ²</button>
      <button class="map-ctrl" onclick="adjustZoom(0.8)">-</button>
    </div>

    <div style="flex:1"></div> <div id="res-text"></div>
  </div>
</div>

<script>
// --- 1. ç¾…ç›¤ç¹ªè£½èˆ‡é‚è¼¯ ---
const dial = document.getElementById('dial');

// ç¹ªè£½åˆ»åº¦
for(let i=0; i<360; i+=2) { // åˆ»åº¦åŠ å¯†
  const isMajor = (i % 10 === 0);
  const isLabel = (i % 30 === 0);
  
  // åˆ»åº¦ç·š
  if(isMajor || i%2===0) {
    const mk = document.createElement('div');
    mk.className = isMajor ? 'mark major' : 'mark';
    mk.style.transform = `translateX(-50%) rotate(${i}deg)`;
    if(!isMajor) { mk.style.height='6px'; mk.style.opacity='0.5'; }
    dial.appendChild(mk);
  }

  // æ–‡å­—æ¨™ç±¤
  if(isLabel) {
    const lb = document.createElement('div');
    lb.className = i===0 ? 'label north' : 'label';
    let txt = i.toString();
    if(i===0) txt='N'; else if(i===90) txt='E'; else if(i===180) txt='S'; else if(i===270) txt='W';
    
    // ä¿®æ­£Nçš„å°é½Šï¼šæ–‡å­—æœ¬èº«åå‘æ—‹è½‰ä»¥ä¿æŒç›´ç«‹
    lb.innerHTML = `<div style="transform: rotate(${-i}deg)">${txt}</div>`;
    lb.style.transform = `translateX(-50%) rotate(${i}deg)`;
    dial.appendChild(lb);
  }
}

let currentHeading = 0;
function handleOrientation(e) {
  // å„ªå…ˆä½¿ç”¨ webkitCompassHeading (iOS)ï¼Œå¦å‰‡ç”¨ alpha (Android)
  let compass = e.webkitCompassHeading || (e.alpha !== null ? (360 - e.alpha) : 0);
  currentHeading = compass;
  
  requestAnimationFrame(()=>{
    // åœ“ç›¤åå‘è½‰ï¼Œè®“ä¸Šæ–¹æŒ‡é‡æ°¸é æŒ‡å‘çœŸå¯¦æ–¹ä½
    dial.style.transform = `rotate(${-currentHeading}deg)`;
    // é¡¯ç¤ºåˆ°å°æ•¸é»å¾Œå…©ä½
    document.getElementById('readout').innerText = `${currentHeading.toFixed(2)}Â°`;
  });
}

function reqPerm() {
  if (typeof DeviceOrientationEvent.requestPermission === 'function') {
    DeviceOrientationEvent.requestPermission().then(r => {
      if (r==='granted') { window.addEventListener('deviceorientation', handleOrientation, true); document.getElementById('permBtn').style.display='none'; }
      else alert('æ¬Šé™è¢«æ‹’çµ•');
    }).catch(console.error);
  } else {
    window.addEventListener('deviceorientation', handleOrientation, true); document.getElementById('permBtn').style.display='none';
  }
}

// --- 2. åˆ—è¡¨èˆ‡é–å®šé‚è¼¯ ---
const list = document.getElementById('list');
let points = [];

function lockCurrent() {
  if(points.length >= 3) { alert("æœ€å¤šä¸‰å€‹é»"); return; }
  const id = Date.now();
  // é è¨­å¡«å…¥ç›®å‰è§’åº¦ï¼Œä¿ç•™å…©ä½å°æ•¸
  points.push({ id, b: currentHeading.toFixed(2), lat: '', lon: '', name: '' });
  renderList();
  if(navigator.vibrate) navigator.vibrate(50);
  
  // è‡ªå‹•èšç„¦åç¨±æ¬„ä½
  setTimeout(() => { 
    const inputs = document.querySelectorAll(`input[data-id="${id}"]`);
    if(inputs[0]) inputs[0].focus();
  }, 100);
}

function updatePoint(id, field, val) {
  const p = points.find(x=>x.id === id);
  if(p) p[field] = val; // é€™è£¡ b å­˜å…¥çš„æ˜¯å­—ä¸²ï¼Œè¨ˆç®—æ™‚æœƒè½‰æ•¸å­—
}

function removePoint(id) {
  points = points.filter(x=>x.id !== id);
  renderList();
}

function renderList() {
  list.innerHTML = '';
  // åè½‰é¡¯ç¤ºï¼Œæœ€æ–°çš„åœ¨ä¸Šé¢
  [...points].reverse().forEach((p) => {
    const el = document.createElement('div');
    el.className = 'record';
    el.innerHTML = `
      <input class="deg-input" type="number" step="0.01" value="${p.b}" 
             onchange="updatePoint(${p.id}, 'b', this.value)">
      
      <div class="inputs-group">
        <input data-id="${p.id}" placeholder="åç¨± (ä¾‹: 101å¤§æ¨“)" value="${p.name}" 
               oninput="updatePoint(${p.id}, 'name', this.value)" style="font-weight:bold;">
        <div class="inputs-row">
          <input placeholder="ç·¯åº¦ Lat" type="number" step="0.0001" value="${p.lat}" 
                 oninput="updatePoint(${p.id}, 'lat', this.value)" style="flex:1">
          <input placeholder="ç¶“åº¦ Lon" type="number" step="0.0001" value="${p.lon}" 
                 oninput="updatePoint(${p.id}, 'lon', this.value)" style="flex:1">
        </div>
      </div>
      
      <button class="del" onclick="removePoint(${p.id})">âœ•</button>
    `;
    list.appendChild(el);
  });
}

// --- 3. å®šä½æ¼”ç®—æ³•èˆ‡åœ°åœ–ç¹ªè£½ ---
const cv = document.getElementById("cv"), ctx = cv.getContext("2d");
const R = 6371000, rad = d => d * Math.PI / 180;
let refLat = 0, refLon = 0;

// å·²ç§»é™¤ autoDeclination (ç£åè§’) å‡½å¼ï¼Œå› ç‚ºä½¿ç”¨è€…è¡¨ç¤ºä¸éœ€è¦

function ll2enu(lat,lon){
  const dLat=rad(lat-refLat),dLon=rad(lon-refLon);
  return [R*dLon*Math.cos(rad(refLat)), R*dLat];
}
function enu2ll(x,y){
  return [
    refLat + y/R*180/Math.PI,
    refLon + x/(R*Math.cos(rad(refLat)))*180/Math.PI
  ];
}

function estimate(mnts){
  let x=0,y=0; mnts.forEach(m=>{x+=m.x;y+=m.y}); x/=mnts.length; y/=mnts.length;
  for(let i=0;i<50;i++){ 
    let gx=0,gy=0; 
    mnts.forEach(m=>{
      const back=rad(Number(m.b)+180); // ç¢ºä¿ m.b æ˜¯æ•¸å­—
      const vx=Math.sin(back),vy=Math.cos(back);
      const dx=x-m.x,dy=y-m.y;
      const p=dx*vx+dy*vy;
      gx+=dx-p*vx; gy+=dy-p*vy;
    });
    x-=gx*0.05; y-=gy*0.05; 
  }
  return [x,y];
}

function simulate(mnts,err){
  let pts=[]; 
  for(let i=0;i<200;i++){
    // æ¨¡æ“¬èª¤å·®é‹ç®—
    const noisy = mnts.map(m=>({...m, b:Number(m.b) + (Math.random()*2-1)*err}));
    pts.push(estimate(noisy));
  }
  return pts;
}

// --- åœ°åœ–æ§åˆ¶è®Šæ•¸ ---
let globalMnts = [], globalPts = [], globalCenter = [0,0];
let viewScale = 1.0; // åŸºç¤æ¯”ä¾‹å°º
let userZoom = 1.0;  // ç”¨æˆ¶ç¸®æ”¾å€ç‡

function draw(){
  cv.width = window.innerWidth; 
  cv.height = window.innerHeight;
  ctx.clearRect(0,0,cv.width,cv.height);

  if(!globalMnts.length) return;

  // 1. è¨ˆç®—æ‰€æœ‰é»çš„ç¯„åœ (åŒ…å«å±±é ­å’Œäºº) ä»¥æ±ºå®šåŸºç¤æ¯”ä¾‹å°º
  let allPoints = [globalCenter, ...globalMnts.map(m=>[m.x,m.y])];
  let xs = allPoints.map(p=>p[0]), ys = allPoints.map(p=>p[1]);
  let minx = Math.min(...xs), maxx = Math.max(...xs);
  let miny = Math.min(...ys), maxy = Math.max(...ys);

  // ç¯„åœå¯¬é«˜
  const w = Math.max(maxx - minx, 100); // é¿å…å…©é»é‡åˆé™¤ä»¥0
  const h = Math.max(maxy - miny, 100);
  
  // è¨ˆç®—é©åˆè¢å¹•çš„åŸºç¤æ¯”ä¾‹ (ç•™é‚Šè·)
  const padding = 0.3; 
  // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¨ˆç®—(viewScaleæ²’è¢«è¨­é)ï¼Œæ‰è‡ªå‹•è¨ˆç®—viewScale
  // ä½†ç‚ºäº†æ–¹ä¾¿æ¯æ¬¡é‡æ–°å®šä½éƒ½é‡ç½®ï¼Œæˆ‘å€‘åœ¨runCalculationè£¡é‡ç½®userZoom
  const baseScale = Math.min(cv.width/(w*(1+padding)), cv.height/(h*(1+padding)));
  
  const finalScale = baseScale * userZoom;

  // --- æ ¸å¿ƒè½‰æ›å‡½å¼ï¼šå¼·åˆ¶ä»¥ globalCenter (You) ç‚ºè¢å¹•ä¸­å¿ƒ ---
  const cx = cv.width / 2;
  const cy = cv.height / 2;
  
  const map = (p) => [
    cx + (p[0] - globalCenter[0]) * finalScale,
    cy - (p[1] - globalCenter[1]) * finalScale // Yè»¸ç¿»è½‰ (åœ°åœ–åŒ—ä¸Šå—ä¸‹ï¼ŒCanvas Yå‘ä¸‹)
  ];

  // ç¹ªè£½ç²’å­é›² (ä½ç½®èª¤å·®)
  ctx.fillStyle="rgba(0,255,255,0.3)"; 
  globalPts.forEach(p=>{ 
    const q=map(p); 
    // åªç•«åœ¨è¢å¹•å…§çš„
    if(q[0]>0 && q[0]<cv.width && q[1]>0 && q[1]<cv.height)
       ctx.fillRect(q[0],q[1],2,2); 
  });

  // ç¹ªè£½å±±é ­èˆ‡è¦–ç·š
  globalMnts.forEach((m,i)=>{
    const p=map([m.x,m.y]);
    
    // å±±çš„è¦–ç·š
    const b = rad(Number(m.b) + 180 - 90); // Canvas 0åº¦ä¿®æ­£
    const L = Math.max(cv.width,cv.height) * 2; // å°„ç·šé•·åº¦

    // æ‰‡å½¢ (æ·¡)
    const err = rad(2);
    ctx.fillStyle=`hsla(${i*60},80%,50%,0.1)`; 
    ctx.beginPath(); ctx.moveTo(p[0],p[1]); ctx.arc(p[0],p[1],L,b-err,b+err); ctx.fill();
    
    // ä¸­å¿ƒç·š (è™›ç·š)
    ctx.strokeStyle=`hsla(${i*60},80%,50%,0.8)`; ctx.lineWidth=1; ctx.setLineDash([5,5]);
    ctx.beginPath(); ctx.moveTo(p[0],p[1]); ctx.lineTo(p[0]+Math.cos(b)*L, p[1]+Math.sin(b)*L); ctx.stroke();
    ctx.setLineDash([]);

    // å±±é ­é»èˆ‡æ–‡å­—
    ctx.fillStyle=`hsl(${i*60},80%,50%)`; 
    ctx.beginPath(); ctx.arc(p[0],p[1],6,0,Math.PI*2); ctx.fill();
    
    ctx.fillStyle="#fff"; ctx.font="bold 14px sans-serif"; 
    ctx.shadowColor="black"; ctx.shadowBlur=4;
    ctx.fillText(m.name||('Ref '+i), p[0]+10, p[1]+5);
    ctx.shadowBlur=0;
  });

  // ç¹ªè£½ä½¿ç”¨è€…ä¸­å¿ƒ (æ°¸é åœ¨ç•«é¢ä¸­é–“)
  const c = map(globalCenter); // ç†è«–ä¸Šé€™æ‡‰è©²ç­‰æ–¼ [cx, cy]
  
  // æº–å¿ƒæ•ˆæœ
  ctx.strokeStyle="#0f0"; ctx.lineWidth=2;
  ctx.beginPath(); ctx.arc(c[0],c[1],15,0,Math.PI*2); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(c[0]-25,c[1]); ctx.lineTo(c[0]+25,c[1]); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(c[0],c[1]-25); ctx.lineTo(c[0],c[1]+25); ctx.stroke();
  
  ctx.fillStyle="#0f0"; ctx.font="16px monospace"; 
  ctx.fillText("YOU", c[0]+18, c[1]-18);
}

// ç¸®æ”¾æ§åˆ¶
function adjustZoom(factor) {
  userZoom *= factor;
  draw();
}
function resetView() {
  userZoom = 1.0;
  draw();
}

function runCalculation(){
  const valid = points.filter(p => p.lat && p.lon);
  if(valid.length < 2){ alert("è«‹è‡³å°‘é–å®š 2 å€‹åº§æ¨™é»"); return; }
  
  document.getElementById('result-overlay').style.display='flex';
  
  // æº–å‚™æ•¸æ“š
  globalMnts = valid.map(p => ({ lat: +p.lat, lon: +p.lon, b: +p.b, name: p.name }));
  
  // è¨ˆç®—åƒè€ƒä¸­å¿ƒé» (ENUåŸé»)
  refLat = globalMnts.reduce((s,m)=>s+m.lat,0)/globalMnts.length;
  refLon = globalMnts.reduce((s,m)=>s+m.lon,0)/globalMnts.length;

  // è½‰ ENU
  globalMnts.forEach(m => { [m.x,m.y] = ll2enu(m.lat, m.lon); });

  // æ¨¡æ“¬é‹ç®—
  globalPts = simulate(globalMnts, 2); // å‡è¨­èª¤å·®2åº¦
  
  // è¨ˆç®—å¹³å‡ä¸­å¿ƒ
  globalCenter = globalPts.reduce((s,p)=>[s[0]+p[0],s[1]+p[1]],[0,0]).map(v=>v/globalPts.length);
  
  // é‡ç½®ç¸®æ”¾ä¸¦ç¹ªåœ–
  userZoom = 1.0;
  draw();
  
  // é¡¯ç¤ºçµæœæ–‡å­—
  const finalLL = enu2ll(globalCenter[0], globalCenter[1]);
  document.getElementById('res-text').innerHTML = 
    `æˆ‘çš„ä½ç½®<br><span style="color:white;font-size:1.4em;user-select:all">${finalLL[0].toFixed(5)}, ${finalLL[1].toFixed(5)}</span><br><span style="color:#aaa;font-size:0.9em">(ä¸å«ç£åè§’ä¿®æ­£)</span>`;
}

function closeResult(){
  document.getElementById('result-overlay').style.display='none';
}
// è¦–çª—å¤§å°æ”¹è®Šæ™‚é‡ç•«
window.onresize = draw;
</script>
</body>
</html>
