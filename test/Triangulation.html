<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ç²¾å¯†ç¾…ç›¤å®šä½ v4.0</title>
<style>
  /* å…¨å±€è¨­å®šï¼šç¦æ­¢é¸å–æ–‡å­—ï¼Œç´”é»‘èƒŒæ™¯ï¼Œé«˜å°æ¯” */
  body { 
    margin: 0; background: #000; color: #fff; 
    font-family: "SF Mono", "Roboto Mono", monospace; /* å¼·åˆ¶ç­‰å¯¬å­—é«”ï¼Œæ•¸å­—ä¸è·³å‹• */
    overflow: hidden; display: flex; flex-direction: column; height: 100vh; 
    user-select: none; -webkit-user-select: none;
  }
  
  /* --- ç¾…ç›¤å€ --- */
  #compass-container {
    flex: 1; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden;
    background: radial-gradient(circle at center, #1a1a1a 0%, #000 85%);
  }

  /* ä¸Šæ–¹ç„æº–å™¨ */
  #aiming-sight {
    position: absolute; top: 0; left: 50%; transform: translateX(-50%);
    z-index: 50; display: flex; flex-direction: column; align-items: center; pointer-events: none;
  }
  #aim-arrowhead { width: 0; height: 0; border-left: 12px solid transparent; border-right: 12px solid transparent; border-bottom: 20px solid #0ff; filter: drop-shadow(0 0 5px #0ff); }
  #aim-line { width: 2px; height: 40vh; background: linear-gradient(to bottom, #0ff 0%, transparent 100%); opacity: 0.5; }
  
  /* è½‰ç›¤å¤–æ¡† (ä¸å‹•) */
  #dial-ring {
    width: 290px; height: 290px;
    border-radius: 50%; border: 2px solid #333;
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    box-shadow: inset 0 0 20px #000;
    pointer-events: none;
  }

  /* è½‰å‹•çš„åˆ»åº¦ç›¤ */
  #dial {
    width: 290px; height: 290px; 
    position: relative; 
    /* é€™è£¡ä¸ç”¨ transitionï¼Œå…¨é  JS é«˜é »æ›´æ–° */
    will-change: transform; 
  }
  
  /* åˆ»åº¦ç·š */
  .mark { position: absolute; left: 50%; top: 0; width: 1px; height: 8px; background: #555; transform-origin: 50% 145px; } /* åŠå¾‘è¦ç²¾æº– */
  .mark.major { height: 12px; width: 2px; background: #aaa; }
  .mark.cardinal { height: 15px; width: 3px; background: #fff; } /* 0,90,180,270 */
  
  /* åˆ»åº¦æ–‡å­— */
  .label { 
    position: absolute; left: 50%; top: 20px; 
    transform-origin: 50% 125px; 
    font-weight: bold; font-size: 14px; width: 40px; text-align: center; margin-left: -20px; color: #888; 
  }
  .label-cardinal { font-size: 18px; color: #fff; top: 18px; }
  .label-zero { color: #f33; } /* 0åº¦ç´…è‰² */

  /* ä¸­å¤®ç´…ç·š (è®€æ•¸åŸºæº–) */
  #pointer-fixed {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -158px); /* ç²¾ç¢ºå°æº–åœ“å‘¨ */
    width: 0; height: 0;
    border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 15px solid #f22; 
    z-index: 20; filter: drop-shadow(0 2px 2px #000);
  }

  /* æ•¸å­—è®€æ•¸ (Raw Data) */
  #readout {
    position: absolute; bottom: 15px; left: 0; right: 0; text-align: center;
    font-size: 48px; font-weight: 700; color: #0ff; 
    text-shadow: 0 0 10px rgba(0,255,255,0.3);
    letter-spacing: 1px;
  }
  #readout small { font-size: 20px; color: #666; margin-left: 5px; font-weight: normal;}

  /* --- æ“ä½œå€ --- */
  #controls { 
    padding: 10px; background: #111; border-top: 1px solid #333; 
    max-height: 45vh; overflow-y: auto; z-index: 60; 
  }
  
  .row { display: flex; gap: 8px; margin-bottom: 8px; align-items: stretch;}
  
  /* æŒ‰éˆ•æ¨£å¼ */
  button { 
    flex: 1; padding: 14px; font-size: 16px; border: none; border-radius: 4px; 
    background: #222; color: #ddd; font-weight: bold; border: 1px solid #444; 
    font-family: inherit;
  }
  button:active { background: #444; transform: translateY(1px); }
  button.active { background: #0056b3; border-color: #007bff; color: #fff; }
  button.calc { background: #1c7430; border-color: #28a745; color: #fff; }
  
  /* èª¤å·®è¨­å®š */
  .err-box { display: flex; align-items: center; background: #000; padding: 0 10px; border: 1px solid #444; border-radius: 4px;}
  .err-input { width: 50px; background: transparent; color: #fa0; border: none; text-align: center; font-size: 18px; font-weight: bold; font-family: inherit; }
  
  /* é–å®šåˆ—è¡¨ */
  .record { display: flex; align-items: center; gap: 6px; margin-bottom: 6px; background: #1a1a1a; padding: 6px; border-radius: 4px; border: 1px solid #333; }
  .deg-disp { 
    width: 80px; text-align: right; color: #0ff; font-size: 18px; font-weight: bold; 
    background: #000; border: 1px solid #333; padding: 4px; border-radius: 3px;
  }
  /* è®“é€™å€‹è¼¸å…¥æ¡†çœ‹èµ·ä¾†åƒç´”æ–‡å­—é¡¯ç¤ºï¼Œä½†é»äº†å¯ä»¥æ”¹ */
  input.deg-edit { 
    width: 100%; height: 100%; background: transparent; border: none; color: inherit; 
    text-align: center; font-family: inherit; font-size: inherit; font-weight: inherit; padding: 0; margin: 0;
  }
  
  .inputs-group { flex: 1; display: flex; flex-direction: column; gap: 4px; }
  .inputs-row { display: flex; gap: 4px; }
  input.text-in { background: #080808; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 3px; font-size: 14px; font-family: inherit; }
  input.text-in:focus { border-color: #0ff; outline: none; }
  
  .del-btn { width: 36px; background: #822; color: #fff; border: none; border-radius: 3px; font-weight: bold; font-size: 18px; display: flex; align-items: center; justify-content: center; }

  /* --- åœ°åœ–å±¤ --- */
  #result-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100;
    display: none; touch-action: none; 
  }
  #map-ui {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
    display: flex; flex-direction: column; padding: 10px;
  }
  .map-btn { pointer-events: auto; background: rgba(0,0,0,0.7); border: 1px solid #666; color: #fff; margin: 5px; backdrop-filter: blur(4px); }
  #close-res { position: absolute; top: 15px; left: 15px; border-radius: 20px; padding: 8px 20px; background: #c22; border: none; font-weight: bold; box-shadow: 0 4px 10px #000; }
  #res-readout {
    pointer-events: auto; margin-top: auto; margin-bottom: 20px; align-self: center;
    background: rgba(0,20,0,0.9); padding: 15px; border-radius: 8px; border: 1px solid #0f0;
    text-align: center; color: #0f0; font-size: 14px; box-shadow: 0 0 20px rgba(0,0,0,0.8);
  }
  .coord-big { font-size: 20px; color: #fff; font-weight: bold; display: block; margin-top: 5px; user-select: text; -webkit-user-select: text;}
</style>
</head>
<body>

<div id="compass-container">
  <div id="aiming-sight"><div id="aim-arrowhead"></div><div id="aim-line"></div></div>
  <div id="pointer-fixed"></div>
  
  <div id="dial-ring"></div> <div id="dial">
     </div>
  
  <div id="readout">0.00<small>Â°</small></div>
</div>

<div id="controls">
  <div class="row">
    <button id="permBtn" onclick="reqPerm()">å•Ÿå‹•ç¾…ç›¤ (iOSé»æ­¤)</button>
    <button class="active" onclick="lockTarget()">ğŸ“ é–å®šç›®æ¨™</button>
  </div>
  
  <div id="list"></div>

  <div class="row">
    <div class="err-box">
      <span style="color:#888; font-size:12px; margin-right:5px;">èª¤å·®Â±</span>
      <input type="number" id="err-val" class="err-input" value="1.0" step="0.5">
      <span style="color:#888; font-size:12px;">Â°</span>
    </div>
    <button class="calc" onclick="runCalculation()">ğŸš€ è¨ˆç®—ä½ç½®</button>
  </div>
</div>

<div id="result-overlay">
  <canvas id="cv"></canvas>
  <div id="map-ui">
    <button id="close-res" class="map-btn" onclick="closeResult()">âœ• é—œé–‰</button>
    <div style="position:absolute; top:70px; right:10px; display:flex; flex-direction:column;">
      <button class="map-btn" style="width:44px;height:44px;font-size:24px;border-radius:8px;" onclick="adjustZoom(1.5)">+</button>
      <button class="map-btn" style="width:44px;height:44px;font-size:20px;border-radius:8px;" onclick="resetView()">âŸ²</button>
      <button class="map-btn" style="width:44px;height:44px;font-size:24px;border-radius:8px;" onclick="adjustZoom(0.66)">-</button>
    </div>
    <div id="res-readout">å°šæœªè¨ˆç®—</div>
  </div>
</div>

<script>
// --- A. ç¾…ç›¤æ ¸å¿ƒï¼šçµ•å°ç²¾æº–ç¹ªè£½ ---
const dial = document.getElementById('dial');

function createDial() {
  dial.innerHTML = '';
  // ç‚ºäº†ç²¾ç¢ºï¼Œæˆ‘å€‘åªç•«å¿…è¦çš„ç·š
  for(let i=0; i<360; i++) {
    // åªæœ‰æ¯åº¦æ‰ç•«ç·šï¼Œé¿å…éå¤šDOM
    if (i % 2 !== 0) continue; // å¶æ•¸ç•«ç·šï¼Œå¥‡æ•¸è·³é (è¦–è¦ºä¸Šå·²è¶³å¤ ï¼Œæå‡æ€§èƒ½)
    
    const isCardinal = (i % 90 === 0);
    const isMajor = (i % 10 === 0);
    
    const mk = document.createElement('div');
    mk.className = isCardinal ? 'mark cardinal' : (isMajor ? 'mark major' : 'mark');
    mk.style.transform = `translateX(-50%) rotate(${i}deg)`;
    dial.appendChild(mk);

    // æ–‡å­—æ¨™ç±¤ï¼šæ¯30åº¦ä¸€å€‹
    if (i % 30 === 0) {
      const lb = document.createElement('div');
      lb.className = isCardinal ? 'label label-cardinal' : 'label';
      if (i===0) lb.classList.add('label-zero'); // 0åº¦ç´…è‰²
      
      let txt = i.toString();
      // ç¢ºä¿ 0 åº¦åœ¨æ­£ä¸­é–“
      lb.innerHTML = `<div style="transform: rotate(${-i}deg)">${txt}</div>`;
      lb.style.transform = `translateX(-50%) rotate(${i}deg)`;
      dial.appendChild(lb);
    }
  }
}
createDial();

// --- B. æ„Ÿæ¸¬å™¨é‚è¼¯ï¼šç›´æ¥èˆ‡å¹³æ»‘åˆ†é›¢ ---
let currentHeading = 0;       // æœ€æ–°çš„åŸå§‹æ•¸æ“š (Float)
let displayHeading = 0;       // ç”¨æ–¼è½‰ç›¤å‹•ç•«çš„æ•¸å€¼

function handleOrientation(e) {
  // iOS ä½¿ç”¨ webkitCompassHeading (0=åŒ—, é †æ™‚é‡)
  // Android ä½¿ç”¨ alpha (0=é–‹æ©Ÿæ–¹å‘ or åŒ—, é€†æ™‚é‡) -> è½‰æˆ (360-alpha)
  let heading = 0;
  if (e.webkitCompassHeading) {
    heading = e.webkitCompassHeading;
  } else if (e.alpha !== null) {
    heading = 360 - e.alpha; // ç°¡æ˜“è½‰æ›ï¼ŒAndroidå¯¦æ©Ÿå¯èƒ½æœ‰å·®ç•°ï¼Œä½†ä½¿ç”¨è€…è¦æ±‚è·Ÿå¾æ©Ÿå­
  }
  
  // 1. æ•¸å­—é¡¯ç¤ºï¼šç«‹å³æ›´æ–°ï¼Œç„¡ç·©è¡ï¼Œä¿ç•™å…©ä½å°æ•¸ (è§£æ±ºæ•¸å­—è·³å‹•å•é¡Œ)
  currentHeading = heading;
  // é˜²æ­¢ 360.00 çš„é¡¯ç¤ºï¼Œå¼·åˆ¶ mod 360
  let textVal = currentHeading % 360; 
  if(textVal < 0) textVal += 360;
  
  document.getElementById('readout').innerHTML = `${textVal.toFixed(2)}<small>Â°</small>`;
}

// ç¨ç«‹çš„å‹•ç•«å¾ªç’° (60fps) è™•ç†è½‰ç›¤ï¼Œé¿å… CSS transition çš„å»¶é²
function animateDial() {
  requestAnimationFrame(animateDial);
  
  // è§£æ±º 359 -> 0 çš„æ—‹è½‰è·¯å¾‘å•é¡Œ
  let target = currentHeading;
  let current = displayHeading % 360;
  if (current < 0) current += 360;
  
  let diff = target - current;
  if (diff > 180) diff -= 360;
  if (diff < -180) diff += 360;
  
  // Lerp ä¿‚æ•¸ï¼š0.3 (åæ‡‰éå¸¸å¿«) -> è§£æ±º "æ•¸å­—è·³è½‰ç›¤æ…¢" çš„å•é¡Œ
  displayHeading += diff * 0.3;
  
  // è½‰ç›¤è¦åå‘è½‰ï¼ŒæŒ‡é‡æ‰åƒæ˜¯å›ºå®šå‘åŒ—
  dial.style.transform = `rotate(${-displayHeading}deg)`;
}
animateDial(); // å•Ÿå‹•

function reqPerm() {
  if (typeof DeviceOrientationEvent.requestPermission === 'function') {
    DeviceOrientationEvent.requestPermission().then(r => {
      if(r==='granted') { 
        window.addEventListener('deviceorientation', handleOrientation, true); 
        document.getElementById('permBtn').style.display='none';
      }
      else alert('æ¬Šé™è¢«æ‹’');
    }).catch(console.error);
  } else {
    window.addEventListener('deviceorientation', handleOrientation, true);
    document.getElementById('permBtn').style.display='none';
  }
}

// --- C. é–å®šèˆ‡è³‡æ–™ç®¡ç† ---
const list = document.getElementById('list');
let points = [];

function lockTarget() {
  if(points.length >= 3) { alert("æœ€å¤šä¸‰å€‹åƒè€ƒé»"); return; }
  
  const id = Date.now();
  // é–å®šç•¶ä¸‹çš„ Raw Value
  const val = currentHeading; 
  // é è¨­ç©ºçš„ name, lat, lon
  points.push({ id, b: val, name: '', lat: '', lon: '' });
  
  renderList();
  if(navigator.vibrate) navigator.vibrate(30);
  
  // è‡ªå‹•èšç„¦åç¨±æ¡†
  setTimeout(() => {
    const input = document.querySelector(`input[data-focus="${id}"]`);
    if(input) input.focus();
  }, 50);
}

function updatePt(id, key, val) {
  const p = points.find(x=>x.id===id);
  if(p) p[key] = val;
}

function removePt(id) {
  points = points.filter(x=>x.id!==id);
  renderList();
}

function renderList() {
  list.innerHTML = '';
  // æœ€æ–°çš„åœ¨ä¸Šé¢
  [...points].reverse().forEach(p => {
    // é€™è£¡è§’åº¦ä½¿ç”¨ input è®“ä½¿ç”¨è€…å¯ä»¥é»é€²å»æ”¹
    // toFixed(2) é¡¯ç¤ºï¼Œä½†ç·¨è¼¯æ™‚æ˜¯æ•¸å­—
    const div = document.createElement('div');
    div.className = 'record';
    div.innerHTML = `
      <div class="deg-disp">
        <input class="deg-edit" type="number" step="0.01" value="${parseFloat(p.b).toFixed(2)}" 
        onchange="updatePt(${p.id}, 'b', this.value)">
      </div>
      <div class="inputs-group">
        <input class="text-in" data-focus="${p.id}" placeholder="ç›®æ¨™åç¨± (ä¾‹å¦‚: ç‰å±±)" value="${p.name}" 
               oninput="updatePt(${p.id}, 'name', this.value)" style="font-weight:bold; color:#0ff;">
        <div class="inputs-row">
          <input class="text-in" type="number" step="0.0001" placeholder="ç·¯åº¦ Lat" value="${p.lat}" oninput="updatePt(${p.id}, 'lat', this.value)">
          <input class="text-in" type="number" step="0.0001" placeholder="ç¶“åº¦ Lon" value="${p.lon}" oninput="updatePt(${p.id}, 'lon', this.value)">
        </div>
      </div>
      <button class="del-btn" onclick="removePt(${p.id})">âœ•</button>
    `;
    list.appendChild(div);
  });
}

// --- D. è¨ˆç®—èˆ‡åœ°åœ–ç¹ªè£½ (Canvas) ---
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
const R = 6371000;
const rad = d => d * Math.PI / 180;

// ENU è½‰æ› (ä¸å«ç£åè§’)
function ll2enu(lat, lon, refLat, refLon) {
  const dLat = rad(lat - refLat);
  const dLon = rad(lon - refLon);
  return [R * dLon * Math.cos(rad(refLat)), R * dLat];
}
function enu2ll(x, y, refLat, refLon) {
  const lat = refLat + (y / R) * (180 / Math.PI);
  const lon = refLon + (x / (R * Math.cos(rad(refLat)))) * (180 / Math.PI);
  return [lat, lon];
}

// æ ¸å¿ƒä¼°ç®—
function estimateLocation(mnts) {
  let x=0, y=0;
  mnts.forEach(m => { x+=m.x; y+=m.y; });
  x /= mnts.length; y /= mnts.length;
  
  // è¿­ä»£æ”¶æ–‚
  for(let i=0; i<30; i++) {
    let gx=0, gy=0;
    mnts.forEach(m => {
      // é€™è£¡ç›´æ¥ç”¨è¼¸å…¥çš„ bearingï¼Œä¸åŠ ä»»ä½•åç§»
      // å› ç‚ºæ˜¯ "Bearing to Mountain"ï¼Œæ‰€ä»¥ back azimuth æ˜¯ +180
      const b = rad(Number(m.b) + 180); 
      const vx = Math.sin(b), vy = Math.cos(b);
      const dx = x - m.x, dy = y - m.y;
      // æŠ•å½±é•·åº¦
      const p = dx*vx + dy*vy;
      // æ¢¯åº¦ä¸‹é™
      gx += dx - p*vx;
      gy += dy - p*vy;
    });
    x -= gx * 0.1;
    y -= gy * 0.1;
  }
  return [x,y];
}

function simulateCloud(mnts, errorDeg) {
  let pts = [];
  for(let i=0; i<150; i++) {
    const noisyMnts = mnts.map(m => ({
      ...m,
      b: Number(m.b) + (Math.random()*2 - 1) * errorDeg
    }));
    pts.push(estimateLocation(noisyMnts));
  }
  return pts;
}

// åœ°åœ–è¦–åœ–è®Šæ•¸
let gMnts=[], gPts=[], gCenter=[0,0], gRefLat=0, gRefLon=0;
let gZoom=1.0, gPanX=0, gPanY=0;

function runCalculation() {
  const valid = points.filter(p => p.lat && p.lon && !isNaN(p.lat) && !isNaN(p.lon));
  if(valid.length < 2) { alert("è«‹è‡³å°‘è¼¸å…¥ 2 å€‹å·²çŸ¥é»çš„åº§æ¨™"); return; }
  
  document.getElementById('result-overlay').style.display='flex';
  
  // 1. å»ºç«‹åŸºæº–é» (Reference)
  gRefLat = valid.reduce((s,p)=>s+Number(p.lat),0)/valid.length;
  gRefLon = valid.reduce((s,p)=>s+Number(p.lon),0)/valid.length;
  
  // 2. è½‰æ›åº§æ¨™
  gMnts = valid.map(p => {
    const [xx, yy] = ll2enu(p.lat, p.lon, gRefLat, gRefLon);
    return { x:xx, y:yy, b:Number(p.b), name:p.name };
  });
  
  // 3. è’™åœ°å¡ç¾…æ¨¡æ“¬
  const errVal = parseFloat(document.getElementById('err-val').value) || 1.0;
  gPts = simulateCloud(gMnts, errVal);
  
  // 4. è¨ˆç®—å¹³å‡ä¸­å¿ƒ
  let sx=0, sy=0;
  gPts.forEach(p=>{sx+=p[0]; sy+=p[1]});
  gCenter = [sx/gPts.length, sy/gPts.length];
  
  resetView();
  
  // é¡¯ç¤ºçµæœ
  const ll = enu2ll(gCenter[0], gCenter[1], gRefRefLat=gRefLat, gRefLon);
  document.getElementById('res-readout').innerHTML = 
    `æˆ‘çš„æ¨ç®—ä½ç½®<br><span class="coord-big">${ll[0].toFixed(5)}, ${ll[1].toFixed(5)}</span>`;
}

// ç¹ªåœ–
function draw() {
  cv.width = window.innerWidth; cv.height = window.innerHeight;
  ctx.clearRect(0,0,cv.width,cv.height);
  
  if(!gMnts.length) return;
  
  const cx = cv.width/2; 
  const cy = cv.height/2;
  
  // è¨ˆç®—è‡ªå‹•ç¸®æ”¾åŸºç¤
  // æ‰¾å‡ºåŒ…å«æ‰€æœ‰é»çš„æœ€å¤§ç¯„åœ
  let all = [...gPts, ...gMnts.map(m=>[m.x,m.y])];
  let minX=Infinity, maxX=-Infinity, minY=Infinity, maxY=-Infinity;
  all.forEach(p=>{
    if(p[0]<minX) minX=p[0]; if(p[0]>maxX) maxX=p[0];
    if(p[1]<minY) minY=p[1]; if(p[1]>maxY) maxY=p[1];
  });
  const w = Math.max(maxX-minX, 50);
  const h = Math.max(maxY-minY, 50);
  // åŸºç¤æ¯”ä¾‹ï¼šè®“æ‰€æœ‰æ±è¥¿ä½”ç•«é¢ 60%
  const baseScale = Math.min(cv.width/w, cv.height/h) * 0.6;
  const scale = baseScale * gZoom;
  
  // æ˜ å°„å‡½æ•¸ (ä»¥ gCenter ç‚ºç•«é¢ä¸­å¿ƒ)
  const map = (x, y) => [
    cx + gPanX + (x - gCenter[0]) * scale,
    cy + gPanY - (y - gCenter[1]) * scale // Yè»¸ç¿»è½‰
  ];
  
  // 1. ç•«ç²’å­é›²
  ctx.fillStyle = "rgba(0,255,255,0.4)";
  gPts.forEach(p => {
    const [px, py] = map(p[0], p[1]);
    ctx.fillRect(px, py, 2, 2);
  });
  
  // 2. ç•«å±±é ­èˆ‡æ‰‡å½¢
  const errRad = rad(parseFloat(document.getElementById('err-val').value)||1);
  gMnts.forEach((m, i) => {
    const [mx, my] = map(m.x, m.y);
    
    // ç¹ªè£½æ‰‡å½¢ (åå‘è§’åº¦)
    // ç¾…ç›¤ 0=åŒ—(Y+), 90=æ±(X+). Canvas 0=X+, 90=Y+
    // Canvas Angle = (Compass - 90) * -1 ??? 
    // ä¸ï¼Œæœ€ç°¡å–®æ˜¯ Compass 0 = Canvas -90 (Up). 
    // Bearing to Mountain is B. Back Azimuth is B+180.
    // Canvas 0 is Right. Up is -90.
    // Angle = (B + 180) - 90 = B + 90 (radians)
    const angle = rad(m.b + 180 - 90); 
    const L = Math.max(cv.width, cv.height) * 1.5;
    
    // å…‰æŸ
    ctx.beginPath();
    ctx.moveTo(mx, my);
    ctx.arc(mx, my, L, angle - errRad, angle + errRad);
    ctx.fillStyle = `hsla(${i*50}, 80%, 60%, 0.1)`;
    ctx.fill();
    
    // ä¸­å¿ƒç·š
    ctx.beginPath();
    ctx.moveTo(mx, my);
    ctx.lineTo(mx + Math.cos(angle)*L, my + Math.sin(angle)*L);
    ctx.strokeStyle = `hsla(${i*50}, 80%, 60%, 0.6)`;
    ctx.setLineDash([4, 4]);
    ctx.stroke();
    ctx.setLineDash([]);
    
    // å±±é ­é»
    ctx.beginPath(); ctx.arc(mx, my, 6, 0, Math.PI*2);
    ctx.fillStyle = `hsl(${i*50}, 80%, 60%)`; ctx.fill();
    
    // åç¨±
    ctx.fillStyle = "#fff"; ctx.font = "bold 14px monospace";
    ctx.fillText(m.name || (i+1), mx+10, my+4);
  });
  
  // 3. ç•«è‡ªå·± (æ°¸é åœ¨ä¸­å¿ƒ + Pan)
  const [ux, uy] = map(gCenter[0], gCenter[1]);
  ctx.strokeStyle = "#0f0"; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.arc(ux, uy, 12, 0, Math.PI*2); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(ux-20, uy); ctx.lineTo(ux+20, uy); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(ux, uy-20); ctx.lineTo(ux, uy+20); ctx.stroke();
  ctx.fillStyle="#0f0"; ctx.fillText("YOU", ux+15, uy-15);
}

// è¦–åœ–æ§åˆ¶
function resetView() { gZoom=1.0; gPanX=0; gPanY=0; draw(); }
function adjustZoom(f) { gZoom *= f; draw(); }
function closeResult() { document.getElementById('result-overlay').style.display='none'; }

// æ‹–æ›³äº‹ä»¶
let isDrag=false, startX=0, startY=0, lastX=0, lastY=0;
const overlay = document.getElementById('result-overlay');

overlay.addEventListener('mousedown', e => { isDrag=true; startX=e.clientX; startY=e.clientY; lastX=gPanX; lastY=gPanY; });
overlay.addEventListener('touchstart', e => { isDrag=true; startX=e.touches[0].clientX; startY=e.touches[0].clientY; lastX=gPanX; lastY=gPanY; }, {passive:false});

window.addEventListener('mousemove', e => {
  if(!isDrag) return;
  gPanX = lastX + (e.clientX - startX);
  gPanY = lastY + (e.clientY - startY);
  draw();
});
window.addEventListener('touchmove', e => {
  if(!isDrag) return;
  e.preventDefault();
  gPanX = lastX + (e.touches[0].clientX - startX);
  gPanY = lastY + (e.touches[0].clientY - startY);
  draw();
}, {passive:false});

window.addEventListener('mouseup', () => isDrag=false);
window.addEventListener('touchend', () => isDrag=false);
window.onresize = draw;

</script>
</body>
</html>
