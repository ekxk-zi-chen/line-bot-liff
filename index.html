function doGet(e) {
  try {
    console.log('收到 GET 請求，參數:', e.parameter);
    
    const userId = e.parameter.userId;
    if (!userId) {
      return createResponse({
        status: "error",
        message: "缺少 userId 參數"
      });
    }
    
    const sheet = SpreadsheetApp.openById("1DPBqbdEkqK-L_5PLun0zDYEsqZPCQYRPGnyaev6Fwjc").getSheetByName("圖文表單連結");
    const data = sheet.getDataRange().getValues();

    for (let i = 1; i < data.length; i++) {
      const sheetUserId = data[i][1] ? data[i][1].toString().trim() : "";
      if (sheetUserId === userId.trim()) {
        // 驗證成功，讀取 B2 儲存格作為連結
        const link = sheet.getRange("B2").getValue();
        console.log('找到對應使用者，跳轉連結:', link);
        
        return createResponse({
          status: "ok",
          redirectUrl: link
        });
      }
    }

    console.log('未找到對應使用者');
    return createResponse({
      status: "not_found"
    });
    
  } catch (error) {
    console.error('doGet 錯誤:', error);
    return createResponse({
      status: "error",
      message: error.toString()
    });
  }
}

function doPost(e) {
  try {
    console.log('收到 POST 請求');
    console.log('POST 資料:', e.postData ? e.postData.contents : 'undefined');
    
    const sheetId = "1DPBqbdEkqK-L_5PLun0zDYEsqZPCQYRPGnyaev6Fwjc";
    const ss = SpreadsheetApp.openById(sheetId);
    const sheet = ss.getSheetByName("人員資料");

    if (!e.postData || !e.postData.contents) {
      throw new Error('沒有收到資料');
    }

    const data = JSON.parse(e.postData.contents);
    console.log('解析後的資料:', data);

    // 驗證必要欄位
    if (!data.lineUserId) {
      throw new Error('缺少 LINE User ID');
    }

    const row = [
      new Date(),
      data.lineUserId || "",
      data.displayName || "",
      data.name || "",
      data.email || "",
      data.phone || "",
      data.message || "",
      data.source || ""
    ];

    sheet.appendRow(row);
    console.log('資料已寫入試算表');

    return createResponse({
      result: "success",
      timestamp: new Date().toISOString()
    });
    
  } catch (error) {
    console.error('doPost 錯誤:', error);
    return createResponse({
      result: "error",
      message: error.toString()
    });
  }
}

// 統一的回應函數，確保正確的 CORS 設定
function createResponse(data) {
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader("Access-Control-Allow-Origin", "*")
    .setHeader("Access-Control-Allow-Methods", "GET, POST, OPTIONS")
    .setHeader("Access-Control-Allow-Headers", "Content-Type")
    .setHeader("Cache-Control", "no-cache");
}

// 處理 preflight OPTIONS 請求
function doOptions(e) {
  return createResponse({ status: "ok" });
}
