<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>特搜線上報名</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- LIFF SDK -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to bottom right, #f0f4f8, #dcefff);
      padding: 30px;
      font-size: 16px;
      line-height: 1.6;
      color: #333;
    }
    .card {
      max-width: 520px;
      margin: auto;
      background: white;
      padding: 28px 32px;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }
    h2 {
      text-align: center;
      margin-bottom: 12px;
      font-size: 28px;
      font-weight: 700;
      color: #222;
    }
    #script {
      font-size: 22px;
      color: #666;
      margin-bottom: 20px;
      text-align: center;
      font-style: italic;
    }
    label {
      font-weight: 600;
      display: block;
      margin-top: 22px;
      margin-bottom: 6px;
      font-size: 17px;
      color: #444;
    }
    input[type="text"],
    select,
    textarea {
      width: 100%;
      padding: 12px 14px;
      margin-top: 2px;
      border-radius: 8px;
      border: 1.5px solid #bbb;
      box-sizing: border-box;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    input[type="text"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 8px rgba(76, 175, 80, 0.4);
    }
    textarea::placeholder { color: #999; }
    button {
      margin-top: 28px;
      width: 100%;
      padding: 14px;
      background-color: #4CAF50;
      color: white;
      font-size: 18px;
      font-weight: 700;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.25s ease;
    }
    button:hover:not(:disabled) { background-color: #45a049; }
    button:disabled { background-color: #9ccc9c; cursor: not-allowed; }
    #status {
      margin-top: 16px;
      text-align: center;
      color: #d32f2f;
      font-weight: 600;
      font-size: 16px;
    }
    .hidden { display: none !important; height: 0; margin: 0 !important; padding: 0 !important; border: none !important; }
  </style>
</head>
<body>
  <div class="card">
    <h2>特搜線上報名</h2>
    <div id="script"></div> <!-- 後端 script -->

    <form id="form">
      <label>1. 是否參加</label>
      <div>
        <label style="font-weight: normal; margin-right: 20px;">
          <input type="radio" name="join" value="參加" /> 參加
        </label>
        <label style="font-weight: normal;">
          <input type="radio" name="join" value="不參加" /> 不參加
        </label>
      </div>

      <label id="reasonLabel" style="display:none; margin-top: 18px;">2. 不參加原因說明</label>
      <input type="text" name="reason" id="reasonInput" placeholder="還敢不填寫原因，是沒被老大罵?" style="display:none; margin-top: 6px;" />

      <label style="margin-top: 22px;">3. 預計抵達時間</label>
      <div>
        <label style="font-weight: normal; margin-right: 20px;">
          <input type="radio" name="arrival" value="30分鐘內抵達大隊" checked /> 30分鐘內抵達大隊
        </label>
        <label style="font-weight: normal;">
          <input type="radio" name="arrival" value=">大於30分鐘" /> 大於30分鐘
        </label>
      </div>

      <button type="submit">送出</button>
      <div id="status"></div>
    </form>
  </div>

  <script>
    const CONFIG = {
      LIFF_ID: "2007782293-RgkE5pPW",
      APPS_SCRIPT_URL: "https://script.google.com/macros/s/AKfycbwyzcire5j9gDVAcANdaIVaD6_4R6jOl-0MtllgzM3HdQTPeedvFThy7IHCG6yEZuSd9A/exec",
      INDEX_PAGE: "index.html",
      Registration_PAGE: "Registration_form.html",
      DEBUG: true
    };

    const url = new URL(location.href);
    const SLOT = url.searchParams.get('slot') || "B2"; 
    let sessionToken = localStorage.getItem('sessionToken') || "";

    function log(msg){ if(CONFIG.DEBUG) console.log("[signup]", msg); }

    function redirectToIndex(reason){ 
      localStorage.removeItem('sessionToken'); 
      const qs = new URLSearchParams({ slot: SLOT, reason: reason || 'expired' }); 
      // location.replace(`${CONFIG.INDEX_PAGE}?${qs.toString()}`);
    }

    // === 初始化 LIFF
    async function initLiff() {
      try {
        if(typeof liff !== 'undefined') {
          await liff.init({ liffId: CONFIG.LIFF_ID });
          log("LIFF 初始化成功");
        }
      } catch(e){ log("LIFF 初始化失敗: " + e.message); }
    }

    // === 驗證 sessionToken 或 idToken
    async function verifySession(){
      if(!sessionToken){
        log("沒有 sessionToken，回主頁重認證");
        document.getElementById('status').textContent = "請先回主頁登入 LINE";
        return;
      }
      try{
        const payload = JSON.stringify({ sessionToken, slot: SLOT, action:'signing' });
        log("發送驗證請求: " + payload);
        const res = await fetch(CONFIG.APPS_SCRIPT_URL, {
          method:'POST',
          headers:{'Content-Type':'text/plain'},
          body: payload
        });
        log("fetch 狀態: " + res.status);
        if(!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        log(["後端回應", data]);

        if(!data || data.status === 'error' || data.status === 'expired'){
          document.getElementById('status').textContent = "登入過期，請回主頁重新登入";
          return;
        }
        if(data.action === "signed"){
          log("使用者已簽到，跳轉 Registration_PAGE");
          document.getElementById('status').textContent = "您已完成報名，資料已送出";
          location.href = `${CONFIG.Registration_PAGE}?slot=${encodeURIComponent(SLOT)}`;
          return;
        }

        if(data.script) document.getElementById('script').textContent = data.script;
        document.getElementById('form').style.display = 'block';
      } catch(err){
        log("verifySession 錯誤: " + err.message);
        document.getElementById('status').textContent = "網路錯誤，請稍後再試";
      }
    }

    // === 顯示/隱藏不參加原因
    function wireReasonField(){
      const joinRadios = document.querySelectorAll('input[name="join"]');
      const reasonInput = document.getElementById('reasonInput');
      const reasonLabel = document.getElementById('reasonLabel');

      function toggle(){
        const selected = [...joinRadios].find(r=>r.checked)?.value;
        if(selected==="不參加"){
          reasonInput.style.display="block";
          reasonLabel.style.display="block";
        } else {
          reasonInput.style.display="none";
          reasonLabel.style.display="none";
          reasonInput.value="";
        }
      }
      joinRadios.forEach(r=>r.addEventListener('change', toggle));
      toggle();
    }

    // === 表單提交
    async function wireSubmit(){
      const form = document.getElementById('form');
      const statusEl = document.getElementById('status');

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const btn = form.querySelector('button[type="submit"]');
        btn.disabled=true; btn.textContent="送出中...";
        const fd = new FormData(form);
        const data = Object.fromEntries(fd.entries());
        if(data.join==="參加") data.reason="";

        try{
          const payload = JSON.stringify({slot:SLOT, sessionToken, action:'signed', ...data});
          log("提交 payload: " + payload);
          const res = await fetch(CONFIG.APPS_SCRIPT_URL,{
            method:'POST',
            headers:{'Content-Type':'text/plain'},
            body:payload
          });
          if(!res.ok) throw new Error("HTTP " + res.status);
          const resp = await res.json();
          log(["送出回應", resp]);
          statusEl.textContent = "已送出，感謝填寫！";
          setTimeout(()=>{ location.href=`${CONFIG.Registration_PAGE}?slot=${encodeURIComponent(SLOT)}`; }, 1000);
        } catch(err){
          log("表單提交錯誤: "+err.message);
          statusEl.textContent="送出失敗，請稍後再試";
          btn.disabled=false; btn.textContent="送出";
        }
      });
    }

    // === 啟動流程 ===
    document.addEventListener('DOMContentLoaded', async ()=>{
      log("頁面載入完成，初始化");
      document.getElementById('form').style.display='none';
      await initLiff();
      wireReasonField();
      wireSubmit();
      setTimeout(()=>{ verifySession(); }, 500);
    });
  </script>
</body>
</html>
