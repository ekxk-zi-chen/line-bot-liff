<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>特搜線上報名</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to bottom right, #f0f4f8, #dcefff);
      padding: 30px;
      font-size: 16px;
      line-height: 1.6;
      color: #333;
    }
    .card {
      max-width: 520px;
      margin: auto;
      background: white;
      padding: 28px 32px;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }
    h2 {
      text-align: center;
      margin-bottom: 12px;
      font-size: 28px;
      font-weight: 700;
      color: #222;
    }
    #script {
      font-size: 22px;
      color: #666;
      margin-bottom: 20px;
      text-align: center;
      font-style: italic;
    }
    label {
      font-weight: 600;
      display: block;
      margin-top: 22px;
      margin-bottom: 6px;
      font-size: 17px;
      color: #444;
    }
    input[type="text"],
    select,
    textarea {
      width: 100%;
      padding: 12px 14px;
      margin-top: 2px;
      border-radius: 8px;
      border: 1.5px solid #bbb;
      box-sizing: border-box;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    input[type="text"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 8px rgba(76, 175, 80, 0.4);
    }
    textarea::placeholder {
      color: #999;
    }
    button {
      margin-top: 28px;
      width: 100%;
      padding: 14px;
      background-color: #4CAF50;
      color: white;
      font-size: 18px;
      font-weight: 700;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.25s ease;
    }
    button:hover:not(:disabled) {
      background-color: #45a049;
    }
    button:disabled {
      background-color: #9ccc9c;
      cursor: not-allowed;
    }
    #status {
      margin-top: 16px;
      text-align: center;
      color: #d32f2f;
      font-weight: 600;
      font-size: 16px;
    }
    /* 讓不參加原因欄位隱藏時佔位不跳動 */
    .hidden {
      display: none !important;
      height: 0;
      margin: 0 !important;
      padding: 0 !important;
      border: none !important;
    }
  </style> 
</head>
<body>
  <div class="card">
    <h2>特搜線上報名</h2>
    <div id="script"></div> <!-- 這裡放 script 內容 -->

    <form id="form">
      <label>1. 是否參加</label>
      <div>
        <label style="font-weight: normal; margin-right: 20px;">
          <input type="radio" name="join" value="參加" /> 參加
        </label>
        <label style="font-weight: normal;">
          <input type="radio" name="join" value="不參加" /> 不參加
        </label>
      </div>
    
      <label id="reasonLabel" style="display:none; margin-top: 18px;">2. 不參加原因說明</label>
      <input
        type="text"
        name="reason"
        id="reasonInput"
        placeholder="還敢不填寫原因，是沒被老大罵?"
        style="display:none; margin-top: 6px;"
      />
    
      <label style="margin-top: 22px;">3. 預計抵達時間</label>
      <div>
        <label style="font-weight: normal; margin-right: 20px;">
          <input type="radio" name="arrival" value="30分鐘內抵達大隊" checked /> 30分鐘內抵達大隊
        </label>
        <label style="font-weight: normal;">
          <input type="radio" name="arrival" value=">大於30分鐘" /> 大於30分鐘
        </label>
      </div>
    
    
      <button type="submit">送出</button>
      <div id="status"></div>
    </form>
  </div>

  <script>
    // === 設定 ===
    const CONFIG = {
      APPS_SCRIPT_URL: "https://script.google.com/macros/s/AKfycbwyzcire5j9gDVAcANdaIVaD6_4R6jOl-0MtllgzM3HdQTPeedvFThy7IHCG6yEZuSd9A/exec",
      INDEX_PAGE: "index.html",
      Registration_PAGE: "Registration_form.html",
      API_PROXY: "https://line-bot-liff-hz4revrw8-ekxk-zi-chens-projects.vercel.app/api/proxy",
      DEBUG: false
    };
  
    const SLOT = new URL(location.href).searchParams.get('slot') || "B2"; // 預設 B2
  
    function log(msg){
      if(CONFIG.DEBUG) console.log("[signup]", msg);
    }
  
    // === 從主頁 sessionStorage 讀 verifyResult ===
    function getVerifyResult() {
      const raw = sessionStorage.getItem('verifyResult');
      if(!raw) {
        log("沒有 verifyResult，回主頁重認證");
        window.location.href = CONFIG.INDEX_PAGE;
        return null;
      }
      const result = JSON.parse(raw);
      log("取得 verifyResult:"); log(result);
      return result;
    }
  
    // === UI：是否參加 -> 顯示/隱藏原因 ===
    function wireReasonField(){
      const joinRadios = document.querySelectorAll('input[name="join"]');
      const reasonInput = document.getElementById('reasonInput');
      const reasonLabel = document.getElementById('reasonLabel');
  
      function toggle(){
        const selected = [...joinRadios].find(r => r.checked)?.value;
        if (selected === "不參加"){
          reasonInput.style.display = "block";
          reasonLabel.style.display = "block";
        }else{
          reasonInput.style.display = "none";
          reasonLabel.style.display = "none";
          reasonInput.value = "";
        }
      }
      joinRadios.forEach(r => r.addEventListener('change', toggle));
      toggle();
    }
  
    // === 表單送出 ===
    async function wireSubmit(verifyResult){
      const form = document.getElementById('form');
      const statusEl = document.getElementById('status');
    
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const btn = form.querySelector('button[type="submit"]');
        btn.disabled = true;
    
        const fd = new FormData(form);
        const data = Object.fromEntries(fd.entries());
        if (data.join === "參加") data.reason = "";
    
        try{
          const payload = JSON.stringify({
            slot: SLOT,
            sessionToken: verifyResult.sessionToken || "",
            url: CONFIG.APPS_SCRIPT_URL,
            action: 'signed',
            ...data
          });
          log("發送填寫請求");
    
          const res = await fetch(CONFIG.API_PROXY, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: payload
          });
          if(!res.ok) throw new Error("HTTP " + res.status);
    
          const resp = await res.json();
          log(["送出回應", resp]);
    
          if(!resp || resp.status !== "ok") throw new Error(resp?.message || "未知錯誤");
    
          // ✅ 更新 sessionStorage，包含 signed_status 資料
          const updatedVerifyResult = {
            realName: resp.realName,
            slot: SLOT,
            sessionToken: resp.sessionToken,
            action: resp.action,
            ...resp.signed_status
          };
          sessionStorage.setItem("verifyResult", JSON.stringify(updatedVerifyResult));
    
          statusEl.textContent = "已送出，感謝填寫！";
          log("跳轉第三子頁");
          location.href = `${CONFIG.Registration_PAGE}?slot=${encodeURIComponent(SLOT)}`;
    
        } catch(err){
          log(err);
          statusEl.textContent = "送出失敗，請稍後再試";
          btn.disabled = false;
        }
      });
    }

  
    // === 啟動 ===
    document.addEventListener('DOMContentLoaded', ()=>{
      const verifyResult = getVerifyResult();
      if(!verifyResult) return;
  
      // 若已簽到，直接跳轉第三頁
      if(verifyResult.action === 'signed'){
        document.getElementById('status').textContent = "您已完成報名，資料已送出";
        location.href = `${CONFIG.Registration_PAGE}?slot=${encodeURIComponent(SLOT)}`;
        return;
      }
  
      // 後端 script 顯示
      if(verifyResult.script) document.getElementById('script').textContent = verifyResult.script;
  
      // 顯示表單
      const form = document.getElementById('form');
      form.style.display = 'block';
  
      wireReasonField();
      wireSubmit(verifyResult);
    });
  </script>


  

</body>
</html>












